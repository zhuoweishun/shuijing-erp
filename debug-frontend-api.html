<!DOCTYPE html>
<html>
<head>
    <title>调试前端API</title>
</head>
<body>
    <h1>库存消耗分析API调试</h1>
    <button onclick="testAPI()">测试API</button>
    <div id="result"></div>
    
    <script>
        async function testAPI() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '正在请求...';
            
            try {
                // 获取token（如果有的话）
                const token = localStorage.getItem('token');
                
                const response = await fetch('http://localhost:3001/api/v1/inventory/consumption-analysis?time_range=30d&limit=10', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(token && { 'Authorization': `Bearer ${token}` })
                    }
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('API Response:', data);
                
                let html = '<h2>API响应结果</h2>';
                html += `<p><strong>成功:</strong> ${data.success}</p>`;
                html += `<p><strong>消息:</strong> ${data.message}</p>`;
                
                if (data.data) {
                    html += '<h3>消耗分析数据</h3>';
                    html += `<p><strong>时间范围:</strong> ${data.data.time_range}</p>`;
                    html += `<p><strong>总消耗量:</strong> ${data.data.total_consumption}</p>`;
                    html += `<p><strong>总消耗次数:</strong> ${data.data.total_consumption_count}</p>`;
                    html += `<p><strong>分析时间:</strong> ${data.data.analysis_date}</p>`;
                    
                    html += '<h3>前10名消耗产品</h3>';
                    html += '<table border="1" style="border-collapse: collapse; width: 100%;">';
                    html += '<tr><th>产品名称</th><th>产品类型</th><th>消耗量</th><th>单位</th><th>消耗次数</th><th>平均消耗</th><th>供应商</th></tr>';
                    
                    data.data.top_consumed_products.forEach(item => {
                        html += '<tr>';
                        html += `<td>${item.product_name}</td>`;
                        html += `<td>${item.product_type}</td>`;
                        html += `<td>${item.total_consumed}</td>`;
                        html += `<td>${item.unit_type}</td>`;
                        html += `<td>${item.consumption_count}</td>`;
                        html += `<td>${item.avg_consumption}</td>`;
                        html += `<td>${item.supplier_name || '未知'}</td>`;
                        html += '</tr>';
                    });
                    
                    html += '</table>';
                    
                    // 验证计算
                    const calculatedTotal = data.data.top_consumed_products.reduce((sum, item) => sum + item.total_consumed, 0);
                    html += '<h3>验证计算</h3>';
                    html += `<p><strong>API返回的总消耗量:</strong> ${data.data.total_consumption}</p>`;
                    html += `<p><strong>手动计算的总消耗量:</strong> ${calculatedTotal}</p>`;
                    html += `<p><strong>计算是否一致:</strong> ${data.data.total_consumption === calculatedTotal ? '✓ 一致' : '✗ 不一致'}</p>`;
                }
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                console.error('API请求失败:', error);
                resultDiv.innerHTML = `<p style="color: red;">错误: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>