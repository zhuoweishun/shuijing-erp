<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´¢åŠ¡APIæµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
        .success {
            border-left-color: #28a745;
            background-color: #d4edda;
        }
        .error {
            border-left-color: #dc3545;
            background-color: #f8d7da;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .highlight {
            font-size: 1.2em;
            font-weight: bold;
            color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>è´¢åŠ¡APIæµ‹è¯• - æ€»æ”¶å…¥éªŒè¯</h1>
        <p>æµ‹è¯•ä¿®æ”¹åçš„è´¢åŠ¡æ¦‚è§ˆAPIï¼ŒéªŒè¯æ€»æ”¶å…¥è®¡ç®—æ˜¯å¦æ­£ç¡®ï¼ˆåº”è¯¥æ˜¾ç¤ºçº¦Â¥4,073ï¼‰</p>
        
        <button onclick="testFinancialOverview()">æµ‹è¯•è´¢åŠ¡æ¦‚è§ˆAPI</button>
        <button onclick="testDirectConnection()">æµ‹è¯•ç›´æ¥è¿æ¥</button>
        <button onclick="clearResults()">æ¸…é™¤ç»“æœ</button>
        
        <div id="results"></div>
    </div>

    <script>
        // åŠ¨æ€è·å–APIåœ°å€
        function getApiUrl() {
            const hostname = window.location.hostname;
            
            // å¦‚æœæ˜¯localhostï¼Œå°è¯•ä½¿ç”¨localhost:3001
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return 'http://localhost:3001/api/v1';
            }
            
            // å¦‚æœæ˜¯å±€åŸŸç½‘IPï¼Œä½¿ç”¨ç›¸åŒIPçš„3001ç«¯å£
            if (hostname.startsWith('192.168.') || hostname.startsWith('10.') || 
                (hostname.startsWith('172.') && parseInt(hostname.split('.')[1]) >= 16 && parseInt(hostname.split('.')[1]) <= 31)) {
                return `http://${hostname}:3001/api/v1`;
            }
            
            // é»˜è®¤ä½¿ç”¨localhost
            return 'http://localhost:3001/api/v1';
        }

        function addResult(content, isSuccess = true) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${isSuccess ? 'success' : 'error'}`;
            div.innerHTML = content;
            results.appendChild(div);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function testFinancialOverview() {
            const apiUrl = getApiUrl();
            addResult(`ğŸ” æµ‹è¯•APIåœ°å€: ${apiUrl}/financial/overview/summary`);
            
            try {
                // è·å–tokenï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                const token = localStorage.getItem('auth_token');
                
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                    addResult(`ğŸ”‘ ä½¿ç”¨è®¤è¯token: ${token.substring(0, 20)}...`);
                } else {
                    addResult(`âš ï¸ æœªæ‰¾åˆ°è®¤è¯tokenï¼Œå¯èƒ½éœ€è¦å…ˆç™»å½•`, false);
                }
                
                const response = await fetch(`${apiUrl}/financial/overview/summary`, {
                    method: 'GET',
                    headers: headers
                });
                
                addResult(`ğŸ“¡ å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    addResult(`âŒ APIé”™è¯¯: ${errorText}`, false);
                    return;
                }
                
                const data = await response.json();
                
                if (data.success && data.data) {
                    const overview = data.data;
                    
                    addResult(`âœ… APIè°ƒç”¨æˆåŠŸï¼`);
                    addResult(`
                        <h3>ğŸ“Š è´¢åŠ¡æ¦‚è§ˆæ•°æ®:</h3>
                        <div class="highlight">æ€»æ”¶å…¥ï¼ˆå¹´åº¦ï¼‰: Â¥${overview.this_year?.income?.toFixed(2) || '0.00'}</div>
                        <p>ä»Šæ—¥æ”¶å…¥: Â¥${overview.today?.income?.toFixed(2) || '0.00'}</p>
                        <p>æœ¬æœˆæ”¶å…¥: Â¥${overview.this_month?.income?.toFixed(2) || '0.00'}</p>
                        <p>ä»Šæ—¥æ”¯å‡º: Â¥${overview.today?.expense?.toFixed(2) || '0.00'}</p>
                        <p>æœ¬æœˆæ”¯å‡º: Â¥${overview.this_month?.expense?.toFixed(2) || '0.00'}</p>
                        <p>å¹´åº¦æ”¯å‡º: Â¥${overview.this_year?.expense?.toFixed(2) || '0.00'}</p>
                    `);
                    
                    // éªŒè¯æ€»æ”¶å…¥æ˜¯å¦åœ¨æœŸæœ›èŒƒå›´å†…
                    const yearlyIncome = overview.this_year?.income || 0;
                    if (yearlyIncome >= 4000 && yearlyIncome <= 4100) {
                        addResult(`ğŸ¯ æ€»æ”¶å…¥éªŒè¯æˆåŠŸï¼æ˜¾ç¤º Â¥${yearlyIncome.toFixed(2)}ï¼Œåœ¨æœŸæœ›çš„4000å·¦å³èŒƒå›´å†…`);
                    } else {
                        addResult(`âš ï¸ æ€»æ”¶å…¥ Â¥${yearlyIncome.toFixed(2)} ä¸åœ¨æœŸæœ›çš„4000å·¦å³èŒƒå›´å†…`, false);
                    }
                } else {
                    addResult(`âŒ APIè¿”å›æ ¼å¼é”™è¯¯: ${JSON.stringify(data)}`, false);
                }
                
            } catch (error) {
                addResult(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, false);
                addResult(`ğŸ’¡ å»ºè®®: æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨ï¼Œæˆ–å°è¯•ä¸åŒçš„APIåœ°å€`, false);
            }
        }

        async function testDirectConnection() {
            const apiUrl = getApiUrl();
            addResult(`ğŸ” æµ‹è¯•ç›´æ¥è¿æ¥: ${apiUrl}/health`);
            
            try {
                const response = await fetch(`${apiUrl}/health`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    addResult(`âœ… åç«¯æœåŠ¡è¿æ¥æˆåŠŸ: ${JSON.stringify(data)}`);
                } else {
                    addResult(`âŒ åç«¯æœåŠ¡å“åº”é”™è¯¯: ${response.status}`, false);
                }
            } catch (error) {
                addResult(`âŒ æ— æ³•è¿æ¥åç«¯æœåŠ¡: ${error.message}`, false);
                
                // å°è¯•å…¶ä»–å¯èƒ½çš„åœ°å€
                const alternatives = [
                    'http://localhost:3001/api/v1',
                    'http://127.0.0.1:3001/api/v1',
                    'http://192.168.50.160:3001/api/v1'
                ];
                
                addResult(`ğŸ”„ å°è¯•å…¶ä»–APIåœ°å€...`);
                
                for (const altUrl of alternatives) {
                    try {
                        const altResponse = await fetch(`${altUrl}/health`);
                        if (altResponse.ok) {
                            addResult(`âœ… æ‰¾åˆ°å¯ç”¨åœ°å€: ${altUrl}`);
                            break;
                        }
                    } catch (e) {
                        addResult(`âŒ ${altUrl} ä¸å¯ç”¨`);
                    }
                }
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºå½“å‰APIåœ°å€
        window.onload = function() {
            const apiUrl = getApiUrl();
            addResult(`ğŸŒ å½“å‰APIåœ°å€: ${apiUrl}`);
            addResult(`ğŸ“ é¡µé¢åœ°å€: ${window.location.href}`);
        };
    </script>
</body>
</html>