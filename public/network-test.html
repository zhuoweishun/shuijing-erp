<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½‘ç»œè¿æ¥æµ‹è¯• - æ°´æ™¶ERP</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .test-title {
            font-weight: bold;
            color: #555;
            margin-bottom: 10px;
        }
        .result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .loading {
            color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ ç½‘ç»œè¿æ¥è¯Šæ–­å·¥å…·</h1>
        
        <div class="test-section">
            <div class="test-title">1. ç¯å¢ƒä¿¡æ¯æ£€æµ‹</div>
            <button onclick="checkEnvironment()">æ£€æµ‹ç¯å¢ƒä¿¡æ¯</button>
            <div id="env-result" class="result"></div>
        </div>

        <div class="test-section">
            <div class="test-title">2. IPåœ°å€æ£€æµ‹</div>
            <button onclick="detectIP()">æ£€æµ‹æœ¬æœºIP</button>
            <button onclick="clearIPCache()">æ¸…é™¤IPç¼“å­˜</button>
            <div id="ip-result" class="result"></div>
        </div>

        <div class="test-section">
            <div class="test-title">3. APIåœ°å€æµ‹è¯•</div>
            <button onclick="testApiUrl()">æµ‹è¯•APIåœ°å€</button>
            <button onclick="testAllEndpoints()">æµ‹è¯•æ‰€æœ‰ç«¯ç‚¹</button>
            <div id="api-result" class="result"></div>
        </div>

        <div class="test-section">
            <div class="test-title">4. è¿æ¥æµ‹è¯•</div>
            <button onclick="testConnections()">æµ‹è¯•æ‰€æœ‰è¿æ¥</button>
            <div id="connection-result" class="result"></div>
        </div>

        <div class="test-section">
            <div class="test-title">5. ä¿®å¤å»ºè®®</div>
            <button onclick="showFixSuggestions()">è·å–ä¿®å¤å»ºè®®</button>
            <div id="fix-result" class="result"></div>
        </div>
    </div>

    <script>
        // åŠ¨æ€è·å–æœ¬æœºå±€åŸŸç½‘IPåœ°å€
        const getLocalNetworkIP = () => {
            return new Promise((resolve) => {
                try {
                    const pc = new RTCPeerConnection({ iceServers: [] })
                    pc.createDataChannel('')
                    
                    let resolved = false
                    
                    pc.onicecandidate = (event) => {
                        if (resolved) return
                        
                        if (event.candidate) {
                            const candidate = event.candidate.candidate
                            const ipMatch = candidate.match(/([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3})/)
                            if (ipMatch && ipMatch[1]) {
                                const ip = ipMatch[1]
                                if (ip.startsWith('192.168.') || ip.startsWith('10.') || 
                                    (ip.startsWith('172.') && parseInt(ip.split('.')[1]) >= 16 && parseInt(ip.split('.')[1]) <= 31)) {
                                    resolved = true
                                    pc.close()
                                    resolve(ip)
                                    return
                                }
                            }
                        }
                    }
                    
                    pc.createOffer().then(offer => pc.setLocalDescription(offer)).catch(() => {
                        if (!resolved) {
                            resolved = true
                            pc.close()
                            resolve(null)
                        }
                    })
                    
                    // ä½¿ç”¨æ›´å®‰å…¨çš„è¶…æ—¶å¤„ç†
                    if (typeof window !== 'undefined' && window.setTimeout) {
                        window.setTimeout(() => {
                            if (!resolved) {
                                resolved = true
                                pc.close()
                                resolve(null)
                            }
                        }, 3000)
                    } else {
                        // å¦‚æœsetTimeoutä¸å¯ç”¨ï¼Œä½¿ç”¨Promise.raceä½œä¸ºå¤‡é€‰
                        Promise.race([
                            new Promise(resolve => {
                                // ç®€å•çš„å»¶æ—¶å®ç°
                                let start = Date.now()
                                function check() {
                                    if (Date.now() - start > 3000) {
                                        resolve(null)
                                    } else {
                                        requestAnimationFrame(check)
                                    }
                                }
                                check()
                            })
                        ]).then(() => {
                            if (!resolved) {
                                resolved = true
                                pc.close()
                                resolve(null)
                            }
                        })
                    }
                } catch (error) {
                    console.error('IPæ£€æµ‹é”™è¯¯:', error)
                    resolve(null)
                }
            })
        }

        // è·å–APIåŸºç¡€URL
        const getApiUrl = () => {
            const hostname = window.location.hostname
            
            if (hostname.includes('dorblecapital.com')) {
                return 'https://api.dorblecapital.com/api/v1'
            }
            
            if (hostname.startsWith('192.168.') || hostname.startsWith('10.') || 
                (hostname.startsWith('172.') && parseInt(hostname.split('.')[1]) >= 16 && parseInt(hostname.split('.')[1]) <= 31)) {
                return `http://${hostname}:3001/api/v1`
            }
            
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return `http://localhost:3001/api/v1`
            }
            
            return `http://${hostname}:3001/api/v1`
        }

        // æ£€æµ‹ç¯å¢ƒä¿¡æ¯
        async function checkEnvironment() {
            const result = document.getElementById('env-result')
            result.className = 'result info'
            result.textContent = 'æ­£åœ¨æ£€æµ‹ç¯å¢ƒä¿¡æ¯...'
            
            try {
                const info = {
                    'å½“å‰URL': window.location.href,
                    'ä¸»æœºå': window.location.hostname,
                    'ç«¯å£': window.location.port || 'é»˜è®¤ç«¯å£',
                    'åè®®': window.location.protocol,
                    'ç”¨æˆ·ä»£ç†': navigator.userAgent,
                    'å¼€å‘æ¨¡å¼': window.location.hostname === 'localhost' ? 'æ˜¯' : 'å¦',
                    'æ—¶é—´æˆ³': new Date().toLocaleString()
                }
                
                let output = 'ç¯å¢ƒä¿¡æ¯æ£€æµ‹ç»“æœ:\n'
                for (const [key, value] of Object.entries(info)) {
                    output += `${key}: ${value}\n`
                }
                
                result.className = 'result success'
                result.textContent = output
            } catch (error) {
                result.className = 'result error'
                result.textContent = `ç¯å¢ƒæ£€æµ‹å¤±è´¥: ${error.message}`
            }
        }

        // æ£€æµ‹IPåœ°å€
        async function detectIP() {
            const result = document.getElementById('ip-result')
            result.className = 'result info'
            result.textContent = 'æ­£åœ¨æ£€æµ‹IPåœ°å€...'
            
            try {
                const cachedIP = localStorage.getItem('cached_local_ip')
                const detectedIP = await getLocalNetworkIP()
                
                let output = 'IPåœ°å€æ£€æµ‹ç»“æœ:\n'
                output += `å½“å‰ä¸»æœºå: ${window.location.hostname}\n`
                output += `ç¼“å­˜çš„IP: ${cachedIP || 'æ— '}\n`
                output += `æ£€æµ‹åˆ°çš„IP: ${detectedIP || 'æ— æ³•æ£€æµ‹'}\n`
                
                if (detectedIP) {
                    localStorage.setItem('cached_local_ip', detectedIP)
                    output += `å·²æ›´æ–°ç¼“å­˜IP: ${detectedIP}\n`
                }
                
                result.className = 'result success'
                result.textContent = output
            } catch (error) {
                result.className = 'result error'
                result.textContent = `IPæ£€æµ‹å¤±è´¥: ${error.message}`
            }
        }

        // æ¸…é™¤IPç¼“å­˜
        function clearIPCache() {
            const result = document.getElementById('ip-result')
            localStorage.removeItem('cached_local_ip')
            result.className = 'result warning'
            result.textContent = 'IPç¼“å­˜å·²æ¸…é™¤ï¼Œè¯·é‡æ–°æ£€æµ‹IPåœ°å€'
        }

        // æµ‹è¯•APIåœ°å€
        async function testApiUrl() {
            const result = document.getElementById('api-result')
            result.className = 'result info'
            result.textContent = 'æ­£åœ¨æµ‹è¯•APIåœ°å€...'
            
            try {
                const apiUrl = getApiUrl()
                let output = 'APIåœ°å€æµ‹è¯•ç»“æœ:\n'
                output += `è®¡ç®—å‡ºçš„APIåœ°å€: ${apiUrl}\n`
                
                // æµ‹è¯•å¥åº·æ£€æŸ¥ç«¯ç‚¹
                const healthUrl = `${apiUrl}/health`
                output += `\næµ‹è¯•å¥åº·æ£€æŸ¥ç«¯ç‚¹: ${healthUrl}\n`
                
                const response = await fetch(healthUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                
                if (response.ok) {
                    const data = await response.json()
                    output += `âœ… å¥åº·æ£€æŸ¥æˆåŠŸ\n`
                    output += `å“åº”çŠ¶æ€: ${response.status}\n`
                    output += `å“åº”æ•°æ®: ${JSON.stringify(data, null, 2)}\n`
                    result.className = 'result success'
                } else {
                    output += `âŒ å¥åº·æ£€æŸ¥å¤±è´¥\n`
                    output += `å“åº”çŠ¶æ€: ${response.status}\n`
                    output += `å“åº”æ–‡æœ¬: ${await response.text()}\n`
                    result.className = 'result error'
                }
                
                result.textContent = output
            } catch (error) {
                result.className = 'result error'
                result.textContent = `APIæµ‹è¯•å¤±è´¥: ${error.message}`
            }
        }

        // æµ‹è¯•æ‰€æœ‰ç«¯ç‚¹
        async function testAllEndpoints() {
            const result = document.getElementById('api-result')
            result.className = 'result info'
            result.textContent = 'æ­£åœ¨æµ‹è¯•æ‰€æœ‰ç«¯ç‚¹...'
            
            const apiUrl = getApiUrl()
            const endpoints = [
                '/health',
                '/auth/verify',
                '/financial/overview/summary'
            ]
            
            let output = 'ç«¯ç‚¹æµ‹è¯•ç»“æœ:\n'
            output += `åŸºç¡€APIåœ°å€: ${apiUrl}\n\n`
            
            for (const endpoint of endpoints) {
                const fullUrl = `${apiUrl}${endpoint}`
                output += `æµ‹è¯•: ${fullUrl}\n`
                
                try {
                    const response = await fetch(fullUrl, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('auth_token') || 'no-token'}`
                        }
                    })
                    
                    output += `çŠ¶æ€: ${response.status} ${response.statusText}\n`
                    
                    if (response.ok) {
                        output += `âœ… æˆåŠŸ\n`
                    } else {
                        output += `âŒ å¤±è´¥\n`
                    }
                } catch (error) {
                    output += `âŒ ç½‘ç»œé”™è¯¯: ${error.message}\n`
                }
                
                output += '\n'
            }
            
            result.className = 'result info'
            result.textContent = output
        }

        // æµ‹è¯•æ‰€æœ‰è¿æ¥
        async function testConnections() {
            const result = document.getElementById('connection-result')
            result.className = 'result info'
            result.textContent = 'æ­£åœ¨æµ‹è¯•æ‰€æœ‰è¿æ¥...'
            
            let output = 'è¿æ¥æµ‹è¯•ç»“æœ:\n'
            
            // æµ‹è¯•ä¸åŒçš„APIåœ°å€
            const testUrls = [
                'http://localhost:3001/api/v1/health',
                'http://127.0.0.1:3001/api/v1/health'
            ]
            
            // æ·»åŠ å±€åŸŸç½‘IPæµ‹è¯•
            const cachedIP = localStorage.getItem('cached_local_ip')
            if (cachedIP) {
                testUrls.push(`http://${cachedIP}:3001/api/v1/health`)
            }
            
            // æ·»åŠ å½“å‰ä¸»æœºåæµ‹è¯•
            const hostname = window.location.hostname
            if (hostname !== 'localhost' && hostname !== '127.0.0.1') {
                testUrls.push(`http://${hostname}:3001/api/v1/health`)
            }
            
            for (const url of testUrls) {
                output += `æµ‹è¯•è¿æ¥: ${url}\n`
                
                try {
                    const startTime = Date.now()
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    })
                    const endTime = Date.now()
                    
                    if (response.ok) {
                        output += `âœ… è¿æ¥æˆåŠŸ (${endTime - startTime}ms)\n`
                    } else {
                        output += `âŒ è¿æ¥å¤±è´¥: ${response.status}\n`
                    }
                } catch (error) {
                    output += `âŒ è¿æ¥é”™è¯¯: ${error.message}\n`
                }
                
                output += '\n'
            }
            
            result.className = 'result info'
            result.textContent = output
        }

        // æ˜¾ç¤ºä¿®å¤å»ºè®®
        function showFixSuggestions() {
            const result = document.getElementById('fix-result')
            
            const suggestions = `ä¿®å¤å»ºè®®:

1. æ£€æŸ¥åç«¯æœåŠ¡çŠ¶æ€:
   - ç¡®è®¤åç«¯æœåŠ¡åœ¨3001ç«¯å£è¿è¡Œ
   - æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
   - ç¡®è®¤CORSé…ç½®æ­£ç¡®

2. IPåœ°å€é—®é¢˜:
   - æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
   - é‡æ–°æ£€æµ‹æœ¬æœºIPåœ°å€
   - æ£€æŸ¥ç½‘ç»œé…ç½®

3. å‰ç«¯é…ç½®:
   - æ£€æŸ¥getApiUrlå‡½æ•°é€»è¾‘
   - éªŒè¯ç¯å¢ƒå˜é‡è®¾ç½®
   - æ¸…é™¤localStorageç¼“å­˜

4. ç½‘ç»œè¿æ¥:
   - å°è¯•ä¸åŒçš„IPåœ°å€
   - æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
   - æµ‹è¯•ç½‘ç»œè¿é€šæ€§

5. å¼€å‘ç¯å¢ƒ:
   - é‡å¯å‰ç«¯å¼€å‘æœåŠ¡å™¨
   - é‡å¯åç«¯æœåŠ¡å™¨
   - æ£€æŸ¥ä¾èµ–åŒ…ç‰ˆæœ¬

å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œè¯·è”ç³»æŠ€æœ¯æ”¯æŒã€‚`
            
            result.className = 'result warning'
            result.textContent = suggestions
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æµ‹ç¯å¢ƒ
        window.addEventListener('load', () => {
            console.log('ğŸŒ ç½‘ç»œè¯Šæ–­å·¥å…·å·²åŠ è½½')
            checkEnvironment()
        })
    </script>
</body>
</html>