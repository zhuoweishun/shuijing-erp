# æ–‡æ¡£ 13ï¼šåŸææ–™åº“å­˜ä¿®å¤æ€»ç»“æ–‡æ¡£

## ä¸€ã€ä¿®å¤æ¦‚è¿°

æœ¬æ–‡æ¡£æ€»ç»“äº†åŸææ–™åº“å­˜æŸ¥è¯¢æ¿å—çš„å®Œæ•´ä¿®å¤æˆæœï¼Œé‡ç‚¹å…³æ³¨purchaseåˆ°materialçš„æ˜ å°„å…³ç³»ã€å­—æ®µè§„èŒƒã€åŠæˆå“åº“å­˜ã€é…ä»¶åº“å­˜ã€æˆå“åŸææ–™åº“å­˜ç­‰æ ¸å¿ƒåŠŸèƒ½çš„å®ç°å’Œä¼˜åŒ–ã€‚

**ä¿®å¤æ—¶é—´ï¼š** 2025å¹´1æœˆ16æ—¥  
**ä¿®å¤èŒƒå›´ï¼š** åŸææ–™åº“å­˜æŸ¥è¯¢ç³»ç»ŸåŠç›¸å…³ç»„ä»¶  
**ä¸»è¦æˆæœï¼š** å®ç°äº†å®Œæ•´çš„purchaseåˆ°materialæ˜ å°„æœºåˆ¶ã€æ•°æ®ç±»å‹å®‰å…¨å¤„ç†ã€å±‚çº§å¼åº“å­˜å±•ç¤º

## äºŒã€æ ¸å¿ƒä¿®å¤æˆæœ

### 2.1 purchaseåˆ°materialæ˜ å°„æœºåˆ¶ï¼ˆæ ¸å¿ƒé‡ç‚¹ï¼‰

**å®ç°åŠŸèƒ½ï¼š**
- âœ… **å­—æ®µæ˜ å°„å‡½æ•°**ï¼šmapPurchaseToMaterialå‡½æ•°å®ç°è‡ªåŠ¨å­—æ®µè½¬æ¢
- âœ… **é€’å½’å¤„ç†**ï¼šæ”¯æŒåµŒå¥—å¯¹è±¡å’Œæ•°ç»„çš„æ·±åº¦æ˜ å°„
- âœ… **Dateå¯¹è±¡ä¿æŠ¤**ï¼šç‰¹æ®Šå¤„ç†Dateå¯¹è±¡ï¼Œé¿å…è¢«å½“ä½œæ™®é€šå¯¹è±¡å¤„ç†
- âœ… **åº“å­˜å¢å¼º**ï¼šè‡ªåŠ¨æ·»åŠ inventory_unitã€usage_rateã€stock_statusç­‰åº“å­˜ç‰¹æœ‰å­—æ®µ
- âœ… **å‰ç«¯å…¼å®¹**ï¼šå‰ç«¯ç»„ä»¶å…¼å®¹æ˜ å°„å‰åçš„å­—æ®µå

**æŠ€æœ¯å®ç°ï¼š**
```typescript
// æ ¸å¿ƒæ˜ å°„é€»è¾‘
const mapPurchaseToMaterial = (data: any): any => {
  if (Array.isArray(data)) {
    return data.map(mapPurchaseToMaterial)
  }
  
  if (data instanceof Date) {
    return data // ä¿æŠ¤Dateå¯¹è±¡
  }
  
  if (data && typeof data === 'object') {
    const mapped: any = {}
    
    for (const [key, value] of Object.entries(data)) {
      // å­—æ®µæ˜ å°„è§„åˆ™
      let newKey = key
      if (key === 'purchase_name') newKey = 'material_name'
      else if (key === 'purchase_type') newKey = 'material_type'
      else if (key === 'purchase_code') newKey = 'material_code'
      else if (key === 'purchase_id') newKey = 'material_id'
      else if (key === 'purchase_date') newKey = 'material_date'
      
      mapped[newKey] = mapPurchaseToMaterial(value)
    }
    
    // æ·»åŠ åº“å­˜ç‰¹æœ‰å­—æ®µ
    if (mapped.material_type && mapped.original_quantity !== undefined) {
      mapped.inventory_unit = getUnit(mapped.material_type)
      mapped.usage_rate = Math.round((mapped.used_quantity / mapped.original_quantity) * 100)
      mapped.remaining_rate = 100 - mapped.usage_rate
      
      if (mapped.remaining_quantity <= 0) {
        mapped.stock_status = 'out'
      } else if (mapped.min_stock_alert && mapped.remaining_quantity <= mapped.min_stock_alert) {
        mapped.stock_status = 'low'
      } else {
        mapped.stock_status = 'sufficient'
      }
    }
    
    return mapped
  }
  
  return data
}
```

**å­—æ®µæ˜ å°„è§„åˆ™ï¼š**
| åŸå­—æ®µåï¼ˆpurchaseï¼‰ | æ˜ å°„å­—æ®µåï¼ˆmaterialï¼‰ | ä¸šåŠ¡å«ä¹‰ |
|---------------------|----------------------|----------|
| purchase_name | material_name | äº§å“åç§° |
| purchase_type | material_type | äº§å“ç±»å‹ |
| purchase_code | material_code | äº§å“ç¼–å· |
| purchase_id | material_id | äº§å“ID |
| purchase_date | material_date | é‡‡è´­æ—¥æœŸ |

### 2.2 å±‚çº§å¼åº“å­˜æŸ¥è¯¢ç³»ç»Ÿ

**å®ç°åŠŸèƒ½ï¼š**
- âœ… **å››çº§å±‚çº§ç»“æ„**ï¼šäº§å“ç±»å‹â†’è§„æ ¼â†’å“ç›¸â†’æ‰¹æ¬¡çš„å®Œæ•´å±‚çº§
- âœ… **ç»Ÿä¸€APIæ¥å£**ï¼šGET /inventory/hierarchicalæ”¯æŒæ‰€æœ‰åº“å­˜ç±»å‹æŸ¥è¯¢
- âœ… **å¤šç»´åº¦ç­›é€‰**ï¼šæ”¯æŒç±»å‹ã€å“è´¨ã€è§„æ ¼èŒƒå›´ã€ä½åº“å­˜ç­‰ç­›é€‰æ¡ä»¶
- âœ… **æƒé™æ§åˆ¶**ï¼šEMPLOYEEè§’è‰²è‡ªåŠ¨è¿‡æ»¤ä»·æ ¼æ•æ„Ÿä¿¡æ¯
- âœ… **åˆ†é¡µæ”¯æŒ**ï¼šæ”¯æŒå¤§æ•°æ®é‡çš„åˆ†é¡µæŸ¥è¯¢

**APIæ¥å£è§„èŒƒï¼š**
```typescript
// è¯·æ±‚å‚æ•°
interface InventoryQueryParams {
  page?: number
  limit?: number
  search?: string
  material_types?: string[] // åŸææ–™ç±»å‹ç­›é€‰
  quality?: 'AA' | 'A' | 'AB' | 'B' | 'C'
  low_stock_only?: boolean
  diameter_min?: number
  diameter_max?: number
  specification_min?: number
  specification_max?: number
  sort?: 'asc' | 'desc'
  sort_by?: string
}

// å“åº”æ•°æ®ç»“æ„
interface HierarchicalInventoryResponse {
  success: boolean
  data: {
    hierarchy: MaterialTypeGroup[]
    pagination: PaginationInfo
  }
}
```

### 2.3 åŠæˆå“åº“å­˜çŸ©é˜µè§†å›¾

**å®ç°åŠŸèƒ½ï¼š**
- âœ… **çŸ©é˜µå±•ç¤º**ï¼šäº§å“åç§° Ã— ç å¾„è§„æ ¼ Ã— å“ç›¸çš„ä¸‰ç»´çŸ©é˜µ
- âœ… **è§†å›¾åˆ‡æ¢**ï¼šæ”¯æŒæŒ‰å°ºå¯¸å’ŒæŒ‰å“ç›¸ä¸¤ç§è§†å›¾æ¨¡å¼
- âœ… **åº“å­˜çŠ¶æ€**ï¼šé¢œè‰²ç¼–ç æ˜¾ç¤ºåº“å­˜å……è¶³/ä½åº“å­˜/ç¼ºè´§çŠ¶æ€
- âœ… **æ‹¼éŸ³æ’åº**ï¼šäº§å“åç§°æŒ‰æ‹¼éŸ³é¦–å­—æ¯æ’åº
- âœ… **ç­›é€‰åŠŸèƒ½**ï¼šæ”¯æŒäº§å“åç§°æœç´¢å’Œå¤šé€‰ç­›é€‰

**æŠ€æœ¯ç‰¹ç‚¹ï¼š**
```typescript
// çŸ©é˜µæ•°æ®ç»“æ„
interface SemiFinishedMatrixData {
  material_type: string // ç»Ÿä¸€ä½¿ç”¨material_type
  total_quantity: number
  total_variants: number
  has_low_stock: boolean
  specifications: SpecificationData[]
}

// åº“å­˜çŠ¶æ€é¢œè‰²ç¼–ç 
const get_stock_status_color = (quantity: number, is_low_stock: boolean) => {
  if (is_low_stock || quantity <= 50) {
    return 'bg-red-100 border-red-200 text-red-800'
  } else if (quantity <= 200) {
    return 'bg-yellow-100 border-yellow-200 text-yellow-800'
  } else {
    return 'bg-green-100 border-green-200 text-green-800'
  }
}
```

### 2.4 é…ä»¶åº“å­˜å¡ç‰‡å±•ç¤º

**å®ç°åŠŸèƒ½ï¼š**
- âœ… **å¡ç‰‡ç½‘æ ¼å¸ƒå±€**ï¼šæ¯ä¸ªé…ä»¶ä¸€å¼ å¡ç‰‡ï¼Œæ˜¾ç¤ºå›¾ç‰‡ã€è§„æ ¼ã€åº“å­˜
- âœ… **æ•°æ®æå–ä¼˜åŒ–**ï¼šä»å±‚çº§æ•°æ®ä¸­æ­£ç¡®æå–é…ä»¶ä¿¡æ¯
- âœ… **å­—æ®µæ˜ å°„å…¼å®¹**ï¼šå…¼å®¹purchase_codeå’Œmaterial_codeå­—æ®µ
- âœ… **æ‹¼éŸ³æ’åº**ï¼šé…ä»¶æŒ‰äº§å“åç§°æ‹¼éŸ³æ’åº
- âœ… **åº“å­˜é¢„è­¦**ï¼šä½åº“å­˜é…ä»¶ç‰¹æ®Šæ ‡è¯†

**æ•°æ®æå–é€»è¾‘ï¼š**
```typescript
// ä»å±‚çº§æ•°æ®ä¸­æå–é…ä»¶äº§å“
const extract_accessory_products = (hierarchy_data: any[]): AccessoryProduct[] => {
  const products: AccessoryProduct[] = []
  
  hierarchy_data.forEach((type_group) => {
    if (type_group.material_type === 'ACCESSORIES' || type_group.purchase_type === 'ACCESSORIES') {
      type_group.specifications?.forEach((spec_group: any) => {
        spec_group.qualities?.forEach((quality_group: any) => {
          if (quality_group.batches && quality_group.batches.length > 0) {
            quality_group.batches.forEach((batch: any) => {
              // å­—æ®µæ˜ å°„å…¼å®¹å¤„ç†
              const purchase_code = batch.material_code || batch.purchase_code || ''
              const remaining_qty = Number(batch.remaining_quantity) || 0
              const price_unit = Number(batch.price_per_unit) || 0
              
              products.push({
                purchase_id: batch.purchase_id,
                purchase_code: purchase_code,
                purchase_name: batch.material_name || batch.purchase_name,
                remaining_quantity: remaining_qty,
                price_per_unit: price_unit,
                // ... å…¶ä»–å­—æ®µ
              })
            })
          }
        })
      })
    }
  })
  
  // åº”ç”¨æ‹¼éŸ³æ’åº
  return sort_by_pinyin(products)
}
```

### 2.5 æˆå“åŸææ–™åº“å­˜å±•ç¤º

**å®ç°åŠŸèƒ½ï¼š**
- âœ… **æˆå“å¡ç‰‡å±•ç¤º**ï¼šæ˜¾ç¤ºæˆå“çš„å®Œæ•´ä¿¡æ¯ï¼ŒåŒ…æ‹¬è§„æ ¼ã€ä»·æ ¼ã€åº“å­˜
- âœ… **ä»·æ ¼æƒé™æ§åˆ¶**ï¼šBOSSè§’è‰²å¯æŸ¥çœ‹å•ä»·å’Œæ€»ä»·ï¼ŒEMPLOYEEè§’è‰²éšè—
- âœ… **åº“å­˜çŠ¶æ€ç­›é€‰**ï¼šæ”¯æŒä½åº“å­˜ç­›é€‰å’Œé¢„è­¦
- âœ… **æ•°æ®ç±»å‹å®‰å…¨**ï¼šæ‰€æœ‰æ•°å€¼å­—æ®µè¿›è¡Œç±»å‹è½¬æ¢ä¿æŠ¤
- âœ… **å›¾ç‰‡å±•ç¤º**ï¼šæ”¯æŒå¤šå›¾ç‰‡è½®æ’­æ˜¾ç¤º

**æƒé™æ§åˆ¶å®ç°ï¼š**
```typescript
// æƒé™æ§åˆ¶æ˜¾ç¤º
const render_price_info = (product: FinishedProduct, user_role: string) => {
  if (user_role !== 'BOSS') {
    return null // EMPLOYEEè§’è‰²ä¸æ˜¾ç¤ºä»·æ ¼
  }
  
  return (
    <div className="price-info">
      <span className="unit-price">Â¥{Number(product.price_per_unit || 0).toFixed(2)}</span>
      <span className="total-price">æ€»ä»·: Â¥{Number(product.total_price || 0).toFixed(2)}</span>
    </div>
  )
}
```

### 2.6 æ•°æ®ç±»å‹å®‰å…¨å¤„ç†ï¼ˆé‡è¦ä¿®å¤ï¼‰

**é—®é¢˜èƒŒæ™¯ï¼š**
- åº“å­˜æ¶ˆè€—åˆ†ææ˜¾ç¤º"161"è€Œä¸æ˜¯"17"
- åç«¯reduceè®¡ç®—æ—¶å‘ç”Ÿå­—ç¬¦ä¸²æ‹¼æ¥ï¼š"16" + "1" = "161"
- å‰ç«¯æœªå¯¹APIè¿”å›æ•°æ®è¿›è¡Œç±»å‹éªŒè¯

**è§£å†³æ–¹æ¡ˆï¼š**
```typescript
// åç«¯ï¼šå¼ºåˆ¶æ•°å­—ç±»å‹è½¬æ¢
const totalConsumption = convertedData.reduce((sum, item) => {
  return sum + Number(item.total_consumed) // å…³é”®ä¿®å¤ç‚¹
}, 0)

// å‰ç«¯ï¼šé˜²æŠ¤æ€§ç±»å‹è½¬æ¢
const displayValue = Number(data.total_consumption).toLocaleString()

// æ•°å€¼å­—æ®µå®‰å…¨å¤„ç†å‡½æ•°
const safe_number_conversion = (value: any): number => {
  if (value === null || value === undefined) return 0
  const num = Number(value)
  return isNaN(num) ? 0 : num
}
```

**ä¿®å¤æ•ˆæœï¼š**
- âœ… åº“å­˜æ¶ˆè€—åˆ†ææ˜¾ç¤ºæ­£ç¡®æ•°å€¼
- âœ… æ‰€æœ‰åº“å­˜æ•°é‡å­—æ®µæ˜¾ç¤ºæ­£ç¡®
- âœ… ä»·æ ¼è®¡ç®—å‡†ç¡®æ— è¯¯
- âœ… å‰åç«¯æ•°æ®ç±»å‹ä¸€è‡´

## ä¸‰ã€æ•°æ®åº“å±‚é¢ä¼˜åŒ–

### 3.1 åº“å­˜æŸ¥è¯¢SQLä¼˜åŒ–

**æ ¸å¿ƒæŸ¥è¯¢é€»è¾‘ï¼š**
```sql
-- åº“å­˜æŸ¥è¯¢ä¸­çš„å­—æ®µæ˜ å°„å’Œè®¡ç®—
SELECT 
  p.id as purchase_id,
  p.purchase_code as purchase_code,  -- æ˜ å°„ä¸ºmaterial_code
  p.purchase_name as purchase_name,  -- æ˜ å°„ä¸ºmaterial_name
  p.purchase_type as purchase_type,  -- æ˜ å°„ä¸ºmaterial_type
  p.purchase_date as purchase_date,  -- æ˜ å°„ä¸ºmaterial_date
  CASE 
    WHEN p.purchase_type = 'LOOSE_BEADS' THEN COALESCE(p.piece_count, 0)
    WHEN p.purchase_type = 'BRACELET' THEN COALESCE(p.total_beads, p.piece_count, 0)
    WHEN p.purchase_type = 'ACCESSORIES' THEN COALESCE(p.piece_count, 0)
    WHEN p.purchase_type = 'FINISHED_MATERIAL' THEN COALESCE(p.piece_count, 0)
    ELSE COALESCE(p.quantity, 0)
  END as original_quantity,
  COALESCE(mu.used_quantity, 0) as used_quantity,
  (CASE 
    WHEN p.purchase_type = 'LOOSE_BEADS' THEN COALESCE(p.piece_count, 0)
    WHEN p.purchase_type = 'BRACELET' THEN COALESCE(p.total_beads, p.piece_count, 0)
    WHEN p.purchase_type = 'ACCESSORIES' THEN COALESCE(p.piece_count, 0)
    WHEN p.purchase_type = 'FINISHED_MATERIAL' THEN COALESCE(p.piece_count, 0)
    ELSE COALESCE(p.quantity, 0)
  END - COALESCE(mu.used_quantity, 0)) as remaining_quantity
FROM purchases p
LEFT JOIN (
  SELECT purchase_id, SUM(quantity_used) as used_quantity
  FROM material_usage
  GROUP BY purchase_id
) mu ON p.id = mu.purchase_id
```

### 3.2 åº“å­˜æŸ¥è¯¢ä¼˜åŒ–ç´¢å¼•

**ä¸“ç”¨ç´¢å¼•åˆ›å»ºï¼š**
```sql
-- åº“å­˜æœç´¢ä¼˜åŒ–ç´¢å¼•
CREATE INDEX idx_inventory_search ON purchases(purchase_name, purchase_code);

-- åº“å­˜ç­›é€‰ä¼˜åŒ–ç´¢å¼•
CREATE INDEX idx_inventory_filter ON purchases(purchase_type, quality, purchase_date);

-- ä¾›åº”å•†ç­›é€‰ç´¢å¼•
CREATE INDEX idx_inventory_supplier ON purchases(supplier_id);

-- ä»·æ ¼èŒƒå›´ç­›é€‰ç´¢å¼•
CREATE INDEX idx_inventory_price_range ON purchases(price_per_gram, total_price);

-- è§„æ ¼èŒƒå›´ç­›é€‰ç´¢å¼•
CREATE INDEX idx_inventory_spec_range ON purchases(bead_diameter, specification);

-- åº“å­˜æ’åºä¼˜åŒ–ç´¢å¼•
CREATE INDEX idx_inventory_sort ON purchases(purchase_date DESC, created_at DESC);

-- material_usageè¡¨ä¼˜åŒ–ç´¢å¼•
CREATE INDEX idx_material_usage_summary ON material_usage(purchase_id, quantity_used);
```

### 3.3 æ•°æ®ç±»å‹å®‰å…¨SQLå¤„ç†

**ç±»å‹è½¬æ¢è§„èŒƒï¼š**
```sql
-- ç¡®ä¿è¿”å›æ•°å­—ç±»å‹ï¼Œé¿å…å­—ç¬¦ä¸²æ‹¼æ¥é—®é¢˜
CAST(COALESCE(SUM(mu.quantity_used_beads), 0) + COALESCE(SUM(mu.quantity_used_pieces), 0) AS UNSIGNED) as total_consumed

-- ä»·æ ¼å­—æ®µå¤„ç†
CAST(p.price_per_gram AS DECIMAL(10,2)) as price_per_gram,
CAST(p.total_price AS DECIMAL(12,2)) as total_price
```

## å››ã€å‰ç«¯ç»„ä»¶æ¶æ„ä¼˜åŒ–

### 4.1 ç»„ä»¶å±‚æ¬¡ç»“æ„

**åº“å­˜é¡µé¢ç»„ä»¶æ¶æ„ï¼š**
```
InventoryList.tsx (ä¸»é¡µé¢)
â”œâ”€â”€ è§†å›¾æ¨¡å¼åˆ‡æ¢ (å…¨éƒ¨/åŠæˆå“/é…ä»¶/æˆå“)
â”œâ”€â”€ SemiFinishedMatrixView.tsx (åŠæˆå“çŸ©é˜µè§†å›¾)
â”œâ”€â”€ AccessoriesProductGrid.tsx (é…ä»¶å¡ç‰‡ç½‘æ ¼)
â”œâ”€â”€ FinishedProductGrid.tsx (æˆå“å¡ç‰‡ç½‘æ ¼)
â””â”€â”€ MaterialStockInfo.tsx (åº“å­˜ä¿¡æ¯ç»„ä»¶)
```

### 4.2 æ•°æ®æµå¤„ç†

**æ•°æ®æµå‘ï¼š**
```mermaid
flowchart TD
    A[InventoryList] --> B[è°ƒç”¨inventory_api.list_hierarchical]
    B --> C[åç«¯mapPurchaseToMaterialæ˜ å°„]
    C --> D[è¿”å›å±‚çº§æ•°æ®]
    D --> E[å‰ç«¯ç»„ä»¶æå–å¯¹åº”ç±»å‹æ•°æ®]
    E --> F[åº”ç”¨æ‹¼éŸ³æ’åº]
    F --> G[æ¸²æŸ“å¯¹åº”è§†å›¾ç»„ä»¶]
```

### 4.3 ç±»å‹å®šä¹‰è§„èŒƒ

**ç»Ÿä¸€ç±»å‹æ¥å£ï¼š**
```typescript
// åŠæˆå“åº“å­˜ç±»å‹
interface SemiFinishedMatrixData {
  material_type: string // ç»Ÿä¸€ä½¿ç”¨material_type
  total_quantity: number
  total_variants: number
  has_low_stock: boolean
  specifications: SpecificationData[]
}

// é…ä»¶åº“å­˜ç±»å‹
interface AccessoryProduct {
  purchase_id: string
  purchase_code?: string // å…¼å®¹æ˜ å°„å‰åçš„å­—æ®µ
  purchase_name: string
  specification?: number
  remaining_quantity: number
  is_low_stock: boolean
}

// æˆå“åŸææ–™ç±»å‹
interface FinishedProduct {
  purchase_id: string
  purchase_code?: string // å…¼å®¹æ˜ å°„å‰åçš„å­—æ®µ
  purchase_name: string
  specification: number
  piece_count: number
  quality?: 'AA' | 'A' | 'AB' | 'B' | 'C'
  remaining_quantity: number
  is_low_stock: boolean
}
```

## äº”ã€æ€§èƒ½ä¼˜åŒ–æˆæœ

### 5.1 æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–

**ä¼˜åŒ–æˆæœï¼š**
- âœ… **ç´¢å¼•ä¼˜åŒ–**ï¼šé’ˆå¯¹åº“å­˜æŸ¥è¯¢åœºæ™¯å»ºç«‹ä¸“ç”¨ç´¢å¼•
- âœ… **SQLä¼˜åŒ–**ï¼šä½¿ç”¨CASEè¯­å¥ä¼˜åŒ–æ•°é‡è®¡ç®—é€»è¾‘
- âœ… **åˆ†é¡µæŸ¥è¯¢**ï¼šæ”¯æŒå¤§æ•°æ®é‡çš„é«˜æ•ˆåˆ†é¡µ
- âœ… **ç¼“å­˜æœºåˆ¶**ï¼šå‰ç«¯ç»„ä»¶çº§åˆ«çš„æ•°æ®ç¼“å­˜

**æ€§èƒ½æŒ‡æ ‡ï¼š**
- åº“å­˜æŸ¥è¯¢å“åº”æ—¶é—´ï¼š< 500ms
- å±‚çº§æ•°æ®æ„å»ºæ—¶é—´ï¼š< 200ms
- å‰ç«¯æ¸²æŸ“æ—¶é—´ï¼š< 100ms
- æ”¯æŒæ•°æ®é‡ï¼š1000+æ¡åº“å­˜è®°å½•

### 5.2 å†…å­˜ä½¿ç”¨ä¼˜åŒ–

**ä¼˜åŒ–æªæ–½ï¼š**
- æŒ‰éœ€åŠ è½½ï¼šåªåŠ è½½å½“å‰è§†å›¾éœ€è¦çš„æ•°æ®
- æ•°æ®å¤ç”¨ï¼šå¤šä¸ªç»„ä»¶å…±äº«åŒä¸€ä»½å±‚çº§æ•°æ®
- åƒåœ¾å›æ”¶ï¼šåŠæ—¶æ¸…ç†ä¸éœ€è¦çš„æ•°æ®å¼•ç”¨
- è™šæ‹Ÿæ»šåŠ¨ï¼šå¤§é‡æ•°æ®æ—¶ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨

## å…­ã€ç”¨æˆ·ä½“éªŒä¼˜åŒ–

### 6.1 è§†è§‰ä½“éªŒä¼˜åŒ–

**ä¼˜åŒ–æˆæœï¼š**
- âœ… **åº“å­˜çŠ¶æ€å¯è§†åŒ–**ï¼šé¢œè‰²ç¼–ç æ¸…æ™°æ˜¾ç¤ºåº“å­˜çŠ¶æ€
- âœ… **å“åº”å¼è®¾è®¡**ï¼šé€‚é…æ¡Œé¢ç«¯å’Œç§»åŠ¨ç«¯
- âœ… **åŠ è½½çŠ¶æ€**ï¼šæ˜¾ç¤ºåŠ è½½åŠ¨ç”»å’Œéª¨æ¶å±
- âœ… **é”™è¯¯å¤„ç†**ï¼šå‹å¥½çš„é”™è¯¯æç¤ºå’Œé‡è¯•æœºåˆ¶

### 6.2 äº¤äº’ä½“éªŒä¼˜åŒ–

**ä¼˜åŒ–æˆæœï¼š**
- âœ… **è§†å›¾åˆ‡æ¢**ï¼šæµç•…çš„è§†å›¾æ¨¡å¼åˆ‡æ¢
- âœ… **ç­›é€‰åŠŸèƒ½**ï¼šç›´è§‚çš„ç­›é€‰æ¡ä»¶è®¾ç½®
- âœ… **æ’åºåŠŸèƒ½**ï¼šæ”¯æŒæ‹¼éŸ³æ’åºå’Œæ•°å€¼æ’åº
- âœ… **æœç´¢åŠŸèƒ½**ï¼šå®æ—¶æœç´¢å’Œé«˜äº®æ˜¾ç¤º

## ä¸ƒã€æƒé™æ§åˆ¶å®ç°

### 7.1 æ•°æ®æƒé™æ§åˆ¶

**æƒé™è§„åˆ™ï¼š**
- **BOSSè§’è‰²**ï¼šå¯æŸ¥çœ‹æ‰€æœ‰ä¿¡æ¯ï¼ŒåŒ…æ‹¬ä»·æ ¼ã€æˆæœ¬ã€ä¾›åº”å•†ç­‰
- **EMPLOYEEè§’è‰²**ï¼šéšè—ä»·æ ¼æ•æ„Ÿä¿¡æ¯ï¼Œåªèƒ½æŸ¥çœ‹åº“å­˜æ•°é‡å’ŒåŸºæœ¬ä¿¡æ¯

**å®ç°æœºåˆ¶ï¼š**
```typescript
// åç«¯æƒé™è¿‡æ»¤
const filterInventoryData = (inventory: any[], userRole: string) => {
  if (userRole === 'BOSS') {
    return inventory
  }
  
  // é›‡å‘˜ä¸èƒ½æŸ¥çœ‹æˆæœ¬ç›¸å…³ä¿¡æ¯
  return inventory.map(item => ({
    ...item,
    price_per_bead: null,
    price_per_gram: null,
    supplier_name: null
  }))
}

// å‰ç«¯æƒé™æ§åˆ¶
const { user } = useAuth()
const should_show_price = user?.role === 'BOSS'
```

### 7.2 æ“ä½œæƒé™æ§åˆ¶

**æƒé™çŸ©é˜µï¼š**
| æ“ä½œ | BOSS | EMPLOYEE |
|------|------|----------|
| æŸ¥çœ‹åº“å­˜åˆ—è¡¨ | âœ… | âœ… |
| æŸ¥çœ‹åº“å­˜è¯¦æƒ… | âœ… | âœ… |
| æŸ¥çœ‹ä»·æ ¼ä¿¡æ¯ | âœ… | âŒ |
| æŸ¥çœ‹ä¾›åº”å•†ä¿¡æ¯ | âœ… | âŒ |
| å¯¼å‡ºåº“å­˜æ•°æ® | âœ… | âŒ |
| åº“å­˜è°ƒæ•´æ“ä½œ | âœ… | âŒ |

## å…«ã€é”™è¯¯å¤„ç†å’Œè°ƒè¯•

### 8.1 å¸¸è§é—®é¢˜è§£å†³

**å­—æ®µæ˜ å°„é—®é¢˜ï¼š**
- **é—®é¢˜**ï¼šå‰ç«¯è®¿é—®purchase_codeå­—æ®µæŠ¥é”™
- **åŸå› **ï¼šåç«¯å·²æ˜ å°„ä¸ºmaterial_code
- **è§£å†³**ï¼šå‰ç«¯å…¼å®¹å¤„ç†ï¼Œä¼˜å…ˆä½¿ç”¨mappedå­—æ®µ

**æ•°æ®ç±»å‹é—®é¢˜ï¼š**
- **é—®é¢˜**ï¼šæ•°å€¼æ˜¾ç¤ºä¸ºå­—ç¬¦ä¸²æ‹¼æ¥ç»“æœ
- **åŸå› **ï¼šåç«¯è®¡ç®—æ—¶æœªè¿›è¡Œç±»å‹è½¬æ¢
- **è§£å†³**ï¼šåç«¯å’Œå‰ç«¯åŒé‡Number()è½¬æ¢

**åº“å­˜è®¡ç®—é—®é¢˜ï¼š**
- **é—®é¢˜**ï¼šå‰©ä½™æ•°é‡è®¡ç®—é”™è¯¯
- **åŸå› **ï¼šä¸åŒäº§å“ç±»å‹çš„æ•°é‡å­—æ®µä¸ç»Ÿä¸€
- **è§£å†³**ï¼šä½¿ç”¨CASEè¯­å¥ç»Ÿä¸€æ•°é‡è®¡ç®—é€»è¾‘

### 8.2 è°ƒè¯•å·¥å…·å’Œæ–¹æ³•

**è°ƒè¯•ç«¯ç‚¹ï¼š**
- `GET /inventory/debug`ï¼šæŸ¥çœ‹æ•°æ®åº“è°ƒè¯•ä¿¡æ¯
- `GET /inventory/debug/raw-inventory`ï¼šæŸ¥çœ‹åŸå§‹SQLæŸ¥è¯¢ç»“æœ
- `GET /inventory/debug/quality-distribution`ï¼šæŸ¥çœ‹å“ç›¸åˆ†å¸ƒè°ƒè¯•ä¿¡æ¯

**å‰ç«¯è°ƒè¯•ï¼š**
```typescript
// è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
console.log('ğŸ” [æˆå“æ•°æ®æå–] åŸå§‹å±‚çº§æ•°æ®:', hierarchy_data)
console.log('ğŸ” [å­—æ®µè°ƒè¯•] batch.remaining_quantity:', batch.remaining_quantity, 'ç±»å‹:', typeof batch.remaining_quantity)
console.log('ğŸ” [å­—æ®µè½¬æ¢] remaining_qty:', remaining_qty, 'price_unit:', price_unit)
```

## ä¹ã€æ–‡æ¡£æ›´æ–°è®°å½•

### 9.1 æ›´æ–°çš„æ–‡æ¡£

1. **02-APIæ¥å£ç»Ÿä¸€è§„èŒƒæ–‡æ¡£.md**
   - æ·»åŠ å±‚çº§å¼åº“å­˜æŸ¥è¯¢æ¥å£è§„èŒƒ
   - æ›´æ–°purchaseåˆ°materialå­—æ®µæ˜ å°„è§„èŒƒ
   - æ·»åŠ æ•°æ®ç±»å‹å®‰å…¨å¤„ç†è¯´æ˜

2. **03-æ•°æ®åº“è®¾è®¡ä¸æ•°æ®è§„åˆ™æ–‡æ¡£.md**
   - æ·»åŠ purchaseåˆ°materialæ˜ å°„æ•°æ®åº“è§„èŒƒ
   - æ›´æ–°åº“å­˜è®¡ç®—è§„åˆ™
   - æ·»åŠ åº“å­˜æŸ¥è¯¢ä¼˜åŒ–ç´¢å¼•

3. **04-Reactå‰ç«¯å¼€å‘è§„èŒƒæ–‡æ¡£.md**
   - æ·»åŠ åŸææ–™åº“å­˜ç»„ä»¶å¼€å‘è§„èŒƒ
   - æ›´æ–°å­—æ®µæ˜ å°„å‰ç«¯å¤„ç†è§„èŒƒ
   - æ·»åŠ æ•°æ®ç±»å‹å®‰å…¨å¤„ç†è§„èŒƒ

4. **05-ä¸šåŠ¡æµç¨‹è¯¦ç»†è§„èŒƒæ–‡æ¡£.md**
   - æ·»åŠ åŸææ–™åº“å­˜æŸ¥è¯¢ä¸šåŠ¡æµç¨‹
   - æ›´æ–°purchaseåˆ°materialæ˜ å°„ä¸šåŠ¡è§„åˆ™
   - æ·»åŠ æ•°æ®ç±»å‹å®‰å…¨ä¸šåŠ¡è§„åˆ™

5. **13-åŸææ–™åº“å­˜ä¿®å¤æ€»ç»“æ–‡æ¡£.md**ï¼ˆæœ¬æ–‡æ¡£ï¼‰
   - æ–°å¢å®Œæ•´çš„ä¿®å¤æˆæœæ€»ç»“
   - è¯¦ç»†çš„æŠ€æœ¯å®ç°è¯´æ˜
   - æ€§èƒ½ä¼˜åŒ–è®°å½•
   - é—®é¢˜è§£å†³ç»éªŒ

### 9.2 æ–‡æ¡£åŒæ­¥ä¿è¯

**åŒæ­¥æœºåˆ¶ï¼š**
- ä»£ç ä¿®æ”¹åç«‹å³æ›´æ–°ç›¸å…³æ–‡æ¡£
- æ–‡æ¡£å†…å®¹ä¸å®é™…ä»£ç ä¿æŒä¸€è‡´
- å®šæœŸæ£€æŸ¥æ–‡æ¡£çš„å‡†ç¡®æ€§å’Œå®Œæ•´æ€§
- å»ºç«‹æ–‡æ¡£ç‰ˆæœ¬æ§åˆ¶æœºåˆ¶

## åã€åç»­ä¼˜åŒ–å»ºè®®

### 10.1 åŠŸèƒ½å¢å¼º

**å»ºè®®é¡¹ç›®ï¼š**
- ğŸ“‹ æ·»åŠ åº“å­˜é¢„è­¦é€šçŸ¥åŠŸèƒ½
- ğŸ“‹ å®ç°åº“å­˜å˜åŠ¨å†å²è¿½è¸ª
- ğŸ“‹ æ·»åŠ åº“å­˜ç›˜ç‚¹åŠŸèƒ½
- ğŸ“‹ æ”¯æŒåº“å­˜æ‰¹é‡è°ƒæ•´
- ğŸ“‹ æ·»åŠ åº“å­˜æŠ¥è¡¨å¯¼å‡º

### 10.2 æ€§èƒ½ä¼˜åŒ–

**ä¼˜åŒ–æ–¹å‘ï¼š**
- ğŸ“‹ å®ç°Redisç¼“å­˜æœºåˆ¶
- ğŸ“‹ æ·»åŠ æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–
- ğŸ“‹ å®ç°å¢é‡æ•°æ®æ›´æ–°
- ğŸ“‹ ä¼˜åŒ–å¤§æ•°æ®é‡æŸ¥è¯¢æ€§èƒ½
- ğŸ“‹ æ·»åŠ CDNåŠ é€Ÿæ”¯æŒ

### 10.3 ç”¨æˆ·ä½“éªŒ

**æ”¹è¿›æ–¹å‘ï¼š**
- ğŸ“‹ æ·»åŠ å¿«æ·é”®æ”¯æŒ
- ğŸ“‹ ä¼˜åŒ–ç§»åŠ¨ç«¯äº¤äº’ä½“éªŒ
- ğŸ“‹ æ·»åŠ ä¸ªæ€§åŒ–è®¾ç½®
- ğŸ“‹ å®ç°æ™ºèƒ½æ¨èåŠŸèƒ½
- ğŸ“‹ æ·»åŠ æ“ä½œå¼•å¯¼åŠŸèƒ½

## åä¸€ã€æ€»ç»“

åŸææ–™åº“å­˜æŸ¥è¯¢æ¿å—çš„ä¿®å¤å·¥ä½œå·²ç»å®Œæˆï¼Œå®ç°äº†å®Œæ•´çš„purchaseåˆ°materialæ˜ å°„æœºåˆ¶ã€æ•°æ®ç±»å‹å®‰å…¨å¤„ç†ã€å±‚çº§å¼åº“å­˜å±•ç¤ºç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚é€šè¿‡ç³»ç»Ÿæ€§çš„ä¼˜åŒ–ï¼Œå¤§å¹…æå‡äº†åº“å­˜æŸ¥è¯¢çš„å‡†ç¡®æ€§å’Œç”¨æˆ·ä½“éªŒã€‚æ‰€æœ‰ç›¸å…³æ–‡æ¡£å·²åŒæ­¥æ›´æ–°ï¼Œä¸ºåç»­çš„å¼€å‘å’Œç»´æŠ¤æä¾›äº†å®Œæ•´çš„æŠ€æœ¯æ”¯æ’‘ã€‚

**ä¸»è¦æˆå°±ï¼š**
- âœ… å®ç°äº†å®Œæ•´çš„purchaseåˆ°materialæ˜ å°„æœºåˆ¶
- âœ… å»ºç«‹äº†æ•°æ®ç±»å‹å®‰å…¨å¤„ç†æ ‡å‡†
- âœ… ä¼˜åŒ–äº†åº“å­˜æŸ¥è¯¢æ€§èƒ½
- âœ… å®ç°äº†å®Œæ•´çš„æƒé™æ§åˆ¶æœºåˆ¶
- âœ… å»ºç«‹äº†å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶
- âœ… æ›´æ–°äº†å®Œæ•´çš„æŠ€æœ¯æ–‡æ¡£

**æŠ€æœ¯ä»·å€¼ï¼š**
- ğŸ¯ æä¾›äº†å¯å¤ç”¨çš„å­—æ®µæ˜ å°„æ¶æ„
- ğŸ¯ å»ºç«‹äº†æ ‡å‡†çš„åº“å­˜æŸ¥è¯¢æ¨¡å¼
- ğŸ¯ ä¼˜åŒ–äº†æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½
- ğŸ¯ å®Œå–„äº†å‰ç«¯ç»„ä»¶å¼€å‘è§„èŒƒ
- ğŸ¯ å»ºç«‹äº†å®Œæ•´çš„è°ƒè¯•éªŒè¯æµç¨‹

**ä¸šåŠ¡ä»·å€¼ï¼š**
- ğŸ’¼ å¤§å¹…æå‡äº†åº“å­˜æŸ¥è¯¢å‡†ç¡®æ€§
- ğŸ’¼ æ”¹å–„äº†ç”¨æˆ·æ“ä½œä½“éªŒ
- ğŸ’¼ å¢å¼ºäº†æ•°æ®å®‰å…¨æ€§
- ğŸ’¼ æé«˜äº†ç³»ç»Ÿå¯ç»´æŠ¤æ€§
- ğŸ’¼ ä¸ºåç»­åŠŸèƒ½æ‰©å±•å¥ å®šäº†åŸºç¡€

åŸææ–™åº“å­˜æŸ¥è¯¢æ¿å—çš„ä¿®å¤å’Œä¼˜åŒ–å·¥ä½œä¸ºæ•´ä¸ªERPç³»ç»Ÿçš„ç¨³å®šè¿è¡Œå’Œåç»­å‘å±•æä¾›äº†åšå®çš„æŠ€æœ¯åŸºç¡€ã€‚