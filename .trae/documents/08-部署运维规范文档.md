## 文档 8：部署运维规范文档（提取现有配置）

### 一、环境配置（提取自《系统架构文档》8 章）

#### 1.1 环境变量规范（统一现有命名）

| 环境变量名                    | 用途                | 示例值                    | 来源文档          |
| ------------------------ | ----------------- | ---------------------- | ------------- |
| NODE\_ENV                | 环境标识              | production/development | 《系统架构文档》8.2.2 |
| PORT                     | 后端端口              | 3001                   | 《系统架构文档》8.2.2 |
| DOUBAO\_API\_KEY         | 豆包 AI 密钥          | 0a7c42e7-d1d3-4d53-9b83-dca43b9b2c81 | 《系统架构文档》2.3.1 |
| OSS\_ACCESS\_KEY\_ID     | 阿里云 OSS 密钥 ID     | LTAIxxx                | 《系统架构文档》2.3.2 |
| OSS\_ACCESS\_KEY\_SECRET | 阿里云 OSS 密钥 Secret | xxx                    | 《系统架构文档》2.3.2 |
| MYSQL\_HOST              | MySQL数据库地址        | localhost/RDS地址       | 《数据库设计文档》1.1 |
| MYSQL\_PORT              | MySQL端口           | 3306                   | 《数据库设计文档》1.1 |
| MYSQL\_USER              | MySQL用户名          | root                   | 《数据库设计文档》1.1 |
| MYSQL\_PASSWORD          | MySQL密码           | xxx                    | 《数据库设计文档》1.1 |
| MYSQL\_DATABASE          | MySQL数据库名        | crystal_erp            | 《数据库设计文档》1.1 |

#### 1.2 PM2 配置（提取自《系统架构文档》8.2.2）

```javascript
// ecosystem.config.js
module.exports = {
  apps: [{
    name: "crystal-erp-backend",
    script: "src/server.js",
    instances: "max", // 最大化利用CPU
    autorestart: true,
    watch: false,
    max_memory_restart: "1G",
    log_date_format: "YYYY-MM-DD HH:mm:ss",
    // 日志路径统一（绝对路径）
    out_file: "/home/crystal-erp/logs/out.log",
    error_file: "/home/crystal-erp/logs/error.log",
    env: {
      NODE_ENV: "production",
      PORT: 3001
    }
  }]
};
```

#### 1.3 默认测试账号配置

**开发环境测试账号**（仅开发和测试环境使用）：

| 角色 | 用户名 | 密码 | 权限说明 | 使用场景 |
|------|--------|------|----------|----------|
| 老板 | boss | 123456 | 完整系统权限，可查看所有敏感信息 | 功能测试、权限验证 |
| 雇员 | employee | 123456 | 受限权限，无法查看价格等敏感信息 | 权限控制测试 |

**重要说明**：
- 测试账号信息硬编码在前端登录页面（`src/pages/Login.tsx`）
- 仅在开发环境显示，生产环境应隐藏或移除
- 生产部署前必须修改默认密码或禁用测试账号
- 测试账号由数据库种子文件（`prisma/seed.ts`）自动创建

**生产环境安全配置**：
```javascript
// 生产环境应移除或隐藏测试账号提示
if (process.env.NODE_ENV !== 'production') {
  // 显示测试账号信息
}
```

### 二、数据库运维（提取自《系统架构文档》9 章）

#### 2.1 自动备份脚本（现有逻辑）

```bash
#!/bin/bash
# backup-mysql.sh（每日2点执行）
# 执行要求：1. 本地用户有/home/backup/mysql写入权限（chmod 755）；2. RDS免密登录（~/.my.cnf）
BACKUP_DIR="/home/backup/mysql"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建目录
mkdir -p $BACKUP_DIR

# 备份数据库（替换为实际RDS地址）
mysqldump -h rm-xxxxx.mysql.rds.aliyuncs.com -u username -p'password' crystal_erp > $BACKUP_DIR/erp_backup_$DATE.sql

# 压缩
gzip $BACKUP_DIR/erp_backup_$DATE.sql

# 保留30天备份
find $BACKUP_DIR -name "erp_backup_*.sql.gz" -mtime +30 -delete

# 日志（与PM2日志路径统一）
echo "$(date): Backup completed - erp_backup_$DATE.sql.gz" >> /home/crystal-erp/logs/backup.log
```

#### 2.2 Crontab 配置

```bash
# 每日凌晨2点执行备份
0 2 * * * /home/scripts/backup-mysql.sh
# 每小时检查服务健康状态
0 * * * * curl -s http://localhost:3001/api/v1/health > /dev/null
```

### 三、阿里云部署配置

#### 3.1 宝塔面板Node项目配置

```bash
# 1. 宝塔面板 -> 网站 -> Node项目 -> 添加Node项目
项目名称: crystal-erp
项目域名: api.dorblecapital.com
项目目录: /www/wwwroot/crystal-erp
启动文件: src/server.js
Node版本: 22.17.1
端口: 3001

# 2. 环境变量配置（宝塔面板 -> Node项目 -> 环境变量）
NODE_ENV=production
PORT=3001
DOUBAO_API_KEY=0a7c42e7-d1d3-4d53-9b83-dca43b9b2c81
MYSQL_HOST=localhost
MYSQL_PORT=3306
MYSQL_USER=root
MYSQL_PASSWORD=your_mysql_password
MYSQL_DATABASE=crystal_erp
```

#### 3.2 阿里云ECS安全组配置

```bash
# 需要开放的端口
22    # SSH
80    # HTTP
443   # HTTPS
3001  # Node.js后端API
3306  # MySQL（仅内网访问）

# 安全组规则示例
入方向规则:
- 协议: TCP, 端口: 22, 源: 0.0.0.0/0 (SSH访问)
- 协议: TCP, 端口: 80, 源: 0.0.0.0/0 (HTTP访问)
- 协议: TCP, 端口: 443, 源: 0.0.0.0/0 (HTTPS访问)
- 协议: TCP, 端口: 3001, 源: 0.0.0.0/0 (API访问)
```

#### 3.3 域名解析配置

```bash
# 阿里云DNS解析配置
主域名: dorblecapital.com
API子域名: api.dorblecapital.com

# DNS记录配置
记录类型: A
主机记录: api
记录值: 139.224.189.1 (公网IP)
TTL: 600
```

#### 3.4 Git部署流程

```bash
# 1. 本地推送到GitHub
git add .
git commit -m "部署更新"
git push origin main

# 2. 服务器拉取更新
cd /www/wwwroot/crystal-erp
git pull origin main
npm install --production

# 3. 重启Node项目（宝塔面板操作）
# 宝塔面板 -> 网站 -> Node项目 -> crystal-erp -> 重启
```

### 四、OSS 部署（提取自《系统架构文档》2.3.2）

```javascript
// 后端Multer-OSS配置（现有逻辑）
const multer = require('multer');
const multerAliOSS = require('multer-aliyun-oss');

const upload = multer({
  storage: multerAliOSS({
    config: {
      region: process.env.OSS_REGION,
      accessKeyId: process.env.OSS_ACCESS_KEY_ID, // 禁止硬编码
      accessKeySecret: process.env.OSS_ACCESS_KEY_SECRET,
      bucket: process.env.OSS_BUCKET
    }
  }),
  limits: {
    fileSize: 5 * 1024 * 1024 // 5MB限制
  }
});
```

### 五、网络环境配置

### 五、图片文件运维规范

#### 5.1 图片文件存储管理

**目录结构规范：**
```bash
/www/wwwroot/crystal-erp/backend/uploads/
├── purchases/          # 采购记录图片
│   ├── 1756102840000_47.jpg
│   ├── 1756227752158_158.png
│   └── ...
└── temp/              # 临时上传文件
```

**文件权限配置：**
```bash
# 设置uploads目录权限
chmod 755 /www/wwwroot/crystal-erp/backend/uploads
chmod 644 /www/wwwroot/crystal-erp/backend/uploads/purchases/*

# 确保Node.js进程有读写权限
chown -R www:www /www/wwwroot/crystal-erp/backend/uploads
```

#### 5.2 图片完整性检查脚本

**批量检查脚本（check-image-integrity.js）：**
```javascript
// 定期执行的图片完整性检查脚本
// 使用方法：node check-image-integrity.js
// 建议每日执行一次

import mysql from 'mysql2/promise';
import fs from 'fs';
import path from 'path';

// 检查JPEG文件完整性
function checkJpegIntegrity(filePath) {
  const buffer = fs.readFileSync(filePath);
  
  // 检查文件头 (FF D8)
  if (buffer[0] !== 0xFF || buffer[1] !== 0xD8) {
    return { valid: false, reason: 'JPEG文件头无效' };
  }
  
  // 检查文件尾 (FF D9)
  const lastTwo = buffer.slice(-2);
  if (lastTwo[0] !== 0xFF || lastTwo[1] !== 0xD9) {
    return { valid: false, reason: 'JPEG文件尾无效' };
  }
  
  return { valid: true, reason: '文件完整' };
}

// 批量修复损坏图片
async function batchFixCorruptedImages() {
  // 1. 查询所有采购记录的图片
  // 2. 检查图片文件完整性
  // 3. 替换损坏的图片
  // 4. 更新数据库记录
  // 5. 生成修复报告
}
```

**Crontab定时任务配置：**
```bash
# 每日凌晨3点执行图片完整性检查
0 3 * * * cd /www/wwwroot/crystal-erp/backend && node check-image-integrity.js >> /home/crystal-erp/logs/image-check.log 2>&1

# 每周凌晨4点执行图片清理（删除未使用的图片文件）
0 4 * * 0 cd /www/wwwroot/crystal-erp/backend && node cleanup-unused-images.js >> /home/crystal-erp/logs/image-cleanup.log 2>&1
```

#### 5.3 图片备份策略

**图片文件备份脚本：**
```bash
#!/bin/bash
# backup-images.sh - 图片文件备份脚本
BACKUP_DIR="/home/backup/images"
SOURCE_DIR="/www/wwwroot/crystal-erp/backend/uploads"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p $BACKUP_DIR

# 压缩备份图片文件
tar -czf $BACKUP_DIR/images_backup_$DATE.tar.gz -C $SOURCE_DIR .

# 保留30天备份
find $BACKUP_DIR -name "images_backup_*.tar.gz" -mtime +30 -delete

# 记录日志
echo "$(date): Images backup completed - images_backup_$DATE.tar.gz" >> /home/crystal-erp/logs/backup.log
```

#### 5.4 图片URL环境适配

**开发环境与生产环境URL切换：**
```javascript
// 环境变量配置
// 开发环境 (.env.development)
IMAGE_BASE_URL=http://localhost:3001

// 生产环境 (.env.production)
IMAGE_BASE_URL=http://api.dorblecapital.com

// 动态IP检测和URL更新
function updateImageUrls(oldIP, newIP) {
  // 1. 查询数据库中所有包含旧IP的图片URL
  // 2. 批量替换为新IP
  // 3. 更新数据库记录
  // 4. 记录更新日志
}
```

#### 5.5 CORS跨域问题解决方案

**问题现象：**
- 浏览器控制台出现 `net::ERR_BLOCKED_BY_RESPONSE.NotSameOrigin` 错误
- 图片显示为叉叉或无法加载
- 数据库中存储的是生产环境URL（api.dorblecapital.com），本地开发时无法访问

**根本原因：**
- 数据库中存储的图片URL指向生产环境域名
- 本地开发环境无法跨域访问生产环境的图片资源
- 缺少环境适配的URL转换机制

**解决方案（fixImageUrl函数增强）：**
```javascript
// src/services/api.ts 中的 fixImageUrl 函数
export const fixImageUrl = (url: string): string => {
  if (!url) return url
  
  // 如果是相对路径，直接返回
  if (!url.startsWith('http')) return url
  
  // 获取当前主机名
  const currentHostname = typeof window !== 'undefined' ? window.location.hostname : 'localhost'
  
  // 处理生产环境域名在本地开发时的转换
  if (url.includes('api.dorblecapital.com')) {
    // 在本地开发环境中，将生产环境的图片URL转换为本地地址
    if (currentHostname === 'localhost' || currentHostname === '127.0.0.1') {
      const newUrl = url.replace(/https?:\/\/api\.dorblecapital\.com/g, 'http://localhost:3001')
      console.log(`🔄 生产环境图片URL已转换为本地: ${url} -> ${newUrl}`)
      return newUrl
    }
    // 如果当前是局域网IP，转换为对应的局域网地址
    else if (currentHostname.startsWith('192.168.') || currentHostname.startsWith('10.') || 
             (currentHostname.startsWith('172.') && parseInt(currentHostname.split('.')[1]) >= 16 && parseInt(currentHostname.split('.')[1]) <= 31)) {
      const newUrl = url.replace(/https?:\/\/api\.dorblecapital\.com/g, `http://${currentHostname}:3001`)
      console.log(`🔄 生产环境图片URL已转换为局域网: ${url} -> ${newUrl}`)
      return newUrl
    }
  }
  
  // 其他IP地址转换逻辑...
  return url
}
```

**预防措施：**
1. **开发阶段**：
   - 确保所有图片URL处理都通过fixImageUrl函数
   - 在图片组件中统一使用URL转换逻辑
   - 定期检查控制台是否有CORS错误

2. **测试阶段**：
   - 在不同网络环境下测试图片显示
   - 验证本地开发、局域网、生产环境的URL转换
   - 检查图片加载性能和错误处理

3. **部署阶段**：
   - 确保生产环境的图片服务正常运行
   - 配置正确的CORS策略（如需要）
   - 监控图片访问异常和加载失败

**检查清单：**
- [ ] fixImageUrl函数是否包含所有域名转换逻辑
- [ ] 图片组件是否统一使用URL转换
- [ ] 控制台是否有CORS相关错误
- [ ] 不同环境下图片是否正常显示
- [ ] 图片URL转换日志是否正常输出

#### 5.5 图片性能优化

**图片压缩和优化：**
```bash
# 安装图片优化工具
npm install sharp imagemin imagemin-mozjpeg imagemin-pngquant

# 批量压缩现有图片
node optimize-images.js
```

**CDN配置（可选）：**
```javascript
// 阿里云CDN配置
const CDN_BASE_URL = 'https://cdn.dorblecapital.com';

// 图片URL生成
function generateImageUrl(filename) {
  if (process.env.NODE_ENV === 'production' && process.env.USE_CDN === 'true') {
    return `${CDN_BASE_URL}/uploads/purchases/${filename}`;
  }
  return `${process.env.IMAGE_BASE_URL}/uploads/purchases/${filename}`;
}
```

### 六、网络环境配置

#### 6.1 动态IP检测配置

```javascript
// 前端网络检测配置
const NETWORK_ENDPOINTS = {
  production: 'https://api.dorblecapital.com/api/v1',
  local: 'http://localhost:3001/api/v1',
  publicIP: 'http://139.224.189.1:3001/api/v1'
};

// 自动检测最佳端点
const detectBestEndpoint = async () => {
  const endpoints = Object.values(NETWORK_ENDPOINTS);
  
  for (const endpoint of endpoints) {
    try {
      const response = await fetch(`${endpoint}/health`, { 
        method: 'GET',
        timeout: 3000 
      });
      if (response.ok) {
        return endpoint;
      }
    } catch (error) {
      console.warn(`端点 ${endpoint} 连接失败:`, error.message);
    }
  }
  
  throw new Error('所有API端点均不可用');
};
```

#### 5.2 手机端测试配置

```bash
# 手机端访问配置
# 确保手机和开发机在同一局域网
# 使用公网IP或局域网IP访问

# 开发环境
API地址: http://192.168.1.100:3001/api/v1 (局域网IP)
前端地址: http://192.168.1.100:5173

# 生产环境
API地址: https://api.dorblecapital.com/api/v1
前端地址: https://dorblecapital.com
```

## 六、代码维护与工具使用规范

### 6.1 批量转换工具使用规范

**工具使用原则：**
- 安全第一，质量至上
- 严格按文档规范执行
- 小步快跑，及时验证
- 发现问题立即停止

**使用前准备：**
```bash
# 1. 确保工作区干净
git status
git add .
git commit -m "字段转换前备份 - $(date)"

# 2. 检查工具排除规则
node scripts/convert-camel-to-snake.cjs --check-rules

# 3. 预览转换结果
node scripts/convert-camel-to-snake.cjs --preview --verbose
```

**分批转换流程：**
```bash
# 按模块分批转换，每次转换后立即验证
node scripts/convert-camel-to-snake.cjs --directory src/types
npm run build  # 立即检查编译

node scripts/convert-camel-to-snake.cjs --directory src/api
npm run build  # 立即检查编译

node scripts/convert-camel-to-snake.cjs --directory src/components
npm run build  # 立即检查编译
```

**转换后验证：**
```bash
# 完整验证流程
npm run build
npx tsc --noEmit
npm run lint
npm run dev  # 手动测试核心功能
```

**问题回滚：**
```bash
# 发现问题立即回滚
git reset --hard HEAD~1
```

### 6.2 代码质量保证机制

**提交前检查：**
- 代码编译通过
- 类型检查无错误
- 核心功能测试正常
- 无明显性能问题

**团队协作规范：**
- 转换前团队通知
- 转换期间代码冻结
- 转换后经验总结
- 问题记录和改进

### 6.3 工具安全机制

**智能保护：**
- 自动识别JavaScript内置方法
- 自动识别React组件属性
- 自动识别CSS属性名
- 自动识别第三方库API

**安全检查：**
- 转换前文件内容扫描
- 风险模式自动检测
- 交互式确认机制
- 实时编译验证

## 结语

本文档提供了水晶ERP系统在阿里云环境下的完整部署和运维指南。通过遵循这些规范，可以确保系统的稳定运行、数据安全和高效维护。

在实际操作中，建议：
1. 严格按照文档步骤执行
2. 做好每个环节的备份
3. 及时更新文档内容
4. 建立完善的监控体系
5. 定期进行安全检查
6. 谨慎使用批量转换工具
7. 持续改进开发流程

通过持续的优化和改进，让水晶ERP系统为业务发展提供强有力的技术支撑。

## 6. SKU系统部署要求

### 6.1 SKU数据库部署

#### 6.1.1 SKU相关表结构部署

**必需的数据库表：**
- `product_skus` - SKU主表
- `sku_inventory_logs` - SKU库存变更日志表
- `material_usages` - 原材料使用记录表（关联SKU生成）

**部署脚本：**
```sql
-- SKU主表创建
CREATE TABLE product_skus (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    sku_code VARCHAR(50) UNIQUE NOT NULL,
    sku_name VARCHAR(200) NOT NULL,
    material_signature_hash VARCHAR(8) NOT NULL,
    total_quantity INT NOT NULL DEFAULT 0,
    available_quantity INT NOT NULL DEFAULT 0,
    material_cost DECIMAL(10,2),
    labor_cost DECIMAL(10,2),
    craft_cost DECIMAL(10,2),
    total_cost DECIMAL(10,2),
    unit_price DECIMAL(10,2),
    total_value DECIMAL(10,2),
    profit_margin DECIMAL(5,2),
    status ENUM('ACTIVE', 'INACTIVE') DEFAULT 'ACTIVE',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- SKU库存变更日志表创建
CREATE TABLE sku_inventory_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    sku_id UUID NOT NULL,
    action ENUM('CREATE', 'SELL', 'ADJUST') NOT NULL,
    quantity_change INT NOT NULL,
    quantity_before INT NOT NULL,
    quantity_after INT NOT NULL,
    reference_type ENUM('PRODUCT', 'SALE', 'MANUAL') NOT NULL,
    reference_id UUID,
    notes TEXT,
    user_id UUID NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    
    FOREIGN KEY (sku_id) REFERENCES product_skus(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE RESTRICT
);

-- 创建索引
CREATE INDEX idx_product_skus_material_hash ON product_skus(material_signature_hash);
CREATE INDEX idx_product_skus_status ON product_skus(status);
CREATE INDEX idx_product_skus_created_at ON product_skus(created_at DESC);
CREATE INDEX idx_sku_inventory_logs_sku_id ON sku_inventory_logs(sku_id);
CREATE INDEX idx_sku_inventory_logs_created_at ON sku_inventory_logs(created_at DESC);
CREATE INDEX idx_sku_inventory_logs_action ON sku_inventory_logs(action);
```

#### 6.1.2 SKU权限配置

**数据库权限设置：**
```sql
-- 为应用用户授权SKU相关表权限
GRANT SELECT, INSERT, UPDATE, DELETE ON product_skus TO erp_app_user;
GRANT SELECT, INSERT, UPDATE, DELETE ON sku_inventory_logs TO erp_app_user;

-- 为只读用户授权查询权限
GRANT SELECT ON product_skus TO erp_readonly_user;
GRANT SELECT ON sku_inventory_logs TO erp_readonly_user;
```

### 6.2 SKU API服务部署

#### 6.2.1 SKU路由配置

**必需的API路由：**
- `GET /api/v1/skus` - SKU列表查询
- `GET /api/v1/skus/:id` - SKU详情查询
- `PUT /api/v1/skus/:id/adjust` - SKU库存调整
- `POST /api/v1/skus/:id/sell` - SKU销售记录
- `GET /api/v1/skus/:id/history` - SKU变更历史
- `GET /api/v1/skus/statistics` - SKU统计信息

**路由文件部署：**
```bash
# 确保SKU路由文件存在
ls -la backend/src/routes/skus.ts

# 检查路由注册
grep -n "skus" backend/src/app.ts
```

#### 6.2.2 SKU服务依赖

**必需的服务依赖：**
- Prisma ORM（数据库操作）
- JWT认证中间件
- Zod数据验证
- 错误处理中间件

**依赖检查脚本：**
```bash
#!/bin/bash
# SKU服务依赖检查

echo "检查SKU服务依赖..."

# 检查Prisma配置
if [ -f "backend/prisma/schema.prisma" ]; then
    echo "✓ Prisma配置文件存在"
else
    echo "✗ Prisma配置文件缺失"
    exit 1
fi

# 检查SKU模型定义
if grep -q "model ProductSku" backend/prisma/schema.prisma; then
    echo "✓ SKU模型定义存在"
else
    echo "✗ SKU模型定义缺失"
    exit 1
fi

# 检查JWT中间件
if [ -f "backend/src/middleware/auth.ts" ]; then
    echo "✓ JWT认证中间件存在"
else
    echo "✗ JWT认证中间件缺失"
    exit 1
fi

echo "SKU服务依赖检查完成"
```

### 6.3 SKU前端组件部署

#### 6.3.1 销售列表页面部署

**必需的前端文件：**
- `src/pages/SalesList.tsx` - 销售列表主页面
- `src/components/sku/SkuCard.tsx` - SKU卡片组件
- `src/components/sku/SkuModal.tsx` - SKU详情弹窗
- `src/services/skuApi.ts` - SKU API服务
- `src/types/sku.ts` - SKU类型定义

**组件部署检查：**
```bash
#!/bin/bash
# SKU前端组件检查

echo "检查SKU前端组件..."

# 检查主要组件文件
components=(
    "src/pages/SalesList.tsx"
    "src/components/sku/SkuCard.tsx"
    "src/components/sku/SkuModal.tsx"
    "src/services/skuApi.ts"
    "src/types/sku.ts"
)

for component in "${components[@]}"; do
    if [ -f "$component" ]; then
        echo "✓ $component 存在"
    else
        echo "✗ $component 缺失"
    fi
done

# 检查路由配置
if grep -q "SalesList" src/App.tsx; then
    echo "✓ 销售列表路由已配置"
else
    echo "✗ 销售列表路由未配置"
fi

echo "SKU前端组件检查完成"
```

#### 6.3.2 SKU权限控制部署

**权限控制组件：**
```typescript
// 部署时确保权限控制正确实现
const SkuPermissionCheck = () => {
  const { user } = useAuth();
  
  // 检查用户角色
  if (!user) {
    return <div>请先登录</div>;
  }
  
  // EMPLOYEE角色隐藏敏感信息
  const canViewSensitiveData = user.role === 'BOSS';
  
  return {
    canViewCost: canViewSensitiveData,
    canViewProfit: canViewSensitiveData,
    canViewSupplier: canViewSensitiveData
  };
};
```

### 6.4 SKU系统环境配置

#### 6.4.1 生产环境配置

**环境变量配置：**
```bash
# .env.production
# SKU系统相关配置
SKU_GENERATION_ENABLED=true
SKU_AUTO_MERGE_ENABLED=true
SKU_PRICE_TOLERANCE=0.05
SKU_LOW_STOCK_THRESHOLD=2
SKU_MAX_QUANTITY_PER_OPERATION=9999

# SKU日志配置
SKU_LOG_RETENTION_DAYS=90
SKU_ERROR_LOG_ENABLED=true
SKU_PERFORMANCE_LOG_ENABLED=false

# SKU缓存配置
SKU_CACHE_TTL=300
SKU_STATISTICS_CACHE_TTL=600
```

#### 6.4.2 开发环境配置

**开发环境特殊配置：**
```bash
# .env.development
# SKU系统开发配置
SKU_DEBUG_MODE=true
SKU_MOCK_DATA_ENABLED=false
SKU_VALIDATION_STRICT=true

# 开发调试
SKU_LOG_LEVEL=debug
SKU_API_TIMEOUT=30000
SKU_RETRY_ATTEMPTS=3
```

### 6.5 SKU系统监控部署

#### 6.5.1 SKU性能监控

**监控指标配置：**
```yaml
# monitoring/sku-metrics.yml
sku_metrics:
  # API响应时间监控
  api_response_time:
    - endpoint: "/api/v1/skus"
      threshold: 2000ms
    - endpoint: "/api/v1/skus/:id"
      threshold: 1000ms
    - endpoint: "/api/v1/skus/:id/adjust"
      threshold: 3000ms
  
  # 数据库查询监控
  database_queries:
    - table: "product_skus"
      slow_query_threshold: 1000ms
    - table: "sku_inventory_logs"
      slow_query_threshold: 500ms
  
  # 业务指标监控
  business_metrics:
    - metric: "sku_generation_rate"
      alert_threshold: 100
    - metric: "inventory_adjustment_frequency"
      alert_threshold: 1000
    - metric: "low_stock_sku_count"
      alert_threshold: 50
```

#### 6.5.2 SKU错误监控

**错误监控配置：**
```javascript
// monitoring/sku-error-tracking.js
const skuErrorTracking = {
  // 错误分类
  errorCategories: {
    'INSUFFICIENT_STOCK': 'business',
    'SKU_NOT_FOUND': 'data',
    'VALIDATION_ERROR': 'input',
    'PERMISSION_DENIED': 'security',
    'DATABASE_ERROR': 'system'
  },
  
  // 告警阈值
  alertThresholds: {
    'business': 10, // 10个业务错误/小时
    'data': 5,      // 5个数据错误/小时
    'input': 20,    // 20个输入错误/小时
    'security': 1,  // 1个安全错误/小时
    'system': 3     // 3个系统错误/小时
  },
  
  // 通知配置
  notifications: {
    email: ['admin@company.com'],
    slack: '#sku-alerts',
    webhook: 'https://hooks.slack.com/services/xxx'
  }
};
```

### 6.6 SKU系统备份策略

#### 6.6.1 SKU数据备份

**备份脚本：**
```bash
#!/bin/bash
# SKU数据备份脚本

BACKUP_DIR="/backup/sku"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="sku_backup_${DATE}.sql"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份SKU相关表
pg_dump -h $DB_HOST -U $DB_USER -d $DB_NAME \
  --table=product_skus \
  --table=sku_inventory_logs \
  --table=material_usages \
  --data-only \
  --file="$BACKUP_DIR/$BACKUP_FILE"

# 压缩备份文件
gzip "$BACKUP_DIR/$BACKUP_FILE"

# 清理7天前的备份
find $BACKUP_DIR -name "sku_backup_*.sql.gz" -mtime +7 -delete

echo "SKU数据备份完成: $BACKUP_FILE.gz"
```

#### 6.6.2 SKU配置备份

**配置文件备份：**
```bash
#!/bin/bash
# SKU配置备份脚本

CONFIG_BACKUP_DIR="/backup/sku-config"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建配置备份目录
mkdir -p $CONFIG_BACKUP_DIR

# 备份SKU相关配置文件
tar -czf "$CONFIG_BACKUP_DIR/sku_config_${DATE}.tar.gz" \
  backend/src/routes/skus.ts \
  backend/src/services/skuService.ts \
  src/pages/SalesList.tsx \
  src/services/skuApi.ts \
  src/types/sku.ts

echo "SKU配置备份完成: sku_config_${DATE}.tar.gz"
```

### 6.7 SKU系统部署验证

#### 6.7.1 部署后功能验证

**验证脚本：**
```bash
#!/bin/bash
# SKU系统部署验证脚本

API_BASE_URL="${API_BASE_URL:-http://localhost:3001}"
TEST_TOKEN="your_test_token_here"

echo "开始SKU系统部署验证..."

# 1. 验证SKU列表API
echo "验证SKU列表API..."
response=$(curl -s -w "%{http_code}" -H "Authorization: Bearer $TEST_TOKEN" \
  "$API_BASE_URL/api/v1/skus?page=1&limit=10")

if [[ "$response" == *"200" ]]; then
    echo "✓ SKU列表API正常"
else
    echo "✗ SKU列表API异常: $response"
    exit 1
fi

# 2. 验证SKU统计API
echo "验证SKU统计API..."
response=$(curl -s -w "%{http_code}" -H "Authorization: Bearer $TEST_TOKEN" \
  "$API_BASE_URL/api/v1/skus/statistics")

if [[ "$response" == *"200" ]]; then
    echo "✓ SKU统计API正常"
else
    echo "✗ SKU统计API异常: $response"
    exit 1
fi

# 3. 验证数据库连接
echo "验证SKU数据库表..."
psql -h $DB_HOST -U $DB_USER -d $DB_NAME -c "\dt product_skus" > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "✓ SKU数据库表存在"
else
    echo "✗ SKU数据库表不存在"
    exit 1
fi

# 4. 验证前端页面
echo "验证前端销售列表页面..."
if [ -f "src/pages/SalesList.tsx" ]; then
    echo "✓ 销售列表页面文件存在"
else
    echo "✗ 销售列表页面文件不存在"
    exit 1
fi

echo "SKU系统部署验证完成！"
```

#### 6.7.2 性能验证

**性能测试脚本：**
```bash
#!/bin/bash
# SKU系统性能验证

API_BASE_URL="${API_BASE_URL:-http://localhost:3001}"
TEST_TOKEN="your_test_token_here"

echo "开始SKU系统性能验证..."

# 1. SKU列表查询性能测试
echo "测试SKU列表查询性能..."
start_time=$(date +%s%N)
curl -s -H "Authorization: Bearer $TEST_TOKEN" \
  "$API_BASE_URL/api/v1/skus?page=1&limit=50" > /dev/null
end_time=$(date +%s%N)
response_time=$(( (end_time - start_time) / 1000000 ))

if [ $response_time -lt 2000 ]; then
    echo "✓ SKU列表查询响应时间: ${response_time}ms (正常)"
else
    echo "⚠ SKU列表查询响应时间: ${response_time}ms (较慢)"
fi

# 2. SKU统计查询性能测试
echo "测试SKU统计查询性能..."
start_time=$(date +%s%N)
curl -s -H "Authorization: Bearer $TEST_TOKEN" \
  "$API_BASE_URL/api/v1/skus/statistics" > /dev/null
end_time=$(date +%s%N)
response_time=$(( (end_time - start_time) / 1000000 ))

if [ $response_time -lt 1000 ]; then
    echo "✓ SKU统计查询响应时间: ${response_time}ms (正常)"
else
    echo "⚠ SKU统计查询响应时间: ${response_time}ms (较慢)"
fi

echo "SKU系统性能验证完成！"
```

### 6.8 SKU系统部署清单

#### 6.8.1 部署前检查清单

**必须完成的检查项：**
- [ ] 数据库表结构已创建（product_skus, sku_inventory_logs）
- [ ] 数据库索引已创建
- [ ] 数据库权限已配置
- [ ] SKU API路由已部署
- [ ] JWT认证中间件已配置
- [ ] 前端SKU组件已部署
- [ ] 环境变量已配置
- [ ] 监控配置已部署
- [ ] 备份脚本已配置
- [ ] 错误处理已实现

#### 6.8.2 部署后验证清单

**必须验证的功能：**
- [ ] SKU列表查询正常
- [ ] SKU详情查询正常
- [ ] SKU库存调整正常
- [ ] SKU销售记录正常
- [ ] SKU统计信息正常
- [ ] 权限控制正常（BOSS/EMPLOYEE）
- [ ] 错误处理正常
- [ ] 性能指标正常
- [ ] 监控告警正常
- [ ] 备份功能正常

#### 6.8.3 回滚计划

**回滚步骤：**
1. **数据库回滚**：
   ```sql
   -- 如需回滚SKU表结构
   DROP TABLE IF EXISTS sku_inventory_logs;
   DROP TABLE IF EXISTS product_skus;
   ```

2. **代码回滚**：
   ```bash
   # 回滚到部署前版本
   git checkout <previous_commit_hash>
   npm run build
   pm2 restart all
   ```

3. **配置回滚**：
   ```bash
   # 恢复之前的配置文件
   cp /backup/config/previous_config.env .env
   ```

4. **验证回滚**：
   ```bash
   # 验证系统功能正常
   ./scripts/health-check.sh
   ```

// ... existing code ...