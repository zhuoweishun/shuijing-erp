## 文档 8：部署运维规范文档（提取现有配置）

### 一、环境配置（提取自《系统架构文档》8 章）

#### 1.1 环境变量规范（统一现有命名）

| 环境变量名                    | 用途                | 示例值                    | 来源文档          |
| ------------------------ | ----------------- | ---------------------- | ------------- |
| NODE\_ENV                | 环境标识              | production/development | 《系统架构文档》8.2.2 |
| PORT                     | 后端端口              | 3001                   | 《系统架构文档》8.2.2 |
| DOUBAO\_API\_KEY         | 豆包 AI 密钥          | 0a7c42e7-d1d3-4d53-9b83-dca43b9b2c81 | 《系统架构文档》2.3.1 |
| OSS\_ACCESS\_KEY\_ID     | 阿里云 OSS 密钥 ID     | LTAIxxx                | 《系统架构文档》2.3.2 |
| OSS\_ACCESS\_KEY\_SECRET | 阿里云 OSS 密钥 Secret | xxx                    | 《系统架构文档》2.3.2 |
| MYSQL\_HOST              | MySQL数据库地址        | localhost/RDS地址       | 《数据库设计文档》1.1 |
| MYSQL\_PORT              | MySQL端口           | 3306                   | 《数据库设计文档》1.1 |
| MYSQL\_USER              | MySQL用户名          | root                   | 《数据库设计文档》1.1 |
| MYSQL\_PASSWORD          | MySQL密码           | xxx                    | 《数据库设计文档》1.1 |
| MYSQL\_DATABASE          | MySQL数据库名        | crystal_erp            | 《数据库设计文档》1.1 |

#### 1.2 PM2 配置（提取自《系统架构文档》8.2.2）

```javascript
// ecosystem.config.js
module.exports = {
  apps: [{
    name: "crystal-erp-backend",
    script: "src/server.js",
    instances: "max", // 最大化利用CPU
    autorestart: true,
    watch: false,
    max_memory_restart: "1G",
    log_date_format: "YYYY-MM-DD HH:mm:ss",
    // 日志路径统一（绝对路径）
    out_file: "/home/crystal-erp/logs/out.log",
    error_file: "/home/crystal-erp/logs/error.log",
    env: {
      NODE_ENV: "production",
      PORT: 3001
    }
  }]
};
```

#### 1.3 默认测试账号配置

**开发环境测试账号**（仅开发和测试环境使用）：

| 角色 | 用户名 | 密码 | 权限说明 | 使用场景 |
|------|--------|------|----------|----------|
| 老板 | boss | 123456 | 完整系统权限，可查看所有敏感信息 | 功能测试、权限验证 |
| 雇员 | employee | 123456 | 受限权限，无法查看价格等敏感信息 | 权限控制测试 |

**重要说明**：
- 测试账号信息硬编码在前端登录页面（`src/pages/Login.tsx`）
- 仅在开发环境显示，生产环境应隐藏或移除
- 生产部署前必须修改默认密码或禁用测试账号
- 测试账号由数据库种子文件（`prisma/seed.ts`）自动创建

**生产环境安全配置**：
```javascript
// 生产环境应移除或隐藏测试账号提示
if (process.env.NODE_ENV !== 'production') {
  // 显示测试账号信息
}
```

### 二、数据库运维（提取自《系统架构文档》9 章）

#### 2.1 自动备份脚本（现有逻辑）

```bash
#!/bin/bash
# backup-mysql.sh（每日2点执行）
# 执行要求：1. 本地用户有/home/backup/mysql写入权限（chmod 755）；2. RDS免密登录（~/.my.cnf）
BACKUP_DIR="/home/backup/mysql"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建目录
mkdir -p $BACKUP_DIR

# 备份数据库（替换为实际RDS地址）
mysqldump -h rm-xxxxx.mysql.rds.aliyuncs.com -u username -p'password' crystal_erp > $BACKUP_DIR/erp_backup_$DATE.sql

# 压缩
gzip $BACKUP_DIR/erp_backup_$DATE.sql

# 保留30天备份
find $BACKUP_DIR -name "erp_backup_*.sql.gz" -mtime +30 -delete

# 日志（与PM2日志路径统一）
echo "$(date): Backup completed - erp_backup_$DATE.sql.gz" >> /home/crystal-erp/logs/backup.log
```

#### 2.2 Crontab 配置

```bash
# 每日凌晨2点执行备份
0 2 * * * /home/scripts/backup-mysql.sh
# 每小时检查服务健康状态
0 * * * * curl -s http://localhost:3001/api/v1/health > /dev/null
```

### 三、阿里云部署配置

#### 3.1 宝塔面板Node项目配置

```bash
# 1. 宝塔面板 -> 网站 -> Node项目 -> 添加Node项目
项目名称: crystal-erp
项目域名: api.dorblecapital.com
项目目录: /www/wwwroot/crystal-erp
启动文件: src/server.js
Node版本: 22.17.1
端口: 3001

# 2. 环境变量配置（宝塔面板 -> Node项目 -> 环境变量）
NODE_ENV=production
PORT=3001
DOUBAO_API_KEY=0a7c42e7-d1d3-4d53-9b83-dca43b9b2c81
MYSQL_HOST=localhost
MYSQL_PORT=3306
MYSQL_USER=root
MYSQL_PASSWORD=your_mysql_password
MYSQL_DATABASE=crystal_erp
```

#### 3.2 阿里云ECS安全组配置

```bash
# 需要开放的端口
22    # SSH
80    # HTTP
443   # HTTPS
3001  # Node.js后端API
3306  # MySQL（仅内网访问）

# 安全组规则示例
入方向规则:
- 协议: TCP, 端口: 22, 源: 0.0.0.0/0 (SSH访问)
- 协议: TCP, 端口: 80, 源: 0.0.0.0/0 (HTTP访问)
- 协议: TCP, 端口: 443, 源: 0.0.0.0/0 (HTTPS访问)
- 协议: TCP, 端口: 3001, 源: 0.0.0.0/0 (API访问)
```

#### 3.3 域名解析配置

```bash
# 阿里云DNS解析配置
主域名: dorblecapital.com
API子域名: api.dorblecapital.com

# DNS记录配置
记录类型: A
主机记录: api
记录值: 139.224.189.1 (公网IP)
TTL: 600
```

#### 3.4 Git部署流程

```bash
# 1. 本地推送到GitHub
git add .
git commit -m "部署更新"
git push origin main

# 2. 服务器拉取更新
cd /www/wwwroot/crystal-erp
git pull origin main
npm install --production

# 3. 重启Node项目（宝塔面板操作）
# 宝塔面板 -> 网站 -> Node项目 -> crystal-erp -> 重启
```

### 四、OSS 部署（提取自《系统架构文档》2.3.2）

```javascript
// 后端Multer-OSS配置（现有逻辑）
const multer = require('multer');
const multerAliOSS = require('multer-aliyun-oss');

const upload = multer({
  storage: multerAliOSS({
    config: {
      region: process.env.OSS_REGION,
      accessKeyId: process.env.OSS_ACCESS_KEY_ID, // 禁止硬编码
      accessKeySecret: process.env.OSS_ACCESS_KEY_SECRET,
      bucket: process.env.OSS_BUCKET
    }
  }),
  limits: {
    fileSize: 5 * 1024 * 1024 // 5MB限制
  }
});
```

### 五、网络环境配置

#### 5.1 动态IP检测配置

```javascript
// 前端网络检测配置
const NETWORK_ENDPOINTS = {
  production: 'https://api.dorblecapital.com/api/v1',
  local: 'http://localhost:3001/api/v1',
  publicIP: 'http://139.224.189.1:3001/api/v1'
};

// 自动检测最佳端点
const detectBestEndpoint = async () => {
  const endpoints = Object.values(NETWORK_ENDPOINTS);
  
  for (const endpoint of endpoints) {
    try {
      const response = await fetch(`${endpoint}/health`, { 
        method: 'GET',
        timeout: 3000 
      });
      if (response.ok) {
        return endpoint;
      }
    } catch (error) {
      console.warn(`端点 ${endpoint} 连接失败:`, error.message);
    }
  }
  
  throw new Error('所有API端点均不可用');
};
```

#### 5.2 手机端测试配置

```bash
# 手机端访问配置
# 确保手机和开发机在同一局域网
# 使用公网IP或局域网IP访问

# 开发环境
API地址: http://192.168.1.100:3001/api/v1 (局域网IP)
前端地址: http://192.168.1.100:5173

# 生产环境
API地址: https://api.dorblecapital.com/api/v1
前端地址: https://dorblecapital.com
```

## 六、代码维护与工具使用规范

### 6.1 批量转换工具使用规范

**工具使用原则：**
- 安全第一，质量至上
- 严格按文档规范执行
- 小步快跑，及时验证
- 发现问题立即停止

**使用前准备：**
```bash
# 1. 确保工作区干净
git status
git add .
git commit -m "字段转换前备份 - $(date)"

# 2. 检查工具排除规则
node scripts/convert-camel-to-snake.cjs --check-rules

# 3. 预览转换结果
node scripts/convert-camel-to-snake.cjs --preview --verbose
```

**分批转换流程：**
```bash
# 按模块分批转换，每次转换后立即验证
node scripts/convert-camel-to-snake.cjs --directory src/types
npm run build  # 立即检查编译

node scripts/convert-camel-to-snake.cjs --directory src/api
npm run build  # 立即检查编译

node scripts/convert-camel-to-snake.cjs --directory src/components
npm run build  # 立即检查编译
```

**转换后验证：**
```bash
# 完整验证流程
npm run build
npx tsc --noEmit
npm run lint
npm run dev  # 手动测试核心功能
```

**问题回滚：**
```bash
# 发现问题立即回滚
git reset --hard HEAD~1
```

### 6.2 代码质量保证机制

**提交前检查：**
- 代码编译通过
- 类型检查无错误
- 核心功能测试正常
- 无明显性能问题

**团队协作规范：**
- 转换前团队通知
- 转换期间代码冻结
- 转换后经验总结
- 问题记录和改进

### 6.3 工具安全机制

**智能保护：**
- 自动识别JavaScript内置方法
- 自动识别React组件属性
- 自动识别CSS属性名
- 自动识别第三方库API

**安全检查：**
- 转换前文件内容扫描
- 风险模式自动检测
- 交互式确认机制
- 实时编译验证

## 结语

本文档提供了水晶ERP系统在阿里云环境下的完整部署和运维指南。通过遵循这些规范，可以确保系统的稳定运行、数据安全和高效维护。

在实际操作中，建议：
1. 严格按照文档步骤执行
2. 做好每个环节的备份
3. 及时更新文档内容
4. 建立完善的监控体系
5. 定期进行安全检查
6. 谨慎使用批量转换工具
7. 持续改进开发流程

通过持续的优化和改进，让水晶ERP系统为业务发展提供强有力的技术支撑。

```

