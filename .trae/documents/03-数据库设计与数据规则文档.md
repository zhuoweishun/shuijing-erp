# 文档 03：数据库设计与数据规则文档

## 一、数据库架构概览

### 1.1 核心表结构
本系统采用MySQL数据库，包含以下核心表：
- 用户表（users）
- 供应商表（suppliers）
- 采购表（purchases）**【已更新：添加purchase_code字段】**
- 成品表（products）
- 原材料使用记录表（material_usages）
- 销售记录表（sales_records）
- 系统配置表（system_configs）

### 1.2 字段命名规范
- 使用snake_case命名（如：purchase_code、product_name）
- 主键统一使用id（VARCHAR(36)）
- 外键使用{table}_id格式
- 时间字段使用_at后缀（created_at、updated_at）
- 编号字段使用_code后缀（purchase_code、product_code）

## 二、核心表结构设计

### 2.1 采购表（purchases）**【重要更新】**

```sql
CREATE TABLE purchases (
  id VARCHAR(36) PRIMARY KEY,
  purchase_code VARCHAR(50) UNIQUE NOT NULL, -- **新增：采购编号字段**
  product_name VARCHAR(200) NOT NULL,
  product_type ENUM('LOOSE_BEADS', 'BRACELET', 'ACCESSORIES', 'FINISHED') NOT NULL,
  supplier_id VARCHAR(36) NOT NULL,
  unit_type ENUM('PIECES', 'STRINGS', 'SLICES', 'ITEMS') NOT NULL,
  bead_diameter DECIMAL(3,1), -- 散珠和手串使用
  specification VARCHAR(100), -- 配件和成品使用
  quantity INT, -- 手串数量
  piece_count INT, -- 散珠颗数/配件片数/成品件数
  min_stock_alert INT DEFAULT 10,
  price_per_gram DECIMAL(10,4),
  unit_price DECIMAL(10,2),
  total_price DECIMAL(10,2) NOT NULL,
  weight DECIMAL(8,3),
  beads_per_string INT, -- 每串珠子数
  total_beads INT, -- 总珠子数
  price_per_bead DECIMAL(10,4), -- 每颗珠子价格
  price_per_piece DECIMAL(10,4), -- 每片/件价格
  quality ENUM('AA', 'A', 'AB', 'B', 'C') NOT NULL,
  photos JSON, -- 图片URL数组
  notes TEXT,
  purchase_date DATE NOT NULL,
  status ENUM('ACTIVE', 'INACTIVE') DEFAULT 'ACTIVE',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  user_id VARCHAR(36) NOT NULL,
  
  FOREIGN KEY (supplier_id) REFERENCES suppliers(id) ON DELETE RESTRICT ON UPDATE CASCADE,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE RESTRICT ON UPDATE CASCADE,
  INDEX idx_purchases_purchase_code (purchase_code), -- **新增：采购编号索引**
  INDEX idx_purchases_product_type (product_type),
  INDEX idx_purchases_supplier_id (supplier_id),
  INDEX idx_purchases_purchase_date (purchase_date DESC),
  INDEX idx_purchases_created_at (created_at DESC),
  INDEX idx_purchases_user_id (user_id),
  FULLTEXT INDEX idx_purchases_search (product_name, notes)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

**重要更新说明：**
- **新增purchase_code字段**：采购编号，格式为PUR+日期+序号（如：PUR20240131001）
- **添加唯一索引**：确保采购编号唯一性
- **支持模糊搜索**：后端API支持purchase_code_search参数进行模糊匹配

### 2.2 成品表（products）

```sql
CREATE TABLE products (
  id VARCHAR(36) PRIMARY KEY,
  product_code VARCHAR(50) UNIQUE, -- 已弃用，使用SKU系统
  purchase_code VARCHAR(50), -- **新增：关联采购编号（用于溯源）**
  name VARCHAR(200) NOT NULL,
  description TEXT,
  category VARCHAR(100),
  quantity INT DEFAULT 1, -- 成品数量，通常为1
  unit VARCHAR(20) NOT NULL DEFAULT '件',
  unit_price DECIMAL(10,2) NOT NULL, -- 销售价格
  total_value DECIMAL(10,2) NOT NULL, -- 总成本价
  status ENUM('IN_STOCK', 'LOW_STOCK', 'OUT_OF_STOCK', 'DISCONTINUED') DEFAULT 'IN_STOCK',
  location VARCHAR(100),
  notes TEXT,
  images JSON, -- 图片URL数组，JSON格式
  sku_id VARCHAR(36), -- **新增：关联SKU ID**
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  user_id VARCHAR(36) NOT NULL,
  
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE RESTRICT ON UPDATE CASCADE,
  FOREIGN KEY (sku_id) REFERENCES product_skus(id) ON DELETE SET NULL ON UPDATE CASCADE,
  INDEX idx_products_purchase_code (purchase_code),
  INDEX idx_products_sku_id (sku_id), -- **新增：SKU关联索引**
  INDEX idx_products_status (status),
  INDEX idx_products_created_at (created_at DESC),
  INDEX idx_products_user_id (user_id),
  FULLTEXT INDEX idx_products_search (name, description, notes)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

**字段说明：**
- `unit_price`: 销售价格
- `total_value`: 总成本价（原材料成本+人工成本+工艺成本）
- `images`: JSON格式存储图片URL数组
- `sku_id`: 关联SKU系统，实现库存统一管理

-- 原材料使用记录表
CREATE TABLE material_usage (
  id VARCHAR(36) PRIMARY KEY,
  purchase_id VARCHAR(36) NOT NULL,
  product_id VARCHAR(36) NOT NULL,
  quantity_used_beads INT DEFAULT 0,
  quantity_used_pieces INT DEFAULT 0,
  unit_cost DECIMAL(10,4),
  total_cost DECIMAL(10,2),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  FOREIGN KEY (purchase_id) REFERENCES purchases(id) ON DELETE RESTRICT ON UPDATE CASCADE,
  FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE RESTRICT ON UPDATE CASCADE,
  INDEX idx_material_usage_purchase_id (purchase_id),
  INDEX idx_material_usage_product_id (product_id),
  INDEX idx_material_usage_created_at (created_at DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 销售记录表
CREATE TABLE sales_records (
  id VARCHAR(36) PRIMARY KEY,
  product_id VARCHAR(36) NOT NULL,
  sale_code VARCHAR(50) UNIQUE,
  product_name VARCHAR(200) NOT NULL,
  product_code VARCHAR(50) NOT NULL,
  selling_price DECIMAL(10,2) NOT NULL,
  original_price DECIMAL(10,2) NOT NULL,
  material_cost DECIMAL(10,2) NOT NULL,
  labor_cost DECIMAL(10,2) DEFAULT 0,
  craft_cost DECIMAL(10,2) DEFAULT 0,
  total_cost DECIMAL(10,2) NOT NULL,
  profit_amount DECIMAL(10,2) NOT NULL,
  profit_margin DECIMAL(5,2) NOT NULL,
  buyer_info TEXT,
  sale_date TIMESTAMP NOT NULL,
  sale_channel VARCHAR(50),
  notes TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  user_id VARCHAR(36) NOT NULL,
  
  FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE RESTRICT ON UPDATE CASCADE,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE RESTRICT ON UPDATE CASCADE,
  INDEX idx_sales_records_sale_date (sale_date DESC),
  INDEX idx_sales_records_product_id (product_id),
  INDEX idx_sales_records_user_id (user_id),
  INDEX idx_sales_records_profit_margin (profit_margin DESC),
  FULLTEXT INDEX idx_sales_records_search (product_name, buyer_info, notes)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 创建数据库
CREATE DATABASE IF NOT EXISTS shuijing_erp 
CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;

USE shuijing_erp;

-- 执行上述所有表的DDL语句
-- ...

-- 插入初始数据
INSERT INTO system_configs (id, key, value, description) VALUES
(UUID(), 'product_code_prefix', 'FP', '成品编号前缀'),
(UUID(), 'sale_code_prefix', 'SL', '销售编号前缀'),
(UUID(), 'sku_code_prefix', 'SKU', 'SKU编号前缀'),
(UUID(), 'default_product_category', '手串', '默认成品分类'),
(UUID(), 'default_product_unit', '件', '默认成品单位');

-- SKU系统表结构
-- SKU主表（完整成本计算字段）
CREATE TABLE product_skus (
  id VARCHAR(36) PRIMARY KEY,
  sku_code VARCHAR(50) UNIQUE NOT NULL, -- SKU编号
  sku_name VARCHAR(200) NOT NULL, -- SKU名称
  material_signature_hash VARCHAR(32) NOT NULL, -- 原材料标识哈希值
  material_signature JSON NOT NULL, -- 原材料标识JSON
  total_quantity INT DEFAULT 0, -- 总数量
  available_quantity INT DEFAULT 0, -- 可售数量
  photos JSON, -- 图片URL数组
  specification VARCHAR(100), -- 规格（直径等）
  description TEXT, -- SKU描述
  material_cost DECIMAL(10,2) DEFAULT 0, -- 原材料成本价
  labor_cost DECIMAL(10,2) DEFAULT 0, -- 人工成本
  craft_cost DECIMAL(10,2) DEFAULT 0, -- 工艺成本
  total_cost DECIMAL(10,2) DEFAULT 0, -- 总成本价
  selling_price DECIMAL(10,2) NOT NULL, -- 售价
  profit_margin DECIMAL(5,2) DEFAULT 0, -- 利润率（%）
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, -- 创建日期
  last_sale_date TIMESTAMP NULL, -- 最后销售日期
  created_by VARCHAR(36) NOT NULL, -- 创建用户
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE RESTRICT ON UPDATE CASCADE,
  INDEX idx_product_skus_sku_code (sku_code),
  INDEX idx_product_skus_material_hash (material_signature_hash),
  INDEX idx_product_skus_created_at (created_at DESC),
  INDEX idx_product_skus_last_sale_date (last_sale_date DESC),
  INDEX idx_product_skus_specification (specification),
  INDEX idx_product_skus_profit_margin (profit_margin DESC), -- **新增：利润率索引**
  FULLTEXT INDEX idx_product_skus_search (sku_name, description, specification)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- **成本计算规则：**
-- total_cost = material_cost + labor_cost + craft_cost
-- profit_margin = (selling_price - total_cost) / selling_price * 100
-- 所有成本字段使用DECIMAL(10,2)确保精度

-- SKU库存变更日志表（新增销毁操作类型）
CREATE TABLE sku_inventory_logs (
  id VARCHAR(36) PRIMARY KEY,
  sku_id VARCHAR(36) NOT NULL, -- SKU ID
  action ENUM('CREATE', 'SELL', 'ADJUST', 'DESTROY') NOT NULL, -- 操作类型：创建、销售、调整、销毁
  quantity_change INT NOT NULL, -- 数量变化
  quantity_before INT NOT NULL, -- 变更前数量
  quantity_after INT NOT NULL, -- 变更后数量
  reference_type ENUM('PRODUCT', 'SALE', 'MANUAL', 'DESTROY') NOT NULL, -- 引用类型
  reference_id VARCHAR(36), -- 引用ID
  notes TEXT, -- 备注
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  user_id VARCHAR(36) NOT NULL, -- 操作用户
  
  FOREIGN KEY (sku_id) REFERENCES product_skus(id) ON DELETE RESTRICT ON UPDATE CASCADE,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE RESTRICT ON UPDATE CASCADE,
  INDEX idx_sku_logs_sku_id (sku_id),
  INDEX idx_sku_logs_action (action),
  INDEX idx_sku_logs_created_at (created_at DESC),
  INDEX idx_sku_logs_reference (reference_type, reference_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- SKU原材料溯源关联表
CREATE TABLE sku_material_traces (
  id VARCHAR(36) PRIMARY KEY,
  sku_id VARCHAR(36) NOT NULL, -- SKU ID
  purchase_id VARCHAR(36) NOT NULL, -- 采购记录ID
  quantity_used_beads INT DEFAULT 0, -- 使用的珠子颗数
  quantity_used_pieces INT DEFAULT 0, -- 使用的片/件数量
  unit_cost DECIMAL(10,4), -- 单位成本
  total_cost DECIMAL(10,2), -- 该原材料的总成本
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (sku_id) REFERENCES product_skus(id) ON DELETE RESTRICT ON UPDATE CASCADE,
  FOREIGN KEY (purchase_id) REFERENCES purchases(id) ON DELETE RESTRICT ON UPDATE CASCADE,
  INDEX idx_sku_traces_sku_id (sku_id),
  INDEX idx_sku_traces_purchase_id (purchase_id),
  INDEX idx_sku_traces_created_at (created_at DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- SKU系统初始化数据
INSERT INTO system_configs (id, key, value, description) VALUES
(UUID(), 'sku_code_prefix', 'SKU', 'SKU编号前缀'),
(UUID(), 'sku_price_tolerance', '0.05', 'SKU价格差异容忍度（5%）'),
(UUID(), 'low_stock_threshold', '2', '低库存预警阈值'),
(UUID(), 'sku_auto_merge', 'true', '是否自动合并相同原材料组合的SKU');

-- 为成品表添加SKU关联
ALTER TABLE products ADD COLUMN sku_id VARCHAR(30) NULL;
ALTER TABLE products ADD FOREIGN KEY (sku_id) REFERENCES product_skus(id);
CREATE INDEX idx_products_sku_id ON products(sku_id);

-- SKU库存统计视图（更新字段，移除状态逻辑）
CREATE VIEW sku_inventory_stats AS
SELECT 
  ps.id,
  ps.sku_code,
  ps.sku_name,
  ps.total_quantity,
  ps.available_quantity,
  ps.total_quantity - ps.available_quantity as sold_quantity,
  ps.photos,
  ps.specification,
  ps.material_cost,
  ps.selling_price,
  ps.profit_margin,
  ps.created_at,
  ps.last_sale_date,
  CASE 
    WHEN ps.available_quantity <= 2 THEN 'LOW_STOCK'
    WHEN ps.available_quantity = 0 THEN 'OUT_OF_STOCK'
    ELSE 'IN_STOCK'
  END as stock_status,
  COUNT(p.id) as product_count,
  ps.updated_at
FROM product_skus ps
LEFT JOIN products p ON ps.id = p.sku_id
GROUP BY ps.id;

-- SKU销售统计视图（更新字段）
CREATE VIEW sku_sales_stats AS
SELECT 
  ps.id as sku_id,
  ps.sku_code,
  ps.sku_name,
  COUNT(CASE WHEN sil.action = 'SELL' THEN 1 END) as total_sales,
  SUM(CASE WHEN sil.action = 'SELL' THEN ABS(sil.quantity_change) ELSE 0 END) as total_sold_quantity,
  SUM(CASE WHEN sil.action = 'SELL' THEN ABS(sil.quantity_change) * ps.selling_price ELSE 0 END) as total_sales_value,
  SUM(CASE WHEN sil.action = 'DESTROY' THEN ABS(sil.quantity_change) ELSE 0 END) as total_destroyed_quantity,
  AVG(CASE WHEN sil.action = 'SELL' THEN ps.profit_margin ELSE NULL END) as avg_profit_margin,
  MAX(CASE WHEN sil.action = 'SELL' THEN sil.created_at END) as last_sale_date
FROM product_skus ps
LEFT JOIN sku_inventory_logs sil ON ps.id = sil.sku_id
GROUP BY ps.id;

-- SKU原材料溯源视图
CREATE VIEW sku_material_trace_view AS
SELECT 
  ps.id as sku_id,
  ps.sku_code,
  ps.sku_name,
  smt.purchase_id,
  p.product_name,
  p.product_type,
  p.quality,
  p.bead_diameter,
  p.specification as purchase_specification,
  p.supplier,
  p.purchase_date,
  smt.quantity_used_beads,
  smt.quantity_used_pieces,
  smt.unit_cost,
  smt.total_cost,
  smt.created_at as trace_created_at
FROM product_skus ps
INNER JOIN sku_material_traces smt ON ps.id = smt.sku_id
INNER JOIN purchases p ON smt.purchase_id = p.id
ORDER BY ps.sku_code, p.purchase_date DESC;