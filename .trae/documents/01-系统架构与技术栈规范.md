# 系统架构与技术栈规范（核心基础）

## 一、架构概览

### 1.0 系统架构概述

本系统采用前后端分离架构，基于现代Web技术栈构建，支持多端访问和响应式设计。系统核心包含采购管理、库存管理、成品制作、SKU管理和销售管理等模块，通过统一的API接口实现数据交互。

#### 1.0.1 SKU系统架构

SKU（Stock Keeping Unit）系统是本ERP的核心模块之一，负责统一管理相同原材料组合的成品，实现库存的标准化管理：

- **SKU生成机制**：基于原材料标识哈希值自动生成或合并SKU
- **库存统一管理**：将相同原材料组合的成品统一到同一SKU下管理
- **销售数据统计**：提供SKU级别的销售统计和库存变更历史
- **权限控制**：根据用户角色控制成本信息的可见性

### 1.1 整体架构图

```mermaid
graph TD 
     %% 顶层用户层 
     A[用户层] 
     A --> B[Web端] 
     A --> C[鸿蒙端] 
     
     %% 前端层（拆分简化子图，避免嵌套过深） 
     subgraph 前端层 
         B --> B1[React@19.1.1] 
         B1 --> B2[React Router@7.8.2] 
         B1 --> B3[Axios@1.11.0] 
         B1 --> B4[Tailwind CSS@4.1.12] 
         
         C --> C1[ArkUI] 
         C1 --> C2[@ohos.net.http] 
         C1 --> C3[@ohos.data.preferences] 
     end 
     
     %% 后端层 
     subgraph 后端层 
         D[Express@5.1.0] 
         D --> D1[JWT认证@9.0.2] 
         D --> D2[Multer上传@2.0.2] 
         D --> D3[Prisma ORM@5.7.1] 
     end 
     
     %% 数据与第三方服务层 
     subgraph 数据/服务层 
         E[MySQL8.0+] 
         F[阿里云OSS/本地存储] 
         G[豆包AI服务] 
     end 
     
     %% 核心关联逻辑 
     B --> D 
     C --> D 
     D --> E 
     D --> F 
     D --> G 
     
     %% 数据层子节点（简化关联，避免冗余） 
     E --> E1[users表] 
     E --> E2[suppliers表] 
     E --> E3[purchases表] 
     E --> E4[products表] 
     E --> E5[inventory_view视图]
```

### 1.2 技术栈清单（统一现有版本，无新增）

| 层级    | 技术/工具      | 版本             | 核心用途       | 来源文档          |
| ----- | ---------- | -------------- | ---------- | ------------- |
| 前端Web | React      | 19.1.1         | 组件开发       | 《系统架构文档》2.1   |
| 前端Web | TypeScript | 5.8.3          | 类型安全       | 《系统架构文档》2.1   |
| 前端鸿蒙  | ArkUI      | 原生             | 鸿蒙端UI实现    | 《系统架构文档》2.1.2 |
| 后端    | Express    | 5.1.0          | 接口开发       | 《系统架构文档》2.2   |
| 后端    | MySQL2     | 3.14.3         | 数据库连接      | 《系统架构文档》2.2   |
| 数据库   | MySQL      | 8.0+           | 数据存储       | 《数据库设计文档》1.1  |
| 第三方服务 | 豆包AI       | doubao-1.5-pro | 自然语言识别     | 《系统架构文档》2.3.1 |
| 第三方服务 | 阿里云OSS     | 最新             | 文件存储（生产环境） | 《系统架构文档》2.3.2 |

### 1.3 核心模块划分（基于现有业务）

| 模块     | 核心功能              | 依赖关系         | 来源文档           |
| ------ | ----------------- | ------------ | -------------- |
| 用户认证模块 | 登录/Token验证/RBAC权限 | 所有模块前置       | 《业务流程文档》2      |
| 采购管理模块 | 采购录入/AI识别/批量导入导出  | 依赖用户模块、供应商模块 | 《业务流程文档》3      |
| 成品管理模块 | 成品录入/销售/销毁（库存回滚）  | 依赖采购模块、库存模块  | 《业务流程文档》6      |
| 库存管理模块 | 实时计算（采购-使用）/低库存预警 | 依赖采购模块、成品模块  | 《业务流程文档》5      |
| 供应商模块  | 自动创建（采购时）/统计分析    | 依赖采购模块       | 《业务流程文档》4      |
| 智能助理模块 | 自然语言查询/业务分析       | 依赖所有业务模块     | 《系统架构文档》4.1.1  |
| 网络检测模块 | 动态IP检测/连通性测试/故障转移 | 所有API调用前置    | 《API接口规范文档》5.5 |

### 1.4 数据计算架构变更（重要）

**价格计算方式的架构变化：**

**之前的架构（已废弃）：**
- 前端根据总价和数量实时计算单颗价格、单片价格等
- 计算结果仅在前端显示，不存储到数据库
- 每次页面刷新或数据重新加载时重新计算

**现在的架构（当前实现）：**
- 后端在采购录入/更新时自动计算所有单价字段
- 计算结果直接存储到数据库中
- 前端直接读取数据库中的计算结果，无需重新计算

**涉及的计算字段：**

| 字段名 | 数据类型 | 计算规则 | 适用产品类型 |
|--------|----------|----------|-------------|
| `pricePerBead` | DECIMAL(10,4) | 总价 ÷ 总颗数 | 散珠、手串 |
| `pricePerPiece` | DECIMAL(10,4) | 总价 ÷ 片数/件数 | 饰品配件、成品 |
| `unitPrice` | DECIMAL(10,1) | 总价 ÷ 数量 | 所有类型 |
| `beadsPerString` | INT | Math.floor(160 ÷ 珠径) | 手串 |
| `totalBeads` | INT | 串数 × 每串颗数 | 手串 |

**计算时机：**
- 采购记录创建时（POST /api/v1/purchases）
- 采购记录更新时（PUT /api/v1/purchases/:id）
- 数据迁移时（migrate-unit-prices.ts脚本）

**架构优势：**
- 数据一致性：避免前端计算误差
- 性能提升：减少前端计算负担
- 数据完整性：计算结果持久化存储
- 查询效率：支持基于计算字段的排序和筛选

### 1.5 前端页面架构规范

#### 1.5.1 采购管理页面架构

### 1.5.2 采购录入页面 (PurchaseEntry.tsx)

**技术实现：**
- React Hook Form 表单管理
- 动态字段显示逻辑
- 图片拖拽上传功能
- AI自然语言解析集成
- 实时表单验证

**核心功能：**
```typescript
// 动态字段控制
const purchase_type = watch('purchase_type')
const show_bead_fields = ['LOOSE_BEADS', 'BRACELET'].includes(purchase_type)
const show_piece_fields = ['ACCESSORIES', 'FINISHED_MATERIAL'].includes(purchase_type)

// 图片上传处理
const handle_image_upload = async (files: File[]) => {
  const formData = new FormData()
  files.forEach(file => formData.append('images', file))
  
  const response = await uploadApi.uploadPurchaseImages(formData)
  if (response.success) {
    setPhotos(prev => [...prev, ...response.data.uploaded_files])
  }
}
```

### 1.5.3 采购列表页面 (PurchaseList.tsx) - 完整技术架构

**核心技术栈：**
- React 18 + TypeScript + Hooks
- TanStack Query（数据缓存和状态管理）
- Headless UI（无样式组件库）
- React Virtual（虚拟滚动优化）
- Tailwind CSS（响应式样式）

**状态管理架构：**
```typescript
// 复杂状态管理使用useReducer
interface PurchaseListState {
  purchases: Purchase[]
  loading: boolean
  error: string | null
  filters: FilterState
  pagination: PaginationState
  ui: UIState
}

const purchase_list_reducer = (state: PurchaseListState, action: Action) => {
  switch (action.type) {
    case 'SET_PURCHASES':
      return { ...state, purchases: action.payload }
    case 'SET_FILTER':
      return { 
        ...state, 
        filters: { ...state.filters, [action.field]: action.value },
        pagination: { ...state.pagination, current_page: 1 } // 重置页码
      }
    case 'TOGGLE_FILTER_PANEL':
      return {
        ...state,
        ui: { 
          ...state.ui, 
          show_filters: { 
            ...state.ui.show_filters, 
            [action.column]: !state.ui.show_filters[action.column] 
          }
        }
      }
    default:
      return state
  }
}
```

**高级筛选器架构：**
```typescript
// 筛选器工厂模式
const FilterFactory = {
  search: (props: SearchFilterProps) => <SearchFilter {...props} />,
  multi_select: (props: MultiSelectProps) => <MultiSelectFilter {...props} />,
  range: (props: RangeFilterProps) => <RangeFilter {...props} />,
  date_range: (props: DateRangeProps) => <DateRangeFilter {...props} />
}

// 表头筛选器组件
const ColumnFilter = ({ column, filter_type, ...props }) => {
  const [show_filter, set_show_filter] = useState(false)
  const filter_ref = useRef<HTMLDivElement>(null)
  
  // 点击外部关闭筛选器
  useClickOutside(filter_ref, () => set_show_filter(false))
  
  return (
    <div className="relative" ref={filter_ref}>
      <button 
        onClick={() => set_show_filter(!show_filter)}
        className="p-1 hover:bg-gray-100 rounded"
      >
        <FunnelIcon className="h-4 w-4" />
      </button>
      
      {show_filter && (
        <div className="absolute top-8 left-0 z-50 bg-white border rounded-lg shadow-lg p-4 min-w-64">
          {FilterFactory[filter_type](props)}
        </div>
      )}
    </div>
  )
}
```

**性能优化实现：**
```typescript
// 1. 数据缓存和查询优化
const {
  data: purchases_data,
  isLoading,
  error,
  refetch
} = useQuery({
  queryKey: ['purchases', filter_params],
  queryFn: () => fetch_purchases(filter_params),
  staleTime: 5 * 60 * 1000, // 5分钟缓存
  keepPreviousData: true // 避免加载闪烁
})

// 2. 防抖搜索
const debounced_search = useCallback(
  debounce((search_term: string) => {
    dispatch({ type: 'SET_FILTER', field: 'search_term', value: search_term })
  }, 500),
  []
)

// 3. 虚拟滚动（处理大量数据）
const VirtualTable = ({ items, render_row }) => {
  const parent_ref = useRef<HTMLDivElement>(null)
  
  const row_virtualizer = useVirtualizer({
    count: items.length,
    getScrollElement: () => parent_ref.current,
    estimateSize: () => 60,
    overscan: 10
  })
  
  return (
    <div ref={parent_ref} className="h-96 overflow-auto">
      {/* 虚拟滚动内容 */}
    </div>
  )
}

// 4. 图片懒加载
const LazyImage = ({ src, alt }) => {
  const [is_in_view, set_is_in_view] = useState(false)
  const img_ref = useRef<HTMLImageElement>(null)
  
  useEffect(() => {
    const observer = new IntersectionObserver(
      ([entry]) => entry.isIntersecting && set_is_in_view(true),
      { threshold: 0.1 }
    )
    
    if (img_ref.current) observer.observe(img_ref.current)
    return () => observer.disconnect()
  }, [])
  
  return (
    <div ref={img_ref}>
      {is_in_view && <img src={src} alt={alt} />}
    </div>
  )
}
```

**响应式设计实现：**
```typescript
// 移动端适配
const useResponsive = () => {
  const [is_mobile, set_is_mobile] = useState(false)
  
  useEffect(() => {
    const check_mobile = () => set_is_mobile(window.innerWidth < 768)
    check_mobile()
    window.addEventListener('resize', check_mobile)
    return () => window.removeEventListener('resize', check_mobile)
  }, [])
  
  return { is_mobile }
}

// 移动端筛选器
const MobileFilters = ({ filters, on_filter_change }) => {
  const [show_modal, set_show_modal] = useState(false)
  
  return (
    <>
      <button 
        onClick={() => set_show_modal(true)}
        className="lg:hidden bg-blue-600 text-white px-4 py-2 rounded"
      >
        筛选 ({get_active_filter_count(filters)})
      </button>
      
      {show_modal && (
        <div className="fixed inset-0 z-50 bg-black bg-opacity-50">
          <div className="bg-white h-full overflow-y-auto">
            {/* 移动端筛选内容 */}
          </div>
        </div>
      )}
    </>
  )
}
```

## 二、第三方服务配置（统一现有规范）

### 2.1 豆包AI配置与服务规范

#### 2.1.1 基础配置

```javascript
// 生产环境必须用环境变量，禁止硬编码
const DOUBAO_CONFIG = {
  apiKey: process.env.DOUBAO_API_KEY || '0a7c42e7-d1d3-4d53-9b83-dca43b9b2c81',
  baseUrl: process.env.DOUBAO_BASE_URL || 'https://ark.cn-beijing.volces.com/api/v3',
  model: process.env.DOUBAO_MODEL || 'doubao-1.5-pro-32k-250115',
  timeout: 30000, // 30秒超时
  maxRetries: 3, // 最大重试3次
  confidence: 0.6, // 识别阈值（低于则失败）
  temperature: 0.3, // 控制回答的随机性
  maxTokens: 2000 // 最大输出token数
};
```

#### 2.1.2 AI服务功能模块

| 功能模块     | 接口路径                         | 权限要求 | 核心功能       | 实现状态  |
| -------- | ---------------------------- | ---- | ---------- | ----- |
| 采购描述解析   | `/api/v1/ai/parse`           | 已认证  | 自然语言提取采购信息 | ✅ 已实现 |
| 智能助理对话   | `/api/v1/assistant/chat`     | 仅老板  | 业务问题智能问答   | ✅ 已实现 |
| 业务洞察分析   | `/api/v1/assistant/insights` | 仅老板  | 数据分析和建议    | ✅ 已实现 |
| AI服务健康检查 | `/api/v1/ai/health`          | 已认证  | 服务状态监控     | ✅ 已实现 |
| AI配置获取   | `/api/v1/ai/config`          | 已认证  | 获取AI服务配置   | ✅ 已实现 |

#### 2.1.3 采购描述解析规范

**支持的产品类型识别：**

* `LOOSE_BEADS`（散珠）：关键词包含'散珠'、'颗'、'粒'、'散装'、'单颗'

* `BRACELET`（手串）：关键词包含'手串'、'串'、'条'、'手链'

* `ACCESSORIES`（饰品）：关键词包含'吊坠'、'挂件'、'饰品'、'片'、'配件'

* `FINISHED`（成品）：关键词包含'成品'、'件'、'个'、'雕件'、'摆件'

**品相等级识别规则：**

* `AA级`：全净体、完美、极品、顶级、无瑕疵

* `A级`：净体、很好、优质、高品质、品质很好

* `AB级`：还不错、不错、良好、轻微瑕疵、品相不错

* `B级`：一般、普通、有点棉、有棉絮、有瑕疵

* `C级`：差、有裂、有明显瑕疵、品质较差

**珠径识别规则：**

* 标准表述：6mm、8mm、10mm、12mm等

* 行业简称：6米、8米、10米（"米"在珠宝行业指毫米）

* 口语表述：6的、8的、10的等

**供应商识别规则：**

* 直接提及："供应商张三"、"张三水晶"

* 购买地点："在阿来水晶买的"、"从张三那里买的"

* 商店名称：完整提取包含"水晶"、"珠宝"等后缀的商店名

#### 2.1.4 前端AI服务类规范

```typescript
class AIService {
  // 解析采购描述
  async parseDescription(description: string): Promise<AIParseResponse>
  
  // 智能助理对话（仅老板）
  async chat(message: string, context?: any): Promise<AssistantResponse>
  
  // 获取业务洞察（仅老板）
  async getBusinessInsights(query: string): Promise<AssistantResponse>
  
  // 检查AI服务可用性
  async checkAvailability(): Promise<boolean>
  
  // 获取AI配置信息
  async getConfig(): Promise<any>
}
```

#### 2.1.5 AI功能权限控制

```typescript
// 权限控制规范
const AI_PERMISSIONS = {
  parseDescription: ['BOSS', 'EMPLOYEE'], // 所有用户可用
  chat: ['BOSS'], // 仅老板可用
  insights: ['BOSS'], // 仅老板可用
  health: ['BOSS', 'EMPLOYEE'], // 所有用户可用
  config: ['BOSS', 'EMPLOYEE'] // 所有用户可用
};
```

#### 2.1.6 AI服务错误处理策略

```typescript
// 错误处理和降级策略
const AI_ERROR_HANDLING = {
  // 网络错误：重试机制
  networkError: {
    maxRetries: 3,
    backoffDelay: [1000, 2000, 4000], // 指数退避
    fallbackMessage: 'AI服务暂时不可用，请手动输入'
  },
  
  // 权限错误：明确提示
  permissionError: {
    message: '智能助理功能仅限老板使用',
    redirectTo: '/login'
  },
  
  // 解析失败：降级处理
  parseError: {
    showManualInput: true,
    logError: true,
    userMessage: 'AI识别失败，请手动输入采购信息'
  }
};
```

### 2.2 阿里云OSS配置（提取自《系统架构文档》2.3.2）

```javascript
const OSS_CONFIG = {
  region: process.env.OSS_REGION || 'oss-cn-hangzhou',
  accessKeyId: process.env.OSS_ACCESS_KEY_ID, // 环境变量注入
  accessKeySecret: process.env.OSS_ACCESS_KEY_SECRET,
  bucket: process.env.OSS_BUCKET || 'crystal-erp-files',
  allowedTypes: ['jpg', 'jpeg', 'png', 'gif', 'webp'],
  maxSize: 5 * 1024 * 1024, // 5MB限制
};
```

**AI解析功能规范：**

* **接口路径：** `/api/v1/ai/parse-crystal-purchase`

* **输入格式：** 自然语言描述文本（最大2000字符）

* **输出格式：** 结构化采购数据（JSON格式）

* **置信度要求：** ≥0.6才进行自动填充

* **字段映射：** camelCase（AI返回） → snake\_case（表单字段）

**字段映射规则：**

| AI返回字段       | 表单字段                         | 数据类型   | 说明                                               |
| ------------ | ---------------------------- | ------ | ------------------------------------------------ |
| productName  | product\_name                | string | 产品名称                                             |
| productType  | product\_type                | enum   | 产品类型（LOOSE\_BEADS/BRACELET/ACCESSORIES/FINISHED） |
| beadDiameter | bead\_diameter/specification | number | 珠径或规格（根据产品类型）                                    |
| quantity     | quantity                     | number | 数量（串数）                                           |
| pieceCount   | piece\_count                 | number | 颗数/片数/件数                                         |
| pricePerGram | price\_per\_gram             | number | 克价                                               |
| totalPrice   | total\_price                 | number | 总价                                               |
| weight       | weight                       | number | 重量(g)                                            |
| quality      | quality                      | enum   | 品相（AA/A/AB/B/C）                                  |
| supplierName | supplier\_name               | string | 供应商名称                                            |
| notes        | notes                        | string | 备注信息                                             |

### 2.2.1 相机功能第三方插件

**插件配置：**

```javascript
// react-html5-camera-photo 插件
import CameraPhoto, { FACING_MODES, IMAGE_TYPES } from 'react-html5-camera-photo'
import 'react-html5-camera-photo/build/css/index.css'
```

**浏览器兼容性检查：**

* **Chrome：** ≥53版本

* **Firefox：** ≥36版本

* **Safari：** ≥11版本

* **安全上下文：** 要求HTTPS或localhost

* **权限要求：** navigator.mediaDevices.getUserMedia

**相机功能规范：**

* **启动条件：** 通过兼容性检查或强制启用模式

* **拍照格式：** JPEG格式，自动命名为camera\_photo\_timestamp.jpg

* **错误处理：** React错误边界组件包装

* **开发模式：** 支持非HTTPS环境下的宽松检查

**错误边界实现：**

```typescript
class CameraErrorBoundary extends React.Component {
  // 捕获相机组件错误
  // 提供重试机制
  // 显示友好错误提示
}
```

### 2.3 网络检测与智能重试配置

```javascript
const NETWORK_CONFIG = {
  // API地址优先级配置
  apiEndpoints: {
    production: 'https://api.dorblecapital.com/api/v1', // 公网域名
    local: 'http://localhost:3001/api/v1', // 本地开发
    fallback: 'http://127.0.0.1:3001/api/v1' // 备用地址
  },
  
  // 连通性测试配置
  connectivity: {
    timeout: 3000, // 3秒超时
    healthCheckPath: '/health', // 健康检查路径
    retryInterval: 30000, // 30秒重新检测
    maxRetries: 2 // 最大重试次数
  },
  
  // 网络环境检测
  detection: {
    publicDomain: 'dorblecapital.com', // 公网域名标识
    localNetworks: ['192.168.', '10.', '172.'], // 局域网IP前缀
    cacheExpiry: 300000, // 缓存5分钟过期
    monitoringInterval: 30000 // 30秒监控间隔
  },
  
  // 智能重试策略
  retry: {
    maxAttempts: 3, // 最大重试次数
    baseDelay: 1000, // 基础延迟1秒
    maxDelay: 5000, // 最大延迟5秒
    backoffFactor: 2, // 指数退避因子
    retryableErrors: ['NETWORK_ERROR', 'TIMEOUT_ERROR', 'API_UNAVAILABLE']
  }
};
```

### 2.4 调试工具配置

```javascript
const DEBUG_CONFIG = {
  // 开发环境调试工具
  enabled: process.env.NODE_ENV === 'development',
  globalName: 'apiDebug', // 全局变量名
  
  // 日志配置
  logging: {
    level: 'debug', // debug | info | warn | error
    networkRequests: true, // 记录网络请求
    apiResponses: true, // 记录API响应
    cacheOperations: true // 记录缓存操作
  },
  
  // 性能监控
  performance: {
    trackApiLatency: true, // 跟踪API延迟
    trackNetworkSwitching: true, // 跟踪网络切换
    reportThreshold: 2000 // 超过2秒报告慢请求
  }
};
```

```
```

