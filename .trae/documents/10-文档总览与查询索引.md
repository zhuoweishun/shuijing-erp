## 文档 10：文档总览与查询索引（整合所有文档）

### 一、文档清单与用途（快速导航）

| 文档编号 | 文档名称           | 核心用途                 | 关键章节                      | 适用角色        | 来源文档                 | 更新状态        |
| ---- | -------------- | -------------------- | ------------------------- | ----------- | -------------------- | ----------- |
| 01   | 系统架构与技术栈规范     | 查看技术栈版本、架构图、第三方配置    | 1.2 技术栈清单、2.3 第三方服务配置     | 前后端开发、运维    | 原 1.txt              | ✅ 已完善       |
| 02   | API 接口统一规范文档   | 对接接口、查看参数 / 响应 / 错误码 | 2.1 认证接口、5.1 库存接口、四 错误码表  | 前后端开发       | 原 2.txt + 库存接口整合  | ✅ 已添加库存接口规范 |
| 03   | 数据库设计与数据规则文档   | 查看表结构、索引、库存视图逻辑      | 二 数据库架构、四 purchase映射规范、五.3 库存索引 | 后端开发、DBA    | 原 3.txt + 库存映射整合  | ✅ 已添加映射规范 |
| 04   | React 前端开发规范文档 | 前端组件开发、权限控制、库存组件  | 三 认证系统规范、四 库存组件规范、五 错误处理    | 前端开发        | 原 4.txt + 库存组件整合  | ✅ 已添加库存组件规范 |
| 05   | 业务流程详细规范文档     | 理解认证/采购/成品/库存核心流程    | 二 用户认证流程、六 库存查询流程、七 系统维护   | 所有开发        | 原 5.txt + 库存流程整合  | ✅ 已添加库存业务流程 |
| 06   | UI/UX 设计规范文档   | 视觉设计、组件样式、鸿蒙端适配      | 2.1 色彩系统、3.1 按钮组件         | 前端开发、UI 设计师 | 原 6.txt              | ⏳ 待更新       |
| 07   | 错误处理与测试规范文档    | 错误类型、前端拦截、测试重点       | 1.1 错误分类、2.1Axios 拦截器     | 前后端开发、测试工程师 | 原 7.txt              | ✅ 已添加图片错误处理规范 |
| 08   | 部署运维规范文档       | 环境配置、备份脚本、OSS 部署     | 1.2PM2 配置、2.1 备份脚本        | 运维工程师、后端开发  | 原 8.txt-11.txt（提取核心） | ✅ 已添加图片运维规范 |
| 09   | 权限与安全规范文档      | 角色权限、敏感字段过滤、安全配置     | 1.1 权限矩阵、2.2 过滤实现         | 前后端开发、安全工程师 | 原 1.txt、3.txt、4.txt  | ⏳ 待创建       |
| 10   | 文档总览与查询索引      | 快速查找文档、术语统一          | 2. 术语对照表、3. 高频问题映射        | 所有角色        | 整合所有文档               | ✅ 持续更新      |
| 11   | 采购录入修复总结文档      | 采购录入功能修复详细记录        | 2. 核心修复内容、3. API接口修复      | 前后端开发       | 采购录入修复工作总结            | ✅ 新增完成      |
| 12   | 采购列表修复总结文档      | 采购列表功能修复详细记录        | 2. 多维度搜索、3. 表头筛选器      | 前后端开发       | 采购列表修复工作总结            | ✅ 新增完成      |
| 13   | 原材料库存修复总结文档    | 原材料库存查询修复详细记录      | 2. purchase映射机制、3. 层级查询、6. 数据类型安全 | 前后端开发       | 原材料库存修复工作总结          | ✅ 新增完成      |

### 二、术语对照表（统一现有表述）

| 规范术语                  | 禁止表述 | 说明                 | 来源文档            |
| --------------------- | ---- | ------------------ | --------------- |
| 库存视图（inventory\_view） | 库存表  | 无物理表，实时计算生成        | 《数据库设计文档》3.6    |
| 雇员（employee）          | 员工   | 角色枚举值为 employee    | 《业务流程文档》1.2     |
| 批量导入                  | 批量上传 | 接口路径含 batch-import | 《API 接口规范文档》4.6 |
| 原材料成品                 | 库存成品 | 库存中的成品类别，属于原材料     | 《业务流程文档》6.1     |
| 销售成品                  | 制作成品 | 成品制作后的最终产品，进入销售列表  | 《业务流程文档》6.1     |
| 成品制作                  | 成品生产 | 将原材料转化为销售成品的过程     | 《业务流程文档》6.1     |
| 成品销毁                  | 成品删除 | 含库存回滚逻辑，非普通删除      | 《业务流程文档》6.3     |
| 克价（price\_per\_gram）  | 每克价格 | 统一字段名，避免歧义         | 《数据库设计文档》3.3    |
| 豆包AI服务                | AI识别 | 使用doubao-1.5-pro模型 | 《系统架构文档》2.3.1   |
| 网络检测模块                | 连接检测 | 动态IP检测和故障转移        | 《API接口规范文档》5.5  |
| 智能重试机制                | 自动重试 | 指数退避策略，最大3次重试      | 《错误处理规范文档》3.3   |

## 三、库存消耗分析数据类型问题解决经验总结（重要更新）

### 3.1 问题背景与根源分析

**问题现象：**
- 前端库存消耗分析显示"161 件"而不是"17 件"
- 后端API返回的total_consumption为字符串"0161"而不是数字17
- 数据计算逻辑正确，但显示结果错误

**根源分析：**
1. **数据类型混合**：后端reduce计算时发生字符串拼接而不是数字相加
2. **类型转换缺失**：item.total_consumed字段可能为字符串类型
3. **JavaScript类型强制转换**："16" + "1" = "161"（字符串拼接）而不是 16 + 1 = 17（数字相加）
4. **前端防护不足**：前端未对API返回数据进行类型验证和转换

### 3.2 解决方案与修复过程

**第一阶段：后端数据类型修复**
- 在inventory.ts第1600-1601行的reduce计算中添加Number()强制类型转换
- 修改前：`sum + item.total_consumed`
- 修改后：`sum + Number(item.total_consumed)`
- 确保后端计算结果为数字类型

**第二阶段：前端数据类型防护**
- 在InventoryConsumptionChart.tsx第178行添加Number()转换
- 修改前：`{data.total_consumption.toLocaleString()}`
- 修改后：`{Number(data.total_consumption).toLocaleString()}`
- 双重保护确保前端显示正确

**第三阶段：文档规范更新**
- 更新业务流程文档，明确数据类型处理规范
- 更新API接口文档，添加数据类型处理说明
- 更新前端开发规范，强调类型安全处理
- 更新数据库文档，添加SQL查询类型转换规范

### 3.3 核心技术要点

**数据类型安全处理算法：**
```javascript
// 后端计算时强制数字类型转换
const totalConsumption = convertedData.reduce((sum, item) => {
  return sum + Number(item.total_consumed);
}, 0);

// 前端显示时强制数字类型转换
const formatTotalConsumption = (data) => {
  return Number(data.total_consumption).toLocaleString();
};
```

**SQL查询类型转换规范：**
```sql
-- 确保返回数字类型
CAST(COALESCE(SUM(mu.quantityUsedBeads), 0) + COALESCE(SUM(mu.quantityUsedPieces), 0) AS UNSIGNED) as total_consumed
```

### 3.4 预防措施与最佳实践

**开发阶段：**
- 所有数值计算都使用Number()强制类型转换
- API接口返回数据进行类型验证
- 前端组件对数值字段进行防护性转换
- TypeScript接口定义明确数据类型

**测试阶段：**
- 验证API返回数据的类型正确性
- 测试边界情况和异常数据
- 确保前端显示与后端计算一致
- 检查控制台是否有类型转换警告

**运维阶段：**
- 监控API返回数据的类型一致性
- 定期检查前端显示是否正确
- 记录数据类型相关的错误日志

## 四、图片显示问题解决经验总结（重要更新）

### 3.1 问题背景与根源分析

**问题现象：**
- 前端页面图片显示为叉叉（无法读取）
- 部分采购记录图片正常，部分异常
- 问题从项目启动初期就存在

**根源分析：**
1. **数据格式不一致**：数据库`photos`字段混合存储JSON数组和字符串URL
2. **图片文件损坏**：JPEG文件存在文件尾无效问题（缺少`FF D9`结束标记）
3. **测试数据质量**：创建测试数据时未考虑图片文件完整性
4. **环境适配问题**：开发环境和生产环境URL格式不统一
5. **CORS跨域问题**：数据库存储生产环境URL，本地开发时无法跨域访问

### 3.2 解决方案与修复过程

**第一阶段：数据格式统一**
- 识别并修复12条`photos`字段为字符串格式的记录
- 使用`JSON_ARRAY()`函数将字符串URL转换为JSON数组格式
- 确保所有记录的`photos`字段格式一致

**第二阶段：图片文件完整性修复**
- 开发批量图片完整性检查脚本
- 检测JPEG和PNG文件的文件头和文件尾
- 自动替换11个损坏的图片文件
- 更新数据库中对应的图片URL

**第三阶段：CORS跨域问题解决**
- 识别生产环境图片URL在本地开发时的跨域访问问题
- 增强fixImageUrl函数，添加域名转换逻辑
- 实现api.dorblecapital.com到localhost:3001的自动转换
- 添加详细的URL转换日志和错误处理

**第四阶段：建立长期机制**
- 制定图片存储规范和完整性检查标准
- 建立定时检查和自动修复机制
- 完善图片上传和处理的错误处理
- 适配阿里云部署环境的URL格式

### 3.3 核心技术要点

**图片完整性检查算法：**
```javascript
// JPEG文件检查
function checkJpegIntegrity(buffer) {
  // 文件头检查：FF D8
  if (buffer[0] !== 0xFF || buffer[1] !== 0xD8) return false;
  
  // 文件尾检查：FF D9
  const lastTwo = buffer.slice(-2);
  if (lastTwo[0] !== 0xFF || lastTwo[1] !== 0xD9) return false;
  
  return true;
}
```

**批量修复策略：**
1. 查询所有采购记录的图片URL
2. 检查对应图片文件的完整性
3. 为损坏图片从可用图片池中随机选择替换
4. 更新数据库记录并记录修复日志
5. 验证新URL的可访问性

**CORS跨域问题解决算法：**
```javascript
// fixImageUrl函数增强版
export const fixImageUrl = (url: string): string => {
  // 处理生产环境域名在本地开发时的转换
  if (url.includes('api.dorblecapital.com')) {
    const currentHostname = window.location.hostname;
    if (currentHostname === 'localhost' || currentHostname === '127.0.0.1') {
      const newUrl = url.replace(/https?:\/\/api\.dorblecapital\.com/g, 'http://localhost:3001');
      console.log(`🔄 生产环境图片URL已转换为本地: ${url} -> ${newUrl}`);
      return newUrl;
    }
  }
  return url;
}
```

### 3.4 阿里云部署适配要点

**URL格式规范：**
- 开发环境：`http://localhost:3001/uploads/purchases/{filename}`
- 生产环境：`http://api.dorblecapital.com/uploads/purchases/{filename}`
- 动态切换：基于环境变量自动适配

**文件存储路径：**
- 本地开发：`./backend/uploads/purchases/`
- 阿里云部署：`/www/wwwroot/crystal-erp/backend/uploads/purchases/`

## 五、成品制作业务流程总结（重要更新）

### 5.1 成品制作模式对比

**直接转化模式 vs 组合制作模式：**

| 对比维度 | 直接转化模式 | 组合制作模式 |
|----------|-------------|-------------|
| **业务场景** | 单一原材料直接转化为销售成品 | 多种原材料组合制作复杂成品 |
| **原材料选择** | 单选，每个原材料独立转化 | 多选，多种原材料组合使用 |
| **图片处理** | 自动使用原材料图片 | 需要手动上传成品图片 |
| **规格处理** | 自动使用原材料规格 | 需要手动输入成品规格 |
| **成本计算** | 原材料成本+人工成本+工艺成本 | 多种原材料成本总和+人工成本+工艺成本 |
| **制作数量** | 支持批量制作（受库存限制） | 支持批量制作（受库存限制） |
| **库存验证** | 实时验证单个原材料库存 | 实时验证所有原材料库存 |
| **适用场景** | 简单加工、包装、品质提升 | 复杂工艺、多材料组合 |

### 5.2 核心技术实现要点

#### 5.2.1 字段自动填充逻辑

**直接转化模式字段处理：**
```typescript
// addMaterial函数中的自动填充
product_info: {
  product_name: material.product_name + '（销售成品）',
  specification: material.specification || '',  // 自动使用原材料规格
  photos: material.photos || [],  // 自动使用原材料图片
  material_cost: material.unit_cost || 0,
  labor_cost: 20,  // 默认人工成本
  craft_cost: 100  // 默认工艺成本
}

// 批量创建时的字段处理
products.push({
  specification: material.specification || '',  // 使用原材料规格
  photos: material.product_info.photos  // 使用原材料图片
})
```

#### 5.2.2 库存验证和制作数量限制

**实时库存验证算法：**
```typescript
const updateMaterialQuantity = (purchaseId, field, value) => {
  // 更新原材料使用量
  const updatedFormData = {
    selected_materials: materials.map(item => 
      item.material.purchase_id === purchaseId 
        ? { ...item, [field]: Math.max(0, Math.min(value, item.material.available_quantity)) }
        : item
    )
  }
  
  // 重新计算最大制作数量
  const newMaxQuantity = calculateMaxProductionQuantity(updatedFormData.selected_materials)
  
  // 自动调整制作数量
  if (updatedFormData.production_quantity > newMaxQuantity) {
    updatedFormData.production_quantity = newMaxQuantity
    toast.warning(`库存不足，制作数量已自动调整为 ${newMaxQuantity} 个`)
  }
}
```

**最大制作数量计算：**
```typescript
const calculateMaxProductionQuantity = (materials) => {
  let maxQuantity = Infinity
  
  for (const item of materials) {
    let availableForThisMaterial = 0
    
    if (material.product_type === 'LOOSE_BEADS' || material.product_type === 'BRACELET') {
      // 散珠和手串按颗数计算
      if (item.quantity_used_beads > 0) {
        availableForThisMaterial = Math.floor(material.available_quantity / item.quantity_used_beads)
      }
    } else if (material.product_type === 'ACCESSORIES' || material.product_type === 'FINISHED') {
      // 配件和成品按片/件数计算
      if (item.quantity_used_pieces > 0) {
        availableForThisMaterial = Math.floor(material.available_quantity / item.quantity_used_pieces)
      }
    }
    
    maxQuantity = Math.min(maxQuantity, availableForThisMaterial)
  }
  
  return maxQuantity === Infinity ? 1 : Math.max(1, maxQuantity)
}
```

#### 5.2.3 成本计算规则

**统一成本计算公式：**
```
总成本 = 材料成本 + 人工成本 + 工艺成本

直接转化模式：
材料成本 = 原材料单位成本 × 使用数量

组合制作模式：
材料成本 = Σ(每种原材料的单位成本 × 使用数量)

利润率 = (销售价格 - 总成本) / 销售价格 × 100%
```

### 5.3 API接口规范

#### 5.3.1 核心接口清单

| 接口路径 | 方法 | 功能说明 | 适用模式 |
|----------|------|----------|----------|
| `/api/v1/finished-products` | POST | 组合制作模式创建成品 | 组合制作 |
| `/api/v1/finished-products/batch-create` | POST | 直接转化模式批量创建 | 直接转化 |
| `/api/v1/finished-products/cost` | POST | 成本计算 | 两种模式 |
| `/api/v1/finished-products/:id` | DELETE | 销毁成品（含库存回滚） | 两种模式 |

#### 5.3.2 关键请求参数

**组合制作模式：**
```typescript
{
  "product_name": "紫水晶组合手串",
  "materials": [
    {
      "purchase_id": "uuid-1",
      "quantity_used_beads": 20,
      "quantity_used_pieces": 0
    }
  ],
  "labor_cost": 20.00,
  "craft_cost": 100.00,
  "selling_price": 280.00,
  "photos": ["手动上传的图片URL"]
}
```

**直接转化模式：**
```typescript
{
  "products": [
    {
      "material_id": "uuid-1",
      "product_name": "8mm紫水晶手串（销售成品）",
      "specification": "8.0",  // 自动使用原材料规格
      "photos": ["原材料图片URL"]  // 自动使用原材料图片
    }
  ]
}
```

### 5.4 数据库设计要点

#### 5.4.1 核心表结构

**成品表（finished_products）：**
- `material_cost`：原材料成本（雇员不可见）
- `labor_cost`：人工成本
- `craft_cost`：工艺成本
- `total_cost`：总成本（自动计算）
- `profit_margin`：利润率（%）
- `photos`：JSON格式图片数组
- `specification`：规格字段

**原材料使用记录表（material_usages）：**
- `quantity_used_beads`：使用的珠子颗数
- `quantity_used_pieces`：使用的片/件数量
- `unit_cost`：单位成本（DECIMAL(10,4)）
- `total_cost`：该原材料的总成本

#### 5.4.2 库存计算逻辑

**剩余库存计算（考虑成品制作消耗）：**
```sql
SELECT 
    p.id as purchase_id,
    p.total_beads - COALESCE(SUM(mu.quantity_used_beads), 0) as remaining_beads,
    p.piece_count - COALESCE(SUM(mu.quantity_used_pieces), 0) as remaining_pieces
FROM purchases p
LEFT JOIN material_usages mu ON p.id = mu.purchase_id
WHERE p.status = 'ACTIVE'
GROUP BY p.id;
```

### 5.5 前端组件架构

#### 5.5.1 ProductEntry组件状态管理

**双模式状态结构：**
```typescript
// 组合制作模式表单数据
const [formData, setFormData] = useState<ProductionFormData>({
  mode: 'DIRECT_TRANSFORM',
  selected_materials: [],  // MaterialUsage[]
  production_quantity: 1
})

// 直接转化模式批量数据
const [batchProducts, setBatchProducts] = useState<BatchProduct[]>([]);
```

## 六、库存弹窗优化与仪表盘修复总结（最新更新）

### 6.1 修改概述

**修改时间：** 2024年1月
**修改范围：** 库存查询页面仪表盘、半成品/配件/成品库存弹窗
**主要目标：** 修复API字段对齐问题、优化用户交互体验、统一CG编号显示

### 6.2 仪表盘修复详情

**问题：** 产品分布图表无法显示数据
**原因：** API返回字段名不匹配（distribution vs top_products）
**解决方案：**
- 修复API接口规范：将`distribution`字段更正为`top_products`
- 更新前端组件字段映射
- 同步更新相关文档

**修改文件：**
- `02-API接口统一规范文档.md`：更新产品分布接口规范
- `05-业务流程详细规范文档.md`：添加仪表盘修复说明

### 6.3 库存弹窗优化详情

#### 6.3.1 CG编号显示优化

**问题：** CG编号显示不一致，部分数据显示为空
**解决方案：**
- 建立字段优先级：`purchase_code` > `batch_number` > '暂无编号'
- 实现数据容错处理，支持历史数据兼容
- 统一所有弹窗的CG编号显示逻辑

**技术实现：**
```typescript
const displayPurchaseCode = (item: any) => {
  return item.purchase_code || 
         item.batch_number || 
         '暂无编号';
};
```

#### 6.3.2 交互体验优化

**新增功能：**
- 点击空白区域关闭弹窗
- 阻止弹窗内容区域事件冒泡
- 统一弹窗布局和样式

**修改组件：**
- `SemiFinishedMatrixView.tsx`：半成品库存弹窗
- `AccessoriesProductGrid.tsx`：配件库存弹窗
- `FinishedProductGrid.tsx`：成品库存弹窗

#### 6.3.3 批次信息统一

**优化内容：**
- 统一批次信息显示格式
- 规格信息和品相等级同行显示
- 价格信息权限控制优化

### 6.4 文档更新清单

**已更新文档：**
1. `02-API接口统一规范文档.md`：API字段修复和库存查询接口规范
2. `03-数据库设计与数据规则文档.md`：CG编号字段规范和查询规范
3. `04-React前端开发规范文档.md`：库存弹窗交互体验规范
4. `05-业务流程详细规范文档.md`：库存弹窗业务流程和仪表盘修复
5. `06-UI设计规范文档.md`：库存弹窗UI设计规范和交互动画
6. `07-错误处理与测试规范文档.md`：库存弹窗错误处理和测试用例
7. `09-权限与安全规范文档.md`：库存弹窗权限控制规范
8. `10-文档总览与查询索引.md`：本次修改总结

### 6.5 技术要点总结

**API层面：**
- 字段名称统一：`top_products`替代`distribution`
- CG编号字段：`purchase_code`作为主要标识
- 数据容错：处理null/undefined值

**前端层面：**
- 事件处理：`onClick`和`stopPropagation`
- 数据安全：类型验证和默认值处理
- 权限控制：BOSS/EMPLOYEE角色区分

**UI/UX层面：**
- 交互优化：点击空白关闭弹窗
- 布局统一：规格和品相同行显示
- 视觉规范：CG编号突出显示

### 6.6 业务价值

**用户体验提升：**
- 弹窗操作更加便捷
- CG编号显示更加清晰
- 数据查询响应更快
- 权限控制更加精确

**开发效率提升：**
- API字段对齐减少调试时间
- 组件复用性增强
- 文档同步更新及时
- 错误处理更加完善

## 七、SKU系统文档索引

### 7.1 SKU系统概览

**系统定位：**
SKU（Stock Keeping Unit）系统是水晶ERP的核心库存管理模块，基于成品制作自动生成唯一SKU编号，实现精细化库存管理和销售追踪。

**核心功能：**
- 自动SKU生成（基于原材料哈希）
- 库存实时管理和调整
- 销售记录和追踪
- 成本利润分析（角色权限控制）
- 库存预警和统计

### 7.2 SKU系统文档映射

#### 7.2.1 按文档分类的SKU内容

| 文档编号 | 文档名称 | SKU相关章节 | 主要内容 | 页面位置 |
|---------|----------|------------|----------|----------|
| 01 | 系统架构与技术栈规范 | 5.1 SKU系统架构设计 | SKU系统在整体架构中的定位和数据流 | 第5章 |
| 02 | API接口统一规范 | 6. SKU管理API规范 | SKU相关API接口定义和规范 | 第6章 |
| 03 | 数据库设计与数据规则 | SKU系统表结构 | product_skus、sku_inventory_logs表设计 | 第4章后 |
| 04 | React前端开发规范 | 6. SKU系统组件开发规范 | SalesList组件、SKU数据类型定义 | 第6章 |
| 05 | 业务流程详细规范 | 6. SKU系统业务流程 | SKU生成、库存管理、销售流程 | 第6章 |
| 06 | UI设计规范 | 销售列表页面UI设计规范 | SKU卡片、筛选、状态显示设计 | 第7章 |
| 07 | 错误处理与测试规范 | SKU系统错误处理规范 | SKU API错误、权限错误处理 | 第6章 |
| 08 | 部署运维规范 | SKU系统部署要求 | SKU数据库、API、前端部署 | 第6章 |
| 09 | 权限与安全规范 | 6. SKU系统权限与安全规范 | SKU权限控制、数据安全保护 | 第6章 |
| 10 | 文档总览与查询索引 | 7. SKU系统文档索引 | SKU系统文档导航和查询 | 第7章 |

#### 7.2.2 SKU功能模块文档分布

**SKU生成机制：**
- 业务流程：《业务流程详细规范》6.1 SKU生成和管理
- 数据库设计：《数据库设计与数据规则》SKU系统表结构
- API接口：《API接口统一规范》6.1 SKU接口清单

**库存管理：**
- 业务流程：《业务流程详细规范》6.2 SKU库存管理
- 前端组件：《React前端开发规范》6.2 销售列表组件开发
- UI设计：《UI设计规范》销售列表页面UI设计规范
- API接口：《API接口统一规范》6.3 SKU库存调整接口

**销售记录：**
- 业务流程：《业务流程详细规范》6.3 销售列表业务流程
- API接口：《API接口统一规范》6.4 SKU销售记录接口
- 错误处理：《错误处理与测试规范》SKU系统错误处理规范

**权限控制：**
- 权限设计：《权限与安全规范》6.1 SKU操作权限控制
- 前端实现：《React前端开发规范》6.3 SKU权限控制
- 后端验证：《权限与安全规范》6.2 SKU数据安全保护

**部署运维：**
- 部署要求：《部署运维规范》SKU系统部署要求
- 监控配置：《权限与安全规范》6.5 SKU系统安全监控
- 错误监控：《错误处理与测试规范》SKU系统错误处理规范

### 7.3 SKU系统快速查询索引

#### 7.3.1 开发相关查询

**我要开发SKU列表页面：**
1. 查看《React前端开发规范》6.2 销售列表组件开发
2. 参考《UI设计规范》销售列表页面UI设计规范
3. 对接《API接口统一规范》6.2 SKU列表查询接口
4. 实现《React前端开发规范》6.3 SKU权限控制

**我要实现SKU API：**
1. 查看《API接口统一规范》6. SKU管理API规范
2. 参考《数据库设计与数据规则》SKU系统表结构
3. 实现《权限与安全规范》6.1 SKU操作权限控制
4. 添加《错误处理与测试规范》SKU系统错误处理规范

**我要设计SKU数据库：**
1. 查看《数据库设计与数据规则》SKU系统表结构
2. 参考《业务流程详细规范》6.1 SKU生成和管理
3. 实现《数据库设计与数据规则》SKU生成机制
4. 配置《数据库设计与数据规则》库存自动更新触发器

#### 7.3.2 业务相关查询

**SKU是如何生成的？**
- 查看《业务流程详细规范》6.1 SKU生成和管理
- 参考《数据库设计与数据规则》SKU生成机制

**SKU权限如何控制？**
- 查看《权限与安全规范》6.1 SKU操作权限控制
- 参考《React前端开发规范》6.3 SKU权限控制

**SKU库存如何管理？**
- 查看《业务流程详细规范》6.2 SKU库存管理

## 八、采购录入修复经验总结（重要更新）

### 8.1 问题背景与根源分析

**问题现象：**
- 前后端字段名称不一致导致数据传输错误
- 产品类型名称混乱（FINISHED vs FINISHED_MATERIAL）
- 成品库存显示为0（实际有库存）
- 图片上传和显示不稳定
- 表单验证规则不完善

**根源分析：**
1. **字段映射不一致**：前端使用product_name，后端期望purchase_name
2. **类型定义混乱**：后端代码中使用'FINISHED'，数据库和前端使用'FINISHED_MATERIAL'
3. **验证规则缺失**：不同采购类型缺乏差异化验证
4. **图片处理问题**：跨域访问、格式验证、大小限制不完善
5. **文档不同步**：代码修改后文档未及时更新

### 8.2 解决方案与修复过程

**第一阶段：字段名称统一**
- 统一使用purchase_name替代product_name
- 修复前后端接口参数名称
- 更新TypeScript类型定义
- 同步数据库字段注释

**第二阶段：产品类型修复**
- 后端代码统一使用'FINISHED_MATERIAL'
- 修复库存查询逻辑中的类型过滤
- 更新前端类型枚举定义
- 验证数据库现有数据一致性

**第三阶段：表单验证增强**
- 实现按采购类型的差异化验证
- 添加必填字段检查
- 增强数值范围验证
- 完善错误提示信息

**第四阶段：图片处理优化**
- 使用react-dropzone实现拖拽上传
- 添加文件格式和大小验证
- 实现fixImageUrl函数处理跨域
- 优化图片预览和错误处理

**第五阶段：文档同步更新**
- 更新API接口规范文档
- 修复数据库设计文档
- 完善前端开发规范
- 更新业务流程文档

### 8.3 核心技术要点

**字段映射统一算法：**
```typescript
// 前后端字段映射统一
interface PurchaseCreateRequest {
  purchase_name: string        // 统一：采购名称
  purchase_type: PurchaseType  // 统一：采购类型
  supplier_id: string         // 统一：供应商ID
  // ... 其他字段
}

// 类型定义统一
type PurchaseType = 'LOOSE_BEADS' | 'BRACELET' | 'ACCESSORIES' | 'FINISHED_MATERIAL'
```

**差异化验证策略：**
```typescript
const validateByType = (type: PurchaseType, data: any): ValidationResult => {
  const errors: string[] = []
  
  switch (type) {
    case 'LOOSE_BEADS':
    case 'BRACELET':
      if (!data.price_per_gram || data.price_per_gram <= 0) {
        errors.push('克价必须大于0')
      }
      if (!data.weight || data.weight <= 0) {
        errors.push('重量必须大于0')
      }
      break
      
    case 'ACCESSORIES':
    case 'FINISHED_MATERIAL':
      if (!data.piece_count || data.piece_count <= 0) {
        errors.push('片数/件数必须大于0')
      }
      break
  }
  
  return { isValid: errors.length === 0, errors }
}
```

### 8.4 修复效果验证

**功能验证：**
- ✅ 采购录入各类型正常工作
- ✅ 成品库存正确显示数量和价格
- ✅ 图片上传和显示稳定
- ✅ 表单验证逻辑完善
- ✅ 前后端数据传输正确

**性能验证：**
- ✅ API响应时间正常
- ✅ 图片加载速度良好
- ✅ 表单提交响应及时
- ✅ 数据库查询效率稳定

**用户体验验证：**
- ✅ 错误提示信息清晰
- ✅ 操作流程顺畅
- ✅ 界面响应及时
- ✅ 数据显示准确

### 8.5 预防措施与最佳实践

**开发阶段：**
- 严格遵循全蛇形命名规范
- 前后端字段定义使用共享类型文件
- 每次字段修改同步更新文档
- 实施代码审查确保一致性

**测试阶段：**
- 验证前后端字段映射正确性
- 测试不同采购类型的验证逻辑
- 检查图片上传的各种边界情况
- 确保文档与实际代码一致

**运维阶段：**
- 监控API接口的成功率
- 定期检查数据一致性
- 记录和分析错误日志
- 建立文档更新机制

### 8.6 文档更新清单

**本次修复涉及的文档更新：**
1. `02-API接口统一规范文档.md`：采购创建接口、图片上传接口规范
2. `03-数据库设计与数据规则文档.md`：采购表字段说明、验证规则
3. `04-React前端开发规范文档.md`：采购录入组件规范、类型定义
4. `05-业务流程详细规范文档.md`：采购录入业务流程、图片处理流程
5. `10-文档总览与查询索引.md`：新增文档索引、修复经验总结
6. `11-采购录入修复总结文档.md`：详细修复记录和技术要点

**文档同步原则：**
- 代码修改必须同步更新文档
- 文档内容必须与实际代码一致
- 修复经验及时记录和分享
- 定期审查文档的准确性和完整性
- 参考《API接口统一规范》6.3 SKU库存调整接口

**SKU销售如何记录？**
- 查看《业务流程详细规范》6.3 销售列表业务流程
- 参考《API接口统一规范》6.4 SKU销售记录接口

#### 7.3.3 运维相关查询

**如何部署SKU系统？**
1. 查看《部署运维规范》SKU系统部署要求
2. 执行《部署运维规范》SKU数据库部署
3. 配置《部署运维规范》SKU系统环境配置
4. 验证《部署运维规范》SKU系统部署验证

**如何监控SKU系统？**
- 查看《权限与安全规范》6.5 SKU系统安全监控
- 参考《部署运维规范》SKU系统监控部署
- 配置《错误处理与测试规范》SKU系统错误处理规范

**SKU系统出错怎么办？**
1. 查看《错误处理与测试规范》SKU系统错误处理规范
2. 参考《权限与安全规范》6.5.1 异常行为检测
3. 执行《部署运维规范》SKU系统部署验证
4. 检查《API接口统一规范》6. SKU管理API规范

### 7.4 SKU系统关键字段映射

#### 7.4.1 数据库字段映射

**product_skus表核心字段：**

| 字段名 | 类型 | 说明 | 相关文档 |
|--------|------|------|----------|
| id | VARCHAR(36) | SKU主键ID | 《数据库设计》SKU系统表结构 |
| sku_code | VARCHAR(50) | SKU编号（唯一） | 《业务流程》6.1 SKU生成机制 |
| sku_name | VARCHAR(200) | SKU名称 | 《API接口》6.2 SKU列表查询 |
| finished_product_id | VARCHAR(36) | 关联成品ID | 《数据库设计》SKU系统表结构 |
| material_hash | VARCHAR(64) | 原材料哈希值 | 《业务流程》6.1 SKU生成机制 |
| total_quantity | INT | 总库存数量 | 《API接口》6.3 SKU库存调整 |
| available_quantity | INT | 可用库存数量 | 《业务流程》6.2 SKU库存管理 |
| material_cost | DECIMAL(10,2) | 原材料成本（敏感） | 《权限安全》6.1 SKU查看权限 |
| labor_cost | DECIMAL(10,2) | 人工成本（敏感） | 《权限安全》6.1 SKU查看权限 |
| craft_cost | DECIMAL(10,2) | 工艺成本（敏感） | 《权限安全》6.1 SKU查看权限 |
| total_cost | DECIMAL(10,2) | 总成本（敏感） | 《权限安全》6.1 SKU查看权限 |
| profit_margin | DECIMAL(5,2) | 利润率（敏感） | 《权限安全》6.1 SKU查看权限 |
| total_value | DECIMAL(10,2) | 总价值（敏感） | 《权限安全》6.1 SKU查看权限 |
| status | ENUM | SKU状态 | 《API接口》6.2 SKU列表查询 |
| version | INT | 乐观锁版本号 | 《权限安全》6.3.2 并发操作控制 |

**sku_inventory_logs表核心字段：**

| 字段名 | 类型 | 说明 | 相关文档 |
|--------|------|------|----------|
| id | VARCHAR(36) | 日志主键ID | 《数据库设计》SKU系统表结构 |
| sku_id | VARCHAR(36) | 关联SKU ID | 《数据库设计》SKU系统表结构 |
| action | ENUM | 操作类型 | 《API接口》6.3 SKU库存调整 |
| quantity_change | INT | 数量变更 | 《业务流程》6.2 SKU库存管理 |
| quantity_before | INT | 变更前数量 | 《API接口》6.3 SKU库存调整 |
| quantity_after | INT | 变更后数量 | 《API接口》6.3 SKU库存调整 |
| reason | TEXT | 操作原因 | 《业务流程》6.2 SKU库存管理 |
| user_id | VARCHAR(36) | 操作用户ID | 《权限安全》6.2.2 数据访问审计 |
| created_at | TIMESTAMP | 创建时间 | 《数据库设计》SKU系统表结构 |

#### 7.4.2 API字段映射

**SKU列表查询响应字段：**

| API字段 | 数据库字段 | 权限控制 | 相关文档 |
|---------|------------|----------|----------|
| skuId | id | 所有用户 | 《API接口》6.2 SKU列表查询 |
| skuCode | sku_code | 所有用户 | 《API接口》6.2 SKU列表查询 |
| skuName | sku_name | 所有用户 | 《API接口》6.2 SKU列表查询 |
| totalQuantity | total_quantity | 所有用户 | 《API接口》6.2 SKU列表查询 |
| availableQuantity | available_quantity | 所有用户 | 《API接口》6.2 SKU列表查询 |
| materialCost | material_cost | 仅BOSS | 《权限安全》6.1 SKU查看权限 |
| laborCost | labor_cost | 仅BOSS | 《权限安全》6.1 SKU查看权限 |
| craftCost | craft_cost | 仅BOSS | 《权限安全》6.1 SKU查看权限 |
| totalCost | total_cost | 仅BOSS | 《权限安全》6.1 SKU查看权限 |
| profitMargin | profit_margin | 仅BOSS | 《权限安全》6.1 SKU查看权限 |
| totalValue | total_value | 仅BOSS | 《权限安全》6.1 SKU查看权限 |
| status | status | 所有用户 | 《API接口》6.2 SKU列表查询 |
| createdAt | created_at | 所有用户 | 《API接口》6.2 SKU列表查询 |
| updatedAt | updated_at | 所有用户 | 《API接口》6.2 SKU列表查询 |

#### 7.4.3 前端组件字段映射

**SalesList组件Props：**

| Props字段 | 类型 | 说明 | 相关文档 |
|-----------|------|------|----------|
| skus | ProductSku[] | SKU数据数组 | 《React规范》6.1 SKU数据类型定义 |
| loading | boolean | 加载状态 | 《React规范》6.2 销售列表组件开发 |
| error | string \| null | 错误信息 | 《错误处理》SKU系统错误处理规范 |
| onSkuSelect | (sku: ProductSku) => void | SKU选择回调 | 《React规范》6.2 销售列表组件开发 |
| onInventoryAdjust | (skuId: string, quantity: number) => void | 库存调整回调 | 《React规范》6.2 销售列表组件开发 |
| onSaleRecord | (skuId: string, quantity: number) => void | 销售记录回调 | 《React规范》6.2 销售列表组件开发 |
| userRole | 'BOSS' \| 'EMPLOYEE' | 用户角色 | 《React规范》6.3 SKU权限控制 |

### 7.5 SKU系统常见问题索引

#### 7.5.1 开发问题

**Q: SKU编号重复怎么办？**
A: 查看《业务流程详细规范》6.1 SKU生成机制，SKU编号基于原材料哈希生成，相同原材料组合会生成相同SKU。

**Q: 敏感字段在EMPLOYEE角色下显示怎么办？**
A: 检查《权限与安全规范》6.1 SKU查看权限，确保后端正确过滤敏感字段，前端使用《React前端开发规范》6.3 SKU权限控制。

**Q: SKU库存调整失败怎么办？**
A: 参考《错误处理与测试规范》SKU系统错误处理规范，检查《API接口统一规范》6.3 SKU库存调整接口的参数验证。

**Q: SKU数据不同步怎么办？**
A: 查看《业务流程详细规范》6.5 SKU数据同步和一致性，检查数据库触发器和事务处理。

#### 7.5.2 业务问题

**Q: 什么时候会自动生成SKU？**
A: 查看《业务流程详细规范》6.1 SKU生成和管理，当成品制作完成时自动触发SKU生成。

**Q: SKU库存如何自动更新？**
A: 参考《数据库设计与数据规则》库存自动更新触发器，通过数据库触发器自动维护库存一致性。

**Q: 如何查看SKU变更历史？**
A: 查看《API接口统一规范》6.4 SKU销售记录接口，通过sku_inventory_logs表查询变更历史。

#### 7.5.3 部署问题

**Q: SKU系统部署失败怎么办？**
A: 按照《部署运维规范》SKU系统部署清单逐项检查，确保数据库表、API路由、前端组件都正确部署。

**Q: SKU API无法访问怎么办？**
A: 检查《部署运维规范》SKU API服务部署，确认路由配置和权限中间件正确设置。

**Q: SKU数据库表不存在怎么办？**
A: 执行《数据库设计与数据规则》SKU系统表结构中的创建SQL，确保表结构和索引正确创建。

### 7.6 SKU系统版本更新记录

#### 7.6.1 文档版本历史

| 版本 | 更新日期 | 更新内容 | 影响文档 |
|------|----------|----------|----------|
| v1.0 | 2024-01-22 | 初始版本，完整SKU系统设计 | 全部10个文档 |
| v1.1 | 待定 | 性能优化和安全增强 | 待定 |

#### 7.6.2 功能版本规划

**当前版本 (v1.0) 功能：**
- ✅ SKU自动生成
- ✅ 库存管理和调整
- ✅ 销售记录和追踪
- ✅ 权限控制和数据过滤
- ✅ 基础统计和报表

**计划版本 (v1.1) 功能：**
- 🔄 SKU批量操作
- 🔄 高级筛选和搜索
- 🔄 库存预警自动化
- 🔄 SKU性能分析
- 🔄 移动端优化

**未来版本 (v2.0) 功能：**
- 📋 SKU生命周期管理
- 📋 智能库存预测
- 📋 SKU成本优化建议
- 📋 多仓库SKU管理
- 📋 SKU销售趋势分析

## 七、SKU系统与销售列表重大更新总结（最新阶段性成果）

### 7.1 更新概述

**更新时间：** 2024年1月
**更新范围：** SKU系统全面重构、销售列表页面重建、字段映射修复、数据库架构优化
**主要目标：** 建立完整的SKU库存管理体系，实现销售数据的统一管理和权限控制

### 7.2 SKU系统重大更新

#### 7.2.1 SKU数据结构和字段映射修复

**问题背景：** 后端skus.ts路由返回camelCase字段，前端期望snake_case字段，导致数据显示异常

**解决方案：**
- 引入`convertToApiFormat`工具统一字段转换
- 建立完整的前后端字段映射规范
- 修复所有SKU相关接口的字段对齐问题

**技术实现：**
```typescript
// 后端路由中的字段转换
import { convertToApiFormat } from '../utils/fieldConverter.js'

res.json({
  success: true,
  message: 'SKU列表获取成功',
  data: convertToApiFormat(result)  // 自动转换camelCase到snake_case
})
```

**修复文件：**
- `backend/src/routes/skus.ts`：SKU路由字段转换
- `src/pages/SalesList.tsx`：前端字段对齐
- `src/types/index.ts`：类型定义统一

#### 7.2.2 SKU API接口完善

**新增接口：**
- `GET /api/v1/skus`：SKU列表查询（支持搜索、筛选、分页）
- `GET /api/v1/skus/:id`：SKU详情查询（权限过滤）
- `POST /api/v1/skus/:id/adjust`：SKU库存调整
- `POST /api/v1/skus/:id/sell`：SKU销售记录
- `GET /api/v1/skus/:id/history`：SKU变更历史
- `GET /api/v1/skus/stats/overview`：SKU统计概览

**权限控制：**
- BOSS角色：可查看所有字段，包括成本和利润信息
- EMPLOYEE角色：自动过滤敏感字段（material_cost、labor_cost、craft_cost、total_cost、profit_margin）

**业务规则：**
- SKU编号格式：`SKU + YYYYMMDD + 3位序号`
- 同一原材料组合自动合并为同一SKU
- 价格差异超过5%时记录警告日志
- 库存变更自动记录操作日志

#### 7.2.3 SKU数据库设计规范

**核心表结构：**

**product_skus表：**
- `sku_code`：SKU编号（唯一索引）
- `material_signature_hash`：原材料标识哈希值（8位MD5）
- `material_signature`：原材料标识JSON
- `total_quantity`：总数量
- `available_quantity`：可售数量
- `unit_price`：单价
- `total_value`：总价值
- 成本字段：`material_cost`、`labor_cost`、`craft_cost`、`total_cost`
- `profit_margin`：利润率
- `status`：SKU状态（ACTIVE/INACTIVE）

**sku_inventory_logs表：**
- `action`：操作类型（CREATE/SELL/ADJUST）
- `quantity_change`：数量变化
- `reference_type`：引用类型（PRODUCT/SALE/MANUAL）
- `reference_id`：引用ID
- `notes`：操作备注

**索引优化：**
```sql
CREATE INDEX idx_product_skus_material_hash ON product_skus(material_signature_hash);
CREATE INDEX idx_product_skus_available_qty ON product_skus(available_quantity);
CREATE INDEX idx_sku_logs_sku_id ON sku_inventory_logs(sku_id);
CREATE INDEX idx_sku_logs_created_at ON sku_inventory_logs(created_at DESC);
```

#### 7.2.4 SKU业务流程（从成品制作到SKU生成）

**完整流程：**
1. **成品制作完成** → 生成原材料标识
2. **计算哈希值** → 查找现有SKU
3. **SKU合并判断** → 更新现有SKU或创建新SKU
4. **库存变更记录** → 创建操作日志
5. **成品关联** → 建立成品与SKU的关联关系

**原材料标识生成：**
```typescript
interface MaterialSignature {
  productName: string      // 产品名称
  productType: string      // 产品类型
  quality: string | null   // 品相等级
  beadDiameter: number | null  // 珠子直径
  specification: number | null // 规格
  quantityUsedBeads: number    // 使用珠子数量
  quantityUsedPieces: number   // 使用片/件数量
}
```

### 7.3 销售列表重大更新

#### 7.3.1 销售列表页面全面重构

**架构变更：**
- 从成品管理转向SKU管理
- 实现完整的状态管理架构
- 支持复杂的筛选和搜索功能
- 优化移动端和桌面端体验

**核心状态结构：**
```typescript
interface SalesListState {
  skuList: SkuItem[]           // SKU列表数据
  loading: boolean             // 加载状态
  error: string | null         // 错误信息
  pagination: PaginationInfo   // 分页信息
  filters: FilterOptions       // 筛选条件
  sorting: SortingState        // 排序状态
  columnFilters: ColumnFilters // 列筛选器状态
}
```

#### 7.3.2 SKU展示和管理功能

**展示功能：**
- SKU卡片式布局，支持图片展示
- 库存状态实时显示（有库存/低库存/缺货）
- 权限控制的信息展示
- 响应式设计适配

**管理功能：**
- SKU详情查看
- 库存数量调整
- 销售记录创建
- 变更历史查询

**图片处理：**
```typescript
// 智能图片URL解析
const getFirstPhotoUrl = (photos: any): string | null => {
  // 支持字符串、JSON数组、数组等多种格式
  // 自动使用fixImageUrl处理CORS问题
  // 提供占位图片fallback
}
```

#### 7.3.3 库存状态显示和筛选

**状态分类：**
- **有库存**：available_quantity > 2，绿色标识
- **低库存**：0 < available_quantity ≤ 2，黄色标识
- **缺货**：available_quantity = 0，红色标识

**筛选功能：**
- SKU名称搜索（300ms防抖）
- SKU状态筛选
- 价格范围筛选
- 利润率范围筛选（BOSS权限）
- 创建日期范围筛选

**实时库存监控：**
```typescript
const StockStatusBadge = ({ sku }: { sku: SkuItem }) => {
  const { label, color } = getStockStatus(sku)
  return (
    <span className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${color}`}>
      {label}
    </span>
  )
}
```

#### 7.3.4 权限控制优化

**角色权限矩阵：**

| 字段 | BOSS | EMPLOYEE | 说明 |
|------|------|----------|------|
| sku_code | ✅ | ✅ | SKU编号 |
| sku_name | ✅ | ✅ | SKU名称 |
| unit_price | ✅ | ✅ | 单价 |
| total_quantity | ✅ | ✅ | 总数量 |
| available_quantity | ✅ | ✅ | 可售数量 |
| material_cost | ✅ | ❌ | 原材料成本 |
| labor_cost | ✅ | ❌ | 人工成本 |
| craft_cost | ✅ | ❌ | 工艺成本 |
| total_cost | ✅ | ❌ | 总成本 |
| profit_margin | ✅ | ❌ | 利润率 |

**实现方式：**
- 后端API自动过滤敏感字段
- 前端组件条件渲染
- 双重保护确保数据安全

#### 7.3.5 分页和搜索功能完善

**分页功能：**
- 支持自定义每页数量（默认10条）
- 显示详细的分页信息
- 快速跳转到首页/末页
- 分页状态持久化

**搜索功能：**
- 防抖搜索（300ms延迟）
- 实时搜索结果更新
- 搜索历史记录
- 搜索条件清除功能

**性能优化：**
```typescript
// 搜索防抖Hook
const useDebounce = (value: string, delay: number) => {
  const [debouncedValue, setDebouncedValue] = useState(value)
  
  useEffect(() => {
    const handler = setTimeout(() => {
      setDebouncedValue(value)
    }, delay)
    
    return () => clearTimeout(handler)
  }, [value, delay])
  
  return debouncedValue
}
```

### 7.4 字段映射和API对齐

#### 7.4.1 前后端字段名称统一

**问题分析：**
- 后端使用camelCase命名（skuCode、totalQuantity）
- 前端期望snake_case命名（sku_code、total_quantity）
- 导致数据显示异常和类型错误

**解决方案：**
- 使用`convertToApiFormat`工具统一转换
- 建立完整的字段映射表
- 在所有API响应中应用转换

**字段映射表：**
```typescript
const fieldMapping = {
  skuCode: 'sku_code',
  skuName: 'sku_name',
  unitPrice: 'unit_price',
  totalQuantity: 'total_quantity',
  availableQuantity: 'available_quantity',
  totalValue: 'total_value',
  materialCost: 'material_cost',
  laborCost: 'labor_cost',
  craftCost: 'craft_cost',
  totalCost: 'total_cost',
  profitMargin: 'profit_margin',
  createdAt: 'created_at',
  updatedAt: 'updated_at'
}
```

#### 7.4.2 convertToApiFormat工具的使用

**工具功能：**
- 递归转换对象字段名
- 支持嵌套对象和数组
- 保持数据类型不变
- 处理null和undefined值

**使用示例：**
```typescript
// 在所有SKU相关路由中使用
router.get('/', authenticateToken, asyncHandler(async (req, res) => {
  const result = await getSkuList(params)
  
  res.json({
    success: true,
    message: 'SKU列表获取成功',
    data: convertToApiFormat(result)  // 统一字段转换
  })
}))
```

#### 7.4.3 数据类型安全处理

**类型安全措施：**
- 前端显示时强制数字类型转换
- API响应数据验证
- 防止字符串拼接导致的显示错误

**实现方式：**
```typescript
// 前端数值显示防护
const formatNumber = (value: any): string => {
  return Number(value).toLocaleString()
}

// API数据验证
const validateSkuData = (data: any) => {
  return {
    ...data,
    total_quantity: Number(data.total_quantity || 0),
    available_quantity: Number(data.available_quantity || 0),
    unit_price: Number(data.unit_price || 0)
  }
}
```

### 7.5 数据库架构优化

#### 7.5.1 SKU表的设计和索引优化

**表结构优化：**
- 添加原材料标识哈希值字段，提升查询性能
- 建立完整的成本字段体系
- 支持库存状态和价值计算

**索引策略：**
```sql
-- 核心业务索引
CREATE INDEX idx_product_skus_material_hash ON product_skus(material_signature_hash);
CREATE INDEX idx_product_skus_status ON product_skus(status);
CREATE INDEX idx_product_skus_available_qty ON product_skus(available_quantity);

-- 查询优化索引
CREATE INDEX idx_product_skus_created_at ON product_skus(created_at DESC);
CREATE INDEX idx_product_skus_profit_margin ON product_skus(profit_margin DESC);
CREATE FULLTEXT INDEX idx_product_skus_search ON product_skus(sku_name, description);
```

#### 7.5.2 库存变更日志机制

**日志记录策略：**
- 所有库存变更必须记录日志
- 包含变更前后状态
- 记录操作用户和时间
- 支持引用关联（成品、销售、手动调整）

**日志查询优化：**
```sql
-- 日志查询索引
CREATE INDEX idx_sku_logs_sku_id ON sku_inventory_logs(sku_id);
CREATE INDEX idx_sku_logs_action ON sku_inventory_logs(action);
CREATE INDEX idx_sku_logs_created_at ON sku_inventory_logs(created_at DESC);
```

#### 7.5.3 原材料标识哈希值的使用

**哈希值生成：**
- 使用MD5算法生成32位哈希值
- 取前8位作为标识
- 确保相同原材料组合生成相同哈希值

**业务价值：**
- 快速匹配相同原材料组合
- 支持SKU自动合并
- 提升查询性能
- 简化业务逻辑

**实现代码：**
```typescript
export function generateSkuHash(materialSignature: MaterialSignature[]) {
  const signatureString = JSON.stringify(materialSignature)
  return crypto.createHash('md5').update(signatureString).digest('hex').substring(0, 8)
}
```

### 7.6 技术要点总结

**API层面：**
- 统一字段命名规范（snake_case）
- 完善的权限控制机制
- 数据类型安全处理
- 错误处理和验证

**前端层面：**
- 组件化架构设计
- 状态管理优化
- 响应式布局适配
- 用户体验提升

**数据库层面：**
- 表结构设计优化
- 索引策略完善
- 数据完整性约束
- 查询性能优化

**业务层面：**
- SKU管理流程标准化
- 库存变更追踪机制
- 权限控制体系
- 数据分析支持

### 7.7 业务价值

**管理效率提升：**
- 统一的SKU管理体系
- 自动化的库存合并机制
- 完整的变更历史追踪
- 实时的库存状态监控

**数据准确性保障：**
- 字段映射问题彻底解决
- 数据类型安全处理
- 完整的权限控制
- 审计日志记录

**用户体验优化：**
- 直观的SKU展示界面
- 便捷的搜索筛选功能
- 响应式设计适配
- 流畅的交互体验

**系统可扩展性：**
- 模块化的架构设计
- 标准化的API接口
- 灵活的权限控制
- 完善的错误处理

### 7.8 后续优化方向

**功能扩展：**
- SKU批量操作功能
- 高级统计分析报表
- 库存预警机制
- 销售趋势预测

**性能优化：**
- 数据库查询优化
- 前端渲染性能提升
- 缓存策略优化
- 分页加载优化

**用户体验：**
- 移动端体验优化
- 快捷操作功能
- 个性化设置
- 操作引导优化
- 信息显示更加清晰
- 交互逻辑更加统一

**数据管理优化：**
- CG编号追溯更加准确
- 批次信息显示更加完整
- 权限控制更加严格

**系统稳定性：**
- API字段对齐减少错误
- 数据容错提高健壮性
- 文档同步确保一致性
const [batchFormData, setBatchFormData] = useState<{
  selected_materials: BatchMaterial[]  // 包含product_info的材料
}>()
```

#### 5.5.2 关键UI组件

- **StockIndicator**：库存状态指示器
- **ProductionQuantityInput**：制作数量限制输入框
- **CostDisplay**：成本分析显示组件
- **AutoImageDisplay**：自动图片填充（直接转化）
- **ManualImageUpload**：手动图片上传（组合制作）

### 5.6 业务规则总结

#### 5.6.1 验证规则

**直接转化模式：**
- 图片和规格自动使用原材料信息，无需验证
- 只需验证人工成本、工艺成本、销售价格
- 库存验证按选择数量进行

**组合制作模式：**
- 图片和规格必须手动输入，需要验证
- 需要验证所有原材料的使用量
- 库存验证按每种原材料的使用量进行

#### 5.6.2 成品销毁规则

**库存回滚逻辑：**
1. 删除MaterialUsage记录
2. 剩余库存自动重新计算
3. 无需手动增加库存
4. 记录销毁操作日志
5. 返回详细回滚信息

### 5.7 开发最佳实践

#### 5.7.1 代码组织

- 使用TypeScript严格类型检查
- 组件职责单一，状态管理清晰
- API调用统一错误处理
- 实时计算和验证逻辑

#### 5.7.2 用户体验优化

- 实时库存验证和数量调整
- 自动填充减少用户输入
- 清晰的成本分析显示
- 友好的错误提示和警告
- 响应式设计适配移动端

#### 5.7.3 性能优化

- 防抖处理用户输入
- 批量API调用减少请求
- 组件懒加载和代码分割
- 图片压缩和缓存策略
- 权限配置：`chmod 755 uploads && chown -R www:www uploads`

**测试数据创建规范：**
- 图片URL必须使用环境变量动态生成
- 避免硬编码localhost或特定IP地址
- 确保测试图片文件的完整性和可访问性

### 3.5 预防措施与最佳实践

**开发阶段：**
- 图片上传时进行完整性验证
- 统一使用JSON数组格式存储图片URL
- 测试数据创建时验证图片文件质量
- 确保所有图片URL处理都通过fixImageUrl函数
- 定期检查控制台是否有CORS错误

**部署阶段：**
- 建立图片文件备份机制
- 配置定时完整性检查任务
- 监控图片访问异常和自动修复
- 验证不同环境下的图片URL转换逻辑

**运维阶段：**
- 每日执行图片完整性检查
- 定期清理未使用的图片文件
- 监控图片存储空间使用情况
- 监控图片CORS错误和URL转换日志

## 五、Login页面功能实现总结（最新更新）

### 3.1 已完成的功能模块

| 功能模块             | 实现状态 | 涉及文档 | 关键内容              |
| ---------------- | ---- | ---- | ----------------- |
| **用户认证API**      | ✅ 完成 | 文档02 | 登录、验证、登出接口规范      |
| **前端Login组件**    | ✅ 完成 | 文档04 | React组件、表单验证、状态管理 |
| **useAuth Hook** | ✅ 完成 | 文档04 | 认证状态管理、Token处理    |
| **登录业务流程**       | ✅ 完成 | 文档05 | 完整登录流程、异常处理       |
| **用户数据表**        | ✅ 完成 | 文档03 | users表结构、索引设计     |
| **审计日志**         | ✅ 完成 | 文档03 | audit\_logs表、操作记录 |

### 3.2 技术实现要点

**认证安全：**

* JWT Token认证机制（24小时有效期）

* bcrypt密码加密存储

* 登录操作审计日志记录

* Token自动验证和刷新

**前端交互：**

* 响应式登录界面设计

* 实时表单验证

* 密码显示/隐藏切换

* 加载状态和错误提示

**权限控制：**

* BOSS/EMPLOYEE角色区分

* 基于角色的功能权限控制

* 用户状态管理（激活/禁用）

### 3.3 数据流程图

```mermaid
flowchart LR
    A[Login页面] --> B[useAuth Hook]
    B --> C[认证API]
    C --> D[MySQL数据库]
    D --> E[JWT Token]
    E --> F[本地存储]
    F --> G[权限验证]
    G --> H[页面跳转]
```

### 三、高频问题查询映射（快速定位）

#### 3.1 采购录入页面（完整版）

**关键词：** 采购录入、相机拍照、豆包AI识别、供应商管理、图片上传、表单验证

**相关文档：**

* 文档01：豆包AI解析功能规范、相机功能第三方插件配置

* 文档02：采购创建API接口规范、图片上传接口规范

* 文档03：采购表字段设计、产品类型配置规范

* 文档04：PurchaseEntry组件完整实现、相机功能组件规范

* 文档05：采购录入完整业务流程、AI识别流程

**核心功能模块：**

**1. 相机功能模块：**

* react-html5-camera-photo插件集成

* 浏览器兼容性检查（HTTPS、getUserMedia）

* 开发环境下的宽松模式

* 相机错误边界组件

* 拍照上传处理（dataUri -> Blob -> FormData）

**2. 豆包AI识别模块：**

* 自然语言采购描述解析

* 字段映射规则（camelCase -> snake\_case）

* AI服务配置和错误处理

* 置信度验证和结果处理

* 自动填充表单字段

**3. 供应商管理模块：**

* 供应商列表加载和权限控制

* 防抖搜索和下拉选择

* 新供应商创建流程

* 数据去重和一致性处理

* 输入失焦延迟隐藏

**4. 产品类型和字段管理：**

* 4种产品类型的动态字段配置

* 散珠、手串、饰品配件、成品的验证规则

* 价格计算逻辑（三选二自动计算）

* 单位类型自动映射

**5. 图片上传和处理：**

* react-dropzone文件上传

* 多种格式支持（JPEG、PNG、WEBP）

* Base64图片处理和Blob转换

* 图片URL修复和协议处理

* 文件验证和错误处理

* 本地存储防丢失机制

**6. 状态管理和持久化：**

* 复杂状态管理（uploading、aiParsing、submitting等）

* localStorage防抖保存

* 页面刷新数据恢复

* 错误状态清理和重试机制

| 问题类型              | 具体问题           | 查询文档                                           | 章节位置                      |
| ----------------- | -------------- | ---------------------------------------------- | ------------------------- |
| **用户认证**          | 登录接口参数格式       | 文档02                                           | 2.1.1 用户登录接口详细规范          |
| **用户认证**          | Token验证机制      | 文档02                                           | 2.1.2 Token验证接口           |
| **用户认证**          | 登录组件实现         | 文档04                                           | 3.1 Login页面组件规范           |
| **用户认证**          | useAuth Hook用法 | 文档04                                           | 3.2 useAuth Hook规范        |
| **用户认证**          | 登录业务流程         | 文档05                                           | 2.1 用户登录流程                |
| **用户认证**          | 用户表结构          | 文档03                                           | 3.1 用户表（users）            |
| **接口对接**          | 采购接口参数格式       | 文档02                                           | 2.2 采购管理接口                |
| **接口对接**          | 错误码含义查询        | 文档02                                           | 3.2 错误码统一表                |
| **数据库**           | 采购表字段说明        | 文档03                                           | 三.1 采购表核心字段               |
| **数据库**           | 库存视图 SQL       | 文档03                                           | 1.3 库存视图（inventory\_view） |
| **前端开发**          | 采购录入组件         | 文档04                                           | 四 核心组件实现                  |
| **前端开发**          | 权限控制实现         | 文档04                                           | 3.3 响应式设计规范               |
| **业务流程**          | 采购录入完整流程       | 文档05                                           | 三.1 采购录入流程                |
| **业务流程**          | 库存管理流程         | 文档05                                           | 四.1 库存查询流程                |
| **错误处理**          | 前端错误拦截         | 文档04                                           | 10.3 错误处理                 |
| **权限安全**          | 角色权限矩阵         | 文档03                                           | 三.1.3 用户表字段说明             |
| 采购编号生成规则是什么？      | 数据库设计文档        | 3.3 采购表结构、6.2generate\_purchase\_code 函数       | <br />                    |
| 雇员不能查看哪些字段？       | 权限与安全规范文档      | 1.1 权限矩阵、2.1 敏感字段清单                            | <br />                    |
| 成品销毁后库存如何回滚？      | 业务流程文档         | 6.3 成品销毁流程、数据库事务 SQL                           | <br />                    |
| **图片处理**          | 图片上传失败怎么处理？      | 文档02、文档07        | 2.2.2 图片上传接口、7.1 图片错误类型                       |
| **图片处理**          | 图片显示叉叉如何修复？      | 文档03、文档08        | 1.1.3 图片完整性检查、5.2 批量修复脚本                      |
| **图片处理**          | 图片URL格式规范是什么？    | 文档03、文档08        | 1.1.3 图片存储规范、5.4 环境适配                          |
| **图片处理**          | 如何批量检查图片完整性？     | 文档08             | 5.2 图片完整性检查脚本、定时任务配置                         |
| **图片处理**          | 图片备份策略是什么？       | 文档08             | 5.3 图片备份策略、备份脚本配置                            |
| **图片处理**          | 图片CORS跨域错误如何解决？  | 文档07、文档08        | 7.2.1 图片CORS错误处理、5.5 CORS跨域问题解决方案             |
| **图片处理**          | 生产环境图片在本地无法显示？   | 文档08             | 5.5 CORS跨域问题解决方案、fixImageUrl函数增强               |
| **图片处理**          | 图片URL环境转换如何实现？   | 文档07、文档08        | 7.2.1 图片组件错误处理、5.5 图片URL环境适配                  |
| API 接口前缀是什么？      | API 接口规范文档     | 1.1 基础规范、4.2 后端路由前缀                            | <br />                    |
| 鸿蒙端 Button 如何适配？  | UI/UX 设计规范文档   | 3.1 组件映射表、3.2 事件桥接示例                           | <br />                    |
| 数据库如何自动备份？        | 部署运维规范文档       | 2.1 备份脚本、2.2Crontab 配置                         | <br />                    |
| **采购记录编辑功能**      | <br />         | <br />                                         | <br />                    |
| 采购记录如何编辑？         | 业务流程文档         | 4.8 采购记录编辑业务流程、权限验证流程                          | <br />                    |
| 价格三选二计算逻辑？        | React前端规范文档    | 3.1.1 价格三选二计算逻辑、业务流程文档 4.8.3                   | <br />                    |
| 串数颗数如何计算？         | React前端规范文档    | 3.1.2 串数颗数计算逻辑、业务流程文档 4.8.4                    | <br />                    |
| 建议数值如何显示？         | React前端规范文档    | 3.1.4 建议值显示规范、UI显示规则                           | <br />                    |
| 字段验证规则更新？         | API接口规范文档      | 2.2.2 字段验证规则、数据库设计文档 3.1 字段约束更新                | <br />                    |
| 修改历史如何记录？         | 业务流程文档         | 4.8.7 修改历史记录业务规则、数据库设计文档 edit\_logs表           | <br />                    |
| 编辑权限如何控制？         | 业务流程文档         | 4.8.2 编辑权限验证流程、权限与安全规范文档                       | <br />                    |
| AI识别如何配置和调用？      | 系统架构文档         | 2.3.1 豆包AI配置、API接口规范文档 4.7 AI接口                | <br />                    |
| 网络连接失败如何处理？       | 错误处理规范文档       | 3.3 智能重试机制、API接口规范文档 5.5 网络检测                  | <br />                    |
| 如何在开发环境调试API？     | React前端开发规范文档  | 2.4 调试工具组件、系统架构文档 2.4 调试工具配置                   | <br />                    |
| 阿里云部署如何配置？        | 部署运维规范文档       | 3.1 宝塔面板配置、3.2 安全组配置、3.3 域名解析配置                | <br />                    |
| 手机端如何访问API？       | 部署运维规范文档       | 5.2 手机端测试配置、5.1 动态IP检测配置                       | <br />                    |
| 供应商权限如何控制？        | 权限与安全规范文档      | 3.1.2 供应商功能权限控制、3.2.2 供应商API权限验证               | <br />                    |
| 供应商选择功能如何实现？      | React前端开发规范文档  | 2.2 供应商选择逻辑、2.4.2 供应商调试工具                      | <br />                    |
| 供应商API接口有哪些？      | API接口规范文档      | 2.5 供应商管理接口、2.5.4 供应商调试端点                      | <br />                    |
| 供应商数据一致性如何保证？     | 业务流程详细规范文档     | 3.2.3 供应商数据一致性验证流程                             | <br />                    |
| 供应商调试功能如何使用？      | React前端开发规范文档  | 2.4.2 供应商调试工具、错误处理与测试规范文档 4.2.3 供应商调试端点        | <br />                    |
| 供应商管理流程是什么？       | 业务流程详细规范文档     | 1.4.1 供应商权限验证流程、3.1.1 供应商权限验证流程                | <br />                    |
| 供应商功能测试如何验证？      | 错误处理与测试规范文档    | 4.2.4 供应商功能测试验证                                | <br />                    |
| 供应商错误码有哪些？        | API接口规范文档      | 3.2 错误码表（DUPLICATE\_SUPPLIER\_NAME等）           | <br />                    |
| **采购记录删除功能**      | <br />         | <br />                                         | <br />                    |
| 采购记录如何安全删除？       | 业务流程文档         | 3.2 采购记录删除流程、业务约束验证流程                          | <br />                    |
| 删除权限如何控制？         | API接口规范文档      | 2.2.1 采购删除接口详细规范、权限验证规则                        | <br />                    |
| 业务约束冲突如何处理？       | 错误处理规范文档       | 1.2 业务约束错误响应示例、BUSINESS\_CONSTRAINT\_VIOLATION | <br />                    |
| 删除确认对话框如何实现？      | React前端规范文档    | 8.1.1 删除确认对话框设计、UI组件结构                         | <br />                    |
| 如何避免重复错误提示？       | React前端规范文档    | 8.2.1 避免重复错误提示、错误处理最佳实践                        | <br />                    |
| 成品使用珠子时如何提示？      | 业务流程文档         | 3.2.4 业务约束冲突异常处理、友好错误提示设计                      | <br />                    |
| 删除操作如何记录日志？       | 业务流程文档         | 3.2.3 数据完整性规则、审计日志记录规范                         | <br />                    |
| 删除API接口规范是什么？     | API接口规范文档      | 2.2.1 采购删除接口详细规范、响应数据结构                        | <br />                    |
| 删除错误码有哪些？         | 错误处理规范文档       | 1.1 错误类型枚举（PURCHASE\_DELETE\_FAILED等）          | <br />                    |
| AI功能如何配置和使用？      | 系统架构文档         | 2.1 豆包AI配置与服务规范、API接口规范文档 2.4 AI智能服务接口         | <br />                    |
| AI解析采购描述如何实现？     | React前端开发规范文档  | 2.2 AI识别调用实现、2.4 AI服务类完整实现规范                   | <br />                    |
| 智能助理功能如何使用？       | API接口规范文档      | 2.4.3 智能助理对话接口、2.4.4 业务洞察分析接口                  | <br />                    |
| AI服务健康检查如何实现？     | 系统架构文档         | 2.1.6 AI服务错误处理策略、API接口规范文档 2.4.2 健康检查接口        | <br />                    |
| AI权限控制如何配置？       | 系统架构文档         | 2.1.5 AI功能权限控制、权限与安全规范文档 1.1 权限矩阵              | <br />                    |
| AI解析结果如何验证？       | React前端开发规范文档  | 2.4 validateAIParseResult工具函数、字段映射规则           | <br />                    |
| AI调试功能如何使用？       | React前端开发规范文档  | 2.5 调试工具组件、window\.apiDebug.testAI()方法         | <br />                    |
| 字段命名规范是什么？        | API接口统一规范文档    | 6.1 命名规范定义、6.2 字段转换机制                          | <br />                    |
| 批量转换工具如何安全使用？     | 错误处理与测试规范文档    | 5.1 批量转换教训总结、5.3 安全转换流程                        | <br />                    |
| 哪些内容禁止批量转换？       | 错误处理与测试规范文档    | 5.2 绝对禁止转换清单、5.4 智能识别机制                        | <br />                    |
| 转换工具使用流程是什么？      | 部署运维规范文档       | 6.1 批量转换工具使用规范、6.2 代码质量保证机制                    | <br />                    |
| **成品制作功能（重要更新）**  | <br />         | <br />                                         | <br />                    |
| 成品制作成本如何计算？       | 业务流程文档         | 3.1 成品制作成本计算业务规则、成本计算核心公式                     | <br />                    |
| 利润率计算公式是什么？       | React前端规范文档    | 7.2 利润率计算和显示、calculateProfitMargin函数            | <br />                    |
| 直接转化模式如何工作？       | 业务流程文档         | 3.2 直接转化模式业务流程、自动化特点                          | <br />                    |
| 组合制作模式如何工作？       | 业务流程文档         | 3.3 组合制作模式业务流程、精确控制特点                         | <br />                    |
| 成本计算API如何调用？       | API接口规范文档      | 4.3 成本计算预估接口、POST /products/cost                | <br />                    |
| 原材料成本如何计算？        | 业务流程文档         | 3.1 原材料成本计算规则、pricePerBead vs pricePerPiece      | <br />                    |
| 成本汇总组件如何实现？       | React前端规范文档    | 7.3 成本汇总组件、CostSummary组件实现                    | <br />                    |
| 实时成本计算如何实现？       | React前端规范文档    | 7.1 成本计算核心函数、calculateCost API调用               | <br />                    |
| 批量成品成本如何管理？       | React前端规范文档    | 7.5 直接转化模式成本处理、updateBatchProduct函数           | <br />                    |
| 成品制作API接口有哪些？     | API接口规范文档      | 4.1 组合制作、4.2 直接转化、4.3 成本计算、4.5 成品销毁           | <br />                    |
| SKU成本字段如何设计？       | 数据库设计文档        | 2.2 SKU主表、material_cost/labor_cost/craft_cost字段  | <br />                    |
| 成品表字段如何设计？        | 数据库设计文档        | 2.2 成品表、unit_price(销售价格)/total_value(总成本价)     | <br />                    |
| **成品销售功能**        | <br />         | <br />                                         | <br />                    |
| 成品销售流程是什么？        | 业务流程文档         | 10.1 成品销售流程、10.1.1 销售操作流程                      | <br />                    |
| 销售记录如何创建？         | API接口规范文档      | 7.4 成品销售接口详细规范、8.1 销售记录接口清单                    | <br />                    |
| 销售编号生成规则是什么？      | 数据库设计文档        | 1.4 销售编号生成规则、API接口规范文档 9.2 销售编号生成规则            | <br />                    |
| 销售利润如何计算？         | 业务流程文档         | 10.1.2 销售数据计算规则、API接口规范文档 9.1 成本计算规则           | <br />                    |
| 销售记录如何查询？         | API接口规范文档      | 8.2 销售记录查询接口详细规范、8.3 销售统计分析接口                  | <br />                    |
| 销售权限如何控制？         | API接口规范文档      | 9.3 权限控制规则、业务流程文档 10.2.1 销售记录查询流程              | <br />                    |
| 销售记录如何修改？         | 业务流程文档         | 10.2.2 销售记录修改流程、API接口规范文档 8.1 销售记录接口清单         | <br />                    |
| 销售记录如何删除？         | 业务流程文档         | 10.4 销售记录删除流程、10.4.1 删除权限和约束                   | <br />                    |
| 销售统计如何分析？         | API接口规范文档      | 8.3 销售统计分析接口、业务流程文档 10.3 销售统计分析流程              | <br />                    |
| 成品状态如何变更？         | 业务流程文档         | 9.3.1 成品状态管理、API接口规范文档 9.2 成品状态变更规则            | <br />                    |
| **数据库设计相关**       | <br />         | <br />                                         | <br />                    |
| MaterialUsage表结构？ | 数据库设计文档        | 1.3 原材料使用记录表（material\_usage）核心字段              | <br />                    |
| 销售记录表结构是什么？       | 数据库设计文档        | 1.4 销售记录数据结构设计、5.3 销售记录表DDL                    | <br />                    |
| 成品制作数据流转规则？       | 数据库设计文档        | 3.1 成品制作流程数据变更、3.2 库存计算规则                      | <br />                    |
| 成品销售数据更新规则？       | 数据库设计文档        | 4.1 销售记录创建流程、4.2 成本和利润计算                       | <br />                    |
| 外键约束如何配置？         | 数据库设计文档        | 1.3 外键约束配置、1.3 数据完整性保证                         | <br />                    |
| **错误处理相关**        | <br />         | <br />                                         | <br />                    |
| 成品制作错误码有哪些？       | API接口规范文档      | 10.2 业务错误码定义、FinishedProductErrors             | <br />                    |
| 销售记录错误码有哪些？       | API接口规范文档      | 10.2 业务错误码定义、SalesRecordErrors                 | <br />                    |
| 库存不足如何处理？         | API接口规范文档      | 9.1 库存充足性验证、业务流程文档 9.2.2 数据验证规则                | <br />                    |
| 成品制作失败如何回滚？       | 数据库设计文档        | 3.1 成品制作流程数据变更、事务处理机制                          | <br />                    |
| **库存仪表盘功能**       | <br />         | <br />                                         | <br />                    |
| 库存仪表盘有哪些功能？       | 业务流程文档         | 4.7 库存仪表盘流程、4.7.3 仪表盘核心功能模块                    | <br />                    |
| 库存统计API如何调用？      | API接口规范文档      | 2.3.1 库存统计接口详细规范、响应数据结构                        | <br />                    |
| 产品分布图表如何实现？       | 业务流程文档         | 4.7.3 产品分布饼图模块、颜色配置规范                          | <br />                    |
| 价格分布分析如何配置？       | API接口规范文档      | 2.3.3 价格分布接口详细规范、价格区间定义                        | <br />                    |
| 库存消耗分析如何使用？       | 业务流程文档         | 4.2 核心业务逻辑、消耗统计规则、数据类型处理                      | API文档 2.3.4、前端文档 5.7.4 |
| 消耗分析数据类型错误如何解决？   | 文档总览索引文档       | 3.2 数据类型问题解决方案、Number()强制转换规范                   | 业务流程文档 4.2、API文档 2.3.4 |
| 消耗分析显示"161"而不是"17"？ | 文档总览索引文档       | 3.1 问题根源分析、字符串拼接vs数字相加                        | 前端文档 5.7.4、数据库文档 1.3 |
| 消耗分析时间范围如何选择？     | 前端开发规范文档       | 5.7.4 时间范围配置、TIME_RANGES常量定义                   | API文档 2.3.4            |
| 消耗分析权限如何控制？       | API接口规范文档      | 2.3.4 权限过滤规则、EMPLOYEE角色supplier_name过滤           | 前端文档 5.7.4            |
| 消耗分析SQL查询如何优化？    | 数据库设计文档        | 1.3 库存消耗分析SQL查询规范、CAST类型转换                     | <br />                    |
| 仪表盘权限如何控制？        | 业务流程文档         | 4.7.4 权限控制与数据过滤、敏感字段清单                         | <br />                    |
| 低库存预警规则是什么？       | 业务流程文档         | 4.7.6 仪表盘业务规则、低库存预警规则                          | <br />                    |
| 仪表盘数据如何刷新？        | 业务流程文档         | 4.7.5 数据刷新与缓存策略、自动刷新机制                         | <br />                    |
| 库存价格区间如何定义？       | API接口规范文档      | 2.3.3 价格区间定义（成品）、价格范围说明                        | <br />                    |
| 仪表盘图表如何交互？        | 业务流程文档         | 4.7.3 图表交互功能、事件处理逻辑                            | <br />                    |
| **成品制作功能**        | <br />         | <br />                                         | <br />                    |
| 成品制作概念如何理解？       | 业务流程文档         | 7.1.1 重要概念区分、原材料成品vs销售成品                       | <br />                    |
| 成品制作有哪些模式？        | 业务流程文档         | 7.1.2 成品制作两种模式、直接转化批量创建vs组合制作                  | <br />                    |
| 直接转化批量创建流程？       | 业务流程文档         | 7.2.2 直接转化模式流程、多选原材料批量信息填写                     | <br />                    |
| 组合制作流程是什么？        | 业务流程文档         | 7.2.2 组合制作模式流程、多种原材料组合制作                       | <br />                    |
| 成品制作成本如何计算？       | 业务流程文档         | 7.2.4 成本计算业务规则、材料+人工+工艺成本                      | <br />                    |
| 销售成品如何管理？         | 业务流程文档         | 7.3 销售成品管理流程、状态管理和列表展示                         | <br />                    |
| 成品销毁如何回滚库存？       | 业务流程文档         | 7.5 成品销毁流程、库存回滚逻辑和事务处理                         | <br />                    |
| 成品制作数据表结构？        | 数据库设计文档        | 1.2 成品表（products）、1.3 原材料使用记录表                 | <br />                    |
| 原材料使用记录如何存储？      | 数据库设计文档        | 1.3 原材料使用记录表、库存扣减和成本追踪                         | <br />                    |
| 成品制作API接口有哪些？     | API接口规范文档      | 2.6 成品制作管理接口、创建/批量创建/查询/销毁接口                   | <br />                    |
| 批量创建成品API如何调用？    | API接口规范文档      | 2.6.2 批量创建销售成品接口、直接转化模式专用                      | <br />                    |
| 可用原材料如何查询？        | API接口规范文档      | 2.6.3 获取可用原材料接口、库存验证和筛选逻辑                      | <br />                    |
| 成品制作组件如何实现？       | React前端规范文档    | 6.1 ProductEntry组件、制作流程和状态管理                   | <br />                    |
| 批量信息填写组件如何设计？     | React前端规范文档    | 6.1.4 BatchProductEditor组件、批量编辑和成本计算           | <br />                    |
| 成品展示组件如何设计？       | React前端规范文档    | 6.2 FinishedProductGrid组件、成品列表和详情展示            | <br />                    |
| 成品制作权限如何控制？       | React前端规范文档    | 6.2.4 权限控制实现、敏感信息过滤规范                          | <br />                    |
| 成品状态如何管理？         | React前端规范文档    | 6.2.3 成品状态管理、可售/已售/预留状态切换                      | <br />                    |

### 四、高频问题查询映射（重要更新）

| 问题类型             | 关键词                                    | 对应文档章节                           | 快速定位               |
| ---------------- | -------------------------------------- | -------------------------------- | ------------------ |
| **采购列表搜索功能（新增）** | <br />                                 | <br />                           | <br />             |
| 采购编号搜索如何实现？      | 采购编号搜索、purchase_code_search、模糊匹配        | 《API接口规范文档》3.1、《业务流程文档》1.1        | 采购编号搜索API规范       |
| 搜索筛选器如何配置？       | 筛选器、renderColumnFilter、搜索类型            | 《React前端规范文档》3.1、《业务流程文档》1.1     | 筛选器渲染函数           |
| 搜索状态如何管理？        | 搜索状态、purchaseCodeSearch、filters         | 《React前端规范文档》3.1、《业务流程文档》1.1     | PurchaseList状态管理   |
| 搜索API如何调用？        | fetchPurchases、搜索参数、API调用              | 《API接口规范文档》3.1、《React前端规范文档》3.2  | 搜索API调用规范        |
| **拼音排序功能（新增）**   | <br />                                 | <br />                           | <br />             |
| 拼音排序如何实现？        | 拼音排序、sortByPinyin、首字母映射               | 《React前端规范文档》2.1、《业务流程文档》2.1     | 拼音排序工具函数         |
| 蜜蜡镀金排序问题如何解决？    | 蜜蜡、镀金、拼音映射、排序错误                        | 《业务流程文档》2.3、《React前端规范文档》2.1     | 拼音映射表维护          |
| 配饰排序如何统一？        | 配饰排序、AccessoriesProductGrid、A-Z排序      | 《React前端规范文档》2.2、《业务流程文档》2.1     | 组件排序使用规范         |
| 拼音映射表如何维护？       | 拼音映射表、PINYIN_MAPPINGS、字符映射            | 《React前端规范文档》2.1、《业务流程文档》2.2     | 映射表维护规则          |
| **数据类型处理（重要）**   | <br />                                 | <br />                           | <br />             |
| 数值显示错误如何解决？      | 数值类型、字符串拼接、Number转换                    | 《业务流程文档》4.1、《API接口规范文档》9.1      | 数值类型安全处理         |
| purchase_code字段如何添加？ | purchase_code、字段添加、类型定义               | 《数据库设计文档》2.1、《React前端规范文档》1.1   | 字段一致性保证          |
| TypeScript错误如何修复？   | TypeScript错误、属性不存在、类型定义               | 《React前端规范文档》4.1、《业务流程文档》5.1     | 错误修复流程           |
| **成品制作CG编码（修复）** | <br />                                 | <br />                           | <br />             |
| CG编码映射错误如何解决？     | CG编码、类型映射、PRODUCT_TYPE_MAPPING         | 《业务流程文档》3.1、《React前端规范文档》1.1     | 类型映射规则更新         |
| 成本计算异常如何处理？      | 成本计算、类型识别、costCalculation              | 《业务流程文档》3.1、《API接口规范文档》4.1      | 成本计算逻辑修复         |
| **采购记录编辑功能**     | <br />                                 | <br />                           | <br />             |
| 编辑权限控制           | 编辑权限、BOSS角色、权限验证、编辑按钮                  | 《权限与安全规范文档》1.1、《业务流程文档》3.3.2     | 仅BOSS角色可编辑         |
| 编辑模式初始化          | 编辑模式、字段初始化、产品类型、editData               | 《React前端规范文档》4.1.2、《业务流程文档》3.3.3 | 根据产品类型动态初始化        |
| 字段变更检测           | 字段变更、updateData、变更检测、字段映射              | 《React前端规范文档》4.1.3、《业务流程文档》3.3.4 | 实时检测字段变化           |
| 编辑API接口          | PUT接口、采购更新、字段验证、权限验证                   | 《API接口规范文档》2.2.2、《业务流程文档》3.3.5   | 采购记录更新接口规范         |
| 修改历史记录           | 修改历史、EditLog、变更详情、历史显示                 | 《数据库设计文档》3.9、《业务流程文档》3.3.7       | edit\_logs表设计和显示   |
| 派生字段计算           | 派生字段、total\_beads、自动计算、优先级             | 《API接口规范文档》2.2.2、《业务流程文档》3.3.6   | 自动计算业务逻辑           |
| 编辑错误处理           | 编辑错误、权限不足、验证失败、错误提示                    | 《错误处理与测试规范文档》1.2、《业务流程文档》3.3.9   | 编辑功能错误处理策略         |
| **价格计算架构变更（重要）** | <br />                                 | <br />                           | <br />             |
| 价格计算架构变更         | 前端计算、后端存储、架构变更、价格字段                    | 《系统架构文档》1.4、《数据库设计文档》1.1.2       | 从前端计算改为后端存储的重要架构变化 |
| 单颗价格存储           | pricePerBead、每颗价格、后端计算、数据库存储           | 《数据库设计文档》1.1.2、《API接口规范文档》2.2.1  | 每颗价格现在后端计算并存储      |
| 单片价格存储           | pricePerPiece、每片价格、饰品配件、成品             | 《数据库设计文档》1.1.2、《业务流程文档》3.3.6     | 每片/件价格后端计算逻辑       |
| 单价字段存储           | unitPrice、通用单价、所有产品类型                  | 《数据库设计文档》1.1.2、《API接口规范文档》2.2.1  | 通用单价字段计算规则         |
| 价格计算时机           | 录入时计算、更新时计算、数据迁移                       | 《API接口规范文档》2.2.1、《业务流程文档》3.3.6   | 价格字段计算的触发时机        |
| 计算字段精度           | DECIMAL精度、4位小数、1位小数                    | 《数据库设计文档》1.1.2、《系统架构文档》1.4       | 不同价格字段的精度规范        |
| 架构优势说明           | 数据一致性、性能提升、查询效率                        | 《系统架构文档》1.4、《业务流程文档》3.3.6        | 新架构的优势和改进点         |
| **采购列表核心功能**     | <br />                                 | <br />                           | <br />             |
| 表头筛选功能           | 表头筛选、筛选面板、位置计算、Portal                  | 《React前端规范文档》4.1-4.7             | 6种筛选类型、位置计算、外部关闭   |
| 多维度筛选            | 产品类型筛选、品相筛选、供应商筛选                      | 《API接口规范文档》2.2.1、《业务流程文档》3.2.4   | 多选、null处理、全选状态     |
| 智能排序功能           | 规格排序、数量排序、克价排序、动态字段                    | 《数据库设计文档》1.2.2、《业务流程文档》3.2.5     | 原生SQL、动态字段选择       |
| 跨页筛选保持           | 跨页筛选、localStorage、状态保持                 | 《React前端规范文档》4.6、《业务流程文档》3.2.6   | 筛选状态持久化            |
| 权限控制筛选           | 权限控制、敏感字段、BOSS、EMPLOYEE                | 《API接口规范文档》2.2.1、《业务流程文档》3.2.7   | 价格字段权限过滤           |
| **筛选参数映射**       | <br />                                 | <br />                           | <br />             |
| 规格筛选逻辑           | 规格筛选、specification、bead\_diameter、动态查询 | 《API接口规范文档》2.2.1、《数据库设计文档》1.2.3  | 同时查询两个字段           |

### 五、SKU系统与销售列表重大更新总结（新增）

### 5.1 SKU系统数据结构

**核心表结构：**
- `product_skus`表：SKU主表，包含编号、名称、原材料哈希值、数量、成本、价格、利润率等字段
- `sku_inventory_logs`表：SKU库存变更日志，记录所有库存操作、数量变化、引用类型等
- `products`表更新：添加`sku_id`字段关联SKU系统

**SKU编号规则：**
- 格式：`SKU + YYYYMMDD + 3位序号`
- 示例：`SKU202501011001`
- 基于原材料标识哈希值自动合并相同配方的成品

**原材料标识生成：**
- JSON格式存储原材料组合信息
- MD5哈希值（8位）用于快速匹配
- 支持成品自动合并到相同SKU

### 5.2 API接口实现

**SKU管理接口：**
- `GET /api/v1/skus` - 获取SKU列表（支持分页、搜索、状态筛选）
- `GET /api/v1/skus/:id` - 获取SKU详情（权限控制敏感字段）
- `POST /api/v1/skus/:id/adjust` - 调整SKU库存数量
- `POST /api/v1/skus/:id/sell` - 销售SKU（减少可售数量）
- `GET /api/v1/skus/:id/history` - 获取SKU库存变更历史
- `GET /api/v1/skus/stats/overview` - 获取SKU统计信息

**字段映射和API对齐：**
- 后端使用`convertToApiFormat`统一字段转换
- 前端使用snake_case字段命名规范
- 权限控制：EMPLOYEE角色过滤成本和利润率字段

### 5.3 数据库架构优化

**索引设计：**
- `materialSignatureHash`索引：快速查找相同配方SKU
- `skuCode`唯一索引：确保SKU编号唯一性
- `status`索引：支持状态筛选查询
- `createdAt`索引：支持时间排序

**数据完整性：**
- SKU状态枚举：`ACTIVE`（活跃）、`INACTIVE`（停用）
- 库存操作类型：`CREATE`（创建）、`SELL`（销售）、`ADJUST`（调整）
- 引用类型：`PRODUCT`（成品）、`SALE`（销售）、`MANUAL`（手动）

### 5.4 销售列表重构

**组件架构：**
- 完全重构`SalesList.tsx`组件，从成品列表转换为SKU列表
- 实现SKU数据类型定义和状态管理
- 支持SKU搜索、筛选、排序功能

**核心功能：**
- SKU列表展示：编号、名称、库存数量、状态、价格、利润率
- 权限控制：BOSS角色可见价格和利润率，EMPLOYEE角色隐藏
- 图片处理：支持JSON数组格式图片显示和预览
- 库存状态：可售数量和总数量分别显示

**交互功能：**
- 表头筛选：SKU名称搜索、状态多选筛选
- 排序功能：支持单价、利润率、创建日期排序
- 详情查看：SKU详情弹窗和编辑功能
- 销售操作：标记已售出功能

### 5.5 字段映射和API对齐

**前后端字段映射：**
```typescript
// 前端期望字段（snake_case）
interface SkuItem {
  id: string
  sku_code: string
  sku_name: string
  unit_price: number
  total_quantity: number
  available_quantity: number
  profit_margin?: number
  status: 'ACTIVE' | 'INACTIVE'
  created_at: string
  photos?: string[]
}

// 后端数据库字段（camelCase）
model ProductSku {
  id: String
  skuCode: String
  skuName: String
  unitPrice: Decimal
  totalQuantity: Int
  availableQuantity: Int
  profitMargin?: Decimal
  status: SkuStatus
  createdAt: DateTime
  photos?: Json
}
```

**字段转换处理：**
- 后端使用`convertToApiFormat`函数统一转换
- 前端使用`fieldConverter.ts`工具进行验证
- 确保API响应格式符合snake_case规范

### 5.6 权限控制实现

**角色权限矩阵：**
| 字段 | BOSS | EMPLOYEE |
|------|------|----------|
| SKU基本信息 | ✅ | ✅ |
| 库存数量 | ✅ | ✅ |
| 单价 | ✅ | ❌ |
| 成本信息 | ✅ | ❌ |
| 利润率 | ✅ | ❌ |
| 销售操作 | ✅ | ❌ |

**实现方式：**
- 后端API根据用户角色过滤敏感字段
- 前端使用`PermissionWrapper`组件控制UI显示
- 确保数据安全和权限隔离

### 5.7 图片处理和显示

**图片数据格式：**
- 数据库存储：JSON数组格式`["url1", "url2"]`
- 前端处理：支持字符串和数组两种格式解析
- URL修复：使用`fixImageUrl`函数处理CORS和协议问题

**图片显示功能：**
- 缩略图展示：12x12像素圆角图片
- 图片预览：点击放大查看
- 错误处理：显示默认包装图标
- 环境适配：开发环境自动转换URL

### 5.8 分页和搜索功能

**分页实现：**
- 支持页码导航和页面大小配置
- 显示总记录数和当前页信息
- 响应式设计适配移动端

**搜索功能：**
- SKU编号和名称模糊搜索
- 防抖处理优化性能
- 实时搜索结果更新

### 5.9 库存状态显示

**状态标识：**
- 活跃状态：绿色标签显示
- 停用状态：灰色标签显示
- 库存数量：可售/总计双重显示

**业务规则：**
- 可售数量为0时禁用销售操作
- 停用状态SKU不显示销售按钮
- 库存调整需要管理员权限

### 5.10 错误处理和加载状态

**错误处理：**
- API请求失败显示友好错误信息
- 网络异常自动重试机制
- 数据格式错误防护处理

**加载状态：**
- 列表加载显示骨架屏
- 操作按钮显示加载动画
- 分页切换平滑过渡

### 5.11 SKU API集成

**前端API服务：**
```typescript
export const skuApi = {
  list: (params) => apiClient.get(`/skus${buildQueryString(params)}`),
  get: (id) => apiClient.get(`/skus/${id}`),
  adjustQuantity: (id, data) => apiClient.post(`/skus/${id}/adjust`, data),
  sell: (id, data) => apiClient.post(`/skus/${id}/sell`, data),
  getHistory: (id, params) => apiClient.get(`/skus/${id}/history${buildQueryString(params)}`),
  getStats: () => apiClient.get('/skus/stats/overview')
}
```

**后端路由实现：**
- 使用Express Router模块化路由
- 集成认证中间件和错误处理
- 支持参数验证和数据转换

### 5.12 技术要点总结

**核心技术栈：**
- 后端：Node.js + Express + Prisma + MySQL
- 前端：React + TypeScript + Tailwind CSS
- 数据库：MySQL 8.0+ 支持JSON字段

**关键技术实现：**
- SKU哈希算法：MD5生成8位唯一标识
- 字段转换：统一的camelCase到snake_case转换
- 权限控制：基于角色的字段过滤
- 图片处理：多格式支持和CORS处理
- 状态管理：React Hooks + 本地状态

### 5.13 业务价值

**库存管理优化：**
- 相同配方成品自动合并，减少重复SKU
- 精确的库存数量跟踪和历史记录
- 支持批量库存调整和销售记录

**数据分析支持：**
- SKU级别的销售统计和趋势分析
- 成本和利润率精确计算
- 库存周转率和热销产品识别

**用户体验提升：**
- 直观的SKU列表展示和操作
- 响应式设计支持移动端使用
- 实时搜索和筛选功能

### 5.14 后续优化方向

**功能扩展：**
- SKU批量操作功能
- 库存预警和自动补货
- SKU销售趋势分析
- 成本优化建议

**性能优化：**
- 大数据量分页优化
- 图片懒加载和缓存
- API响应时间优化
- 数据库查询性能调优

**用户体验：**
- SKU二维码生成和扫描
- 移动端专用界面优化
- 离线数据同步支持
- 多语言国际化支持

## 六、库存查询多视图功能映射（新增）

| 问题类型           | 关键词                                                       | 对应文档章节                           | 快速定位                          |
| -------------- | --------------------------------------------------------- | -------------------------------- | ----------------------------- |
| **库存查询总体架构**   | <br />                                                    | <br />                           | <br />                        |
| 多视图切换          | 视图切换、层级式、分组、配件、成品、仪表盘                                     | 《React前端规范文档》5.1、《业务流程文档》4.1     | 5种视图类型切换逻辑                    |
| 库存API接口        | 库存接口、hierarchical、grouped、accessories、finished、statistics | 《API接口规范文档》2.3、《业务流程文档》4.1.2     | 4个新增库存API接口                   |
| 筛选状态管理         | 筛选状态、跨视图保持、localStorage、状态同步                              | 《React前端规范文档》5.7、《业务流程文档》4.7     | 筛选条件跨视图保持                     |
| **层级式库存视图**    | <br />                                                    | <br />                           | <br />                        |
| 树形结构展示         | 树形结构、节点展开、层级导航、HierarchicalNode                           | 《React前端规范文档》5.2、《业务流程文档》4.2     | 4层树形结构设计                      |
| 节点状态管理         | 节点状态、展开折叠、expanded、children                               | 《React前端规范文档》5.2、《业务流程文档》4.2.2   | 节点交互逻辑                        |
| 层级数据结构         | 数据层级、产品类型、品相、供应商、库存项目                                     | 《API接口规范文档》2.3.1、《业务流程文档》4.2.3   | 4层数据结构定义                      |
| **分组库存列表**     | <br />                                                    | <br />                           | <br />                        |
| 动态分组功能         | 动态分组、GROUP BY、分组统计、GroupedData                            | 《React前端规范文档》5.3、《业务流程文档》4.3     | 3种分组方式配置                      |
| 分组配置规范         | 分组配置、product\_type、quality、supplier\_name                 | 《API接口规范文档》2.3.2、《业务流程文档》4.3.3   | 分组字段和统计信息                     |
| 分组统计信息         | 分组统计、total\_quantity、total\_value、item\_count             | 《React前端规范文档》5.3、《业务流程文档》4.3.2   | 分组内统计计算                       |
| **半成品矩阵视图**    | <br />                                                    | <br />                           | <br />                        |
| 矩阵布局展示         | 矩阵视图、SemiFinishedMatrixView、按尺寸、按品相                       | 《React前端规范文档》5.5、《业务流程文档》4.4     | 2种矩阵模式切换                      |
| 矩阵数据结构         | 矩阵数据、MatrixCell、散珠手串、库存状态                                 | 《API接口规范文档》2.3.1、《业务流程文档》4.4.3   | 矩阵单元格数据定义                     |
| 库存状态编码         | 状态颜色、低库存、中等库存、充足库存                                        | 《React前端规范文档》5.5、《业务流程文档》4.4.3   | 红黄绿三色编码规则                     |
| 产品筛选功能         | 产品筛选、搜索关键词、产品选择、筛选应用                                      | 《React前端规范文档》5.5、《业务流程文档》4.4.2   | 矩阵数据筛选机制                      |
| **饰品配件专用视图**   | <br />                                                    | <br />                           | <br />                        |
| 配件网格布局         | 配件网格、AccessoriesProductGrid、卡片布局                          | 《React前端规范文档》5.4、《业务流程文档》4.5     | 网格布局和卡片设计                     |
| 配件筛选功能         | 配件筛选、材质筛选、规格查询、category                                   | 《API接口规范文档》2.3.3、《业务流程文档》4.5.2   | 配件专用筛选器                       |
| 配件数据结构         | 配件数据、AccessoryItem、材质、规格、分类                               | 《React前端规范文档》5.4、《业务流程文档》4.5.3   | 配件字段定义                        |
| **成品卡片视图**     | <br />                                                    | <br />                           | <br />                        |
| 成品卡片布局         | 成品卡片、FinishedProductGrid、利润展示                             | 《React前端规范文档》5.6、《业务流程文档》4.6     | 卡片式成品展示                       |
| 成品状态管理         | 成品状态、available、sold、reserved、状态筛选                         | 《API接口规范文档》2.3.4、《业务流程文档》4.6.2   | 3种成品状态管理                      |
| 利润计算显示         | 利润计算、cost、selling\_price、profit\_margin                   | 《React前端规范文档》5.6、《业务流程文档》4.6.3   | 成本利润计算逻辑                      |
| 材料追溯功能         | 材料追溯、MaterialUsage、材料清单、quantity\_used                    | 《API接口规范文档》2.3.4、《业务流程文档》4.6.3   | 成品材料组成追溯                      |
| **库存仪表盘**      | <br />                                                    | <br />                           | <br />                        |
| 统计数据展示         | 统计数据、DashboardStatistics、指标卡片                             | 《React前端规范文档》5.7、《业务流程文档》4.7     | 关键指标统计展示                      |
| 分布图表显示         | 分布图表、产品类型分布、品相分布、价值分布                                     | 《API接口规范文档》2.3.5、《业务流程文档》4.7.3   | 多维度分布统计                       |
| 预警监控功能         | 预警监控、低库存、缺货、recent\_changes                               | 《React前端规范文档》5.7、《业务流程文档》4.7.2   | 库存预警和变化监控                     |
| 仪表盘数据加载        | 数据加载、并行查询、统计汇总、趋势计算                                       | 《API接口规范文档》2.3.5、《业务流程文档》4.7.2   | 多维度并行统计查询                     |
| **库存数据导出**     | <br />                                                    | <br />                           | <br />                        |
| 导出功能实现         | 数据导出、Excel、CSV、导出范围、权限控制                                  | 《API接口规范文档》2.3、《业务流程文档》4.8       | 多格式数据导出                       |

### 5.12 SKU系统文档索引（更新版 v2.0）

**SKU系统概览：**
- 移除状态切换功能，重新设计为四大核心功能
- 核心功能：展示、销售确认、销毁退回、库存调整
- 完整的原材料溯源体系，支持采购记录追溯
- 基于角色的权限控制，区分BOSS和EMPLOYEE权限
- 支持图片、规格、成本、售价、利润率等完整信息

**文档映射：**

按文档分类：
| 文档类型 | 章节 | 内容描述 |
|----------|------|----------|
| 数据库设计 | SKU系统表结构 | product_skus、sku_inventory_logs、sku_material_traces表设计 |
| API接口 | 6. SKU系统API接口（更新版） | 7个接口：列表、详情、销售确认、销毁、调整、溯源、历史 |
| 前端开发 | 6. SKU系统组件开发规范（更新版） | 11个子章节，涵盖所有SKU相关组件和Hook |
| 业务流程 | SKU系统业务流程详细规范（更新版） | 10个章节，完整业务流程设计 |
| UI设计 | 销售列表页面UI设计规范 | SKU卡片、操作按钮、弹窗设计 |
| 错误处理 | SKU系统错误处理规范 | API错误、验证错误、权限错误处理 |
| 部署运维 | SKU系统部署要求 | 数据库、API、前端组件部署 |
| 权限安全 | SKU系统权限与安全规范 | 操作权限、数据安全、审计日志 |

按功能模块分布：
| 功能模块 | 涉及文档 | 关键章节 |
|----------|----------|----------|
| SKU展示 | 前端开发、UI设计、业务流程 | SalesList组件、卡片设计、展示流程 |
| 销售确认 | API接口、业务流程、前端开发 | 销售接口、销售流程、SkuSellForm组件 |
| 销毁功能 | API接口、业务流程、前端开发 | 销毁接口、销毁流程、SkuDestroyForm组件 |
| 原材料溯源 | 数据库设计、API接口、前端开发 | 溯源表、溯源接口、SkuTraceView组件 |
| 库存调整 | API接口、业务流程、权限安全 | 调整接口、调整流程、权限控制 |
| 权限控制 | 权限安全、前端开发、业务流程 | 权限矩阵、useSkuPermissions Hook |

**快速查询索引：**

开发相关：
- SKU数据类型定义：《前端开发规范》6.1 SalesList组件
- SKU API接口完整列表：《API接口规范》6.1-6.7（7个接口）
- SKU组件开发指南：《前端开发规范》6.2-6.11（10个组件规范）
- SKU数据库表结构：《数据库设计》SKU系统表结构（3个表）
- SKU字段映射规则：《前端开发规范》MaterialTrace、SkuInventoryLog接口

业务相关：
- SKU创建流程：《业务流程规范》3.1（Mermaid流程图）
- SKU销售确认流程：《业务流程规范》3.2（包含业务规则）
- SKU销毁流程：《业务流程规范》3.3（支持原材料退回）
- SKU库存调整流程：《业务流程规范》3.4（权限验证）
- SKU溯源管理：《业务流程规范》4.1-4.2（完整溯源体系）
- 权限控制规则：《业务流程规范》5.1-5.2（角色权限矩阵）

运维相关：
- SKU系统部署清单：《部署运维规范》SKU系统部署要求
- SKU错误处理策略：《错误处理规范》SKU系统错误处理规范
- SKU安全配置：《权限安全规范》SKU系统权限与安全规范
- SKU性能优化：《业务流程规范》8.1-8.2
- SKU监控和日志：《业务流程规范》9.1-9.2

**关键字段映射：**

数据库字段（移除status，新增字段）：
| 字段名 | 类型 | 说明 | 文档位置 |
|--------|------|------|----------|
| sku_code | VARCHAR(50) | SKU编号 | 《数据库设计》SKU系统表结构 |
| sku_name | VARCHAR(200) | SKU名称 | 《数据库设计》SKU系统表结构 |
| total_quantity | INT | 总数量 | 《数据库设计》SKU系统表结构 |
| available_quantity | INT | 可售数量 | 《数据库设计》SKU系统表结构 |
| photos | JSON | 图片URL数组 | 《数据库设计》SKU系统表结构 |
| specification | VARCHAR(100) | 规格（直径等） | 《数据库设计》SKU系统表结构 |
| material_cost | DECIMAL(10,2) | 原材料成本价 | 《数据库设计》SKU系统表结构 |
| labor_cost | DECIMAL(10,2) | 人工成本 | 《数据库设计》SKU系统表结构 |
| craft_cost | DECIMAL(10,2) | 工艺成本 | 《数据库设计》SKU系统表结构 |
| total_cost | DECIMAL(10,2) | 总成本价 | 《数据库设计》SKU系统表结构 |
| selling_price | DECIMAL(10,2) | 售价 | 《数据库设计》SKU系统表结构 |
| profit_margin | DECIMAL(5,2) | 利润率 | 《数据库设计》SKU系统表结构 |
| last_sale_date | TIMESTAMP | 最后销售日期 | 《数据库设计》SKU系统表结构 |

API字段（snake_case格式）：
| 字段名 | 类型 | 说明 | 文档位置 |
|--------|------|------|----------|
| sku_code | string | SKU编号 | 《API接口》6.1 SKU列表查询 |
| sku_name | string | SKU名称 | 《API接口》6.1 SKU列表查询 |
| photos | string[] | 图片URL数组 | 《API接口》6.1 SKU列表查询 |
| specification | string | 规格信息 | 《API接口》6.1 SKU列表查询 |
| material_cost | number | 原材料成本价 | 《API接口》6.2 SKU详情查询 |
| selling_price | number | 售价 | 《API接口》6.1 SKU列表查询 |
| profit_margin | number | 利润率 | 《API接口》6.1 SKU列表查询 |
| last_sale_date | string | 最后销售日期 | 《API接口》6.1 SKU列表查询 |
| material_traces | object[] | 溯源信息 | 《API接口》6.2 SKU详情查询 |

前端组件（完整组件体系）：
| 组件名 | 类型 | 说明 | 文档位置 |
|--------|------|------|----------|
| SalesList | Component | SKU列表主组件 | 《前端开发》6.1 |
| SkuDetailModal | Component | SKU详情弹窗 | 《前端开发》6.2 |
| SkuSellForm | Component | 销售确认表单 | 《前端开发》6.3 |
| SkuDestroyForm | Component | 销毁操作表单 | 《前端开发》6.4 |
| SkuTraceView | Component | 溯源信息组件 | 《前端开发》6.5 |
| SkuHistoryView | Component | 操作历史组件 | 《前端开发》6.6 |
| useSkuPermissions | Hook | 权限控制Hook | 《前端开发》6.7 |
| skuApi | Service | SKU API服务 | 《前端开发》6.8 |
| SkuContext | Context | SKU状态管理 | 《前端开发》6.9 |

**常见问题索引：**

Q: SKU系统有哪些核心功能？
A: 参考《业务流程规范》1.2，包括展示、销售确认、销毁退回、库存调整四大功能

Q: SKU如何自动生成和合并？
A: 参考《业务流程规范》3.1 SKU创建流程，基于原材料标识哈希值自动判断是否合并

Q: 如何实现SKU销售确认？
A: 参考《API接口规范》6.3 SKU销售确认接口和《前端开发》6.3 SkuSellForm组件

Q: SKU销毁后如何退回原材料？
A: 参考《业务流程规范》3.3 SKU销毁流程，支持按比例退回原材料库存

Q: 如何查看SKU的原材料溯源？
A: 参考《API接口规范》6.6 SKU原材料溯源接口和《前端开发》6.5 SkuTraceView组件

Q: SKU权限如何控制？
A: 参考《权限安全规范》SKU系统权限与安全规范和《前端开发》6.7 useSkuPermissions Hook

Q: SKU包含哪些字段信息？
A: 参考《业务流程规范》2.1 核心字段，包括图片、编号、名称、数量、规格、成本价、售价、利润率、创建日期、销售日期、溯源信息

Q: 如何处理SKU操作错误？
A: 参考《错误处理规范》SKU系统错误处理规范，包含7种错误码和处理策略

Q: SKU销毁功能如何使用？
A: 参考《业务流程规范》3.3 SKU销毁流程和《前端开发》6.4 SkuDestroyForm组件

Q: SKU库存调整需要什么权限？
A: 参考《业务流程规范》3.4 SKU库存调整流程，只有BOSS角色可以进行库存调整

**版本更新记录：**
- v2.0: 移除SKU状态切换功能，重新设计为展示、销售确认、销毁、调整四大功能
- v2.0: 新增销售确认和销毁功能，支持部分或全部操作
- v2.0: 完善原材料溯源体系，新增sku_material_traces溯源关联表
- v2.0: 优化权限控制，明确BOSS和EMPLOYEE角色权限差异
- v2.0: 扩展SKU字段，新增图片、规格、成本分解、销售日期等字段
- v2.0: 更新所有相关文档，确保数据库、API、前端、业务流程完全同步
- v2.0: 新增11个前端组件规范和7个API接口定义
- v2.0: 完善业务流程设计，包含4个主要流程的Mermaid流程图
- v2.0: 新增SKU操作历史记录和完整的错误处理机制
| 导出权限控制         | 导出权限、BOSS、EMPLOYEE、敏感字段过滤                                 | 《业务流程文档》4.8.2、《权限与安全规范文档》1.1     | 基于角色的导出权限                     |
| 导出数据格式         | 导出格式、字段映射、基础信息、价格信息                                       | 《业务流程文档》4.8.2、《API接口规范文档》2.3     | 导出字段规范定义                      |
| **通用筛选功能**     | <br />                                                    | <br />                           | <br />                        |
| 筛选条件管理         | 筛选条件、产品类型、品相、供应商、价格范围                                     | 《业务流程文档》4.8.1、《React前端规范文档》5.8   | 6种通用筛选字段                      |
| 筛选状态同步         | 状态同步、localStorage、跨视图保持、参数验证                              | 《业务流程文档》4.8.2、《React前端规范文档》5.8   | 筛选状态持久化机制                     |
| 筛选API参数        | API参数、筛选映射、字段转换、查询优化                                      | 《API接口规范文档》2.3、《业务流程文档》4.8.2     | 筛选参数标准化                       |
| 品相null处理       | 品相筛选、UNKNOWN、null值处理                                      | 《API接口规范文档》2.2.1、《业务流程文档》3.2.4   | UNKNOWN映射为null                |
| 供应商多选          | 供应商筛选、多选、模糊匹配、精确匹配                                        | 《API接口规范文档》2.2.1、《业务流程文档》3.2.4   | 支持字符串和数组格式                    |
| 克价null处理       | 克价筛选、null值视为0、COALESCE                                    | 《API接口规范文档》2.2.1、《数据库设计文档》1.2.2  | null值特殊处理                     |
| 日期范围处理         | 日期筛选、startDate、endDate、时间处理                               | 《API接口规范文档》2.2.1、《业务流程文档》3.2.4   | 自动设置时间边界                      |
| **数据库优化**      | <br />                                                    | <br />                           | <br />                        |
| 索引设计           | 索引优化、复合索引、筛选性能                                            | 《数据库设计文档》1.2.1                   | 筛选和排序索引配置                     |
| 复杂查询SQL        | 复杂筛选、多维度查询、原生SQL                                          | 《数据库设计文档》1.2.3                   | 多条件组合查询                       |
| 查询性能优化         | 分页优化、游标分页、缓存策略                                            | 《数据库设计文档》1.2.4                   | 大数据量查询优化                      |
| **前端实现**       | <br />                                                    | <br />                           | <br />                        |
| 防抖搜索           | 防抖搜索、300ms、debounce                                       | 《React前端规范文档》4.7                 | 搜索性能优化                        |
| 筛选面板Portal     | Portal组件、createPortal、筛选面板                                | 《React前端规范文档》4.4                 | 筛选面板渲染                        |
| 外部点击关闭         | 外部点击、事件监听、筛选面板关闭                                          | 《React前端规范文档》4.3                 | 交互体验优化                        |
| 多选筛选器          | 多选组件、全选、取消全选                                              | 《React前端规范文档》4.5                 | 多选状态管理                        |
| 范围筛选器          | 范围筛选、最小值、最大值、验证                                           | 《React前端规范文档》4.5                 | 范围值验证                         |
| **业务流程**       | <br />                                                    | <br />                           | <br />                        |
| 采购列表查询流程       | 采购列表、查询流程、初始化                                             | 《业务流程文档》3.2.1-3.2.2              | 完整查询流程                        |
| 筛选操作流程         | 筛选操作、用户交互、状态管理                                            | 《业务流程文档》3.2.3                    | 筛选交互流程                        |
| 异常处理流程         | 筛选异常、网络异常、数据异常                                            | 《业务流程文档》3.2.9                    | 异常处理策略                        |
| **库存状态显示功能**   | <br />                                                    | <br />                           | <br />                        |
| 库存状态分级规则是什么？   | UI设计规范文档                                                  | 4.1 库存状态颜色编码、4.2 库存状态交互效果        | <br />                        |
| 库存为0如何显示？      | React前端规范文档                                               | 9.2 库存为0的显示处理、矩阵视图空单元格处理         | <br />                        |
| 低库存交互效果如何实现？   | React前端规范文档                                               | 9.3 低库存交互效果实现、灰度滤镜效果             | <br />                        |
| 库存状态颜色函数如何使用？  | React前端规范文档                                               | 9.1 getStockStatusColor函数实现      | <br />                        |
| 品相颜色标识如何配置？    | React前端规范文档                                               | 9.5 getQualityColor函数实现、品相颜色圆点显示 | <br />                        |
| 库存状态标识组件如何设计？  | React前端规范文档                                               | 9.4 库存状态标识组件、低库存警告标识             | <br />                        |
| 库存状态业务规则是什么？   | 业务流程文档                                                    | 8.1 库存状态分级业务规则、8.1.2 库存状态计算逻辑    | <br />                        |
| 不同视图中库存状态如何显示？ | 业务流程文档                                                    | 8.2 不同视图中的库存状态显示规范               | <br />                        |
| 库存状态如何自动更新？    | 业务流程文档                                                    | 8.3.1 库存状态自动更新机制                 | <br />                        |
| 低库存预警规则是什么？    | 业务流程文档                                                    | 8.3.2 低库存预警业务规则                  | <br />                        |
| 库存状态与业务决策如何关联？ | 业务流程文档                                                    | 8.4 库存状态与业务决策关联                  | <br />                        |
| 层级视图中库存为0如何处理？ | 业务流程文档                                                    | 8.2.1 层级式库存视图显示规范                | <br />                        |
| 矩阵视图中空单元格如何显示？ | 业务流程文档                                                    | 8.2.2 半成品矩阵视图显示规范                | <br />                        |
| 成品卡片中库存不足如何标识？ | 业务流程文档                                                    | 8.2.3 成品卡片视图显示规范                 | <br />                        |
| 库存状态视觉设计规范是什么？ | UI设计规范文档                                                  | 4.1-4.3 库存状态视觉设计规范               | <br />                        |
| **传统功能**       | <br />                                                    | <br />                           | <br />                        |
| 产品类型相关         | 产品类型、LOOSE\_BEADS、BRACELET                                | 《数据库设计文档》1.1.2、《业务流程文档》3.2.4     | 支持4种产品类型                      |
| API接口          | 接口、API、请求参数                                               | 《API接口规范文档》2.1-2.5               | 统一/api/v1/前缀                  |
| 数据库字段          | 字段、表结构、数据类型                                               | 《数据库设计文档》1.1、3.3-3.5             | 采购表、成品表、供应商表                  |
| 前端组件           | 组件、React、UI                                               | 《React前端规范文档》2.1-2.4、5.1-5.3     | 统一组件规范                        |
| 错误处理调试         | 错误、异常、调试                                                  | 《错误处理文档》2.1-3.3                  | 统一错误码和调试规范                    |
| 部署运维           | 部署、服务器、环境                                                 | 《部署运维文档》1.1-1.3                  | 阿里云+宝塔+MySQL                  |
| 业务流程           | 流程、操作、步骤                                                  | 《业务流程文档》1.1-1.4                  | 采购录入、成品制作、库存管理                |
| 字段命名规范         | 字段命名、snake\_case、camelCase                                | 《API接口规范文档》6.1-6.3               | API响应snake\_case，数据库camelCase |
| 批量转换安全         | 批量转换、转换工具、安全规范                                            | 《错误处理文档》5.1-5.4、《部署运维文档》6.1-6.3  | 转换前备份、分批转换、安全检查               |

