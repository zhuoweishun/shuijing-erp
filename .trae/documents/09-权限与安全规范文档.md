## æ–‡æ¡£ 9ï¼šæƒé™ä¸å®‰å…¨è§„èŒƒæ–‡æ¡£ï¼ˆåŸºäºmaterialsè¡¨æ¶æ„ï¼‰

### ä¸€ã€è§’è‰²æƒé™çŸ©é˜µï¼ˆmaterialsè¡¨æ¶æ„ä¼˜åŒ–ï¼‰

| è§’è‰² | åŠŸèƒ½æ¨¡å—  | æ“ä½œæƒé™                       | æ•°æ®æƒé™ï¼ˆæ•æ„Ÿå­—æ®µï¼‰                                      | æ¥æºæ–‡æ¡£            |
| -- | ----- | -------------------------- | ----------------------------------------------- | --------------- |
| è€æ¿ | é‡‡è´­ç®¡ç†  | å½•å…¥ / æŸ¥è¯¢ / ç¼–è¾‘ / åˆ é™¤ / æ‰¹é‡å¯¼å…¥å¯¼å‡º | å¯è§æ‰€æœ‰å­—æ®µï¼ˆå« price\_per\_gramã€total\_priceï¼‰ï¼Œæ‹¥æœ‰å®Œæ•´ç¼–è¾‘æƒé™         | ã€Šä¸šåŠ¡æµç¨‹æ–‡æ¡£ã€‹1.2     |
| è€æ¿ | SKUåˆ¶ä½œç®¡ç†  | åˆ¶ä½œ / æŸ¥è¯¢ / æˆæœ¬è®¡ç®— / æ‰¹é‡åˆ¶ä½œ      | å¯è§æ‰€æœ‰æˆæœ¬å­—æ®µï¼ˆmaterial\_costã€labor\_costã€craft\_costã€total\_costã€profit\_marginï¼‰                 | ã€Šä¸šåŠ¡æµç¨‹æ–‡æ¡£ã€‹2.1     |
| è€æ¿ | SKUåº“å­˜ç®¡ç†  | æŸ¥è¯¢ / è°ƒæ•´ / é”€å”® / é”€æ¯ / è¡¥è´§ / çŠ¶æ€ç®¡ç†      | å¯è§æ‰€æœ‰SKUå­—æ®µï¼ŒåŒ…æ‹¬æˆæœ¬å’Œåˆ©æ¶¦ä¿¡æ¯                 | ã€ŠAPIæ¥å£è§„èŒƒæ–‡æ¡£ã€‹4.1     |
| è€æ¿ | æˆå“ç®¡ç†  | å½•å…¥ / é”€å”® / é”€æ¯ / æ‰¹é‡å¯¼å…¥å¯¼å‡º      | å¯è§ materialsã€total\_costã€profit                 | ã€Šä¸šåŠ¡æµç¨‹æ–‡æ¡£ã€‹1.2     |
| è€æ¿ | ä¾›åº”å•†ç®¡ç† | æŸ¥çœ‹ / ç¼–è¾‘ / ç»Ÿè®¡ / æ‰‹åŠ¨åˆ›å»º        | å¯è§ contact\_personã€phoneã€address                | ã€Šä¸šåŠ¡æµç¨‹æ–‡æ¡£ã€‹4.2     |
| é›‡å‘˜ | ä¾›åº”å•†ç®¡ç† | å®Œå…¨ç¦æ­¢è®¿é—®                     | æ¥å£è¿”å›403ï¼Œå‰ç«¯éšè—æ‰€æœ‰ä¾›åº”å•†åŠŸèƒ½                             | ã€ŠAPIæ¥å£è§„èŒƒæ–‡æ¡£ã€‹2.5  |
| é›‡å‘˜ | é‡‡è´­ç®¡ç†  | å½•å…¥ / æŸ¥è¯¢ï¼ˆä»…è‡ªå·±åˆ›å»ºï¼‰/ æ‰¹é‡å¯¼å‡º       | éšè— price\_per\_gramã€total\_priceã€supplier\_infoï¼Œç¦æ­¢ç¼–è¾‘æ“ä½œ | ã€Šæ•°æ®åº“è®¾è®¡æ–‡æ¡£ã€‹1.3    |
| é›‡å‘˜ | SKUåˆ¶ä½œç®¡ç†  | åˆ¶ä½œ / æŸ¥è¯¢ï¼ˆåŸºç¡€ä¿¡æ¯ï¼‰/ æ‰¹é‡åˆ¶ä½œ         | éšè—æ‰€æœ‰æˆæœ¬å­—æ®µï¼ˆmaterial\_costã€labor\_costã€craft\_costã€total\_costã€profit\_marginï¼‰                 | ã€Šä¸šåŠ¡æµç¨‹æ–‡æ¡£ã€‹2.1     |
| é›‡å‘˜ | SKUåº“å­˜ç®¡ç†  | æŸ¥è¯¢ï¼ˆåŸºç¡€ä¿¡æ¯ï¼‰/ é”€å”® / é”€æ¯         | éšè—æˆæœ¬å’Œåˆ©æ¶¦å­—æ®µï¼Œä»…å¯è§åŸºç¡€åº“å­˜ä¿¡æ¯                 | ã€ŠAPIæ¥å£è§„èŒƒæ–‡æ¡£ã€‹4.1     |
| é›‡å‘˜ | æˆå“ç®¡ç†  | å½•å…¥ï¼ˆä»…åŸºç¡€ä¿¡æ¯ï¼‰/ é”€å”® / é”€æ¯         | éšè— materialsã€total\_costã€profit                 | ã€Šæ•°æ®åº“è®¾è®¡æ–‡æ¡£ã€‹1.3    |
| é›‡å‘˜ | åº“å­˜ç®¡ç†  | æŸ¥è¯¢ï¼ˆä»…åŸºç¡€ä¿¡æ¯ï¼‰                  | éšè— unit\_costã€supplier\_nameã€purchase\_id | ã€ŠAPI æ¥å£è§„èŒƒæ–‡æ¡£ã€‹5.1 |
| è€æ¿ | åº“å­˜å¼¹çª—  | æŸ¥çœ‹å®Œæ•´ä¿¡æ¯ï¼ˆå«ä»·æ ¼ã€æ‰¹æ¬¡ã€materialç¼–å·ï¼‰       | å¯è§æ‰€æœ‰materialsè¡¨å­—æ®µï¼ŒåŒ…æ‹¬unit\_costå’Œsupplier\_name                         | ã€ŠUIè®¾è®¡è§„èŒƒæ–‡æ¡£ã€‹5.6   |
| é›‡å‘˜ | åº“å­˜å¼¹çª—  | æŸ¥çœ‹åŸºç¡€ä¿¡æ¯ï¼ˆéšè—ä»·æ ¼ï¼‰               | éšè— unit\_costã€supplier\_nameã€purchase\_id      | ã€ŠUIè®¾è®¡è§„èŒƒæ–‡æ¡£ã€‹5.6   |
| è€æ¿ | åŸææ–™ç®¡ç† | æŸ¥è¯¢ / ç¼–è¾‘ / åˆ é™¤ / çŠ¶æ€ç®¡ç† | å¯è§materialsè¡¨æ‰€æœ‰å­—æ®µï¼ŒåŒ…æ‹¬åº“å­˜è®¡ç®—å’Œæˆæœ¬ä¿¡æ¯ | materialsè¡¨æ¶æ„æ–‡æ¡£ |
| é›‡å‘˜ | åŸææ–™ç®¡ç† | æŸ¥è¯¢ï¼ˆåŸºç¡€ä¿¡æ¯ï¼‰ | éšè— unit\_costã€purchase\_idã€supplier\_name | materialsè¡¨æ¶æ„æ–‡æ¡£ |

### äºŒã€æ•æ„Ÿå­—æ®µè¿‡æ»¤è§„åˆ™ï¼ˆåŸºäºmaterialsè¡¨æ¶æ„ï¼‰

#### 2.1 æ•æ„Ÿå­—æ®µæ¸…å•ï¼ˆæŒ‰è¡¨åˆ†ç±»ï¼Œmaterialsè¡¨ä¼˜å…ˆï¼‰

| è¡¨å              | æ•æ„Ÿå­—æ®µ                                              | è¿‡æ»¤è§„åˆ™ï¼ˆé›‡å‘˜ï¼‰        | æ¥æºæ–‡æ¡£            |
| --------------- | ------------------------------------------------- | --------------- | --------------- |
| materials       | unit\_costã€supplier\_nameã€purchase\_id           | è¿”å› null         | materialsè¡¨æ¶æ„æ–‡æ¡£    |
| purchases       | price\_per\_gramã€total\_priceã€weightã€supplier\_id | è¿”å› null         | ã€Šæ•°æ®åº“è®¾è®¡æ–‡æ¡£ã€‹1.3    |
| products        | materialsã€total\_costã€profitã€profit\_margin       | è¿”å› null         | ã€Šæ•°æ®åº“è®¾è®¡æ–‡æ¡£ã€‹1.3    |
| product\_skus    | material\_costã€labor\_costã€craft\_costã€total\_costã€profit\_marginã€unit\_priceã€total\_value | è¿”å› null         | ã€Šæ•°æ®åº“è®¾è®¡æ–‡æ¡£ã€‹2.2    |
| sku\_inventory\_logs | unit\_priceã€total\_amount | è¿”å› null         | ã€Šæ•°æ®åº“è®¾è®¡æ–‡æ¡£ã€‹2.3    |
| material\_usages | unit\_costã€total\_cost | è¿”å› null         | ã€Šæ•°æ®åº“è®¾è®¡æ–‡æ¡£ã€‹2.4    |
| suppliers       | contact\_personã€phoneã€emailã€address               | å®Œå…¨ä¸å¯è§ï¼ˆæ¥å£è¿”å› 403ï¼‰ | ã€Šä¸šåŠ¡æµç¨‹æ–‡æ¡£ã€‹1.2     |
| åº“å­˜å¼¹çª—æ•°æ®ï¼ˆmaterialsè¡¨ï¼‰ | unit\_costã€supplier\_nameã€purchase\_id           | å‰ç«¯éšè—æ˜¾ç¤º        | ã€ŠUIè®¾è®¡è§„èŒƒæ–‡æ¡£ã€‹5.6   |

#### 2.2 è¿‡æ»¤å®ç°ï¼ˆusePermission Hookï¼Œç°æœ‰é€»è¾‘ï¼‰

```typescript
const usePermission = () => {
  const { user } = useAuth();
  const isBoss = user?.role === 'BOSS';

  // æ•æ„Ÿæ•°æ®è¿‡æ»¤ï¼ˆé€’å½’å¤„ç†åµŒå¥—å­—æ®µï¼‰
  const filterSensitiveData = <T>(data: T): T => {
    if (isBoss) return data;

    const sensitiveFields = [
      // purchasesè¡¨æ•æ„Ÿå­—æ®µ
      'price_per_gram', 'total_price', 'weight', 'supplier_info',
      // productsè¡¨æ•æ„Ÿå­—æ®µ
      'materials', 'total_cost', 'profit', 'profit_margin',
      // materialsè¡¨æ•æ„Ÿå­—æ®µ
      'unit_cost', 'supplier_name', 'purchase_id',
      // product_skusè¡¨æ•æ„Ÿå­—æ®µï¼ˆæ–°å¢ï¼‰
      'material_cost', 'labor_cost', 'craft_cost', 'total_cost', 'profit_margin', 'unit_price', 'total_value',
      // sku_inventory_logsè¡¨æ•æ„Ÿå­—æ®µï¼ˆæ–°å¢ï¼‰
      'unit_price', 'total_amount',
      // material_usagesè¡¨æ•æ„Ÿå­—æ®µï¼ˆæ–°å¢ï¼‰
      'unit_cost', 'total_cost'
    ];

    const filter = (item: any) => {
      if (Array.isArray(item)) return item.map(i => filter(i));
      if (typeof item !== 'object' || item === null) return item;

      const filtered = { ...item };
      Object.keys(filtered).forEach(key => {
        if (sensitiveFields.includes(key)) {
          filtered[key] = null; // ä¿ç•™å­—æ®µé”®åï¼Œé¿å…å‰ç«¯æŠ¥é”™
        } else if (typeof filtered[key] === 'object') {
          filtered[key] = filter(filtered[key]); // åµŒå¥—å­—æ®µè¿‡æ»¤
        }
      });
      return filtered;
    };

    return filter(data) as T;
  };

  return { isBoss, filterSensitiveData };
};
```

### ä¸‰ã€ä¾›åº”å•†æƒé™æ§åˆ¶è¯¦ç»†å®ç°

#### 3.1 å‰ç«¯æƒé™æ§åˆ¶

#### 3.1.1 ç»„ä»¶çº§æƒé™æ§åˆ¶

```typescript
// æƒé™åŒ…è£…ç»„ä»¶
const PermissionWrapper: React.FC<{
  requiredRole: 'BOSS' | 'EMPLOYEE';
  children: React.ReactNode;
}> = ({ requiredRole, children }) => {
  const { user } = useAuth();
  
  if (user?.role !== requiredRole && requiredRole === 'BOSS') {
    return <div className="text-gray-500">æƒé™ä¸è¶³</div>;
  }
  
  return <>{children}</>;
};
```

#### 3.1.2 ä¾›åº”å•†åŠŸèƒ½æƒé™æ§åˆ¶

```typescript
// ä¾›åº”å•†åŠŸèƒ½æƒé™æ£€æŸ¥
const SupplierPermissionWrapper: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const { user } = useAuth();
  
  if (user?.role !== 'BOSS') {
    return (
      <div className="text-gray-500 text-sm">
        <i className="fas fa-lock mr-2"></i>
        æƒé™ä¸è¶³ï¼šä»…è€æ¿å¯ç®¡ç†ä¾›åº”å•†ä¿¡æ¯
      </div>
    );
  }
  
  return <>{children}</>;
};

// é‡‡è´­å½•å…¥é¡µé¢ä¾›åº”å•†é€‰æ‹©æƒé™æ§åˆ¶
const PurchaseEntrySupplierSection: React.FC = () => {
  const { user } = useAuth();
  
  return (
    <div className="supplier-section">
      {user?.role === 'BOSS' ? (
        <>
          <label>ä¾›åº”å•†ä¿¡æ¯</label>
          <SupplierSelector />
          <CreateSupplierButton />
        </>
      ) : (
        <div className="text-gray-400 text-sm">
          <i className="fas fa-info-circle mr-2"></i>
          ä¾›åº”å•†ä¿¡æ¯ä»…è€æ¿å¯è§
        </div>
      )}
    </div>
  );
};
```

#### 3.2 åç«¯æƒé™éªŒè¯

#### 3.2.1 ä¸­é—´ä»¶æƒé™æ£€æŸ¥

```typescript
// æƒé™éªŒè¯ä¸­é—´ä»¶
const checkPermission = (requiredRole: string) => {
  return (req: Request, res: Response, next: NextFunction) => {
    if (req.user.role !== requiredRole) {
      return res.status(403).json({
        success: false,
        message: 'æƒé™ä¸è¶³',
        error: { code: 'INSUFFICIENT_PERMISSIONS' }
      });
    }
    next();
  };
};
```

#### 3.2.2 ä¾›åº”å•†APIæƒé™éªŒè¯

```typescript
// ä¾›åº”å•†APIæƒé™ä¸­é—´ä»¶
const checkSupplierPermission = (req: Request, res: Response, next: NextFunction) => {
  if (req.user.role !== 'BOSS') {
    return res.status(403).json({
      success: false,
      message: 'æƒé™ä¸è¶³ï¼Œä»…è€æ¿å¯æŸ¥çœ‹ä¾›åº”å•†ä¿¡æ¯',
      error: {
        code: 'INSUFFICIENT_PERMISSIONS',
        details: 'é›‡å‘˜æ— æ³•è®¿é—®ä¾›åº”å•†ç®¡ç†åŠŸèƒ½'
      }
    });
  }
  next();
};

// åº”ç”¨åˆ°æ‰€æœ‰ä¾›åº”å•†è·¯ç”±
router.get('/', authenticateToken, checkSupplierPermission, asyncHandler(async (req, res) => {
  // ä¾›åº”å•†åˆ—è¡¨æŸ¥è¯¢é€»è¾‘
}));

router.post('/', authenticateToken, checkSupplierPermission, asyncHandler(async (req, res) => {
  // ä¾›åº”å•†åˆ›å»ºé€»è¾‘
}));
```

#### 3.2.3 é‡‡è´­è®°å½•ç¼–è¾‘æƒé™éªŒè¯

```typescript
// é‡‡è´­è®°å½•ç¼–è¾‘æƒé™ä¸­é—´ä»¶
const checkPurchaseEditPermission = (req: Request, res: Response, next: NextFunction) => {
  if (req.user.role !== 'BOSS') {
    return res.status(403).json({
      success: false,
      message: 'æƒé™ä¸è¶³ï¼Œä»…è€æ¿å¯ç¼–è¾‘é‡‡è´­è®°å½•',
      error: {
        code: 'INSUFFICIENT_PERMISSIONS',
        details: 'é›‡å‘˜æ— æ³•ç¼–è¾‘é‡‡è´­è®°å½•ï¼Œä»…å¯æŸ¥çœ‹å’Œå½•å…¥'
      }
    });
  }
  next();
};

// åº”ç”¨åˆ°é‡‡è´­è®°å½•ç¼–è¾‘è·¯ç”±
router.put('/:id', authenticateToken, checkPurchaseEditPermission, asyncHandler(async (req, res) => {
  // é‡‡è´­è®°å½•æ›´æ–°é€»è¾‘
  const { id } = req.params;
  const updateData = req.body;
  
  // éªŒè¯é‡‡è´­è®°å½•æ˜¯å¦å­˜åœ¨
  const existingPurchase = await prisma.purchase.findUnique({
    where: { id },
    include: { supplier: true, user: true }
  });
  
  if (!existingPurchase) {
    return res.status(404).json({
      success: false,
      message: 'é‡‡è´­è®°å½•ä¸å­˜åœ¨',
      error: { code: 'PURCHASE_NOT_FOUND' }
    });
  }
  
  // æ‰§è¡Œæ›´æ–°æ“ä½œ
  // ...
}));

// é‡‡è´­è®°å½•åˆ é™¤æƒé™éªŒè¯
router.delete('/:id', authenticateToken, checkPurchaseEditPermission, asyncHandler(async (req, res) => {
  // é‡‡è´­è®°å½•åˆ é™¤é€»è¾‘
}));
```

#### 3.3 æ•°æ®ä¸€è‡´æ€§éªŒè¯

```typescript
// ä¾›åº”å•†æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
const validateSupplierConsistency = {
  // åç§°å”¯ä¸€æ€§æ£€æŸ¥ï¼ˆå¿½ç•¥å¤§å°å†™å’Œç©ºæ ¼ï¼‰
  checkNameUniqueness: async (name: string, excludeId?: string) => {
    const normalizedName = name.trim().toLowerCase();
    const existingSupplier = await prisma.supplier.findFirst({
      where: {
        name: {
          equals: normalizedName,
          mode: 'insensitive'
        },
        isActive: true,
        ...(excludeId && { id: { not: excludeId } })
      }
    });
    return !existingSupplier;
  },
  
  // IDå’Œåç§°ç»‘å®šå…³ç³»éªŒè¯
  validateIdNameBinding: (suppliers: Supplier[]) => {
    const idNameMap = new Map();
    const nameIdMap = new Map();
    const inconsistencies = [];
    
    suppliers.forEach(supplier => {
      if (supplier.id) {
        // æ£€æŸ¥åŒä¸€IDå¯¹åº”ä¸åŒåç§°
        if (idNameMap.has(supplier.id) && idNameMap.get(supplier.id) !== supplier.name) {
          inconsistencies.push({
            type: 'ID_NAME_MISMATCH',
            id: supplier.id,
            existingName: idNameMap.get(supplier.id),
            newName: supplier.name
          });
        }
        idNameMap.set(supplier.id, supplier.name);
        
        // æ£€æŸ¥åŒä¸€åç§°å¯¹åº”ä¸åŒID
        if (nameIdMap.has(supplier.name) && nameIdMap.get(supplier.name) !== supplier.id) {
          inconsistencies.push({
            type: 'NAME_ID_MISMATCH',
            name: supplier.name,
            existingId: nameIdMap.get(supplier.name),
            newId: supplier.id
          });
        }
        nameIdMap.set(supplier.name, supplier.id);
      }
    });
    
    return inconsistencies;
  }
};
```

### å››ã€å®‰å…¨é…ç½®ï¼ˆæå–è‡ªã€Šç³»ç»Ÿæ¶æ„æ–‡æ¡£ã€‹6 ç« ï¼‰

#### 4.1 å¯†ç å®‰å…¨

* **åŠ å¯†ç®—æ³•**ï¼šbcryptï¼ˆæˆæœ¬å› å­ 10ï¼‰ï¼ˆæå–è‡ªã€Šç³»ç»Ÿæ¶æ„æ–‡æ¡£ã€‹6.1ï¼‰

* **å¯†ç è§„åˆ™**ï¼šé•¿åº¦ 6-100 å­—ç¬¦ï¼Œç¦æ­¢çº¯æ•°å­— / çº¯å­—æ¯ï¼ˆæå–è‡ªã€ŠAPI æ¥å£è§„èŒƒæ–‡æ¡£ã€‹2.1ï¼‰

#### 4.2 æ¥å£å®‰å…¨

* **é˜² SQL æ³¨å…¥**ï¼šPrisma å‚æ•°åŒ–æŸ¥è¯¢ï¼ˆæå–è‡ªã€Šç³»ç»Ÿæ¶æ„æ–‡æ¡£ã€‹6.2ï¼‰

* **é˜² XSS**ï¼šå‰ç«¯è¾“å…¥éªŒè¯ï¼ˆZod\@3.22.4ï¼‰ï¼ˆæå–è‡ªã€Šç³»ç»Ÿæ¶æ„æ–‡æ¡£ã€‹2.1.1ï¼‰

* **è·¨åŸŸ**ï¼šCORS é…ç½®ï¼ˆä»…å…è®¸æŒ‡å®šåŸŸåï¼‰ï¼ˆæå–è‡ªã€Šç³»ç»Ÿæ¶æ„æ–‡æ¡£ã€‹4.2ï¼‰

```javascript
// CORSé…ç½®ï¼ˆç°æœ‰é€»è¾‘ï¼‰
const cors = require('cors');
app.use(cors({
  origin: process.env.CORS_ORIGIN || 'http://localhost:5173',
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH'],
  credentials: true
}));
```

### äº”ã€å‰ç«¯æƒé™æ§åˆ¶å®ç°

#### 5.1 æƒé™Hookå®ç°

**useSkuPermissions Hookï¼š**
```typescript
import { useMemo } from 'react'
import { useAuth } from './useAuth'

export interface SkuPermissions {
  can_view_price: boolean
  can_sell: boolean
  can_destroy: boolean
  can_adjust: boolean
  can_refund: boolean
  can_view_trace: boolean
  canViewTrace: boolean
  canViewHistory: boolean
  canBatchOperate: boolean
  canExport: boolean
  can_manage: boolean
}

const ROLE_PERMISSIONS: Record<string, SkuPermissions> = {
  BOSS: {
    can_view_price: true,
    can_sell: true,
    can_destroy: true,
    can_adjust: true,
    can_refund: true,
    can_view_trace: true,
    canViewTrace: true,
    canViewHistory: true,
    canBatchOperate: true,
    canExport: true,
    can_manage: true,
  },
  MANAGER: {
    can_view_price: true,
    can_sell: true,
    can_destroy: true,
    can_adjust: true,
    can_refund: true,
    can_view_trace: true,
    canViewTrace: true,
    canViewHistory: true,
    canBatchOperate: true,
    canExport: true,
    can_manage: false,
  },
  EMPLOYEE: {
    can_view_price: false,
    can_sell: true,
    can_destroy: false,
    can_adjust: false,
    can_refund: false,
    can_view_trace: true,
    canViewTrace: true,
    canViewHistory: false,
    canBatchOperate: false,
    canExport: false,
    can_manage: false,
  },
  VIEWER: {
    can_view_price: false,
    can_sell: false,
    can_destroy: false,
    can_adjust: false,
    can_refund: false,
    can_view_trace: false,
    canViewTrace: false,
    canViewHistory: false,
    canBatchOperate: false,
    canExport: false,
    can_manage: false,
  },
}

export const use_sku_permissions = (): SkuPermissions => {
  const { user } = useAuth()

  const permissions = useMemo(() => {
    if (!user) {
      return ROLE_PERMISSIONS.VIEWER
    }

    const userRole = user.role?.toUpperCase() || 'VIEWER'
    const rolePermissions = ROLE_PERMISSIONS[userRole]

    if (!rolePermissions) {
      console.warn(`æœªçŸ¥ç”¨æˆ·è§’è‰²: ${userRole}ï¼Œä½¿ç”¨é»˜è®¤æƒé™`)
      return ROLE_PERMISSIONS.VIEWER
    }

    return rolePermissions
  }, [user])

  return permissions
}
```

#### 5.2 SKUé”€å”®åˆ—è¡¨æƒé™æ§åˆ¶å®ç°

**SalesListç»„ä»¶æƒé™é›†æˆï¼š**
```typescript
// åœ¨SalesListç»„ä»¶ä¸­ä½¿ç”¨æƒé™æ§åˆ¶
const permissions = use_sku_permissions()

// ä»·æ ¼ä¿¡æ¯æ˜¾ç¤ºæ§åˆ¶
{permissions.can_view_price && (
  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
    å”®ä»·
  </th>
)}

{permissions.can_view_price && (
  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
    åˆ©æ¶¦ç‡
  </th>
)}

// æ“ä½œæŒ‰é’®æƒé™æ§åˆ¶
{permissions.can_sell && sku.available_quantity > 0 && sku.status === 'ACTIVE' && (
  <button
    onClick={() => open_detail_modal(sku, 'sell')}
    className="inline-flex items-center px-2 py-1 text-xs font-medium text-white bg-green-600 rounded hover:bg-green-700"
    title="é”€å”®"
  >
    <ShoppingCart className="h-3 w-3" />
  </button>
)}

{permissions.can_destroy && sku.available_quantity > 0 && (
  <button
    onClick={() => open_detail_modal(sku, 'destroy')}
    className="inline-flex items-center px-2 py-1 text-xs font-medium text-white bg-red-600 rounded hover:bg-red-700"
    title="é”€æ¯"
  >
    <Trash2 className="h-3 w-3" />
  </button>
)}

{permissions.can_adjust && (
  <button
    onClick={() => open_detail_modal(sku, 'restock')}
    className="inline-flex items-center px-2 py-1 text-xs font-medium text-gray-700 border border-gray-300 rounded hover:bg-gray-50"
    title="è¡¥è´§"
  >
    <Package className="h-3 w-3" />
  </button>
)}

{permissions.can_manage && (
  <button
    onClick={() => open_detail_modal(sku, 'control')}
    className="inline-flex items-center px-2 py-1 text-xs font-medium text-gray-700 border border-gray-300 rounded hover:bg-gray-50"
    title="è°ƒæ§"
  >
    <Settings className="h-3 w-3" />
  </button>
)}
```

**ç§»åŠ¨ç«¯æƒé™æ§åˆ¶ï¼š**
```typescript
// ç§»åŠ¨ç«¯å¡ç‰‡å¸ƒå±€ä¸­çš„æƒé™æ§åˆ¶
{permissions.can_view_price && (
  <div className="mt-2 flex items-center justify-between">
    <div className="text-xs text-gray-600">
      å•ä»·: {format_price(sku.selling_price)}
    </div>
    {sku.profit_margin && (
      <div className="text-xs text-gray-600">
        åˆ©æ¶¦ç‡: {formatProfitMargin(sku.profit_margin)}
      </div>
    )}
  </div>
)}

// ç§»åŠ¨ç«¯æ“ä½œæŒ‰é’®æƒé™æ§åˆ¶
<div className="mt-3 flex items-center space-x-2">
  <button
    onClick={() => open_detail_modal(sku, 'view')}
    className="flex-1 inline-flex items-center justify-center px-3 py-1.5 text-xs font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200"
  >
    <Eye className="h-3 w-3 mr-1" />
    æŸ¥çœ‹
  </button>
  
  {permissions.can_sell && sku.available_quantity > 0 && sku.status === 'ACTIVE' && (
    <button
      onClick={() => open_detail_modal(sku, 'sell')}
      className="flex-1 inline-flex items-center justify-center px-3 py-1.5 text-xs font-medium text-white bg-green-600 rounded-lg hover:bg-green-700"
    >
      <ShoppingCart className="h-3 w-3 mr-1" />
      é”€å”®
    </button>
  )}
  
  {permissions.can_destroy && sku.available_quantity > 0 && (
    <button
      onClick={() => open_detail_modal(sku, 'destroy')}
      className="flex-1 inline-flex items-center justify-center px-3 py-1.5 text-xs font-medium text-white bg-red-600 rounded-lg hover:bg-red-700"
    >
      <Trash2 className="h-3 w-3 mr-1" />
      é”€æ¯
    </button>
  )}
  
  {permissions.can_manage && (
    <button
      onClick={() => open_detail_modal(sku, 'control')}
      className="flex-1 inline-flex items-center justify-center px-3 py-1.5 text-xs font-medium text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50"
    >
      <Settings className="h-3 w-3 mr-1" />
      è°ƒæ§
    </button>
  )}
</div>
```


## 6. SKUç³»ç»Ÿæƒé™ä¸å®‰å…¨è§„èŒƒ

### 6.1 SKUæ“ä½œæƒé™æ§åˆ¶

#### 6.1.1 SKUæŸ¥çœ‹æƒé™

**æƒé™åˆ†çº§ï¼š**
- **æ‰€æœ‰ç”¨æˆ·**ï¼šå¯ä»¥æŸ¥çœ‹SKUåŸºç¡€ä¿¡æ¯ï¼ˆåç§°ã€ç¼–å·ã€åº“å­˜æ•°é‡ã€çŠ¶æ€ï¼‰
- **BOSSè§’è‰²**ï¼šå¯ä»¥æŸ¥çœ‹å®Œæ•´SKUä¿¡æ¯ï¼ŒåŒ…æ‹¬æˆæœ¬ã€ä»·æ ¼ã€åˆ©æ¶¦ç‡ç­‰æ•æ„Ÿæ•°æ®
- **EMPLOYEEè§’è‰²**ï¼šæ•æ„Ÿå­—æ®µè‡ªåŠ¨è¿‡æ»¤ï¼Œè¿”å›nullæˆ–éšè—

**æƒé™å®ç°ï¼š**
```typescript
// åç«¯æƒé™è¿‡æ»¤
const filterSkuDataByRole = (skuData: any[], userRole: string) => {
  if (userRole === 'BOSS') {
    return skuData; // è¿”å›å®Œæ•´æ•°æ®
  }
  
  // EMPLOYEEè§’è‰²è¿‡æ»¤æ•æ„Ÿå­—æ®µ
  return skuData.map(sku => {
    const { 
      materialCost, 
      laborCost, 
      craftCost, 
      totalCost, 
      profitMargin,
      totalValue,
      ...publicFields 
    } = sku;
    
    return {
      ...publicFields,
      // æ•æ„Ÿå­—æ®µè®¾ä¸ºnull
      materialCost: null,
      laborCost: null,
      craftCost: null,
      totalCost: null,
      profitMargin: null,
      totalValue: null
    };
  });
};
```

#### 6.1.2 SKUæ“ä½œæƒé™

**æ“ä½œæƒé™çŸ©é˜µï¼š**

| æ“ä½œç±»å‹ | BOSSæƒé™ | EMPLOYEEæƒé™ | æƒé™éªŒè¯æ–¹å¼ |
|---------|----------|-------------|-------------|
| æŸ¥çœ‹SKUåˆ—è¡¨ | âœ… å®Œæ•´ä¿¡æ¯ | âœ… åŸºç¡€ä¿¡æ¯ | JWT + è§’è‰²è¿‡æ»¤ |
| æŸ¥çœ‹SKUè¯¦æƒ… | âœ… å®Œæ•´ä¿¡æ¯ | âœ… åŸºç¡€ä¿¡æ¯ | JWT + è§’è‰²è¿‡æ»¤ |
| åº“å­˜è°ƒæ•´ | âœ… å…è®¸ | âœ… å…è®¸ | JWTéªŒè¯ |
| é”€å”®è®°å½• | âœ… å…è®¸ | âœ… å…è®¸ | JWTéªŒè¯ |
| æŸ¥çœ‹å˜æ›´å†å² | âœ… å…è®¸ | âœ… å…è®¸ | JWTéªŒè¯ |
| æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯ | âœ… å®Œæ•´ç»Ÿè®¡ | âœ… åŸºç¡€ç»Ÿè®¡ | JWT + è§’è‰²è¿‡æ»¤ |
| SKUç”Ÿæˆ | ğŸ”„ è‡ªåŠ¨è§¦å‘ | ğŸ”„ è‡ªåŠ¨è§¦å‘ | ç³»ç»Ÿè‡ªåŠ¨ |
| SKUåˆ é™¤ | âŒ ä¸æ”¯æŒ | âŒ ä¸æ”¯æŒ | ä¸šåŠ¡é™åˆ¶ |

**æƒé™éªŒè¯ä¸­é—´ä»¶ï¼š**
```typescript
// SKUæƒé™éªŒè¯ä¸­é—´ä»¶
const verifySkuPermission = (requiredRole?: string) => {
  return (req: Request, res: Response, next: NextFunction) => {
    try {
      // 1. éªŒè¯JWT Token
      const token = req.headers.authorization?.replace('Bearer ', '');
      if (!token) {
        return res.status(401).json({
          success: false,
          error: {
            code: 'UNAUTHORIZED',
            message: 'æœªæä¾›è®¤è¯ä»¤ç‰Œ'
          }
        });
      }
      
      // 2. è§£æç”¨æˆ·ä¿¡æ¯
      const decoded = jwt.verify(token, process.env.JWT_SECRET!) as any;
      req.user = decoded;
      
      // 3. æ£€æŸ¥è§’è‰²æƒé™ï¼ˆå¦‚æœéœ€è¦ï¼‰
      if (requiredRole && decoded.role !== requiredRole) {
        return res.status(403).json({
          success: false,
          error: {
            code: 'INSUFFICIENT_ROLE',
            message: `éœ€è¦${requiredRole}è§’è‰²æƒé™`
          }
        });
      }
      
      next();
    } catch (error) {
      return res.status(401).json({
        success: false,
        error: {
          code: 'INVALID_TOKEN',
          message: 'æ— æ•ˆçš„è®¤è¯ä»¤ç‰Œ'
        }
      });
    }
  };
};
```

### 6.2 SKUæ•°æ®å®‰å…¨ä¿æŠ¤

#### 6.2.1 æ•æ„Ÿæ•°æ®åŠ å¯†

**æ•æ„Ÿå­—æ®µè¯†åˆ«ï¼š**
- `materialCost` - åŸææ–™æˆæœ¬
- `laborCost` - äººå·¥æˆæœ¬
- `craftCost` - å·¥è‰ºæˆæœ¬
- `totalCost` - æ€»æˆæœ¬
- `profitMargin` - åˆ©æ¶¦ç‡
- `totalValue` - æ€»ä»·å€¼

**æ•°æ®ä¼ è¾“åŠ å¯†ï¼š**
```typescript
// æ•æ„Ÿæ•°æ®ä¼ è¾“åŠ å¯†
const encryptSensitiveData = (data: any) => {
  const sensitiveFields = ['materialCost', 'laborCost', 'craftCost', 'totalCost', 'profitMargin', 'totalValue'];
  
  const encrypted = { ...data };
  
  sensitiveFields.forEach(field => {
    if (encrypted[field] !== null && encrypted[field] !== undefined) {
      // ä½¿ç”¨AESåŠ å¯†æ•æ„Ÿæ•°æ®
      encrypted[field] = encrypt(encrypted[field].toString());
    }
  });
  
  return encrypted;
};

// å‰ç«¯è§£å¯†æ•æ„Ÿæ•°æ®
const decryptSensitiveData = (data: any, userRole: string) => {
  if (userRole !== 'BOSS') {
    return data; // éBOSSè§’è‰²ä¸è§£å¯†
  }
  
  const sensitiveFields = ['materialCost', 'laborCost', 'craftCost', 'totalCost', 'profitMargin', 'totalValue'];
  
  const decrypted = { ...data };
  
  sensitiveFields.forEach(field => {
    if (decrypted[field] && typeof decrypted[field] === 'string') {
      try {
        decrypted[field] = parseFloat(decrypt(decrypted[field]));
      } catch (error) {
        console.warn(`è§£å¯†å­—æ®µ${field}å¤±è´¥:`, error);
        decrypted[field] = null;
      }
    }
  });
  
  return decrypted;
};
```

#### 6.2.2 æ•°æ®è®¿é—®å®¡è®¡

**å®¡è®¡æ—¥å¿—è®°å½•ï¼š**
```typescript
// SKUè®¿é—®å®¡è®¡æ—¥å¿—
interface SkuAuditLog {
  id: string;
  userId: string;
  userRole: string;
  action: 'VIEW' | 'ADJUST' | 'SELL' | 'EXPORT';
  skuId?: string;
  skuCode?: string;
  sensitiveDataAccessed: boolean;
  ipAddress: string;
  userAgent: string;
  timestamp: Date;
  details?: any;
}

// è®°å½•SKUè®¿é—®æ—¥å¿—
const logSkuAccess = async (auditData: Omit<SkuAuditLog, 'id' | 'timestamp'>) => {
  try {
    await prisma.skuAuditLog.create({
      data: {
        ...auditData,
        timestamp: new Date()
      }
    });
  } catch (error) {
    console.error('è®°å½•SKUå®¡è®¡æ—¥å¿—å¤±è´¥:', error);
  }
};

// åœ¨SKU APIä¸­ä½¿ç”¨å®¡è®¡æ—¥å¿—
router.get('/skus', verifySkuPermission(), async (req, res) => {
  try {
    const skus = await getSkuList(req.query);
    const filteredSkus = filterSkuDataByRole(skus, req.user.role);
    
    // è®°å½•è®¿é—®æ—¥å¿—
    await logSkuAccess({
      userId: req.user.id,
      userRole: req.user.role,
      action: 'VIEW',
      sensitiveDataAccessed: req.user.role === 'BOSS',
      ipAddress: req.ip,
      userAgent: req.get('User-Agent') || '',
      details: { query: req.query }
    });
    
    res.json({ success: true, data: filteredSkus });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
});
```

### 6.3 SKUæ“ä½œå®‰å…¨æ§åˆ¶

#### 6.3.1 åº“å­˜æ“ä½œå®‰å…¨

**æ“ä½œéªŒè¯è§„åˆ™ï¼š**
```typescript
// SKUåº“å­˜æ“ä½œå®‰å…¨éªŒè¯
const validateSkuInventoryOperation = (operation: {
  skuId: string;
  action: 'ADJUST' | 'SELL';
  quantity: number;
  userId: string;
}) => {
  const validationRules = {
    // æ•°é‡é™åˆ¶
    quantity: {
      min: 1,
      max: 9999,
      message: 'æ“ä½œæ•°é‡å¿…é¡»åœ¨1-9999ä¹‹é—´'
    },
    
    // æ“ä½œé¢‘ç‡é™åˆ¶
    frequency: {
      maxOperationsPerHour: 100,
      message: 'æ“ä½œè¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•'
    },
    
    // å•æ¬¡æ“ä½œé™åˆ¶
    singleOperation: {
      maxQuantityPerOperation: 1000,
      message: 'å•æ¬¡æ“ä½œæ•°é‡ä¸èƒ½è¶…è¿‡1000'
    }
  };
  
  // éªŒè¯æ•°é‡èŒƒå›´
  if (operation.quantity < validationRules.quantity.min || 
      operation.quantity > validationRules.quantity.max) {
    throw new Error(validationRules.quantity.message);
  }
  
  // éªŒè¯å•æ¬¡æ“ä½œé™åˆ¶
  if (operation.quantity > validationRules.singleOperation.maxQuantityPerOperation) {
    throw new Error(validationRules.singleOperation.message);
  }
  
  return true;
};
```

#### 6.3.2 å¹¶å‘æ“ä½œæ§åˆ¶

**ä¹è§‚é”å®ç°ï¼š**
```typescript
// SKUä¹è§‚é”å¹¶å‘æ§åˆ¶
const updateSkuWithOptimisticLock = async (skuId: string, updateData: any, expectedVersion: number) => {
  const transaction = await prisma.$transaction(async (tx) => {
    // 1. æŸ¥è¯¢å½“å‰SKUç‰ˆæœ¬
    const currentSku = await tx.productSku.findUnique({
      where: { id: skuId },
      select: { id: true, version: true, availableQuantity: true }
    });
    
    if (!currentSku) {
      throw new Error('SKUä¸å­˜åœ¨');
    }
    
    // 2. æ£€æŸ¥ç‰ˆæœ¬å†²çª
    if (currentSku.version !== expectedVersion) {
      throw new Error('æ•°æ®å·²è¢«å…¶ä»–ç”¨æˆ·ä¿®æ”¹ï¼Œè¯·åˆ·æ–°åé‡è¯•');
    }
    
    // 3. æ‰§è¡Œæ›´æ–°æ“ä½œ
    const updatedSku = await tx.productSku.update({
      where: { id: skuId },
      data: {
        ...updateData,
        version: currentSku.version + 1, // ç‰ˆæœ¬å·é€’å¢
        updatedAt: new Date()
      }
    });
    
    return updatedSku;
  });
  
  return transaction;
};
```

#### 6.3.3 æ“ä½œé™æµæ§åˆ¶

**APIé™æµå®ç°ï¼š**
```typescript
// SKUæ“ä½œé™æµä¸­é—´ä»¶
const skuRateLimit = rateLimit({
  windowMs: 60 * 1000, // 1åˆ†é’Ÿçª—å£
  max: (req) => {
    // æ ¹æ®ç”¨æˆ·è§’è‰²è®¾ç½®ä¸åŒé™åˆ¶
    if (req.user?.role === 'BOSS') {
      return 200; // BOSSè§’è‰²æ¯åˆ†é’Ÿ200æ¬¡
    }
    return 100; // EMPLOYEEè§’è‰²æ¯åˆ†é’Ÿ100æ¬¡
  },
  message: {
    success: false,
    error: {
      code: 'RATE_LIMIT_EXCEEDED',
      message: 'æ“ä½œè¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•'
    }
  },
  standardHeaders: true,
  legacyHeaders: false,
  keyGenerator: (req) => {
    // åŸºäºç”¨æˆ·IDå’ŒIPåœ°å€ç”Ÿæˆé™æµé”®
    return `sku_ops:${req.user?.id || 'anonymous'}:${req.ip}`;
  }
});

// åœ¨SKUè·¯ç”±ä¸­åº”ç”¨é™æµ
router.put('/skus/:id/adjust', skuRateLimit, verifySkuPermission(), async (req, res) => {
  // SKUåº“å­˜è°ƒæ•´é€»è¾‘
});

router.post('/skus/:id/sell', skuRateLimit, verifySkuPermission(), async (req, res) => {
  // SKUé”€å”®è®°å½•é€»è¾‘
});
```

### 6.4 SKUæ•°æ®å¯¼å‡ºå®‰å…¨

#### 6.4.1 å¯¼å‡ºæƒé™æ§åˆ¶

**å¯¼å‡ºæƒé™è§„åˆ™ï¼š**
- **BOSSè§’è‰²**ï¼šå¯ä»¥å¯¼å‡ºå®Œæ•´SKUæ•°æ®ï¼ŒåŒ…æ‹¬æˆæœ¬å’Œåˆ©æ¶¦ä¿¡æ¯
- **EMPLOYEEè§’è‰²**ï¼šåªèƒ½å¯¼å‡ºåŸºç¡€SKUæ•°æ®ï¼Œæ•æ„Ÿä¿¡æ¯è‡ªåŠ¨è¿‡æ»¤
- **å¯¼å‡ºé¢‘ç‡é™åˆ¶**ï¼šæ¯ç”¨æˆ·æ¯å°æ—¶æœ€å¤šå¯¼å‡º5æ¬¡
- **å¯¼å‡ºæ•°é‡é™åˆ¶**ï¼šå•æ¬¡æœ€å¤šå¯¼å‡º1000æ¡è®°å½•

**å¯¼å‡ºå®‰å…¨å®ç°ï¼š**
```typescript
// SKUæ•°æ®å¯¼å‡ºå®‰å…¨æ§åˆ¶
const exportSkuData = async (req: Request, res: Response) => {
  try {
    // 1. éªŒè¯å¯¼å‡ºæƒé™
    const user = req.user;
    if (!user) {
      return res.status(401).json({
        success: false,
        error: { code: 'UNAUTHORIZED', message: 'æœªæˆæƒè®¿é—®' }
      });
    }
    
    // 2. æ£€æŸ¥å¯¼å‡ºé¢‘ç‡é™åˆ¶
    const exportCount = await checkExportFrequency(user.id);
    if (exportCount >= 5) {
      return res.status(429).json({
        success: false,
        error: { code: 'EXPORT_LIMIT_EXCEEDED', message: 'å¯¼å‡ºæ¬¡æ•°è¶…é™' }
      });
    }
    
    // 3. è·å–SKUæ•°æ®
    const skuData = await getSkuDataForExport(req.query);
    
    // 4. æ ¹æ®è§’è‰²è¿‡æ»¤æ•æ„Ÿæ•°æ®
    const filteredData = filterSkuDataByRole(skuData, user.role);
    
    // 5. è®°å½•å¯¼å‡ºæ—¥å¿—
    await logSkuAccess({
      userId: user.id,
      userRole: user.role,
      action: 'EXPORT',
      sensitiveDataAccessed: user.role === 'BOSS',
      ipAddress: req.ip,
      userAgent: req.get('User-Agent') || '',
      details: { 
        exportCount: filteredData.length,
        filters: req.query 
      }
    });
    
    // 6. ç”Ÿæˆå¯¼å‡ºæ–‡ä»¶
    const exportFile = await generateExportFile(filteredData, user.role);
    
    res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
    res.setHeader('Content-Disposition', `attachment; filename=sku_export_${Date.now()}.xlsx`);
    res.send(exportFile);
    
  } catch (error) {
    console.error('SKUæ•°æ®å¯¼å‡ºå¤±è´¥:', error);
    res.status(500).json({
      success: false,
      error: { code: 'EXPORT_FAILED', message: 'å¯¼å‡ºå¤±è´¥' }
    });
  }
};
```

#### 6.4.2 å¯¼å‡ºæ–‡ä»¶å®‰å…¨

**æ–‡ä»¶å®‰å…¨æªæ–½ï¼š**
```typescript
// å¯¼å‡ºæ–‡ä»¶å®‰å…¨å¤„ç†
const generateSecureExportFile = async (data: any[], userRole: string) => {
  // 1. æ•°æ®è„±æ•å¤„ç†
  const sanitizedData = data.map(item => {
    if (userRole !== 'BOSS') {
      // ç§»é™¤æ•æ„Ÿå­—æ®µ
      const { materialCost, laborCost, craftCost, totalCost, profitMargin, totalValue, ...safeData } = item;
      return safeData;
    }
    return item;
  });
  
  // 2. æ·»åŠ æ°´å°ä¿¡æ¯
  const watermark = {
    exportedBy: userRole,
    exportTime: new Date().toISOString(),
    confidentiality: userRole === 'BOSS' ? 'æœºå¯†' : 'å†…éƒ¨ä½¿ç”¨'
  };
  
  // 3. ç”ŸæˆExcelæ–‡ä»¶
  const workbook = new ExcelJS.Workbook();
  const worksheet = workbook.addWorksheet('SKUæ•°æ®');
  
  // 4. æ·»åŠ è¡¨å¤´
  const headers = getExportHeaders(userRole);
  worksheet.addRow(headers);
  
  // 5. æ·»åŠ æ•°æ®
  sanitizedData.forEach(item => {
    const row = headers.map(header => item[header] || '');
    worksheet.addRow(row);
  });
  
  // 6. æ·»åŠ æ°´å°
  worksheet.addRow([]);
  worksheet.addRow(['å¯¼å‡ºä¿¡æ¯:', JSON.stringify(watermark)]);
  
  // 7. è®¾ç½®æ–‡ä»¶ä¿æŠ¤
  if (userRole === 'BOSS') {
    worksheet.protect('sku_export_password', {
      selectLockedCells: true,
      selectUnlockedCells: true
    });
  }
  
  return await workbook.xlsx.writeBuffer();
};
```

### 6.5 SKUç³»ç»Ÿå®‰å…¨ç›‘æ§

#### 6.5.1 å¼‚å¸¸è¡Œä¸ºæ£€æµ‹

**å¼‚å¸¸è¡Œä¸ºæ¨¡å¼ï¼š**
```typescript
// SKUå¼‚å¸¸è¡Œä¸ºæ£€æµ‹
const detectAnomalousSkuBehavior = async (userId: string, action: string, details: any) => {
  const anomalyPatterns = [
    {
      name: 'FREQUENT_LARGE_ADJUSTMENTS',
      condition: (logs: any[]) => {
        // æ£€æµ‹é¢‘ç¹å¤§é‡åº“å­˜è°ƒæ•´
        const largeAdjustments = logs.filter(log => 
          log.action === 'ADJUST' && 
          Math.abs(log.quantityChange) > 100
        );
        return largeAdjustments.length > 5; // 1å°æ—¶å†…è¶…è¿‡5æ¬¡å¤§é‡è°ƒæ•´
      },
      severity: 'HIGH',
      message: 'æ£€æµ‹åˆ°é¢‘ç¹å¤§é‡åº“å­˜è°ƒæ•´è¡Œä¸º'
    },
    
    {
      name: 'UNUSUAL_ACCESS_PATTERN',
      condition: (logs: any[]) => {
        // æ£€æµ‹å¼‚å¸¸è®¿é—®æ¨¡å¼
        const accessTimes = logs.map(log => new Date(log.timestamp).getHours());
        const nightAccess = accessTimes.filter(hour => hour < 6 || hour > 22);
        return nightAccess.length > 10; // å¤œé—´è®¿é—®è¶…è¿‡10æ¬¡
      },
      severity: 'MEDIUM',
      message: 'æ£€æµ‹åˆ°å¼‚å¸¸æ—¶é—´æ®µè®¿é—®è¡Œä¸º'
    },
    
    {
      name: 'RAPID_EXPORT_ATTEMPTS',
      condition: (logs: any[]) => {
        // æ£€æµ‹å¿«é€Ÿå¯¼å‡ºå°è¯•
        const exports = logs.filter(log => log.action === 'EXPORT');
        return exports.length > 3; // 1å°æ—¶å†…å¯¼å‡ºè¶…è¿‡3æ¬¡
      },
      severity: 'MEDIUM',
      message: 'æ£€æµ‹åˆ°é¢‘ç¹æ•°æ®å¯¼å‡ºè¡Œä¸º'
    }
  ];
  
  // è·å–ç”¨æˆ·æœ€è¿‘1å°æ—¶çš„æ“ä½œæ—¥å¿—
  const recentLogs = await getRecentSkuLogs(userId, 1);
  
  // æ£€æµ‹å¼‚å¸¸æ¨¡å¼
  for (const pattern of anomalyPatterns) {
    if (pattern.condition(recentLogs)) {
      await alertSecurityTeam({
        userId,
        pattern: pattern.name,
        severity: pattern.severity,
        message: pattern.message,
        details: { recentLogs, currentAction: action }
      });
    }
  }
};
```

#### 6.5.2 å®‰å…¨å‘Šè­¦æœºåˆ¶

**å‘Šè­¦é…ç½®ï¼š**
```typescript
// SKUå®‰å…¨å‘Šè­¦ç³»ç»Ÿ
const skuSecurityAlerts = {
  // å‘Šè­¦çº§åˆ«
  levels: {
    LOW: { color: 'green', notify: ['log'] },
    MEDIUM: { color: 'yellow', notify: ['log', 'email'] },
    HIGH: { color: 'red', notify: ['log', 'email', 'sms'] },
    CRITICAL: { color: 'red', notify: ['log', 'email', 'sms', 'phone'] }
  },
  
  // å‘Šè­¦è§„åˆ™
  rules: [
    {
      name: 'UNAUTHORIZED_ACCESS_ATTEMPT',
      level: 'HIGH',
      condition: 'JWTéªŒè¯å¤±è´¥æ¬¡æ•° > 5/åˆ†é’Ÿ',
      action: 'ä¸´æ—¶å°ç¦IPåœ°å€'
    },
    {
      name: 'SENSITIVE_DATA_BREACH_ATTEMPT',
      level: 'CRITICAL',
      condition: 'EMPLOYEEè§’è‰²å°è¯•è®¿é—®æ•æ„Ÿæ•°æ®',
      action: 'ç«‹å³é€šçŸ¥å®‰å…¨å›¢é˜Ÿ'
    },
    {
      name: 'BULK_OPERATION_ANOMALY',
      level: 'MEDIUM',
      condition: 'æ‰¹é‡æ“ä½œè¶…è¿‡æ­£å¸¸é˜ˆå€¼',
      action: 'è®°å½•è¯¦ç»†æ—¥å¿—å¹¶ç›‘æ§'
    }
  ],
  
  // é€šçŸ¥æ¸ é“
  notifications: {
    email: 'security@company.com',
    sms: '+86-138-0000-0000',
    webhook: 'https://hooks.slack.com/services/xxx'
  }
};

// å‘é€å®‰å…¨å‘Šè­¦
const sendSecurityAlert = async (alert: {
  level: string;
  title: string;
  message: string;
  details: any;
}) => {
  const config = skuSecurityAlerts.levels[alert.level];
  
  for (const channel of config.notify) {
    switch (channel) {
      case 'log':
        console.error(`[SKUå®‰å…¨å‘Šè­¦-${alert.level}] ${alert.title}: ${alert.message}`);
        break;
      case 'email':
        await sendEmailAlert(alert);
        break;
      case 'sms':
        await sendSmsAlert(alert);
        break;
      case 'phone':
        await makePhoneCall(alert);
        break;
    }
  }
};
```

### 6.6 SKUç³»ç»Ÿå®‰å…¨æœ€ä½³å®è·µ

#### 6.6.1 å¼€å‘å®‰å…¨è§„èŒƒ

**ä»£ç å®‰å…¨æ£€æŸ¥æ¸…å•ï¼š**
- [ ] æ‰€æœ‰SKU APIéƒ½æœ‰JWTè®¤è¯
- [ ] æ•æ„Ÿæ•°æ®æ ¹æ®è§’è‰²è¿‡æ»¤
- [ ] è¾“å…¥å‚æ•°éƒ½æœ‰éªŒè¯å’Œæ¸…ç†
- [ ] æ•°æ®åº“æŸ¥è¯¢ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
- [ ] é”™è¯¯ä¿¡æ¯ä¸æ³„éœ²æ•æ„Ÿä¿¡æ¯
- [ ] æ“ä½œæ—¥å¿—è®°å½•å®Œæ•´
- [ ] å¹¶å‘æ“ä½œæœ‰é€‚å½“æ§åˆ¶
- [ ] APIæœ‰åˆç†çš„é™æµè®¾ç½®

#### 6.6.2 éƒ¨ç½²å®‰å…¨è§„èŒƒ

**ç”Ÿäº§ç¯å¢ƒå®‰å…¨é…ç½®ï¼š**
```bash
# ç¯å¢ƒå˜é‡å®‰å…¨é…ç½®
JWT_SECRET=complex_random_string_min_32_chars
SKU_ENCRYPTION_KEY=another_complex_random_string
SKU_AUDIT_ENABLED=true
SKU_RATE_LIMIT_ENABLED=true
SKU_ANOMALY_DETECTION_ENABLED=true

# æ•°æ®åº“å®‰å…¨é…ç½®
SKU_DB_SSL_ENABLED=true
SKU_DB_CONNECTION_LIMIT=10
SKU_DB_QUERY_TIMEOUT=30000

# æ—¥å¿—å®‰å…¨é…ç½®
SKU_LOG_LEVEL=info
SKU_LOG_RETENTION_DAYS=90
SKU_SENSITIVE_LOG_MASKING=true
```

#### 6.6.3 è¿ç»´å®‰å…¨è§„èŒƒ

**å®šæœŸå®‰å…¨æ£€æŸ¥ï¼š**
```bash
#!/bin/bash
# SKUç³»ç»Ÿå®‰å…¨æ£€æŸ¥è„šæœ¬

echo "å¼€å§‹SKUç³»ç»Ÿå®‰å…¨æ£€æŸ¥..."

# 1. æ£€æŸ¥å¼‚å¸¸ç™»å½•
echo "æ£€æŸ¥å¼‚å¸¸ç™»å½•æ¨¡å¼..."
psql -d crystal_erp -c "
SELECT user_id, COUNT(*) as login_count, 
       array_agg(DISTINCT ip_address) as ip_addresses
FROM sku_audit_logs 
WHERE action = 'VIEW' 
  AND timestamp > NOW() - INTERVAL '24 hours'
GROUP BY user_id 
HAVING COUNT(DISTINCT ip_address) > 3;
"

# 2. æ£€æŸ¥å¤§é‡æ“ä½œ
echo "æ£€æŸ¥å¤§é‡åº“å­˜æ“ä½œ..."
psql -d crystal_erp -c "
SELECT user_id, action, COUNT(*) as operation_count
FROM sku_inventory_logs 
WHERE created_at > NOW() - INTERVAL '1 hour'
GROUP BY user_id, action 
HAVING COUNT(*) > 50;
"

# 3. æ£€æŸ¥æ•æ„Ÿæ•°æ®è®¿é—®
echo "æ£€æŸ¥æ•æ„Ÿæ•°æ®è®¿é—®..."
psql -d crystal_erp -c "
SELECT user_id, user_role, COUNT(*) as sensitive_access_count
FROM sku_audit_logs 
WHERE sensitive_data_accessed = true 
  AND timestamp > NOW() - INTERVAL '24 hours'
GROUP BY user_id, user_role;
"

echo "SKUç³»ç»Ÿå®‰å…¨æ£€æŸ¥å®Œæˆ"
```