## 文档 9：权限与安全规范文档（整合现有权限体系）

### 一、角色权限矩阵（提取自《业务流程文档》1.2、《数据库设计文档》1.3）

| 角色 | 功能模块  | 操作权限                       | 数据权限（敏感字段）                                      | 来源文档            |
| -- | ----- | -------------------------- | ----------------------------------------------- | --------------- |
| 老板 | 采购管理  | 录入 / 查询 / 编辑 / 删除 / 批量导入导出 | 可见所有字段（含 price\_per\_gram、total\_price），拥有完整编辑权限         | 《业务流程文档》1.2     |
| 老板 | 成品管理  | 录入 / 销售 / 销毁 / 批量导入导出      | 可见 materials、total\_cost、profit                 | 《业务流程文档》1.2     |
| 老板 | 供应商管理 | 查看 / 编辑 / 统计 / 手动创建        | 可见 contact\_person、phone、address                | 《业务流程文档》4.2     |
| 雇员 | 供应商管理 | 完全禁止访问                     | 接口返回403，前端隐藏所有供应商功能                             | 《API接口规范文档》2.5  |
| 雇员 | 采购管理  | 录入 / 查询（仅自己创建）/ 批量导出       | 隐藏 price\_per\_gram、total\_price、supplier\_info，禁止编辑操作 | 《数据库设计文档》1.3    |
| 雇员 | 成品管理  | 录入（仅基础信息）/ 销售 / 销毁         | 隐藏 materials、total\_cost、profit                 | 《数据库设计文档》1.3    |
| 雇员 | 库存管理  | 查询（仅基础信息）                  | 隐藏 price\_per\_bead、supplier\_name              | 《API 接口规范文档》5.1 |

### 二、敏感字段过滤规则（提取自《React 组件规范文档》4.2）

#### 2.1 敏感字段清单（按表分类）

| 表名              | 敏感字段                                              | 过滤规则（雇员）        | 来源文档            |
| --------------- | ------------------------------------------------- | --------------- | --------------- |
| purchases       | price\_per\_gram、total\_price、weight、supplier\_id | 返回 null         | 《数据库设计文档》1.3    |
| products        | materials、total\_cost、profit、profit\_margin       | 返回 null         | 《数据库设计文档》1.3    |
| suppliers       | contact\_person、phone、email、address               | 完全不可见（接口返回 403） | 《业务流程文档》1.2     |
| inventory\_view | price\_per\_bead、supplier\_name                   | 返回 null         | 《API 接口规范文档》5.1 |

#### 2.2 过滤实现（usePermission Hook，现有逻辑）

```typescript
const usePermission = () => {
  const { user } = useAuth();
  const isBoss = user?.role === 'boss';

  // 敏感数据过滤（递归处理嵌套字段）
  const filterSensitiveData = <T>(data: T): T => {
    if (isBoss) return data;

    const sensitiveFields = [
      'price_per_gram', 'total_price', 'weight', 'supplier_info',
      'materials', 'total_cost', 'profit', 'profit_margin'
    ];

    const filter = (item: any) => {
      if (Array.isArray(item)) return item.map(i => filter(i));
      if (typeof item !== 'object' || item === null) return item;

      const filtered = { ...item };
      Object.keys(filtered).forEach(key => {
        if (sensitiveFields.includes(key)) {
          filtered[key] = null; // 保留字段键名，避免前端报错
        } else if (typeof filtered[key] === 'object') {
          filtered[key] = filter(filtered[key]); // 嵌套字段过滤
        }
      });
      return filtered;
    };

    return filter(data) as T;
  };

  return { isBoss, filterSensitiveData };
};
```

### 三、供应商权限控制详细实现

#### 3.1 前端权限控制

#### 3.1.1 组件级权限控制

```typescript
// 权限包装组件
const PermissionWrapper: React.FC<{
  requiredRole: 'BOSS' | 'EMPLOYEE';
  children: React.ReactNode;
}> = ({ requiredRole, children }) => {
  const { user } = useAuth();
  
  if (user?.role !== requiredRole && requiredRole === 'BOSS') {
    return <div className="text-gray-500">权限不足</div>;
  }
  
  return <>{children}</>;
};
```

#### 3.1.2 供应商功能权限控制

```typescript
// 供应商功能权限检查
const SupplierPermissionWrapper: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const { user } = useAuth();
  
  if (user?.role !== 'BOSS') {
    return (
      <div className="text-gray-500 text-sm">
        <i className="fas fa-lock mr-2"></i>
        权限不足：仅老板可管理供应商信息
      </div>
    );
  }
  
  return <>{children}</>;
};

// 采购录入页面供应商选择权限控制
const PurchaseEntrySupplierSection: React.FC = () => {
  const { user } = useAuth();
  
  return (
    <div className="supplier-section">
      {user?.role === 'BOSS' ? (
        <>
          <label>供应商信息</label>
          <SupplierSelector />
          <CreateSupplierButton />
        </>
      ) : (
        <div className="text-gray-400 text-sm">
          <i className="fas fa-info-circle mr-2"></i>
          供应商信息仅老板可见
        </div>
      )}
    </div>
  );
};
```

#### 3.2 后端权限验证

#### 3.2.1 中间件权限检查

```typescript
// 权限验证中间件
const checkPermission = (requiredRole: string) => {
  return (req: Request, res: Response, next: NextFunction) => {
    if (req.user.role !== requiredRole) {
      return res.status(403).json({
        success: false,
        message: '权限不足',
        error: { code: 'INSUFFICIENT_PERMISSIONS' }
      });
    }
    next();
  };
};
```

#### 3.2.2 供应商API权限验证

```typescript
// 供应商API权限中间件
const checkSupplierPermission = (req: Request, res: Response, next: NextFunction) => {
  if (req.user.role !== 'BOSS') {
    return res.status(403).json({
      success: false,
      message: '权限不足，仅老板可查看供应商信息',
      error: {
        code: 'INSUFFICIENT_PERMISSIONS',
        details: '雇员无法访问供应商管理功能'
      }
    });
  }
  next();
};

// 应用到所有供应商路由
router.get('/', authenticateToken, checkSupplierPermission, asyncHandler(async (req, res) => {
  // 供应商列表查询逻辑
}));

router.post('/', authenticateToken, checkSupplierPermission, asyncHandler(async (req, res) => {
  // 供应商创建逻辑
}));
```

#### 3.2.3 采购记录编辑权限验证

```typescript
// 采购记录编辑权限中间件
const checkPurchaseEditPermission = (req: Request, res: Response, next: NextFunction) => {
  if (req.user.role !== 'BOSS') {
    return res.status(403).json({
      success: false,
      message: '权限不足，仅老板可编辑采购记录',
      error: {
        code: 'INSUFFICIENT_PERMISSIONS',
        details: '雇员无法编辑采购记录，仅可查看和录入'
      }
    });
  }
  next();
};

// 应用到采购记录编辑路由
router.put('/:id', authenticateToken, checkPurchaseEditPermission, asyncHandler(async (req, res) => {
  // 采购记录更新逻辑
  const { id } = req.params;
  const updateData = req.body;
  
  // 验证采购记录是否存在
  const existingPurchase = await prisma.purchase.findUnique({
    where: { id },
    include: { supplier: true, user: true }
  });
  
  if (!existingPurchase) {
    return res.status(404).json({
      success: false,
      message: '采购记录不存在',
      error: { code: 'PURCHASE_NOT_FOUND' }
    });
  }
  
  // 执行更新操作
  // ...
}));

// 采购记录删除权限验证
router.delete('/:id', authenticateToken, checkPurchaseEditPermission, asyncHandler(async (req, res) => {
  // 采购记录删除逻辑
}));
```

#### 3.3 数据一致性验证

```typescript
// 供应商数据一致性检查
const validateSupplierConsistency = {
  // 名称唯一性检查（忽略大小写和空格）
  checkNameUniqueness: async (name: string, excludeId?: string) => {
    const normalizedName = name.trim().toLowerCase();
    const existingSupplier = await prisma.supplier.findFirst({
      where: {
        name: {
          equals: normalizedName,
          mode: 'insensitive'
        },
        isActive: true,
        ...(excludeId && { id: { not: excludeId } })
      }
    });
    return !existingSupplier;
  },
  
  // ID和名称绑定关系验证
  validateIdNameBinding: (suppliers: Supplier[]) => {
    const idNameMap = new Map();
    const nameIdMap = new Map();
    const inconsistencies = [];
    
    suppliers.forEach(supplier => {
      if (supplier.id) {
        // 检查同一ID对应不同名称
        if (idNameMap.has(supplier.id) && idNameMap.get(supplier.id) !== supplier.name) {
          inconsistencies.push({
            type: 'ID_NAME_MISMATCH',
            id: supplier.id,
            existingName: idNameMap.get(supplier.id),
            newName: supplier.name
          });
        }
        idNameMap.set(supplier.id, supplier.name);
        
        // 检查同一名称对应不同ID
        if (nameIdMap.has(supplier.name) && nameIdMap.get(supplier.name) !== supplier.id) {
          inconsistencies.push({
            type: 'NAME_ID_MISMATCH',
            name: supplier.name,
            existingId: nameIdMap.get(supplier.name),
            newId: supplier.id
          });
        }
        nameIdMap.set(supplier.name, supplier.id);
      }
    });
    
    return inconsistencies;
  }
};
```

### 四、安全配置（提取自《系统架构文档》6 章）

#### 3.1 密码安全

* **加密算法**：bcrypt（成本因子 10）（提取自《系统架构文档》6.1）

* **密码规则**：长度 6-100 字符，禁止纯数字 / 纯字母（提取自《API 接口规范文档》2.1）

#### 3.2 接口安全

* **防 SQL 注入**：Prisma 参数化查询（提取自《系统架构文档》6.2）

* **防 XSS**：前端输入验证（Zod\@3.22.4）（提取自《系统架构文档》2.1.1）

* **跨域**：CORS 配置（仅允许指定域名）（提取自《系统架构文档》4.2）

```javascript
// CORS配置（现有逻辑）
const cors = require('cors');
app.use(cors({
  origin: process.env.CORS_ORIGIN || 'http://localhost:5173',
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH'],
  credentials: true
}));
```

