## 文档 9：权限与安全规范文档（基于materials表架构）

### 一、角色权限矩阵（materials表架构优化）

| 角色 | 功能模块  | 操作权限                       | 数据权限（敏感字段）                                      | 来源文档            |
| -- | ----- | -------------------------- | ----------------------------------------------- | --------------- |
| 老板 | 采购管理  | 录入 / 查询 / 编辑 / 删除 / 批量导入导出 | 可见所有字段（含 price\_per\_gram、total\_price），拥有完整编辑权限         | 《业务流程文档》1.2     |
| 老板 | SKU制作管理  | 制作 / 查询 / 成本计算 / 批量制作      | 可见所有成本字段（material\_cost、labor\_cost、craft\_cost、total\_cost、profit\_margin）                 | 《业务流程文档》2.1     |
| 老板 | SKU库存管理  | 查询 / 调整 / 销售 / 销毁 / 补货 / 状态管理      | 可见所有SKU字段，包括成本和利润信息                 | 《API接口规范文档》4.1     |
| 老板 | 成品管理  | 录入 / 销售 / 销毁 / 批量导入导出      | 可见 materials、total\_cost、profit                 | 《业务流程文档》1.2     |
| 老板 | 供应商管理 | 查看 / 编辑 / 统计 / 手动创建        | 可见 contact\_person、phone、address                | 《业务流程文档》4.2     |
| 雇员 | 供应商管理 | 完全禁止访问                     | 接口返回403，前端隐藏所有供应商功能                             | 《API接口规范文档》2.5  |
| 雇员 | 采购管理  | 录入 / 查询（仅自己创建）/ 批量导出       | 隐藏 price\_per\_gram、total\_price、supplier\_info，禁止编辑操作 | 《数据库设计文档》1.3    |
| 雇员 | SKU制作管理  | 制作 / 查询（基础信息）/ 批量制作         | 隐藏所有成本字段（material\_cost、labor\_cost、craft\_cost、total\_cost、profit\_margin）                 | 《业务流程文档》2.1     |
| 雇员 | SKU库存管理  | 查询（基础信息）/ 销售 / 销毁         | 隐藏成本和利润字段，仅可见基础库存信息                 | 《API接口规范文档》4.1     |
| 雇员 | 成品管理  | 录入（仅基础信息）/ 销售 / 销毁         | 隐藏 materials、total\_cost、profit                 | 《数据库设计文档》1.3    |
| 雇员 | 库存管理  | 查询（仅基础信息）                  | 隐藏 unit\_cost、supplier\_name、purchase\_id | 《API 接口规范文档》5.1 |
| 老板 | 库存弹窗  | 查看完整信息（含价格、批次、material编号）       | 可见所有materials表字段，包括unit\_cost和supplier\_name                         | 《UI设计规范文档》5.6   |
| 雇员 | 库存弹窗  | 查看基础信息（隐藏价格）               | 隐藏 unit\_cost、supplier\_name、purchase\_id      | 《UI设计规范文档》5.6   |
| 老板 | 原材料管理 | 查询 / 编辑 / 删除 / 状态管理 | 可见materials表所有字段，包括库存计算和成本信息 | materials表架构文档 |
| 雇员 | 原材料管理 | 查询（基础信息） | 隐藏 unit\_cost、purchase\_id、supplier\_name | materials表架构文档 |

### 二、敏感字段过滤规则（基于materials表架构）

#### 2.1 敏感字段清单（按表分类，materials表优先）

| 表名              | 敏感字段                                              | 过滤规则（雇员）        | 来源文档            |
| --------------- | ------------------------------------------------- | --------------- | --------------- |
| materials       | unit\_cost、supplier\_name、purchase\_id           | 返回 null         | materials表架构文档    |
| purchases       | price\_per\_gram、total\_price、weight、supplier\_id | 返回 null         | 《数据库设计文档》1.3    |
| products        | materials、total\_cost、profit、profit\_margin       | 返回 null         | 《数据库设计文档》1.3    |
| product\_skus    | material\_cost、labor\_cost、craft\_cost、total\_cost、profit\_margin、unit\_price、total\_value | 返回 null         | 《数据库设计文档》2.2    |
| sku\_inventory\_logs | unit\_price、total\_amount | 返回 null         | 《数据库设计文档》2.3    |
| material\_usages | unit\_cost、total\_cost | 返回 null         | 《数据库设计文档》2.4    |
| suppliers       | contact\_person、phone、email、address               | 完全不可见（接口返回 403） | 《业务流程文档》1.2     |
| 库存弹窗数据（materials表） | unit\_cost、supplier\_name、purchase\_id           | 前端隐藏显示        | 《UI设计规范文档》5.6   |

#### 2.2 过滤实现（usePermission Hook，现有逻辑）

```typescript
const usePermission = () => {
  const { user } = useAuth();
  const isBoss = user?.role === 'BOSS';

  // 敏感数据过滤（递归处理嵌套字段）
  const filterSensitiveData = <T>(data: T): T => {
    if (isBoss) return data;

    const sensitiveFields = [
      // purchases表敏感字段
      'price_per_gram', 'total_price', 'weight', 'supplier_info',
      // products表敏感字段
      'materials', 'total_cost', 'profit', 'profit_margin',
      // materials表敏感字段
      'unit_cost', 'supplier_name', 'purchase_id',
      // product_skus表敏感字段（新增）
      'material_cost', 'labor_cost', 'craft_cost', 'total_cost', 'profit_margin', 'unit_price', 'total_value',
      // sku_inventory_logs表敏感字段（新增）
      'unit_price', 'total_amount',
      // material_usages表敏感字段（新增）
      'unit_cost', 'total_cost'
    ];

    const filter = (item: any) => {
      if (Array.isArray(item)) return item.map(i => filter(i));
      if (typeof item !== 'object' || item === null) return item;

      const filtered = { ...item };
      Object.keys(filtered).forEach(key => {
        if (sensitiveFields.includes(key)) {
          filtered[key] = null; // 保留字段键名，避免前端报错
        } else if (typeof filtered[key] === 'object') {
          filtered[key] = filter(filtered[key]); // 嵌套字段过滤
        }
      });
      return filtered;
    };

    return filter(data) as T;
  };

  return { isBoss, filterSensitiveData };
};
```

### 三、供应商权限控制详细实现

#### 3.1 前端权限控制

#### 3.1.1 组件级权限控制

```typescript
// 权限包装组件
const PermissionWrapper: React.FC<{
  requiredRole: 'BOSS' | 'EMPLOYEE';
  children: React.ReactNode;
}> = ({ requiredRole, children }) => {
  const { user } = useAuth();
  
  if (user?.role !== requiredRole && requiredRole === 'BOSS') {
    return <div className="text-gray-500">权限不足</div>;
  }
  
  return <>{children}</>;
};
```

#### 3.1.2 供应商功能权限控制

```typescript
// 供应商功能权限检查
const SupplierPermissionWrapper: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const { user } = useAuth();
  
  if (user?.role !== 'BOSS') {
    return (
      <div className="text-gray-500 text-sm">
        <i className="fas fa-lock mr-2"></i>
        权限不足：仅老板可管理供应商信息
      </div>
    );
  }
  
  return <>{children}</>;
};

// 采购录入页面供应商选择权限控制
const PurchaseEntrySupplierSection: React.FC = () => {
  const { user } = useAuth();
  
  return (
    <div className="supplier-section">
      {user?.role === 'BOSS' ? (
        <>
          <label>供应商信息</label>
          <SupplierSelector />
          <CreateSupplierButton />
        </>
      ) : (
        <div className="text-gray-400 text-sm">
          <i className="fas fa-info-circle mr-2"></i>
          供应商信息仅老板可见
        </div>
      )}
    </div>
  );
};
```

#### 3.2 后端权限验证

#### 3.2.1 中间件权限检查

```typescript
// 权限验证中间件
const checkPermission = (requiredRole: string) => {
  return (req: Request, res: Response, next: NextFunction) => {
    if (req.user.role !== requiredRole) {
      return res.status(403).json({
        success: false,
        message: '权限不足',
        error: { code: 'INSUFFICIENT_PERMISSIONS' }
      });
    }
    next();
  };
};
```

#### 3.2.2 供应商API权限验证

```typescript
// 供应商API权限中间件
const checkSupplierPermission = (req: Request, res: Response, next: NextFunction) => {
  if (req.user.role !== 'BOSS') {
    return res.status(403).json({
      success: false,
      message: '权限不足，仅老板可查看供应商信息',
      error: {
        code: 'INSUFFICIENT_PERMISSIONS',
        details: '雇员无法访问供应商管理功能'
      }
    });
  }
  next();
};

// 应用到所有供应商路由
router.get('/', authenticateToken, checkSupplierPermission, asyncHandler(async (req, res) => {
  // 供应商列表查询逻辑
}));

router.post('/', authenticateToken, checkSupplierPermission, asyncHandler(async (req, res) => {
  // 供应商创建逻辑
}));
```

#### 3.2.3 采购记录编辑权限验证

```typescript
// 采购记录编辑权限中间件
const checkPurchaseEditPermission = (req: Request, res: Response, next: NextFunction) => {
  if (req.user.role !== 'BOSS') {
    return res.status(403).json({
      success: false,
      message: '权限不足，仅老板可编辑采购记录',
      error: {
        code: 'INSUFFICIENT_PERMISSIONS',
        details: '雇员无法编辑采购记录，仅可查看和录入'
      }
    });
  }
  next();
};

// 应用到采购记录编辑路由
router.put('/:id', authenticateToken, checkPurchaseEditPermission, asyncHandler(async (req, res) => {
  // 采购记录更新逻辑
  const { id } = req.params;
  const updateData = req.body;
  
  // 验证采购记录是否存在
  const existingPurchase = await prisma.purchase.findUnique({
    where: { id },
    include: { supplier: true, user: true }
  });
  
  if (!existingPurchase) {
    return res.status(404).json({
      success: false,
      message: '采购记录不存在',
      error: { code: 'PURCHASE_NOT_FOUND' }
    });
  }
  
  // 执行更新操作
  // ...
}));

// 采购记录删除权限验证
router.delete('/:id', authenticateToken, checkPurchaseEditPermission, asyncHandler(async (req, res) => {
  // 采购记录删除逻辑
}));
```

#### 3.3 数据一致性验证

```typescript
// 供应商数据一致性检查
const validateSupplierConsistency = {
  // 名称唯一性检查（忽略大小写和空格）
  checkNameUniqueness: async (name: string, excludeId?: string) => {
    const normalizedName = name.trim().toLowerCase();
    const existingSupplier = await prisma.supplier.findFirst({
      where: {
        name: {
          equals: normalizedName,
          mode: 'insensitive'
        },
        isActive: true,
        ...(excludeId && { id: { not: excludeId } })
      }
    });
    return !existingSupplier;
  },
  
  // ID和名称绑定关系验证
  validateIdNameBinding: (suppliers: Supplier[]) => {
    const idNameMap = new Map();
    const nameIdMap = new Map();
    const inconsistencies = [];
    
    suppliers.forEach(supplier => {
      if (supplier.id) {
        // 检查同一ID对应不同名称
        if (idNameMap.has(supplier.id) && idNameMap.get(supplier.id) !== supplier.name) {
          inconsistencies.push({
            type: 'ID_NAME_MISMATCH',
            id: supplier.id,
            existingName: idNameMap.get(supplier.id),
            newName: supplier.name
          });
        }
        idNameMap.set(supplier.id, supplier.name);
        
        // 检查同一名称对应不同ID
        if (nameIdMap.has(supplier.name) && nameIdMap.get(supplier.name) !== supplier.id) {
          inconsistencies.push({
            type: 'NAME_ID_MISMATCH',
            name: supplier.name,
            existingId: nameIdMap.get(supplier.name),
            newId: supplier.id
          });
        }
        nameIdMap.set(supplier.name, supplier.id);
      }
    });
    
    return inconsistencies;
  }
};
```

### 四、安全配置（提取自《系统架构文档》6 章）

#### 4.1 密码安全

* **加密算法**：bcrypt（成本因子 10）（提取自《系统架构文档》6.1）

* **密码规则**：长度 6-100 字符，禁止纯数字 / 纯字母（提取自《API 接口规范文档》2.1）

#### 4.2 接口安全

* **防 SQL 注入**：Prisma 参数化查询（提取自《系统架构文档》6.2）

* **防 XSS**：前端输入验证（Zod\@3.22.4）（提取自《系统架构文档》2.1.1）

* **跨域**：CORS 配置（仅允许指定域名）（提取自《系统架构文档》4.2）

```javascript
// CORS配置（现有逻辑）
const cors = require('cors');
app.use(cors({
  origin: process.env.CORS_ORIGIN || 'http://localhost:5173',
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH'],
  credentials: true
}));
```

### 五、前端权限控制实现

#### 5.1 权限Hook实现

**useSkuPermissions Hook：**
```typescript
import { useMemo } from 'react'
import { useAuth } from './useAuth'

export interface SkuPermissions {
  can_view_price: boolean
  can_sell: boolean
  can_destroy: boolean
  can_adjust: boolean
  can_refund: boolean
  can_view_trace: boolean
  canViewTrace: boolean
  canViewHistory: boolean
  canBatchOperate: boolean
  canExport: boolean
  can_manage: boolean
}

const ROLE_PERMISSIONS: Record<string, SkuPermissions> = {
  BOSS: {
    can_view_price: true,
    can_sell: true,
    can_destroy: true,
    can_adjust: true,
    can_refund: true,
    can_view_trace: true,
    canViewTrace: true,
    canViewHistory: true,
    canBatchOperate: true,
    canExport: true,
    can_manage: true,
  },
  MANAGER: {
    can_view_price: true,
    can_sell: true,
    can_destroy: true,
    can_adjust: true,
    can_refund: true,
    can_view_trace: true,
    canViewTrace: true,
    canViewHistory: true,
    canBatchOperate: true,
    canExport: true,
    can_manage: false,
  },
  EMPLOYEE: {
    can_view_price: false,
    can_sell: true,
    can_destroy: false,
    can_adjust: false,
    can_refund: false,
    can_view_trace: true,
    canViewTrace: true,
    canViewHistory: false,
    canBatchOperate: false,
    canExport: false,
    can_manage: false,
  },
  VIEWER: {
    can_view_price: false,
    can_sell: false,
    can_destroy: false,
    can_adjust: false,
    can_refund: false,
    can_view_trace: false,
    canViewTrace: false,
    canViewHistory: false,
    canBatchOperate: false,
    canExport: false,
    can_manage: false,
  },
}

export const use_sku_permissions = (): SkuPermissions => {
  const { user } = useAuth()

  const permissions = useMemo(() => {
    if (!user) {
      return ROLE_PERMISSIONS.VIEWER
    }

    const userRole = user.role?.toUpperCase() || 'VIEWER'
    const rolePermissions = ROLE_PERMISSIONS[userRole]

    if (!rolePermissions) {
      console.warn(`未知用户角色: ${userRole}，使用默认权限`)
      return ROLE_PERMISSIONS.VIEWER
    }

    return rolePermissions
  }, [user])

  return permissions
}
```

#### 5.2 SKU销售列表权限控制实现

**SalesList组件权限集成：**
```typescript
// 在SalesList组件中使用权限控制
const permissions = use_sku_permissions()

// 价格信息显示控制
{permissions.can_view_price && (
  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
    售价
  </th>
)}

{permissions.can_view_price && (
  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
    利润率
  </th>
)}

// 操作按钮权限控制
{permissions.can_sell && sku.available_quantity > 0 && sku.status === 'ACTIVE' && (
  <button
    onClick={() => open_detail_modal(sku, 'sell')}
    className="inline-flex items-center px-2 py-1 text-xs font-medium text-white bg-green-600 rounded hover:bg-green-700"
    title="销售"
  >
    <ShoppingCart className="h-3 w-3" />
  </button>
)}

{permissions.can_destroy && sku.available_quantity > 0 && (
  <button
    onClick={() => open_detail_modal(sku, 'destroy')}
    className="inline-flex items-center px-2 py-1 text-xs font-medium text-white bg-red-600 rounded hover:bg-red-700"
    title="销毁"
  >
    <Trash2 className="h-3 w-3" />
  </button>
)}

{permissions.can_adjust && (
  <button
    onClick={() => open_detail_modal(sku, 'restock')}
    className="inline-flex items-center px-2 py-1 text-xs font-medium text-gray-700 border border-gray-300 rounded hover:bg-gray-50"
    title="补货"
  >
    <Package className="h-3 w-3" />
  </button>
)}

{permissions.can_manage && (
  <button
    onClick={() => open_detail_modal(sku, 'control')}
    className="inline-flex items-center px-2 py-1 text-xs font-medium text-gray-700 border border-gray-300 rounded hover:bg-gray-50"
    title="调控"
  >
    <Settings className="h-3 w-3" />
  </button>
)}
```

**移动端权限控制：**
```typescript
// 移动端卡片布局中的权限控制
{permissions.can_view_price && (
  <div className="mt-2 flex items-center justify-between">
    <div className="text-xs text-gray-600">
      单价: {format_price(sku.selling_price)}
    </div>
    {sku.profit_margin && (
      <div className="text-xs text-gray-600">
        利润率: {formatProfitMargin(sku.profit_margin)}
      </div>
    )}
  </div>
)}

// 移动端操作按钮权限控制
<div className="mt-3 flex items-center space-x-2">
  <button
    onClick={() => open_detail_modal(sku, 'view')}
    className="flex-1 inline-flex items-center justify-center px-3 py-1.5 text-xs font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200"
  >
    <Eye className="h-3 w-3 mr-1" />
    查看
  </button>
  
  {permissions.can_sell && sku.available_quantity > 0 && sku.status === 'ACTIVE' && (
    <button
      onClick={() => open_detail_modal(sku, 'sell')}
      className="flex-1 inline-flex items-center justify-center px-3 py-1.5 text-xs font-medium text-white bg-green-600 rounded-lg hover:bg-green-700"
    >
      <ShoppingCart className="h-3 w-3 mr-1" />
      销售
    </button>
  )}
  
  {permissions.can_destroy && sku.available_quantity > 0 && (
    <button
      onClick={() => open_detail_modal(sku, 'destroy')}
      className="flex-1 inline-flex items-center justify-center px-3 py-1.5 text-xs font-medium text-white bg-red-600 rounded-lg hover:bg-red-700"
    >
      <Trash2 className="h-3 w-3 mr-1" />
      销毁
    </button>
  )}
  
  {permissions.can_manage && (
    <button
      onClick={() => open_detail_modal(sku, 'control')}
      className="flex-1 inline-flex items-center justify-center px-3 py-1.5 text-xs font-medium text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50"
    >
      <Settings className="h-3 w-3 mr-1" />
      调控
    </button>
  )}
</div>
```


## 6. SKU系统权限与安全规范

### 6.1 SKU操作权限控制

#### 6.1.1 SKU查看权限

**权限分级：**
- **所有用户**：可以查看SKU基础信息（名称、编号、库存数量、状态）
- **BOSS角色**：可以查看完整SKU信息，包括成本、价格、利润率等敏感数据
- **EMPLOYEE角色**：敏感字段自动过滤，返回null或隐藏

**权限实现：**
```typescript
// 后端权限过滤
const filterSkuDataByRole = (skuData: any[], userRole: string) => {
  if (userRole === 'BOSS') {
    return skuData; // 返回完整数据
  }
  
  // EMPLOYEE角色过滤敏感字段
  return skuData.map(sku => {
    const { 
      materialCost, 
      laborCost, 
      craftCost, 
      totalCost, 
      profitMargin,
      totalValue,
      ...publicFields 
    } = sku;
    
    return {
      ...publicFields,
      // 敏感字段设为null
      materialCost: null,
      laborCost: null,
      craftCost: null,
      totalCost: null,
      profitMargin: null,
      totalValue: null
    };
  });
};
```

#### 6.1.2 SKU操作权限

**操作权限矩阵：**

| 操作类型 | BOSS权限 | EMPLOYEE权限 | 权限验证方式 |
|---------|----------|-------------|-------------|
| 查看SKU列表 | ✅ 完整信息 | ✅ 基础信息 | JWT + 角色过滤 |
| 查看SKU详情 | ✅ 完整信息 | ✅ 基础信息 | JWT + 角色过滤 |
| 库存调整 | ✅ 允许 | ✅ 允许 | JWT验证 |
| 销售记录 | ✅ 允许 | ✅ 允许 | JWT验证 |
| 查看变更历史 | ✅ 允许 | ✅ 允许 | JWT验证 |
| 查看统计信息 | ✅ 完整统计 | ✅ 基础统计 | JWT + 角色过滤 |
| SKU生成 | 🔄 自动触发 | 🔄 自动触发 | 系统自动 |
| SKU删除 | ❌ 不支持 | ❌ 不支持 | 业务限制 |

**权限验证中间件：**
```typescript
// SKU权限验证中间件
const verifySkuPermission = (requiredRole?: string) => {
  return (req: Request, res: Response, next: NextFunction) => {
    try {
      // 1. 验证JWT Token
      const token = req.headers.authorization?.replace('Bearer ', '');
      if (!token) {
        return res.status(401).json({
          success: false,
          error: {
            code: 'UNAUTHORIZED',
            message: '未提供认证令牌'
          }
        });
      }
      
      // 2. 解析用户信息
      const decoded = jwt.verify(token, process.env.JWT_SECRET!) as any;
      req.user = decoded;
      
      // 3. 检查角色权限（如果需要）
      if (requiredRole && decoded.role !== requiredRole) {
        return res.status(403).json({
          success: false,
          error: {
            code: 'INSUFFICIENT_ROLE',
            message: `需要${requiredRole}角色权限`
          }
        });
      }
      
      next();
    } catch (error) {
      return res.status(401).json({
        success: false,
        error: {
          code: 'INVALID_TOKEN',
          message: '无效的认证令牌'
        }
      });
    }
  };
};
```

### 6.2 SKU数据安全保护

#### 6.2.1 敏感数据加密

**敏感字段识别：**
- `materialCost` - 原材料成本
- `laborCost` - 人工成本
- `craftCost` - 工艺成本
- `totalCost` - 总成本
- `profitMargin` - 利润率
- `totalValue` - 总价值

**数据传输加密：**
```typescript
// 敏感数据传输加密
const encryptSensitiveData = (data: any) => {
  const sensitiveFields = ['materialCost', 'laborCost', 'craftCost', 'totalCost', 'profitMargin', 'totalValue'];
  
  const encrypted = { ...data };
  
  sensitiveFields.forEach(field => {
    if (encrypted[field] !== null && encrypted[field] !== undefined) {
      // 使用AES加密敏感数据
      encrypted[field] = encrypt(encrypted[field].toString());
    }
  });
  
  return encrypted;
};

// 前端解密敏感数据
const decryptSensitiveData = (data: any, userRole: string) => {
  if (userRole !== 'BOSS') {
    return data; // 非BOSS角色不解密
  }
  
  const sensitiveFields = ['materialCost', 'laborCost', 'craftCost', 'totalCost', 'profitMargin', 'totalValue'];
  
  const decrypted = { ...data };
  
  sensitiveFields.forEach(field => {
    if (decrypted[field] && typeof decrypted[field] === 'string') {
      try {
        decrypted[field] = parseFloat(decrypt(decrypted[field]));
      } catch (error) {
        console.warn(`解密字段${field}失败:`, error);
        decrypted[field] = null;
      }
    }
  });
  
  return decrypted;
};
```

#### 6.2.2 数据访问审计

**审计日志记录：**
```typescript
// SKU访问审计日志
interface SkuAuditLog {
  id: string;
  userId: string;
  userRole: string;
  action: 'VIEW' | 'ADJUST' | 'SELL' | 'EXPORT';
  skuId?: string;
  skuCode?: string;
  sensitiveDataAccessed: boolean;
  ipAddress: string;
  userAgent: string;
  timestamp: Date;
  details?: any;
}

// 记录SKU访问日志
const logSkuAccess = async (auditData: Omit<SkuAuditLog, 'id' | 'timestamp'>) => {
  try {
    await prisma.skuAuditLog.create({
      data: {
        ...auditData,
        timestamp: new Date()
      }
    });
  } catch (error) {
    console.error('记录SKU审计日志失败:', error);
  }
};

// 在SKU API中使用审计日志
router.get('/skus', verifySkuPermission(), async (req, res) => {
  try {
    const skus = await getSkuList(req.query);
    const filteredSkus = filterSkuDataByRole(skus, req.user.role);
    
    // 记录访问日志
    await logSkuAccess({
      userId: req.user.id,
      userRole: req.user.role,
      action: 'VIEW',
      sensitiveDataAccessed: req.user.role === 'BOSS',
      ipAddress: req.ip,
      userAgent: req.get('User-Agent') || '',
      details: { query: req.query }
    });
    
    res.json({ success: true, data: filteredSkus });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
});
```

### 6.3 SKU操作安全控制

#### 6.3.1 库存操作安全

**操作验证规则：**
```typescript
// SKU库存操作安全验证
const validateSkuInventoryOperation = (operation: {
  skuId: string;
  action: 'ADJUST' | 'SELL';
  quantity: number;
  userId: string;
}) => {
  const validationRules = {
    // 数量限制
    quantity: {
      min: 1,
      max: 9999,
      message: '操作数量必须在1-9999之间'
    },
    
    // 操作频率限制
    frequency: {
      maxOperationsPerHour: 100,
      message: '操作过于频繁，请稍后重试'
    },
    
    // 单次操作限制
    singleOperation: {
      maxQuantityPerOperation: 1000,
      message: '单次操作数量不能超过1000'
    }
  };
  
  // 验证数量范围
  if (operation.quantity < validationRules.quantity.min || 
      operation.quantity > validationRules.quantity.max) {
    throw new Error(validationRules.quantity.message);
  }
  
  // 验证单次操作限制
  if (operation.quantity > validationRules.singleOperation.maxQuantityPerOperation) {
    throw new Error(validationRules.singleOperation.message);
  }
  
  return true;
};
```

#### 6.3.2 并发操作控制

**乐观锁实现：**
```typescript
// SKU乐观锁并发控制
const updateSkuWithOptimisticLock = async (skuId: string, updateData: any, expectedVersion: number) => {
  const transaction = await prisma.$transaction(async (tx) => {
    // 1. 查询当前SKU版本
    const currentSku = await tx.productSku.findUnique({
      where: { id: skuId },
      select: { id: true, version: true, availableQuantity: true }
    });
    
    if (!currentSku) {
      throw new Error('SKU不存在');
    }
    
    // 2. 检查版本冲突
    if (currentSku.version !== expectedVersion) {
      throw new Error('数据已被其他用户修改，请刷新后重试');
    }
    
    // 3. 执行更新操作
    const updatedSku = await tx.productSku.update({
      where: { id: skuId },
      data: {
        ...updateData,
        version: currentSku.version + 1, // 版本号递增
        updatedAt: new Date()
      }
    });
    
    return updatedSku;
  });
  
  return transaction;
};
```

#### 6.3.3 操作限流控制

**API限流实现：**
```typescript
// SKU操作限流中间件
const skuRateLimit = rateLimit({
  windowMs: 60 * 1000, // 1分钟窗口
  max: (req) => {
    // 根据用户角色设置不同限制
    if (req.user?.role === 'BOSS') {
      return 200; // BOSS角色每分钟200次
    }
    return 100; // EMPLOYEE角色每分钟100次
  },
  message: {
    success: false,
    error: {
      code: 'RATE_LIMIT_EXCEEDED',
      message: '操作过于频繁，请稍后重试'
    }
  },
  standardHeaders: true,
  legacyHeaders: false,
  keyGenerator: (req) => {
    // 基于用户ID和IP地址生成限流键
    return `sku_ops:${req.user?.id || 'anonymous'}:${req.ip}`;
  }
});

// 在SKU路由中应用限流
router.put('/skus/:id/adjust', skuRateLimit, verifySkuPermission(), async (req, res) => {
  // SKU库存调整逻辑
});

router.post('/skus/:id/sell', skuRateLimit, verifySkuPermission(), async (req, res) => {
  // SKU销售记录逻辑
});
```

### 6.4 SKU数据导出安全

#### 6.4.1 导出权限控制

**导出权限规则：**
- **BOSS角色**：可以导出完整SKU数据，包括成本和利润信息
- **EMPLOYEE角色**：只能导出基础SKU数据，敏感信息自动过滤
- **导出频率限制**：每用户每小时最多导出5次
- **导出数量限制**：单次最多导出1000条记录

**导出安全实现：**
```typescript
// SKU数据导出安全控制
const exportSkuData = async (req: Request, res: Response) => {
  try {
    // 1. 验证导出权限
    const user = req.user;
    if (!user) {
      return res.status(401).json({
        success: false,
        error: { code: 'UNAUTHORIZED', message: '未授权访问' }
      });
    }
    
    // 2. 检查导出频率限制
    const exportCount = await checkExportFrequency(user.id);
    if (exportCount >= 5) {
      return res.status(429).json({
        success: false,
        error: { code: 'EXPORT_LIMIT_EXCEEDED', message: '导出次数超限' }
      });
    }
    
    // 3. 获取SKU数据
    const skuData = await getSkuDataForExport(req.query);
    
    // 4. 根据角色过滤敏感数据
    const filteredData = filterSkuDataByRole(skuData, user.role);
    
    // 5. 记录导出日志
    await logSkuAccess({
      userId: user.id,
      userRole: user.role,
      action: 'EXPORT',
      sensitiveDataAccessed: user.role === 'BOSS',
      ipAddress: req.ip,
      userAgent: req.get('User-Agent') || '',
      details: { 
        exportCount: filteredData.length,
        filters: req.query 
      }
    });
    
    // 6. 生成导出文件
    const exportFile = await generateExportFile(filteredData, user.role);
    
    res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
    res.setHeader('Content-Disposition', `attachment; filename=sku_export_${Date.now()}.xlsx`);
    res.send(exportFile);
    
  } catch (error) {
    console.error('SKU数据导出失败:', error);
    res.status(500).json({
      success: false,
      error: { code: 'EXPORT_FAILED', message: '导出失败' }
    });
  }
};
```

#### 6.4.2 导出文件安全

**文件安全措施：**
```typescript
// 导出文件安全处理
const generateSecureExportFile = async (data: any[], userRole: string) => {
  // 1. 数据脱敏处理
  const sanitizedData = data.map(item => {
    if (userRole !== 'BOSS') {
      // 移除敏感字段
      const { materialCost, laborCost, craftCost, totalCost, profitMargin, totalValue, ...safeData } = item;
      return safeData;
    }
    return item;
  });
  
  // 2. 添加水印信息
  const watermark = {
    exportedBy: userRole,
    exportTime: new Date().toISOString(),
    confidentiality: userRole === 'BOSS' ? '机密' : '内部使用'
  };
  
  // 3. 生成Excel文件
  const workbook = new ExcelJS.Workbook();
  const worksheet = workbook.addWorksheet('SKU数据');
  
  // 4. 添加表头
  const headers = getExportHeaders(userRole);
  worksheet.addRow(headers);
  
  // 5. 添加数据
  sanitizedData.forEach(item => {
    const row = headers.map(header => item[header] || '');
    worksheet.addRow(row);
  });
  
  // 6. 添加水印
  worksheet.addRow([]);
  worksheet.addRow(['导出信息:', JSON.stringify(watermark)]);
  
  // 7. 设置文件保护
  if (userRole === 'BOSS') {
    worksheet.protect('sku_export_password', {
      selectLockedCells: true,
      selectUnlockedCells: true
    });
  }
  
  return await workbook.xlsx.writeBuffer();
};
```

### 6.5 SKU系统安全监控

#### 6.5.1 异常行为检测

**异常行为模式：**
```typescript
// SKU异常行为检测
const detectAnomalousSkuBehavior = async (userId: string, action: string, details: any) => {
  const anomalyPatterns = [
    {
      name: 'FREQUENT_LARGE_ADJUSTMENTS',
      condition: (logs: any[]) => {
        // 检测频繁大量库存调整
        const largeAdjustments = logs.filter(log => 
          log.action === 'ADJUST' && 
          Math.abs(log.quantityChange) > 100
        );
        return largeAdjustments.length > 5; // 1小时内超过5次大量调整
      },
      severity: 'HIGH',
      message: '检测到频繁大量库存调整行为'
    },
    
    {
      name: 'UNUSUAL_ACCESS_PATTERN',
      condition: (logs: any[]) => {
        // 检测异常访问模式
        const accessTimes = logs.map(log => new Date(log.timestamp).getHours());
        const nightAccess = accessTimes.filter(hour => hour < 6 || hour > 22);
        return nightAccess.length > 10; // 夜间访问超过10次
      },
      severity: 'MEDIUM',
      message: '检测到异常时间段访问行为'
    },
    
    {
      name: 'RAPID_EXPORT_ATTEMPTS',
      condition: (logs: any[]) => {
        // 检测快速导出尝试
        const exports = logs.filter(log => log.action === 'EXPORT');
        return exports.length > 3; // 1小时内导出超过3次
      },
      severity: 'MEDIUM',
      message: '检测到频繁数据导出行为'
    }
  ];
  
  // 获取用户最近1小时的操作日志
  const recentLogs = await getRecentSkuLogs(userId, 1);
  
  // 检测异常模式
  for (const pattern of anomalyPatterns) {
    if (pattern.condition(recentLogs)) {
      await alertSecurityTeam({
        userId,
        pattern: pattern.name,
        severity: pattern.severity,
        message: pattern.message,
        details: { recentLogs, currentAction: action }
      });
    }
  }
};
```

#### 6.5.2 安全告警机制

**告警配置：**
```typescript
// SKU安全告警系统
const skuSecurityAlerts = {
  // 告警级别
  levels: {
    LOW: { color: 'green', notify: ['log'] },
    MEDIUM: { color: 'yellow', notify: ['log', 'email'] },
    HIGH: { color: 'red', notify: ['log', 'email', 'sms'] },
    CRITICAL: { color: 'red', notify: ['log', 'email', 'sms', 'phone'] }
  },
  
  // 告警规则
  rules: [
    {
      name: 'UNAUTHORIZED_ACCESS_ATTEMPT',
      level: 'HIGH',
      condition: 'JWT验证失败次数 > 5/分钟',
      action: '临时封禁IP地址'
    },
    {
      name: 'SENSITIVE_DATA_BREACH_ATTEMPT',
      level: 'CRITICAL',
      condition: 'EMPLOYEE角色尝试访问敏感数据',
      action: '立即通知安全团队'
    },
    {
      name: 'BULK_OPERATION_ANOMALY',
      level: 'MEDIUM',
      condition: '批量操作超过正常阈值',
      action: '记录详细日志并监控'
    }
  ],
  
  // 通知渠道
  notifications: {
    email: 'security@company.com',
    sms: '+86-138-0000-0000',
    webhook: 'https://hooks.slack.com/services/xxx'
  }
};

// 发送安全告警
const sendSecurityAlert = async (alert: {
  level: string;
  title: string;
  message: string;
  details: any;
}) => {
  const config = skuSecurityAlerts.levels[alert.level];
  
  for (const channel of config.notify) {
    switch (channel) {
      case 'log':
        console.error(`[SKU安全告警-${alert.level}] ${alert.title}: ${alert.message}`);
        break;
      case 'email':
        await sendEmailAlert(alert);
        break;
      case 'sms':
        await sendSmsAlert(alert);
        break;
      case 'phone':
        await makePhoneCall(alert);
        break;
    }
  }
};
```

### 6.6 SKU系统安全最佳实践

#### 6.6.1 开发安全规范

**代码安全检查清单：**
- [ ] 所有SKU API都有JWT认证
- [ ] 敏感数据根据角色过滤
- [ ] 输入参数都有验证和清理
- [ ] 数据库查询使用参数化查询
- [ ] 错误信息不泄露敏感信息
- [ ] 操作日志记录完整
- [ ] 并发操作有适当控制
- [ ] API有合理的限流设置

#### 6.6.2 部署安全规范

**生产环境安全配置：**
```bash
# 环境变量安全配置
JWT_SECRET=complex_random_string_min_32_chars
SKU_ENCRYPTION_KEY=another_complex_random_string
SKU_AUDIT_ENABLED=true
SKU_RATE_LIMIT_ENABLED=true
SKU_ANOMALY_DETECTION_ENABLED=true

# 数据库安全配置
SKU_DB_SSL_ENABLED=true
SKU_DB_CONNECTION_LIMIT=10
SKU_DB_QUERY_TIMEOUT=30000

# 日志安全配置
SKU_LOG_LEVEL=info
SKU_LOG_RETENTION_DAYS=90
SKU_SENSITIVE_LOG_MASKING=true
```

#### 6.6.3 运维安全规范

**定期安全检查：**
```bash
#!/bin/bash
# SKU系统安全检查脚本

echo "开始SKU系统安全检查..."

# 1. 检查异常登录
echo "检查异常登录模式..."
psql -d crystal_erp -c "
SELECT user_id, COUNT(*) as login_count, 
       array_agg(DISTINCT ip_address) as ip_addresses
FROM sku_audit_logs 
WHERE action = 'VIEW' 
  AND timestamp > NOW() - INTERVAL '24 hours'
GROUP BY user_id 
HAVING COUNT(DISTINCT ip_address) > 3;
"

# 2. 检查大量操作
echo "检查大量库存操作..."
psql -d crystal_erp -c "
SELECT user_id, action, COUNT(*) as operation_count
FROM sku_inventory_logs 
WHERE created_at > NOW() - INTERVAL '1 hour'
GROUP BY user_id, action 
HAVING COUNT(*) > 50;
"

# 3. 检查敏感数据访问
echo "检查敏感数据访问..."
psql -d crystal_erp -c "
SELECT user_id, user_role, COUNT(*) as sensitive_access_count
FROM sku_audit_logs 
WHERE sensitive_data_accessed = true 
  AND timestamp > NOW() - INTERVAL '24 hours'
GROUP BY user_id, user_role;
"

echo "SKU系统安全检查完成"
```