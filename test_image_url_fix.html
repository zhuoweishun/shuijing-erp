<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡URLä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        .test-input {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            margin-bottom: 10px;
            word-break: break-all;
        }
        .test-output {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            word-break: break-all;
        }
        .error {
            background: #ffe6e6;
            color: #d00;
        }
        .success {
            background: #e8f5e8;
            color: #080;
        }
        img {
            max-width: 200px;
            max-height: 200px;
            border: 1px solid #ddd;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>å›¾ç‰‡URLä¿®å¤æµ‹è¯•</h1>
        
        <div class="test-section">
            <div class="test-title">æµ‹è¯•1: é”™è¯¯çš„JSONæ•°ç»„æ ¼å¼URL</div>
            <div class="test-input">è¾“å…¥: ["http://192.168.50.160:3001/uploads/purchases/1758003856630_188.jpg"]</div>
            <div id="test1-output" class="test-output">å¤„ç†ä¸­...</div>
            <img id="test1-img" style="display:none;" onerror="document.getElementById('test1-status').textContent = 'âŒ å›¾ç‰‡åŠ è½½å¤±è´¥'">
            <div id="test1-status"></div>
        </div>
        
        <div class="test-section">
            <div class="test-title">æµ‹è¯•2: æ­£ç¡®çš„å•ä¸ªURL</div>
            <div class="test-input">è¾“å…¥: "http://192.168.50.160:3001/uploads/purchases/1758003856630_188.jpg"</div>
            <div id="test2-output" class="test-output">å¤„ç†ä¸­...</div>
            <img id="test2-img" style="display:none;" onerror="document.getElementById('test2-status').textContent = 'âŒ å›¾ç‰‡åŠ è½½å¤±è´¥'">
            <div id="test2-status"></div>
        </div>
        
        <div class="test-section">
            <div class="test-title">æµ‹è¯•3: JSONå­—ç¬¦ä¸²æ ¼å¼</div>
            <div class="test-input">è¾“å…¥: '["http://192.168.50.160:3001/uploads/purchases/1758003856630_188.jpg"]'</div>
            <div id="test3-output" class="test-output">å¤„ç†ä¸­...</div>
            <img id="test3-img" style="display:none;" onerror="document.getElementById('test3-status').textContent = 'âŒ å›¾ç‰‡åŠ è½½å¤±è´¥'">
            <div id="test3-status"></div>
        </div>
        
        <div class="test-section">
            <div class="test-title">å½“å‰ç¯å¢ƒä¿¡æ¯</div>
            <div class="test-output">
                <div>å½“å‰ä¸»æœºå: <span id="hostname"></span></div>
                <div>å½“å‰åè®®: <span id="protocol"></span></div>
                <div>ç¼“å­˜çš„IP: <span id="cached-ip"></span></div>
            </div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹ŸfixImageUrlå‡½æ•°
        function fixImageUrl(url) {
            // ç±»å‹æ£€æŸ¥ï¼šç¡®ä¿urlæ˜¯å­—ç¬¦ä¸²ç±»å‹
            if (!url || typeof url !== 'string') return url || '';
            
            // å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œè½¬æ¢ä¸ºå®Œæ•´URL
            if (!url.startsWith('http')) {
                const hostname = window.location.hostname;
                const protocol = window.location.protocol;
                
                let backendUrl;
                if (hostname === 'localhost' || hostname === '127.0.0.1') {
                    backendUrl = 'http://localhost:3001';
                } else {
                    backendUrl = `${protocol}//${hostname}:3001`;
                }
                
                const fullUrl = `${backendUrl}${url}`;
                console.log(`ğŸ”„ ç›¸å¯¹è·¯å¾„è½¬æ¢ä¸ºå®Œæ•´URL: ${url} -> ${fullUrl}`);
                return fullUrl;
            }
            
            // è·å–å½“å‰ä¸»æœºå
            const currentHostname = window.location.hostname;
            
            // å¤„ç†ç”Ÿäº§ç¯å¢ƒåŸŸååœ¨æœ¬åœ°å¼€å‘æ—¶çš„è½¬æ¢
            if (url.includes('api.dorblecapital.com')) {
                const cachedIP = localStorage.getItem('cached_local_ip');
                
                if (cachedIP && cachedIP !== 'localhost' && cachedIP !== '127.0.0.1') {
                    const newUrl = url.replace(/https?:\/\/api\.dorblecapital\.com/g, `http://${cachedIP}:3001`);
                    console.log(`ğŸ”„ [å¼€å‘ç¯å¢ƒ] ç”Ÿäº§ç¯å¢ƒå›¾ç‰‡URLå·²è½¬æ¢ä¸ºå±€åŸŸç½‘: ${url} -> ${newUrl}`);
                    return newUrl;
                } else if (currentHostname.startsWith('192.168.') || currentHostname.startsWith('10.') || 
                           (currentHostname.startsWith('172.') && parseInt(currentHostname.split('.')[1]) >= 16 && parseInt(currentHostname.split('.')[1]) <= 31)) {
                    const newUrl = url.replace(/https?:\/\/api\.dorblecapital\.com/g, `http://${currentHostname}:3001`);
                    console.log(`ğŸ”„ [å¼€å‘ç¯å¢ƒ] ç”Ÿäº§ç¯å¢ƒå›¾ç‰‡URLå·²è½¬æ¢ä¸ºå±€åŸŸç½‘: ${url} -> ${newUrl}`);
                    return newUrl;
                } else {
                    const newUrl = url.replace(/https?:\/\/api\.dorblecapital\.com/g, 'http://localhost:3001');
                    console.log(`âš ï¸ [å¼€å‘ç¯å¢ƒ] ä½¿ç”¨localhostï¼ˆæ‰‹æœºæ— æ³•è®¿é—®ï¼‰: ${url} -> ${newUrl}`);
                    return newUrl;
                }
            }
            
            // æå–URLä¸­çš„IPåœ°å€
            const urlMatch = url.match(/https?:\/\/(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}):3001/);
            if (urlMatch) {
                const urlIP = urlMatch[1];
                
                if (urlIP !== currentHostname) {
                    if (currentHostname.startsWith('192.168.') || currentHostname.startsWith('10.') || 
                        (currentHostname.startsWith('172.') && parseInt(currentHostname.split('.')[1]) >= 16 && parseInt(currentHostname.split('.')[1]) <= 31)) {
                        const newUrl = url.replace(new RegExp(`https?://${urlIP.replace(/\./g, '\\.')}:3001`, 'g'), `http://${currentHostname}:3001`);
                        console.log(`ğŸ”„ å›¾ç‰‡URLå·²æ›´æ–°ä¸ºå½“å‰å±€åŸŸç½‘IP: ${url} -> ${newUrl}`);
                        return newUrl;
                    } else if (currentHostname === 'localhost' || currentHostname === '127.0.0.1') {
                        const cachedIP = localStorage.getItem('cached_local_ip');
                        if (cachedIP && cachedIP !== urlIP && cachedIP !== 'localhost' && cachedIP !== '127.0.0.1') {
                            const newUrl = url.replace(new RegExp(`https?://${urlIP.replace(/\./g, '\\.')}:3001`, 'g'), `http://${cachedIP}:3001`);
                            console.log(`ğŸ”„ å›¾ç‰‡URLå·²æ›´æ–°ä¸ºç¼“å­˜çš„å±€åŸŸç½‘IP: ${url} -> ${newUrl}`);
                            return newUrl;
                        }
                    }
                }
            }
            
            // å¦‚æœæ˜¯HTTPSçš„æœ¬åœ°/å±€åŸŸç½‘åœ°å€ï¼Œæ”¹ä¸ºHTTP
            if (url.startsWith('https://localhost:') || 
                url.startsWith('https://127.0.0.1:') ||
                url.startsWith('https://192.168.') ||
                url.startsWith('https://10.') ||
                url.startsWith('https://172.')) {
                return url.replace('https://', 'http://');
            }
            
            return url;
        }
        
        // å¤„ç†photosæ•°ç»„çš„å‡½æ•°
        function processPhotos(photosData) {
            let photos = [];
            if (photosData) {
                try {
                    if (typeof photosData === 'string') {
                        photos = JSON.parse(photosData);
                    } else if (Array.isArray(photosData)) {
                        photos = photosData;
                    }
                    if (!Array.isArray(photos)) {
                        photos = [];
                    }
                } catch (error) {
                    console.error('photosè§£æå¤±è´¥:', error, 'photosData:', photosData);
                    photos = [];
                }
            }
            return photos;
        }
        
        // æµ‹è¯•å‡½æ•°
        function runTests() {
            // æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
            document.getElementById('hostname').textContent = window.location.hostname;
            document.getElementById('protocol').textContent = window.location.protocol;
            document.getElementById('cached-ip').textContent = localStorage.getItem('cached_local_ip') || 'æ— ';
            
            // æµ‹è¯•1: é”™è¯¯çš„JSONæ•°ç»„æ ¼å¼URLï¼ˆè¿™æ˜¯é—®é¢˜çš„æ ¹æºï¼‰
            const test1Input = '["http://192.168.50.160:3001/uploads/purchases/1758003856630_188.jpg"]';
            try {
                const photos1 = processPhotos(test1Input);
                if (photos1.length > 0) {
                    const fixedUrl1 = fixImageUrl(photos1[0]);
                    document.getElementById('test1-output').textContent = `è¾“å‡º: ${fixedUrl1}`;
                    document.getElementById('test1-output').className = 'test-output success';
                    
                    const img1 = document.getElementById('test1-img');
                    img1.src = fixedUrl1;
                    img1.style.display = 'block';
                    img1.onload = () => document.getElementById('test1-status').textContent = 'âœ… å›¾ç‰‡åŠ è½½æˆåŠŸ';
                } else {
                    document.getElementById('test1-output').textContent = 'âŒ photosæ•°ç»„ä¸ºç©º';
                    document.getElementById('test1-output').className = 'test-output error';
                }
            } catch (error) {
                document.getElementById('test1-output').textContent = `âŒ é”™è¯¯: ${error.message}`;
                document.getElementById('test1-output').className = 'test-output error';
            }
            
            // æµ‹è¯•2: æ­£ç¡®çš„å•ä¸ªURL
            const test2Input = 'http://192.168.50.160:3001/uploads/purchases/1758003856630_188.jpg';
            try {
                const fixedUrl2 = fixImageUrl(test2Input);
                document.getElementById('test2-output').textContent = `è¾“å‡º: ${fixedUrl2}`;
                document.getElementById('test2-output').className = 'test-output success';
                
                const img2 = document.getElementById('test2-img');
                img2.src = fixedUrl2;
                img2.style.display = 'block';
                img2.onload = () => document.getElementById('test2-status').textContent = 'âœ… å›¾ç‰‡åŠ è½½æˆåŠŸ';
            } catch (error) {
                document.getElementById('test2-output').textContent = `âŒ é”™è¯¯: ${error.message}`;
                document.getElementById('test2-output').className = 'test-output error';
            }
            
            // æµ‹è¯•3: JSONå­—ç¬¦ä¸²æ ¼å¼
            const test3Input = '["http://192.168.50.160:3001/uploads/purchases/1758003856630_188.jpg"]';
            try {
                const photos3 = processPhotos(test3Input);
                if (photos3.length > 0) {
                    const fixedUrl3 = fixImageUrl(photos3[0]);
                    document.getElementById('test3-output').textContent = `è¾“å‡º: ${fixedUrl3}`;
                    document.getElementById('test3-output').className = 'test-output success';
                    
                    const img3 = document.getElementById('test3-img');
                    img3.src = fixedUrl3;
                    img3.style.display = 'block';
                    img3.onload = () => document.getElementById('test3-status').textContent = 'âœ… å›¾ç‰‡åŠ è½½æˆåŠŸ';
                } else {
                    document.getElementById('test3-output').textContent = 'âŒ photosæ•°ç»„ä¸ºç©º';
                    document.getElementById('test3-output').className = 'test-output error';
                }
            } catch (error) {
                document.getElementById('test3-output').textContent = `âŒ é”™è¯¯: ${error.message}`;
                document.getElementById('test3-output').className = 'test-output error';
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè¿è¡Œæµ‹è¯•
        window.onload = runTests;
    </script>
</body>
</html>