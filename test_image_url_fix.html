<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片URL修复测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        .test-input {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            margin-bottom: 10px;
            word-break: break-all;
        }
        .test-output {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            word-break: break-all;
        }
        .error {
            background: #ffe6e6;
            color: #d00;
        }
        .success {
            background: #e8f5e8;
            color: #080;
        }
        img {
            max-width: 200px;
            max-height: 200px;
            border: 1px solid #ddd;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>图片URL修复测试</h1>
        
        <div class="test-section">
            <div class="test-title">测试1: 错误的JSON数组格式URL</div>
            <div class="test-input">输入: ["http://192.168.50.160:3001/uploads/purchases/1758003856630_188.jpg"]</div>
            <div id="test1-output" class="test-output">处理中...</div>
            <img id="test1-img" style="display:none;" onerror="document.getElementById('test1-status').textContent = '❌ 图片加载失败'">
            <div id="test1-status"></div>
        </div>
        
        <div class="test-section">
            <div class="test-title">测试2: 正确的单个URL</div>
            <div class="test-input">输入: "http://192.168.50.160:3001/uploads/purchases/1758003856630_188.jpg"</div>
            <div id="test2-output" class="test-output">处理中...</div>
            <img id="test2-img" style="display:none;" onerror="document.getElementById('test2-status').textContent = '❌ 图片加载失败'">
            <div id="test2-status"></div>
        </div>
        
        <div class="test-section">
            <div class="test-title">测试3: JSON字符串格式</div>
            <div class="test-input">输入: '["http://192.168.50.160:3001/uploads/purchases/1758003856630_188.jpg"]'</div>
            <div id="test3-output" class="test-output">处理中...</div>
            <img id="test3-img" style="display:none;" onerror="document.getElementById('test3-status').textContent = '❌ 图片加载失败'">
            <div id="test3-status"></div>
        </div>
        
        <div class="test-section">
            <div class="test-title">当前环境信息</div>
            <div class="test-output">
                <div>当前主机名: <span id="hostname"></span></div>
                <div>当前协议: <span id="protocol"></span></div>
                <div>缓存的IP: <span id="cached-ip"></span></div>
            </div>
        </div>
    </div>

    <script>
        // 模拟fixImageUrl函数
        function fixImageUrl(url) {
            // 类型检查：确保url是字符串类型
            if (!url || typeof url !== 'string') return url || '';
            
            // 如果是相对路径，转换为完整URL
            if (!url.startsWith('http')) {
                const hostname = window.location.hostname;
                const protocol = window.location.protocol;
                
                let backendUrl;
                if (hostname === 'localhost' || hostname === '127.0.0.1') {
                    backendUrl = 'http://localhost:3001';
                } else {
                    backendUrl = `${protocol}//${hostname}:3001`;
                }
                
                const fullUrl = `${backendUrl}${url}`;
                console.log(`🔄 相对路径转换为完整URL: ${url} -> ${fullUrl}`);
                return fullUrl;
            }
            
            // 获取当前主机名
            const currentHostname = window.location.hostname;
            
            // 处理生产环境域名在本地开发时的转换
            if (url.includes('api.dorblecapital.com')) {
                const cachedIP = localStorage.getItem('cached_local_ip');
                
                if (cachedIP && cachedIP !== 'localhost' && cachedIP !== '127.0.0.1') {
                    const newUrl = url.replace(/https?:\/\/api\.dorblecapital\.com/g, `http://${cachedIP}:3001`);
                    console.log(`🔄 [开发环境] 生产环境图片URL已转换为局域网: ${url} -> ${newUrl}`);
                    return newUrl;
                } else if (currentHostname.startsWith('192.168.') || currentHostname.startsWith('10.') || 
                           (currentHostname.startsWith('172.') && parseInt(currentHostname.split('.')[1]) >= 16 && parseInt(currentHostname.split('.')[1]) <= 31)) {
                    const newUrl = url.replace(/https?:\/\/api\.dorblecapital\.com/g, `http://${currentHostname}:3001`);
                    console.log(`🔄 [开发环境] 生产环境图片URL已转换为局域网: ${url} -> ${newUrl}`);
                    return newUrl;
                } else {
                    const newUrl = url.replace(/https?:\/\/api\.dorblecapital\.com/g, 'http://localhost:3001');
                    console.log(`⚠️ [开发环境] 使用localhost（手机无法访问）: ${url} -> ${newUrl}`);
                    return newUrl;
                }
            }
            
            // 提取URL中的IP地址
            const urlMatch = url.match(/https?:\/\/(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}):3001/);
            if (urlMatch) {
                const urlIP = urlMatch[1];
                
                if (urlIP !== currentHostname) {
                    if (currentHostname.startsWith('192.168.') || currentHostname.startsWith('10.') || 
                        (currentHostname.startsWith('172.') && parseInt(currentHostname.split('.')[1]) >= 16 && parseInt(currentHostname.split('.')[1]) <= 31)) {
                        const newUrl = url.replace(new RegExp(`https?://${urlIP.replace(/\./g, '\\.')}:3001`, 'g'), `http://${currentHostname}:3001`);
                        console.log(`🔄 图片URL已更新为当前局域网IP: ${url} -> ${newUrl}`);
                        return newUrl;
                    } else if (currentHostname === 'localhost' || currentHostname === '127.0.0.1') {
                        const cachedIP = localStorage.getItem('cached_local_ip');
                        if (cachedIP && cachedIP !== urlIP && cachedIP !== 'localhost' && cachedIP !== '127.0.0.1') {
                            const newUrl = url.replace(new RegExp(`https?://${urlIP.replace(/\./g, '\\.')}:3001`, 'g'), `http://${cachedIP}:3001`);
                            console.log(`🔄 图片URL已更新为缓存的局域网IP: ${url} -> ${newUrl}`);
                            return newUrl;
                        }
                    }
                }
            }
            
            // 如果是HTTPS的本地/局域网地址，改为HTTP
            if (url.startsWith('https://localhost:') || 
                url.startsWith('https://127.0.0.1:') ||
                url.startsWith('https://192.168.') ||
                url.startsWith('https://10.') ||
                url.startsWith('https://172.')) {
                return url.replace('https://', 'http://');
            }
            
            return url;
        }
        
        // 处理photos数组的函数
        function processPhotos(photosData) {
            let photos = [];
            if (photosData) {
                try {
                    if (typeof photosData === 'string') {
                        photos = JSON.parse(photosData);
                    } else if (Array.isArray(photosData)) {
                        photos = photosData;
                    }
                    if (!Array.isArray(photos)) {
                        photos = [];
                    }
                } catch (error) {
                    console.error('photos解析失败:', error, 'photosData:', photosData);
                    photos = [];
                }
            }
            return photos;
        }
        
        // 测试函数
        function runTests() {
            // 显示环境信息
            document.getElementById('hostname').textContent = window.location.hostname;
            document.getElementById('protocol').textContent = window.location.protocol;
            document.getElementById('cached-ip').textContent = localStorage.getItem('cached_local_ip') || '无';
            
            // 测试1: 错误的JSON数组格式URL（这是问题的根源）
            const test1Input = '["http://192.168.50.160:3001/uploads/purchases/1758003856630_188.jpg"]';
            try {
                const photos1 = processPhotos(test1Input);
                if (photos1.length > 0) {
                    const fixedUrl1 = fixImageUrl(photos1[0]);
                    document.getElementById('test1-output').textContent = `输出: ${fixedUrl1}`;
                    document.getElementById('test1-output').className = 'test-output success';
                    
                    const img1 = document.getElementById('test1-img');
                    img1.src = fixedUrl1;
                    img1.style.display = 'block';
                    img1.onload = () => document.getElementById('test1-status').textContent = '✅ 图片加载成功';
                } else {
                    document.getElementById('test1-output').textContent = '❌ photos数组为空';
                    document.getElementById('test1-output').className = 'test-output error';
                }
            } catch (error) {
                document.getElementById('test1-output').textContent = `❌ 错误: ${error.message}`;
                document.getElementById('test1-output').className = 'test-output error';
            }
            
            // 测试2: 正确的单个URL
            const test2Input = 'http://192.168.50.160:3001/uploads/purchases/1758003856630_188.jpg';
            try {
                const fixedUrl2 = fixImageUrl(test2Input);
                document.getElementById('test2-output').textContent = `输出: ${fixedUrl2}`;
                document.getElementById('test2-output').className = 'test-output success';
                
                const img2 = document.getElementById('test2-img');
                img2.src = fixedUrl2;
                img2.style.display = 'block';
                img2.onload = () => document.getElementById('test2-status').textContent = '✅ 图片加载成功';
            } catch (error) {
                document.getElementById('test2-output').textContent = `❌ 错误: ${error.message}`;
                document.getElementById('test2-output').className = 'test-output error';
            }
            
            // 测试3: JSON字符串格式
            const test3Input = '["http://192.168.50.160:3001/uploads/purchases/1758003856630_188.jpg"]';
            try {
                const photos3 = processPhotos(test3Input);
                if (photos3.length > 0) {
                    const fixedUrl3 = fixImageUrl(photos3[0]);
                    document.getElementById('test3-output').textContent = `输出: ${fixedUrl3}`;
                    document.getElementById('test3-output').className = 'test-output success';
                    
                    const img3 = document.getElementById('test3-img');
                    img3.src = fixedUrl3;
                    img3.style.display = 'block';
                    img3.onload = () => document.getElementById('test3-status').textContent = '✅ 图片加载成功';
                } else {
                    document.getElementById('test3-output').textContent = '❌ photos数组为空';
                    document.getElementById('test3-output').className = 'test-output error';
                }
            } catch (error) {
                document.getElementById('test3-output').textContent = `❌ 错误: ${error.message}`;
                document.getElementById('test3-output').className = 'test-output error';
            }
        }
        
        // 页面加载完成后运行测试
        window.onload = runTests;
    </script>
</body>
</html>