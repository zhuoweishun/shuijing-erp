generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String             @id @default(cuid())
  user_name             String             @unique
  email                 String?            @unique
  password              String
  role                  UserRole           @default(EMPLOYEE)
  name                  String
  phone                 String?
  avatar                String?
  created_at            DateTime           @default(now())
  is_active             Boolean            @default(true)
  last_login_at         DateTime?
  updated_at            DateTime           @updatedAt
  customer_notes        CustomerNotes[]
  edit_logs             EditLog[]
  financial_records     FinancialRecords[]
  created_materials     Material[]
  created_skus          ProductSku[]
  products              Product[]
  last_edited_purchases Purchase[]         @relation("PurchaseLastEditedBy")
  purchases             Purchase[]
  sku_inventory_logs    SkuInventoryLog[]

  @@map("users")
}

model Supplier {
  id            String     @id @default(cuid())
  supplier_code String?    @unique
  name          String     @unique
  contact       String?
  phone         String?
  email         String?
  address       String?
  description   String?    @db.Text
  created_at    DateTime   @default(now())
  is_active     Boolean    @default(true)
  updated_at    DateTime   @updatedAt
  materials     Material[]
  purchases     Purchase[]

  @@map("suppliers")
}

model Purchase {
  id                     String           @id @default(cuid())
  quantity               Int?
  weight                 Decimal?         @db.Decimal(10, 1)
  quality                Quality?
  specification          Decimal?         @db.Decimal(10, 1)
  photos                 Json
  notes                  String?          @db.Text
  status                 purchases_status @default(ACTIVE)
  ai_recognition_result  Json?
  bead_diameter          Decimal?         @db.Decimal(10, 1)
  beads_per_string       Int?
  created_at             DateTime         @default(now())
  last_edited_by_id      String?
  min_stock_alert        Int?
  natural_language_input String?          @db.Text
  piece_count            Int?
  price_per_bead         Decimal?         @db.Decimal(10, 4)
  price_per_gram         Decimal?         @db.Decimal(10, 1)
  price_per_piece        Decimal?         @db.Decimal(10, 4)
  purchase_name          String
  purchase_type          ProductType      @default(BRACELET)
  purchase_code          String           @unique
  purchase_date          DateTime
  supplier_id            String?
  total_beads            Int?
  total_price            Decimal?         @db.Decimal(10, 1)
  unit_price             Decimal?         @db.Decimal(10, 1)
  unit_type              UnitType         @default(STRINGS)
  updated_at             DateTime         @updatedAt
  user_id                String
  edit_logs              EditLog[]
  material_usages        MaterialUsage[]
  materials              Material[]
  last_edited_by         User?            @relation("PurchaseLastEditedBy", fields: [last_edited_by_id], references: [id])
  supplier               Supplier?        @relation(fields: [supplier_id], references: [id])
  user                   User             @relation(fields: [user_id], references: [id])

  @@index([last_edited_by_id], map: "purchases_lastEditedById_fkey")
  @@index([supplier_id], map: "purchases_supplierId_fkey")
  @@index([user_id], map: "purchases_userId_fkey")
  @@map("purchases")
}

model Product {
  id           String        @id @default(cuid())
  name         String
  description  String?       @db.Text
  category     String?
  quantity     Int           @default(0)
  unit         String
  status       ProductStatus @default(AVAILABLE)
  location     String?
  notes        String?       @db.Text
  images       String?       @db.Text
  created_at   DateTime      @default(now())
  product_code String?
  sku_id       String?
  total_value  Decimal       @db.Decimal(10, 2)
  unit_price   Decimal       @db.Decimal(10, 2)
  updated_at   DateTime      @updatedAt
  user_id      String
  sku          ProductSku?   @relation(fields: [sku_id], references: [id])
  user         User          @relation(fields: [user_id], references: [id])

  @@index([sku_id], map: "products_skuId_fkey")
  @@index([user_id], map: "products_userId_fkey")
  @@map("products")
}

model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String   @db.Text
  description String?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("system_configs")
}

model EditLog {
  id             String   @id @default(cuid())
  action         String
  details        String?  @db.Text
  changed_fields Json?
  created_at     DateTime @default(now())
  purchase_id    String
  user_id        String
  purchase       Purchase @relation(fields: [purchase_id], references: [id], onDelete: Cascade)
  user           User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([purchase_id], map: "edit_logs_purchaseId_fkey")
  @@index([user_id], map: "edit_logs_userId_fkey")
  @@map("edit_logs")
}

model Material {
  id                              String          @id @default(cuid())
  material_code                   String          @unique
  material_name                   String
  material_type                   ProductType
  quality                         Quality?        @default(UNKNOWN)
  bead_diameter                   Decimal?        @db.Decimal(5, 2)
  bracelet_inner_diameter         Decimal?        @db.Decimal(5, 2)
  bracelet_bead_count             Int?
  accessory_specification         String?
  finished_material_specification String?
  original_quantity               Int
  used_quantity                   Int             @default(0)
  inventory_unit                  UnitType
  unit_cost                       Decimal         @db.Decimal(10, 4)
  total_cost                      Decimal         @db.Decimal(12, 2)
  min_stock_alert                 Int?
  purchase_id                     String
  supplier_id                     String?
  photos                          Json?
  material_date                   DateTime        @db.Date
  notes                           String?         @db.Text
  created_at                      DateTime        @default(now())
  updated_at                      DateTime        @updatedAt
  created_by                      String
  remaining_quantity              Int?            @default(0)
  stock_status                    String?         @default("SUFFICIENT")
  material_usages                 MaterialUsage[]
  creator                         User            @relation(fields: [created_by], references: [id])
  purchase                        Purchase        @relation(fields: [purchase_id], references: [id])
  supplier                        Supplier?       @relation(fields: [supplier_id], references: [id])

  @@index([material_code])
  @@index([material_name])
  @@index([material_type, quality])
  @@index([purchase_id])
  @@index([supplier_id])
  @@index([material_date])
  @@index([material_name, material_code])
  @@index([stock_status])
  @@index([remaining_quantity])
  @@index([purchase_id], map: "idx_materials_purchase_id")
  @@index([created_by], map: "materials_created_by_fkey")
  @@map("materials")
}

model MaterialUsage {
  id            String                @id @default(cuid())
  action        material_usage_action @default(CREATE)
  notes         String?               @db.Text
  created_at    DateTime              @default(now())
  material_id   String
  purchase_id   String?
  quantity_used Int
  sku_id        String?
  total_cost    Decimal?              @db.Decimal(10, 2)
  unit_cost     Decimal?              @db.Decimal(10, 4)
  updated_at    DateTime              @updatedAt
  material      Material              @relation(fields: [material_id], references: [id])
  purchase      Purchase?             @relation(fields: [purchase_id], references: [id], onDelete: Restrict)
  sku           ProductSku?           @relation(fields: [sku_id], references: [id], onDelete: Restrict)

  @@index([material_id], map: "material_usage_materialId_fkey")
  @@index([sku_id], map: "material_usage_skuId_fkey")
  @@index([purchase_id], map: "material_usage_purchaseId_fkey")
  @@index([action])
  @@index([material_id], map: "idx_material_usage_material_id")
  @@map("material_usage")
}

model ProductSku {
  id                      String              @id @default(cuid())
  total_quantity          Int                 @default(0)
  unit_price              Decimal             @db.Decimal(10, 2)
  photos                  Json?
  description             String?             @db.Text
  specification           String?
  status                  SkuStatus           @default(ACTIVE)
  available_quantity      Int                 @default(0)
  craft_cost              Decimal?            @db.Decimal(10, 2)
  created_at              DateTime            @default(now())
  created_by              String
  labor_cost              Decimal?            @db.Decimal(10, 2)
  material_cost           Decimal?            @db.Decimal(10, 2)
  material_signature      Json
  material_signature_hash String
  profit_margin           Decimal?            @db.Decimal(5, 2)
  selling_price           Decimal             @db.Decimal(10, 2)
  sku_code                String              @unique
  sku_name                String
  total_cost              Decimal?            @db.Decimal(10, 2)
  total_value             Decimal             @db.Decimal(10, 2)
  updated_at              DateTime            @updatedAt
  customer_purchases      CustomerPurchases[]
  material_usages         MaterialUsage[]
  creator                 User                @relation(fields: [created_by], references: [id])
  products                Product[]
  inventory_logs          SkuInventoryLog[]

  @@index([material_signature_hash])
  @@index([sku_code])
  @@index([status])
  @@index([created_by], map: "product_skus_createdBy_fkey")
  @@map("product_skus")
}

model SkuInventoryLog {
  id              String                           @id @default(cuid())
  action          sku_inventory_logs_action
  notes           String?                          @db.Text
  created_at      DateTime                         @default(now())
  quantity_after  Int
  quantity_before Int
  quantity_change Int
  reference_id    String?
  reference_type  sku_inventory_logs_referenceType
  sku_id          String
  user_id         String
  sku             ProductSku                       @relation(fields: [sku_id], references: [id])
  user            User                             @relation(fields: [user_id], references: [id])

  @@index([sku_id])
  @@index([action])
  @@index([created_at])
  @@index([user_id], map: "sku_inventory_logs_userId_fkey")
  @@map("sku_inventory_logs")
}

model AuditLog {
  id          String   @id @default(cuid())
  action      String
  resource    String
  details     String?  @db.Text
  created_at  DateTime @default(now())
  ip_address  String?
  resource_id String?
  user_agent  String?
  user_id     String?

  @@map("audit_logs")
}

model CustomerNotes {
  id          String                  @id
  category    customer_notes_category
  content     String                  @db.Text
  created_at  DateTime                @default(now())
  created_by  String
  customer_id String
  updated_at  DateTime
  users       User                    @relation(fields: [created_by], references: [id])
  customers   Customers               @relation(fields: [customer_id], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([created_by], map: "customer_notes_createdBy_fkey")
  @@index([customer_id])
  @@map("customer_notes")
}

model CustomerPurchases {
  id             String                    @id
  quantity       Int
  unit_price     Decimal                   @db.Decimal(10, 2)
  total_price    Decimal                   @db.Decimal(10, 2)
  status         customer_purchases_status @default(ACTIVE)
  notes          String?                   @db.Text
  created_at     DateTime                  @default(now())
  customer_id    String
  original_price Decimal?                  @db.Decimal(10, 2)
  purchase_date  DateTime                  @default(now())
  refund_date    DateTime?
  refund_notes   String?                   @db.Text
  refund_reason  String?
  sale_channel   String?
  sku_id         String
  sku_name       String
  updated_at     DateTime
  customers      Customers                 @relation(fields: [customer_id], references: [id])
  product_skus   ProductSku                @relation(fields: [sku_id], references: [id])

  @@index([customer_id])
  @@index([purchase_date])
  @@index([sku_id])
  @@index([status])
  @@map("customer_purchases")
}

model Customers {
  id                        String              @id
  name                      String
  phone                     String              @unique
  address                   String?             @db.Text
  notes                     String?             @db.Text
  birthday                  DateTime?
  wechat                    String?
  city                      String?
  province                  String?
  average_order_value       Decimal             @default(0.00) @db.Decimal(10, 2)
  created_at                DateTime            @default(now())
  customer_labels           Json?
  days_since_first_purchase Int?
  days_since_last_purchase  Int?
  first_purchase_date       DateTime?
  last_purchase_date        DateTime?
  primary_label             String?
  refund_count              Int                 @default(0)
  refund_rate               Decimal             @default(0.00) @db.Decimal(5, 2)
  total_all_orders          Int                 @default(0)
  total_orders              Int                 @default(0)
  total_purchases           Decimal             @default(0.00) @db.Decimal(10, 2)
  updated_at                DateTime
  customer_notes            CustomerNotes[]
  customer_purchases        CustomerPurchases[]

  @@index([name])
  @@index([phone])
  @@map("customers")
}

model FinancialRecords {
  id               String                          @id
  amount           Decimal                         @db.Decimal(10, 2)
  description      String
  category         String?
  notes            String?                         @db.Text
  created_at       DateTime                        @default(now())
  record_type      financial_records_recordType
  reference_id     String?
  reference_type   financial_records_referenceType
  transaction_date DateTime
  updated_at       DateTime
  user_id          String
  users            User                            @relation(fields: [user_id], references: [id])

  @@index([created_at])
  @@index([record_type])
  @@index([reference_type, reference_id])
  @@index([transaction_date])
  @@index([user_id])
  @@map("financial_records")
}

enum UserRole {
  BOSS
  EMPLOYEE
}

enum Quality {
  AA
  A
  AB
  B
  C
  UNKNOWN
}

enum ProductType {
  LOOSE_BEADS
  BRACELET
  ACCESSORIES
  FINISHED_MATERIAL
}

enum UnitType {
  PIECES
  STRINGS
  SLICES
  ITEMS
}

enum ProductStatus {
  MAKING
  AVAILABLE
  SOLD
  OFFLINE
}

enum SkuStatus {
  ACTIVE
  INACTIVE
}

enum financial_records_recordType {
  INCOME
  EXPENSE
  REFUND
  LOSS
}

enum customer_notes_category {
  PREFERENCE
  BEHAVIOR
  CONTACT
  OTHER
}

enum sku_inventory_logs_action {
  CREATE
  SELL
  ADJUST
  DESTROY
  REFUND
}

enum financial_records_referenceType {
  PURCHASE
  SALE
  REFUND
  MANUAL
}

enum sku_inventory_logs_referenceType {
  PRODUCT
  SALE
  MANUAL
  DESTROY
  REFUND
}

enum material_usage_action {
  CREATE
  USE
  RETURN
  ADJUST
}

enum customer_purchases_status {
  ACTIVE
  REFUNDED
}

enum purchases_status {
  ACTIVE
  USED
}
