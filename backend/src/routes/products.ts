import { Router } from 'express'
import { asyncHandler } from '../middleware/errorHandler.js'
import { authenticateToken } from '../middleware/auth.js'
import { prisma } from '../lib/prisma.js'
import { Decimal } from '@prisma/client/runtime/library'
// ÁßªÈô§fieldConverterÂØºÂÖ•ÔºåÁõ¥Êé•‰ΩøÁî®snake_case
import { 
  findOrCreateSku, 
  createSkuInventoryLog} from '../utils/skuUtils.js'

const router = Router()



// ÊµãËØïË∑ØÁî±ÔºàÊó†ÈúÄËÆ§ËØÅÔºâ- ÂøÖÈ°ªÂú®/:idË∑ØÁî±‰πãÂâçÂÆö‰πâ
router.get('/test', (_req, res) => {
  console.log('üî• [TEST] ÊµãËØïË∑ØÁî±Ë¢´Ë∞ÉÁî®!')
  res.json({ success: true, message: 'ÊµãËØïË∑ØÁî±Ê≠£Â∏∏Â∑•‰Ωú' })
})

// ÊµãËØïË∑ØÁî±ÔºàÈúÄË¶ÅËÆ§ËØÅÔºâ- ÂøÖÈ°ªÂú®/:idË∑ØÁî±‰πãÂâçÂÆö‰πâ
router.get('/test-auth', authenticateToken, (_req, res) => {
  console.log('üî• [TEST-AUTH] ËÆ§ËØÅÊµãËØïË∑ØÁî±Ë¢´Ë∞ÉÁî®!')
  res.json({ success: true, message: 'ËÆ§ËØÅÊµãËØïË∑ØÁî±Ê≠£Â∏∏Â∑•‰Ωú' })
})

// Ëé∑ÂèñÂèØÁî®ÂéüÊùêÊñôÂàóË°® - ÂøÖÈ°ªÂú®/:idË∑ØÁî±‰πãÂâçÂÆö‰πâ
  // ÈªòËÆ§ËøîÂõû
  //   return res.status(500).json({ success: false, message: "Êìç‰ΩúÂ§±Ë¥•" })  // ÁßªÈô§ÂáΩÊï∞‰ΩìÂ§ñÁöÑreturnËØ≠Âè•
router.get('/materials', authenticateToken, asyncHandler(async (req, res) => {
  console.log('üîç [Materials API] Êé•Âè£Ë¢´Ë∞ÉÁî®:', {
    query: req.query,
    user: req.user?.id,
    timestamp: new Date().toISOString()
  })
  
  const { 
    search, 
    material_types,
    available_only = 'true', 
    min_quantity = 1 
  } = req.query
  
  try {
    // ÊûÑÂª∫Êü•ËØ¢Êù°‰ª∂ÔºåÊîØÊåÅÊâÄÊúâ‰∫ßÂìÅÁ±ªÂûã
    let whereClause = 'WHERE 1=1'
    const params: any[] = []
    
    if (search) {
      whereClause += ' AND m.material_name LIKE ?'
      params.push(`%${search}%`)
    }
    
    // ÊùêÊñôÁ±ªÂûãÁ≠õÈÄâ - Â§ÑÁêÜÂ≠óÁ¨¶‰∏≤ÊàñÊï∞ÁªÑÊ†ºÂºè
    let materialTypesArray: string[] = []
    if (material_types) {
      if (typeof material_types === 'string') {
        // Â¶ÇÊûúÊòØÈÄóÂè∑ÂàÜÈöîÁöÑÂ≠óÁ¨¶‰∏≤ÔºåÂàÜÂâ≤ÊàêÊï∞ÁªÑ
        materialTypesArray = (material_types as string).split(',').map(type => type.trim()).filter(Boolean)
      } else if (Array.isArray(material_types)) {
        materialTypesArray = material_types as string[]
      }
    }
    
    if (materialTypesArray.length > 0) {
      const placeholders = materialTypesArray.map(() => '?').join(',')
      whereClause += ` AND m.material_type IN (${placeholders})`
      params.push(...materialTypesArray)
    }
    
    // Áõ¥Êé•Êü•ËØ¢materialsË°®ÔºåËøôÊòØÁã¨Á´ãÁöÑÂ∫ìÂ≠òÊï∞ÊçÆË°®
    const materialsQuery = `
      SELECT 
        m.id,
        m.material_code,
        m.material_name,
        m.material_type,
        m.bead_diameter,
        m.accessory_specification,
        m.finished_material_specification,
        m.quality,
        m.original_quantity,
        m.used_quantity,
        m.remaining_quantity as available_quantity,
        m.inventory_unit,
        m.unit_cost,
        m.total_cost,
        m.photos,
        s.name as supplier_name,
        m.material_date,
        m.notes,
        m.created_at,
        m.updated_at
      FROM materials m
      LEFT JOIN suppliers s ON m.supplier_id = s.id
      ${whereClause}
      ${available_only === 'true' ? 'AND m.remaining_quantity >= ?' : ''}
      ORDER BY m.created_at DESC
    `
    
    if (available_only === 'true') {
      params.push(Number(min_quantity))
    }
    
    console.log('üîç [Materials API] ÊâßË°åSQLÊü•ËØ¢:', {
      query: materialsQuery.substring(0, 200) + '...',
      params,
      whereClause
    })
    
    const materialsResult = await prisma.$queryRawUnsafe(materialsQuery, ...(params || [])) as any[]
    
    console.log('üîç [Materials API] SQLÊü•ËØ¢ÁªìÊûú:', {
      resultCount: materialsResult.length,
      firstResult: materialsResult[0] || null,
      allIds: materialsResult.slice(0, 3).map(m => ({ id: m.id, name: m.material_name }))
    })
    
    // Ê†ºÂºèÂåñmaterialsË°®Êï∞ÊçÆ
    const formattedMaterials = materialsResult.map(material => {
      // ÊûÑÂª∫ÂìçÂ∫îÂØπË±°Ôºå‰ΩøÁî®materialsË°®ÁöÑÂ≠óÊÆµÁªìÊûÑ
      const converted = {
        id: material.id,
        material_id: material.id, // ÂÖºÂÆπÂâçÁ´Ø
        material_code: material.material_code,
        material_name: material.material_name,
        material_type: material.material_type,
        quality: material.quality,
        
        // ËßÑÊ†º‰ø°ÊÅØ
        bead_diameter: material.bead_diameter,
        accessory_specification: material.accessory_specification,
        finished_material_specification: material.finished_material_specification,
        specification: material.accessory_specification || material.finished_material_specification, // ÂÖºÂÆπÂâçÁ´Ø
        
        // Â∫ìÂ≠ò‰ø°ÊÅØ
        original_quantity: Number(material.original_quantity),
        used_quantity: Number(material.used_quantity),
        available_quantity: Number(material.available_quantity),
        remaining_quantity: Number(material.available_quantity), // ÂÖºÂÆπÂâçÁ´Ø
        inventory_unit: material.inventory_unit,
        
        // ÊàêÊú¨‰ø°ÊÅØ
        unit_cost: Number(material.unit_cost) || 0,
        total_cost: Number(material.total_cost) || 0,
        
        // ÂÖ∂‰ªñ‰ø°ÊÅØ
        photos: material.photos,
        supplier_name: material.supplier_name,
        material_date: material.material_date,
        notes: material.notes,
        created_at: material.created_at,
        updated_at: material.updated_at
      }
      
      // Ê†πÊçÆÁî®Êà∑ÊùÉÈôêËøáÊª§ÊïèÊÑü‰ø°ÊÅØ
      if ((req.user?.role || "USER") === 'EMPLOYEE') {
        // Ê≥®ÊÑèÔºöunit_cost‰øùÁïôÁªôSKUÂà∂‰ΩúÂäüËÉΩ‰ΩøÁî®Ôºå‰∏çËøáÊª§
        converted.supplier_name = null
        converted.total_cost = 0
      }
      
      return converted
    })
    
    console.log('üîç [Materials API] ÂáÜÂ§áËøîÂõûÂìçÂ∫î:', {
      materialsCount: formattedMaterials.length,
      success: true
    })
    
    return res.json({
      success: true,
      message: 'Ëé∑ÂèñÂèØÁî®ÂéüÊùêÊñôÊàêÂäü',
      data: {
        materials: formattedMaterials,
        total_count: formattedMaterials.length
      }
    })
  } catch (error) {
    console.error('Ëé∑ÂèñÂéüÊùêÊñôÂ§±Ë¥•:', error)
    return res.status(500).json({
      success: false,
      message: 'Ëé∑ÂèñÂéüÊùêÊñôÂ§±Ë¥•',
      error: {
        code: 'MATERIALS_FETCH_ERROR',
        details: (error as Error).message,
        stack: (error as Error).stack
      }
    })
  }
  // ÂáΩÊï∞ÁªìÊùü
  // ÂáΩÊï∞ÁªìÊùü
}))

// ÊóßÁöÑÈ™åËØÅschemaÂ∑≤Âà†Èô§ÔºåÊñ∞ÁöÑÊé•Âè£‰ΩøÁî®ÊâãÂä®È™åËØÅ

// Ëé∑ÂèñÈîÄÂîÆÂàóË°®
  // ÈªòËÆ§ËøîÂõû
  //   return res.status(500).json({ success: false, message: "Êìç‰ΩúÂ§±Ë¥•" })  // ÁßªÈô§ÂáΩÊï∞‰ΩìÂ§ñÁöÑreturnËØ≠Âè•
router.get('/', authenticateToken, asyncHandler(async (req, res) => {
  const { 
    page = 1, 
    limit = 10, 
    search, 
    status,
    sort_by = 'created_at',
    sort_order = 'desc'
  } = req.query
  
  const where: any = {}
  
  if (search) {
    where.name = {
      contains: search as string
    }
  }
  
  if (status) {
    // Â§ÑÁêÜÊï∞ÁªÑÊ†ºÂºèÁöÑstatusÂèÇÊï∞
    if (Array.isArray(status)) {
      where.status = {
        in: status
      }
    } else {
      where.status = status
    }
  }
  
  // Â≠óÊÆµÂêçÊò†Â∞ÑÔºöÂâçÁ´Øsnake_case -> Êï∞ÊçÆÂ∫ìcamelCase
  const fieldMapping: Record<string, string> = {
    'created_at': 'created_at',
    'updated_at': 'updated_at',
    'purchase_name': 'name',
    'product_code': 'product_code',
    'unit_price': 'unit_price',
    'total_value': 'totalValue'
  }
  
  const dbSortField = fieldMapping[sort_by as string] || sort_by as string
  
  const [products, total] = await Promise.all([
    prisma.product.findMany({
      where,
      include: {
        user: {
          select: {
            id: true,
            name: true,
            user_name: true
          }
        },
        material_usages: {
          include: {
            purchase: {
              select: {
                id: true,
                purchase_name: true,
                bead_diameter: true,
                specification: true,
                quality: true
              }
            }
          }
        }
      },
      orderBy: {
        [dbSortField]: sort_order
      },
      skip: (Number(page) - 1) * Number(limit),
      take: Number(limit)
    }),
    prisma.product.count({ where })
  ])
  
  // Áõ¥Êé•‰ΩøÁî®ËõáÂΩ¢ÂëΩÂêçÔºåËøáÊª§ÊïèÊÑü‰ø°ÊÅØ
  const filteredProducts = products.map((product, _index) => {
    // ÊûÑÂª∫ÂìçÂ∫îÂØπË±°ÔºåÊâÄÊúâÂ≠óÊÆµÂ∑≤ÁªèÊòØËõáÂΩ¢ÂëΩÂêç
    const converted = {
      ...product,
      created_at: product.created_at,
      updated_at: product.updated_at
    }
    
    if ((req.user?.role || "USER") === 'EMPLOYEE') {
      // ÈõáÂëò‰∏çËÉΩÊü•ÁúãÊàêÊú¨Áõ∏ÂÖ≥‰ø°ÊÅØ
      converted.unit_price = new Decimal(0)
      converted.total_value = new Decimal(0)
    }
    
    return converted
  })
  
  res.json({
    success: true,
    message: 'Ëé∑ÂèñÈîÄÂîÆÂàóË°®ÊàêÂäü',
    data: {
      products: filteredProducts,
      pagination: {
        page: Number(page),
        limit: Number(limit),
        total,
        pages: Math.ceil(total / Number(limit))
      }
    }
  })
}))

// ÊóßÁöÑÂàõÂª∫ÊàêÂìÅËÆ∞ÂΩïÊé•Âè£Â∑≤Ë¢´‰∏ãÊñπÁöÑÂÆåÊï¥ÂÆûÁé∞Êõø‰ª£
// Ê≠§Êé•Âè£Â∑≤Ê≥®ÈáäÊéâ‰ª•ÈÅøÂÖçË∑ØÁî±ÂÜ≤Á™Å

// Ëé∑ÂèñÂçï‰∏™ÊàêÂìÅËÆ∞ÂΩï
  // ÈªòËÆ§ËøîÂõû
  //   return res.status(500).json({ success: false, message: "Êìç‰ΩúÂ§±Ë¥•" })  // ÁßªÈô§ÂáΩÊï∞‰ΩìÂ§ñÁöÑreturnËØ≠Âè•
router.get('/:id', authenticateToken, asyncHandler(async (req, res) => {
  const { id } = req.params
  
  const product = await prisma.product.findUnique({
    where: { id },
    include: {
      user: {
        select: {
          id: true,
          name: true,
          user_name: true
        }
      },
      material_usages: {
        include: {
          purchase: {
            select: {
              id: true,
              purchase_name: true,
              bead_diameter: true,
              specification: true,
              quality: true,
              price_per_bead: true
            }
          }
        }
      }
    }
  })
  

  if (!product) {
    return res.status(404).json({
      success: false,
      message: 'ÊàêÂìÅËÆ∞ÂΩï‰∏çÂ≠òÂú®'
    })
  }
  
  // Áõ¥Êé•‰ΩøÁî®ËõáÂΩ¢ÂëΩÂêçÔºåËøáÊª§ÊïèÊÑü‰ø°ÊÅØ
  const converted = {
    ...product,
    created_at: product.created_at,
    updated_at: product.updated_at,
    material_usages: product.material_usages?.map((usage: any) => ({
      ...usage,
      created_at: usage.created_at,
      updated_at: usage.updated_at,
      purchase: {
        ...usage.purchase,
        price_per_bead: usage.purchase?.price_per_bead
      }
    }))
  }
  
  if ((req.user?.role || "USER") === 'EMPLOYEE') {
    converted.unit_price = new Decimal(0)
    converted.total_value = new Decimal(0)
    // ËøáÊª§ÂéüÊùêÊñô‰ª∑Ê†º‰ø°ÊÅØ
    converted.material_usages = converted.material_usages?.map((usage: any) => ({
      ...usage,
      purchase: {
        ...usage.purchase,
        price_per_bead: null
      }
    }))
  }
  
  return res.json({
    success: true,
    message: 'Ëé∑ÂèñÊàêÂìÅËÆ∞ÂΩïÊàêÂäü',
    data: converted
  })
}))

// ÊàêÂìÅÈîÄÊØÅÔºàÂê´Â∫ìÂ≠òÂõûÊªöÔºâ
  // ÈªòËÆ§ËøîÂõû
  //   return res.status(500).json({ success: false, message: "Êìç‰ΩúÂ§±Ë¥•" })  // ÁßªÈô§ÂáΩÊï∞‰ΩìÂ§ñÁöÑreturnËØ≠Âè•
router.delete('/:id/destroy', authenticateToken, asyncHandler(async (req, res) => {
  const { id } = req.params
  
  // ÂºÄÂêØ‰∫ãÂä°ËøõË°åÈîÄÊØÅÊìç‰Ωú
  const result = await prisma.$transaction(async (tx) => {
    // Êü•ËØ¢ÊàêÂìÅÂèäÂÖ∂ÂéüÊùêÊñô‰ΩøÁî®ËÆ∞ÂΩï
    const product = await tx.product.findUnique({
      where: { id },
      include: {
        material_usages: {
          include: {
            purchase: {
              select: {
                id: true,
                purchase_name: true,
                bead_diameter: true,
                quality: true
              }
            }
          }
        }
      }
    })
    

    if (!product) {
      throw new Error('ÊàêÂìÅËÆ∞ÂΩï‰∏çÂ≠òÂú®')
    }
    
    // ËÆ∞ÂΩïË¶ÅÂõûÊªöÁöÑÂéüÊùêÊñô‰ø°ÊÅØ
    const restoredMaterials = product.material_usages.map((usage: any) => ({
      purchase_id: usage.purchase_id,
      purchase_name: usage.purchase?.purchase_name,
      bead_diameter: usage.purchase?.bead_diameter,
      quality: usage.purchase?.quality,
      restored_quantity: usage.quantity_used
    }))
    
    // Âà†Èô§ÂéüÊùêÊñô‰ΩøÁî®ËÆ∞ÂΩïÔºàËá™Âä®ÂõûÊªöÂ∫ìÂ≠òÔºâ
    await tx.materialUsage.deleteMany({
      where: { product_id: id }
    })
    
    // Âà†Èô§ÊàêÂìÅËÆ∞ÂΩï
    await tx.product.delete({
      where: { id }
    })
    
    return {
      destroyed_product_id: id,
      restored_materials: restoredMaterials
    }
  })
  
  return res.json({
    success: true,
    message: 'ÊàêÂìÅÈîÄÊØÅÊàêÂäüÔºåÂéüÊùêÊñôÂ∑≤ÂõûÊªö',
    data: result
  })
}))

// Êõ¥Êñ∞ÊàêÂìÅËÆ∞ÂΩï
router.put('/:id', authenticateToken, asyncHandler(async (_req, res) => {
  res.json({
    success: false,
    message: 'Êõ¥Êñ∞ÊàêÂìÅËÆ∞ÂΩïÂäüËÉΩÊ≠£Âú®ÂºÄÂèë‰∏≠...',
    error: {
      code: 'NOT_IMPLEMENTED',
      details: 'ËØ•ÂäüËÉΩÂ∞öÊú™ÂÆûÁé∞'
    }
  })
  // ÂáΩÊï∞ÁªìÊùü
  // ÂáΩÊï∞ÁªìÊùü
}))

// ËÆ°ÁÆóÂà∂‰ΩúÊàêÊú¨È¢Ñ‰º∞
  // ÈªòËÆ§ËøîÂõû
  //   return res.status(500).json({ success: false, message: "Êìç‰ΩúÂ§±Ë¥•" })  // ÁßªÈô§ÂáΩÊï∞‰ΩìÂ§ñÁöÑreturnËØ≠Âè•
router.post('/cost', authenticateToken, asyncHandler(async (req, res) => {
  const { materials, labor_cost = 0, craft_cost = 0} = req.body
  
  if (!materials || !Array.isArray(materials) || materials.length === 0) {
    return res.status(400).json({
      success: false,
      message: 'ËØ∑Êèê‰æõÂéüÊùêÊñôÂàóË°®'
    })
  }
  
  let totalMaterialCost = 0
  const materialDetails = []
  
  // ËÆ°ÁÆóÂéüÊùêÊñôÊàêÊú¨
  for (const material of materials) {
    const materialRecord = await prisma.material.findUnique({
      where: { id: material.material_id }
    })
    

    if (!materialRecord) {
      return res.status(400).json({
        success: false,
        message: `ÂéüÊùêÊñôËÆ∞ÂΩï ${material.material_id} ‰∏çÂ≠òÂú®`
      })
    }
    
    const usedBeads = material.quantity_used_beads || 0
    const usedPieces = material.quantity_used_pieces || 0
    
    let materialCost = 0
    if (usedBeads > 0 && materialRecord.unit_cost) {
      materialCost += usedBeads * Number(materialRecord.unit_cost)
    }
    if (usedPieces > 0 && materialRecord.unit_cost) {
      materialCost += usedPieces * Number(materialRecord.unit_cost)
    }
    
    totalMaterialCost += materialCost
    materialDetails.push({
      material_id: material.material_id,
      material_name: materialRecord.material_name,
      used_beads: usedBeads,
      used_pieces: usedPieces,
      unit_cost: materialRecord.unit_cost || 0,
      material_cost: materialCost
    })
  }
  
  // ËÆ°ÁÆóÊÄªÊàêÊú¨
  const totalCost = totalMaterialCost + Number(labor_cost) + Number(craft_cost)
  
  // ËÆ°ÁÆóÂª∫ËÆÆÂîÆ‰ª∑
  const data = req.body;

  const profit_margin = data.profit_margin || 0;
  const profitMultiplier = 1 + (Number(profit_margin) / 100)
  const suggestedPrice = totalCost * profitMultiplier
  
  return res.json({
    success: true,
    message: 'ÊàêÊú¨ËÆ°ÁÆóÊàêÂäü',
    data: {
      material_cost: totalMaterialCost,
      labor_cost: Number(labor_cost),
      craft_cost: Number(craft_cost),
      total_price: totalCost,
      profit_margin: Number(profit_margin),
      pricing_suggestion: {
        suggested_price: Math.round(suggestedPrice * 100) / 100,
        min_price: Math.round(totalCost * 1.1 * 100) / 100,
        max_price: Math.round(totalCost * 2 * 100) / 100
      },
      material_details: materialDetails
    }
  })
  // ÂáΩÊï∞ÁªìÊùü
  // ÂáΩÊï∞ÁªìÊùü
}))

// ÂàõÂª∫ÊàêÂìÅËÆ∞ÂΩïÔºàÈáçÂÜôÂéüÊúâÁöÑPOST /Êé•Âè£Ôºâ
  // ÈªòËÆ§ËøîÂõû
  //   return res.status(500).json({ success: false, message: "Êìç‰ΩúÂ§±Ë¥•" })  // ÁßªÈô§ÂáΩÊï∞‰ΩìÂ§ñÁöÑreturnËØ≠Âè•
router.post('/', authenticateToken, asyncHandler(async (req, res) => {
  const {
    sku_name,
    description,
    specification,
    materials,
    labor_cost = 0,
    craft_cost = 0,
    selling_price,
    photos = []
  } = req.body
  
  // È™åËØÅÂøÖÂ°´Â≠óÊÆµ
  if (!sku_name || !materials || !Array.isArray(materials) || materials.length === 0) {
    return res.status(400).json({
      success: false,
      message: 'ËØ∑Êèê‰æõSKUÂêçÁß∞ÂíåÂéüÊùêÊñôÂàóË°®'
    })
  }
  
  if (!selling_price || selling_price <= 0) {
    return res.status(400).json({
      success: false,
      message: 'ËØ∑ËÆæÁΩÆÊúâÊïàÁöÑÈîÄÂîÆ‰ª∑Ê†º'
    })
  }
  
  // ÂºÄÂêØ‰∫ãÂä°
  const result = await prisma.$transaction(async (tx) => {
    // È™åËØÅÂéüÊùêÊñôÂ∫ìÂ≠ò
    let totalMaterialCost = 0
    
    for (const material of materials) {
      const materialRecord = await tx.material.findUnique({
        where: { id: material.material_id }
      })
      

      if (!materialRecord) {
        throw new Error(`ÂéüÊùêÊñôËÆ∞ÂΩï ${material.material_id} ‰∏çÂ≠òÂú®`)
      }
      
      // Ê†πÊçÆÊùêÊñôÁ±ªÂûãËÆ°ÁÆóÂ∫ìÂ≠òÂíåÈúÄÊ±ÇÈáè
      const available_quantity = materialRecord.remaining_quantity || 0
      const requiredQuantityBeads = material.quantity_used_beads || 0
      const requiredQuantityPieces = material.quantity_used_pieces || 0
      const totalRequired = requiredQuantityBeads + requiredQuantityPieces
      
      if (available_quantity < totalRequired) {
        const unit = materialRecord.material_type === 'LOOSE_BEADS' || materialRecord.material_type === 'BRACELET' ? 'È¢ó' :
                    materialRecord.material_type === 'ACCESSORIES' ? 'Áâá' : '‰ª∂'
        throw new Error(`ÂéüÊùêÊñôÂ∫ìÂ≠ò‰∏çË∂≥ÔºåÂèØÁî®Ôºö${available_quantity}${unit}ÔºåÈúÄË¶ÅÔºö${totalRequired}${unit}`)
      }
      
      // ËÆ°ÁÆóÂéüÊùêÊñôÊàêÊú¨
      const materialUnitCost = Number(materialRecord.unit_cost) || 0;
      const materialUsedQuantity = requiredQuantityBeads + requiredQuantityPieces;
      
      // Á¥ØÂä†ÊùêÊñôÊàêÊú¨Ôºö‰ΩøÁî®Êï∞Èáè √ó Âçï‰ª∑
      if (materialUsedQuantity > 0 && materialUnitCost > 0) {
        totalMaterialCost += materialUsedQuantity * materialUnitCost;
      }
    }
    
    // ËÆ°ÁÆóÊÄªÊàêÊú¨
    const totalCost = totalMaterialCost + Number(labor_cost) + Number(craft_cost)
    
    // ÂáÜÂ§áÂéüÊùêÊñô‰ΩøÁî®ËÆ∞ÂΩïÔºàÁî®‰∫éSKUÊ†áËØÜÁîüÊàêÔºâ
    const materialUsagesForSku = []
    for (const material of materials) {
      // Ëé∑ÂèñÂÆåÊï¥ÁöÑÊùêÊñô‰ø°ÊÅØ
      const materialRecord = await tx.material.findUnique({
        where: { id: material.material_id }
      })
      
      if (!materialRecord) {
        throw new Error(`ÂéüÊùêÊñôËÆ∞ÂΩï‰∏çÂ≠òÂú®Ôºåmaterial_id: ${material.material_id}`)
      }
      
      const usedQuantity = (material.quantity_used_beads || 0) + (material.quantity_used_pieces || 0)
      materialUsagesForSku.push({
        material: {
          material_name: materialRecord.material_name,
          material_type: materialRecord.material_type,
          quality: materialRecord.quality,
          bead_diameter: materialRecord.bead_diameter,
          accessory_specification: materialRecord.accessory_specification,
          finished_material_specification: materialRecord.finished_material_specification
        },
        quantity_used_beads: material.quantity_used_beads || 0,
        quantity_used_pieces: material.quantity_used_pieces || 0,
        quantity_used: usedQuantity
      })
    }
    
    // Êü•ÊâæÊàñÂàõÂª∫SKU
    const { sku, is_new_sku, log_created } = await findOrCreateSku({
      material_usages: materialUsagesForSku,
      sku_name: sku_name,
      selling_price: Number(selling_price),
      user_id: req.user!.id,
      tx: tx,
      additional_data: {
        photos: photos.length > 0 ? photos : null,
        description: description || null,
        specification: specification || null,
        material_cost: totalMaterialCost,
        labor_cost: Number(labor_cost || 0),
        craft_cost: Number(craft_cost || 0),
        total_cost: totalCost,
        profit_margin: Number(selling_price) > 0 
          ? ((Number(selling_price) - totalCost) / Number(selling_price) * 100)
          : 0,
        reference_type: 'PRODUCT',
        notes: `ÁªÑÂêàÂà∂‰ΩúÊ®°ÂºèÂàõÂª∫ÊàêÂìÅ: ${sku_name}`
      }
    })
    
    // ÂàõÂª∫ÊàêÂìÅËÆ∞ÂΩïÂπ∂ÂÖ≥ËÅîÂà∞SKU
    const product = await tx.product.create({
      data: {
        product_code: null, // ‰∏çÂÜç‰ΩøÁî®ÂçïÁã¨ÁöÑÊàêÂìÅÁºñÂè∑
        name: sku_name,
        description: description || null,
        unit_price: Number(selling_price),
        total_value: totalCost,
        unit: '‰ª∂',
        quantity: 1,
        images: photos.length > 0 ? JSON.stringify(photos) : null,
        notes: description || null,
        user_id: req.user!.id,
        sku_id: sku.id // ÂÖ≥ËÅîÂà∞SKU
      }
    })
    
    // ÂàõÂª∫ÂéüÊùêÊñô‰ΩøÁî®ËÆ∞ÂΩï
    for (const material of materials) {
      const usedBeads = material.quantity_used_beads || 0
      const usedPieces = material.quantity_used_pieces || 0
      const totalUsed = usedBeads + usedPieces
      
      if (totalUsed > 0) {
        // Ëé∑ÂèñÊùêÊñôËÆ∞ÂΩï
        const materialRecord = await tx.material.findUnique({
          where: { id: material.material_id }
        })
        
        if (!materialRecord) {
          throw new Error(`ÂéüÊùêÊñôËÆ∞ÂΩï‰∏çÂ≠òÂú®Ôºåmaterial_id: ${material.material_id}`)
        }
        
        const unitCost = materialRecord.unit_cost || 0
        
        await tx.materialUsage.create({
          data: {
            material_id: material.material_id,
            sku_id: sku.id,
            quantity_used: totalUsed,
            unit_cost: unitCost,
            total_cost: unitCost * totalUsed,
            action: 'CREATE'
          }
        })
        
        // Ê≥®ÊÑèÔºö‰∏çÈúÄË¶ÅÊâãÂä®Êõ¥Êñ∞ÊùêÊñôÂ∫ìÂ≠òÔºåÊï∞ÊçÆÂ∫ìËß¶ÂèëÂô®‰ºöËá™Âä®Â§ÑÁêÜ
        // Ëß¶ÂèëÂô®‰ºöÂú®MaterialUsageËÆ∞ÂΩïÊèíÂÖ•ÂêéËá™Âä®Êõ¥Êñ∞used_quantityÂíåremaining_quantity
      }
    }
    
    // Âè™Âú®ÂàõÂª∫Êñ∞SKUÊó∂ÂàõÂª∫Â∫ìÂ≠òÂèòÊõ¥Êó•ÂøóÔºåÈÅøÂÖçÈáçÂ§çËÆ∞ÂΩï
    if (is_new_sku && !log_created) {
      await createSkuInventoryLog({
        sku_id: sku.id!,
        action: 'CREATE',
        quantity_change: 1,
        quantity_before: 0,
        quantity_after: 1,
        reference_type: 'PRODUCT',
        reference_id: product.id,
        notes: `ÁªÑÂêàÂà∂‰ΩúÊ®°ÂºèÂàõÂª∫Êñ∞SKU: ${sku_name}`,
        user_id: req.user!.id,
        tx: tx
      })
    }
    
    return {
      id: product.id,
      sku_name,
      sku_code: sku.sku_code,
      sku_id: sku.id,
      is_new_sku: is_new_sku,
      total_price: totalCost,
      selling_price: Number(selling_price),
      profit: Number(selling_price) - totalCost,
      profit_margin: ((Number(selling_price) - totalCost) / Number(selling_price) * 100).toFixed(2),
      sku_total_quantity: sku.total_quantity,
      sku_available_quantity: sku.available_quantity
    }
  })
  
  return res.status(201).json({
    success: true,
    message: 'ÊàêÂìÅÂàõÂª∫ÊàêÂäü',
    data: result
  })
  // ÂáΩÊï∞ÁªìÊùü
  // ÂáΩÊï∞ÁªìÊùü
}))

// ÊâπÈáèÂàõÂª∫ÊàêÂìÅËÆ∞ÂΩïÔºàÁõ¥Êé•ËΩ¨ÂåñÊ®°ÂºèÔºâ
  // ÈªòËÆ§ËøîÂõû
  //   return res.status(500).json({ success: false, message: "Êìç‰ΩúÂ§±Ë¥•" })  // ÁßªÈô§ÂáΩÊï∞‰ΩìÂ§ñÁöÑreturnËØ≠Âè•
router.post('/batch', authenticateToken, asyncHandler(async (req, res) => {
  const { products } = req.body
  
  // È™åËØÅËØ∑Ê±ÇÂèÇÊï∞
  if (!products || !Array.isArray(products) || products.length === 0) {
    return res.status(400).json({
      success: false,
      message: 'ËØ∑Êèê‰æõÊàêÂìÅÂàóË°®'
    })
  }
  
  // È™åËØÅÊØè‰∏™ÊàêÂìÅÁöÑÂøÖÂ°´Â≠óÊÆµ
  for (let i = 0; i < products.length; i++) {
    const product = products[i]
    if (!product.material_id || !product.sku_name || !product.selling_price || product.selling_price <= 0) {
      return res.status(400).json({
        success: false,
        message: `Á¨¨${i + 1}‰∏™ÊàêÂìÅ‰ø°ÊÅØ‰∏çÂÆåÊï¥ÔºöÈúÄË¶ÅÂéüÊùêÊñôID„ÄÅSKUÂêçÁß∞ÂíåÊúâÊïàÁöÑÈîÄÂîÆ‰ª∑Ê†º`
      })
    }
  }
  
  const createdProducts = []
  const failedProducts = []
  
  // ÈÄê‰∏™Â§ÑÁêÜÊØè‰∏™ÊàêÂìÅÂàõÂª∫ÔºàÈÅøÂÖç‰∫ãÂä°ËøáÂ§ßÔºâ
  for (let i = 0; i < products.length; i++) {
    const productData = products[i]
    
    try {
      // ÂºÄÂêØÂçï‰∏™ÊàêÂìÅÁöÑ‰∫ãÂä°
      const result = await prisma.$transaction(async (tx) => {
        // Ê∑ªÂä†Ë∞ÉËØïÊó•Âøó
        console.log('üîç [ÂêéÁ´ØË∞ÉËØï] Êü•ËØ¢ÂéüÊùêÊñô:', {
          material_id: productData.material_id,
          material_id_type: typeof productData.material_id
        })
        
        // È™åËØÅÂéüÊùêÊñôÂ≠òÂú®ÊÄßÂíåÂ∫ìÂ≠ò
        console.log('üîç [ÂêéÁ´ØË∞ÉËØï] ÂºÄÂßãÊü•ËØ¢ÂéüÊùêÊñô:', {
          material_id: productData.material_id,
          material_id_type: typeof productData.material_id,
          material_id_length: productData.material_id?.length
        })
        
        const materialRecord = await tx.material.findUnique({
          where: { id: productData.material_id }
        })
        
        console.log('üîç [ÂêéÁ´ØË∞ÉËØï] Êü•ËØ¢ÁªìÊûú:', {
          found: !!materialRecord,
          material_id: materialRecord?.id,
          material_name: materialRecord?.material_name,
          material_type: materialRecord?.material_type,
          query_id: productData.material_id
        })

        if (!materialRecord) {
          throw new Error(`ÂéüÊùêÊñôËÆ∞ÂΩï‰∏çÂ≠òÂú®Ôºåmaterial_id: ${productData.material_id}`)
        }
        
        // Ê£ÄÊü•ÊòØÂê¶‰∏∫ÊàêÂìÅÁ±ªÂûãÁöÑÂéüÊùêÊñô
        if (materialRecord.material_type !== 'FINISHED_MATERIAL') {
          throw new Error(`Âè™ËÉΩ‰ΩøÁî®ÊàêÂìÅÁ±ªÂûãÁöÑÂéüÊùêÊñôËøõË°åÁõ¥Êé•ËΩ¨Âåñ`)
        }
        
        // Ê£ÄÊü•Â∫ìÂ≠ò
        const available_quantity = materialRecord.remaining_quantity || 0
        
        if (available_quantity < 1) {
          throw new Error(`ÂéüÊùêÊñôÂ∫ìÂ≠ò‰∏çË∂≥ÔºåÂèØÁî®Ôºö${available_quantity}‰ª∂ÔºåÈúÄË¶ÅÔºö1‰ª∂`)
        }
        
        // ËÆ°ÁÆóÊùêÊñôÊàêÊú¨
        const materialCost = Number(materialRecord.unit_cost) || 0;
        
        const laborCost = productData.labor_cost || 0;
        const craftCost = productData.craft_cost || 0;
        const totalCost = Number(materialCost) + Number(laborCost) + Number(craftCost);
        
        // Â§ÑÁêÜÂõæÁâáÁªßÊâøÈÄªËæëÔºàÁõ¥Êé•ËΩ¨ÂåñÊ®°ÂºèÔºâ
        let productImages = null;
        if (productData.photos && productData.photos.length > 0) {
          // Â¶ÇÊûúÂâçÁ´Ø‰º†ÈÄí‰∫ÜÂõæÁâáÔºå‰ΩøÁî®ÂâçÁ´ØÂõæÁâá
          productImages = JSON.stringify(productData.photos);
        } else if (materialRecord.photos) {
          // Â¶ÇÊûúÂâçÁ´ØÊ≤°ÊúâÂõæÁâáÔºå‰ªéÂéüÊùêÊñôÁªßÊâøÂõæÁâá
          let photosArray = materialRecord.photos;
          
          // Á°Æ‰øùÊòØÊï∞ÁªÑÊ†ºÂºè
          if (!Array.isArray(photosArray)) {
            photosArray = [photosArray];
          }
          
          // ËøáÊª§Êó†ÊïàÁöÑURL
          photosArray = photosArray.filter(url => url && typeof url === 'string' && url.trim() !== '');
          
          if (photosArray.length > 0) {
            productImages = JSON.stringify(photosArray);
          }
        }
        
        // ÂáÜÂ§áÂéüÊùêÊñô‰ΩøÁî®ËÆ∞ÂΩïÔºàÁî®‰∫éSKUÊ†áËØÜÁîüÊàêÔºâ
        // ÁßªÈô§Êú™‰ΩøÁî®ÁöÑÂèòÈáè
        
        // ÁßªÈô§Êú™‰ΩøÁî®ÁöÑÂèòÈáè

        // ÂáÜÂ§áÂéüÊùêÊñô‰ΩøÁî®ËÆ∞ÂΩïÔºàÁî®‰∫éSKUÊ†áËØÜÁîüÊàêÔºâ
        // Ê∑ªÂä†È¢ùÂ§ñÁöÑÂÆâÂÖ®Ê£ÄÊü•
        if (!materialRecord || !materialRecord.material_name) {
          throw new Error(`ÂéüÊùêÊñôËÆ∞ÂΩïÊï∞ÊçÆ‰∏çÂÆåÊï¥Ôºåmaterial_id: ${productData.material_id}`);
        }
        
        const materialUsages = [{
          material: {
            material_name: materialRecord.material_name,
            material_type: materialRecord.material_type,
            quality: materialRecord.quality || null,
            bead_diameter: materialRecord.bead_diameter || null,
            specification: materialRecord.specification || null
          },
          quantity_used_beads: 0,
          quantity_used_pieces: 1
        }];

        // Êü•ÊâæÊàñÂàõÂª∫SKU
        const { sku, is_new_sku, log_created } = await findOrCreateSku({
          material_usages: materialUsages,
          sku_name: productData.sku_name,
          selling_price: Number(productData.selling_price),
          user_id: req.user!.id,
          tx: tx,
          additional_data: {
            photos: productImages ? JSON.parse(productImages) : null,
            description: productData.description || null,
            specification: productData.specification || null,
            materialCost: materialCost,
            laborCost: laborCost,
            craftCost: craftCost,
            totalCost: totalCost,
            profitMargin: Number(productData.selling_price) > 0 
              ? ((Number(productData.selling_price) - totalCost) / Number(productData.selling_price) * 100).toFixed(1)
              : '0.0',
            reference_type: 'PRODUCT',
            notes: `Áõ¥Êé•ËΩ¨ÂåñÊ®°ÂºèÂàõÂª∫SKU: ${productData.sku_name}`
          }
        })
        
        // ÂàõÂª∫SKUËÆ∞ÂΩïÂπ∂ÂÖ≥ËÅîÂà∞SKU
        const product = await tx.product.create({
          data: {
            product_code: null, // ‰∏çÂÜç‰ΩøÁî®ÂçïÁã¨ÁöÑÊàêÂìÅÁºñÂè∑
            name: productData.sku_name,
            description: productData.description || null,
            unit_price: Number(productData.selling_price),
            total_value: totalCost,
            unit: '‰ª∂',
            quantity: 1,
            images: productImages,
            notes: productData.description || null,
            user_id: req.user!.id,
            sku_id: sku.id // ÂÖ≥ËÅîÂà∞SKU
          }
        })
        
        // Áõ¥Êé•‰ΩøÁî®Â∑≤È™åËØÅÁöÑmaterialRecord
        const material = materialRecord;

        // ÂàõÂª∫ÂéüÊùêÊñô‰ΩøÁî®ËÆ∞ÂΩï
        await tx.materialUsage.create({
          data: {
            material_id: material.id,
            sku_id: sku.id,
            quantity_used: 1,
            unit_cost: material.unit_cost,
            total_cost: material.unit_cost * 1,
            action: 'CREATE'
          }
        })
        
        // Ê≥®ÊÑèÔºö‰∏çÈúÄË¶ÅÊâãÂä®Êõ¥Êñ∞ÊùêÊñôÂ∫ìÂ≠òÔºåÊï∞ÊçÆÂ∫ìËß¶ÂèëÂô®‰ºöËá™Âä®Â§ÑÁêÜ
        // Ëß¶ÂèëÂô®‰ºöÂú®MaterialUsageËÆ∞ÂΩïÊèíÂÖ•ÂêéËá™Âä®Êõ¥Êñ∞used_quantityÂíåremaining_quantity
        
        // Âè™Âú®ÂàõÂª∫Êñ∞SKUÊó∂ÂàõÂª∫Â∫ìÂ≠òÂèòÊõ¥Êó•ÂøóÔºåÈÅøÂÖçÈáçÂ§çËÆ∞ÂΩï
        if (is_new_sku && !log_created) {
          await createSkuInventoryLog({
            sku_id: sku.id,
            action: 'CREATE',
            quantity_change: 1,
            quantity_before: 0,
            quantity_after: 1,
            reference_type: 'PRODUCT',
            reference_id: product.id,
            notes: `Áõ¥Êé•ËΩ¨ÂåñÊ®°ÂºèÂàõÂª∫Êñ∞SKU: ${productData.sku_name}`,
            user_id: req.user!.id,
            tx: tx
          })
        }
        
        return {
          id: product.id,
          sku_code: sku.sku_code,
          sku_id: sku.id,
          is_new_sku: is_new_sku,
          sku_name: productData.sku_name,
          material_cost: Number(materialCost),
          total_price: totalCost,
          selling_price: Number(productData.selling_price),
          profit_margin: Number(productData.selling_price) > 0 
            ? ((Number(productData.selling_price) - totalCost) / Number(productData.selling_price) * 100).toFixed(1)
            : '0.0',
          status: 'AVAILABLE',
          sku_total_quantity: sku.total_quantity,
          sku_available_quantity: sku.available_quantity
        }
      })
      
      createdProducts.push(result)
      
    } catch (error) {
      console.error(`ÊâπÈáèÂàõÂª∫Á¨¨${i + 1}‰∏™ÊàêÂìÅÂ§±Ë¥•:`, error)
      failedProducts.push({
        material_id: productData.material_id,
        error: (error as Error).message,
        error_code: 'CREATION_FAILED'
      })
    }
  }
  
  const successCount = createdProducts.length
  const failedCount = failedProducts.length
  
  // Ê†πÊçÆÁªìÊûúËøîÂõûÁõ∏Â∫îÁöÑÁä∂ÊÄÅÁ†ÅÂíåÊ∂àÊÅØ
  if (successCount === 0) {
    return res.status(400).json({
      success: false,
      message: 'ÊâπÈáèÂàõÂª∫ÂÖ®ÈÉ®Â§±Ë¥•',
      data: {
        success_count: 0,
        failed_count: failedCount,
        created_products: [],
        failed_products: failedProducts
      }
    })
  }
  
  const message = failedCount > 0 
    ? `ÊâπÈáèÂàõÂª∫ÈÉ®ÂàÜÊàêÂäüÔºöÊàêÂäü${successCount}‰∏™ÔºåÂ§±Ë¥•${failedCount}‰∏™`
    : `ÊâπÈáèÂàõÂª∫ÂÖ®ÈÉ®ÊàêÂäüÔºöÂÖ±ÂàõÂª∫${successCount}‰∏™ÊàêÂìÅ`
  
  return res.status(201).json({
    success: true,
    message,
    data: {
      success_count: successCount,
      failed_count: failedCount,
      created_products: createdProducts,
      failed_products: failedProducts
    }
  })
  // ÂáΩÊï∞ÁªìÊùü
  // ÂáΩÊï∞ÁªìÊùü
}))

export default router