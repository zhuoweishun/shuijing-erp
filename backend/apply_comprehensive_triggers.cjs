const mysql = require('mysql2/promise');
const fs = require('fs');

async function applyComprehensiveTriggers() {
  const connection = await mysql.createConnection({
    host: 'localhost',
    user: 'root',
    password: 'ZWSloveWCC123',
    database: 'crystal_erp_dev'
  });

  try {
    console.log('üîß ÂºÄÂßãÂ∫îÁî®ÂÖ®Èù¢ÁöÑpurchase-materialÂêåÊ≠•Ëß¶ÂèëÂô®...');
    
    // Âà†Èô§Áé∞ÊúâËß¶ÂèëÂô®
    console.log('üóëÔ∏è Âà†Èô§Áé∞ÊúâËß¶ÂèëÂô®...');
    await connection.query('DROP TRIGGER IF EXISTS tr_purchase_insert_material');
    await connection.query('DROP TRIGGER IF EXISTS tr_purchase_update_material');
    await connection.query('DROP TRIGGER IF EXISTS tr_material_usage_update_stock');
    await connection.query('DROP TRIGGER IF EXISTS tr_material_usage_update_stock_after_update');
    await connection.query('DROP TRIGGER IF EXISTS tr_material_usage_update_stock_after_delete');
    
    // ÂàõÂª∫INSERTËß¶ÂèëÂô®
    console.log('üìù ÂàõÂª∫INSERTËß¶ÂèëÂô®...');
    const insertTrigger = `
    CREATE TRIGGER tr_purchase_insert_material
    AFTER INSERT ON purchases
    FOR EACH ROW
    BEGIN
      IF NEW.status = 'ACTIVE' THEN
        INSERT INTO materials (
          id,
          material_code, 
          material_name, 
          material_type, 
          quality,
          bead_diameter, 
          bracelet_inner_diameter,
          bracelet_bead_count,
          accessory_specification, 
          finished_material_specification,
          original_quantity, 
          used_quantity,
          remaining_quantity,
          inventory_unit, 
          unit_cost, 
          total_cost,
          min_stock_alert, 
          purchase_id, 
          supplier_id, 
          photos, 
          material_date, 
          notes, 
          created_by,
          created_at,
          updated_at
        ) VALUES (
          CONCAT('mat_', SUBSTRING(UUID(), 1, 8), '_', UNIX_TIMESTAMP()),
          NEW.purchase_code,
          NEW.purchase_name,
          NEW.purchase_type,
          COALESCE(NEW.quality, 'UNKNOWN'),
          NEW.bead_diameter,
          CASE 
            WHEN NEW.purchase_type = 'BRACELET' THEN NEW.specification
            ELSE NULL
          END,
          NEW.beads_per_string,
          CASE 
            WHEN NEW.purchase_type = 'ACCESSORIES' THEN CAST(NEW.specification AS CHAR)
            ELSE NULL
          END,
          CASE 
            WHEN NEW.purchase_type = 'FINISHED_MATERIAL' THEN CAST(NEW.specification AS CHAR)
            ELSE NULL
          END,
          
          -- Êï∞ÈáèËÆ°ÁÆóÈÄªËæë
          CASE 
            WHEN NEW.purchase_type = 'LOOSE_BEADS' THEN 
              COALESCE(NEW.piece_count, 
                CASE 
                  WHEN COALESCE(NEW.weight, 0) > 0 THEN
                    CASE 
                      WHEN NEW.bead_diameter = 4.0 THEN FLOOR(NEW.weight * 25)
                      WHEN NEW.bead_diameter = 6.0 THEN FLOOR(NEW.weight * 11)
                      WHEN NEW.bead_diameter = 8.0 THEN FLOOR(NEW.weight * 6)
                      WHEN NEW.bead_diameter = 10.0 THEN FLOOR(NEW.weight * 4)
                      WHEN NEW.bead_diameter = 12.0 THEN FLOOR(NEW.weight * 3)
                      ELSE FLOOR(NEW.weight * 5)
                    END
                  ELSE 0
                END
              )
            WHEN NEW.purchase_type = 'BRACELET' THEN 
              COALESCE(NEW.total_beads, NEW.piece_count,
                CASE 
                  WHEN COALESCE(NEW.weight, 0) > 0 THEN
                    CASE 
                      WHEN NEW.bead_diameter = 4.0 THEN FLOOR(NEW.weight * 25)
                      WHEN NEW.bead_diameter = 6.0 THEN FLOOR(NEW.weight * 11)
                      WHEN NEW.bead_diameter = 8.0 THEN FLOOR(NEW.weight * 6)
                      WHEN NEW.bead_diameter = 10.0 THEN FLOOR(NEW.weight * 4)
                      WHEN NEW.bead_diameter = 12.0 THEN FLOOR(NEW.weight * 3)
                      ELSE FLOOR(NEW.weight * 5)
                    END
                  ELSE 1
                END
              )
            WHEN NEW.purchase_type = 'ACCESSORIES' THEN COALESCE(NEW.piece_count, 1)
            WHEN NEW.purchase_type = 'FINISHED_MATERIAL' THEN COALESCE(NEW.piece_count, 1)
            ELSE COALESCE(NEW.piece_count, NEW.quantity, 1)
          END,
          
          -- Â∑≤‰ΩøÁî®Êï∞ÈáèÔºàÂàùÂßã‰∏∫0Ôºâ
          0,
          
          -- Ââ©‰ΩôÊï∞ÈáèÔºàÂàùÂßãÁ≠â‰∫éÂéüÂßãÊï∞ÈáèÔºâ
          CASE 
            WHEN NEW.purchase_type = 'LOOSE_BEADS' THEN 
              COALESCE(NEW.piece_count, 
                CASE 
                  WHEN COALESCE(NEW.weight, 0) > 0 THEN
                    CASE 
                      WHEN NEW.bead_diameter = 4.0 THEN FLOOR(NEW.weight * 25)
                      WHEN NEW.bead_diameter = 6.0 THEN FLOOR(NEW.weight * 11)
                      WHEN NEW.bead_diameter = 8.0 THEN FLOOR(NEW.weight * 6)
                      WHEN NEW.bead_diameter = 10.0 THEN FLOOR(NEW.weight * 4)
                      WHEN NEW.bead_diameter = 12.0 THEN FLOOR(NEW.weight * 3)
                      ELSE FLOOR(NEW.weight * 5)
                    END
                  ELSE 0
                END
              )
            WHEN NEW.purchase_type = 'BRACELET' THEN 
              COALESCE(NEW.total_beads, NEW.piece_count,
                CASE 
                  WHEN COALESCE(NEW.weight, 0) > 0 THEN
                    CASE 
                      WHEN NEW.bead_diameter = 4.0 THEN FLOOR(NEW.weight * 25)
                      WHEN NEW.bead_diameter = 6.0 THEN FLOOR(NEW.weight * 11)
                      WHEN NEW.bead_diameter = 8.0 THEN FLOOR(NEW.weight * 6)
                      WHEN NEW.bead_diameter = 10.0 THEN FLOOR(NEW.weight * 4)
                      WHEN NEW.bead_diameter = 12.0 THEN FLOOR(NEW.weight * 3)
                      ELSE FLOOR(NEW.weight * 5)
                    END
                  ELSE 1
                END
              )
            WHEN NEW.purchase_type = 'ACCESSORIES' THEN COALESCE(NEW.piece_count, 1)
            WHEN NEW.purchase_type = 'FINISHED_MATERIAL' THEN COALESCE(NEW.piece_count, 1)
            ELSE COALESCE(NEW.piece_count, NEW.quantity, 1)
          END,
          
          -- Â∫ìÂ≠òÂçï‰Ωç
          CASE 
            WHEN NEW.purchase_type IN ('LOOSE_BEADS', 'BRACELET') THEN 'PIECES'
            WHEN NEW.purchase_type = 'ACCESSORIES' THEN 'SLICES'
            WHEN NEW.purchase_type = 'FINISHED_MATERIAL' THEN 'ITEMS'
            ELSE 'PIECES'
          END,
          
          -- Âçï‰ΩçÊàêÊú¨ËÆ°ÁÆó
          CASE 
            WHEN NEW.purchase_type = 'LOOSE_BEADS' THEN 
              COALESCE(NEW.total_price, 0) / GREATEST(
                COALESCE(NEW.piece_count, 
                  CASE 
                    WHEN COALESCE(NEW.weight, 0) > 0 THEN
                      CASE 
                        WHEN NEW.bead_diameter = 4.0 THEN FLOOR(NEW.weight * 25)
                        WHEN NEW.bead_diameter = 6.0 THEN FLOOR(NEW.weight * 11)
                        WHEN NEW.bead_diameter = 8.0 THEN FLOOR(NEW.weight * 6)
                        WHEN NEW.bead_diameter = 10.0 THEN FLOOR(NEW.weight * 4)
                        WHEN NEW.bead_diameter = 12.0 THEN FLOOR(NEW.weight * 3)
                        ELSE FLOOR(NEW.weight * 5)
                      END
                    ELSE 1
                  END
                ),
                1
              )
            WHEN NEW.purchase_type = 'BRACELET' THEN 
              COALESCE(NEW.total_price, 0) / GREATEST(
                COALESCE(NEW.total_beads, NEW.piece_count,
                  CASE 
                    WHEN COALESCE(NEW.weight, 0) > 0 THEN
                      CASE 
                        WHEN NEW.bead_diameter = 4.0 THEN FLOOR(NEW.weight * 25)
                        WHEN NEW.bead_diameter = 6.0 THEN FLOOR(NEW.weight * 11)
                        WHEN NEW.bead_diameter = 8.0 THEN FLOOR(NEW.weight * 6)
                        WHEN NEW.bead_diameter = 10.0 THEN FLOOR(NEW.weight * 4)
                        WHEN NEW.bead_diameter = 12.0 THEN FLOOR(NEW.weight * 3)
                        ELSE FLOOR(NEW.weight * 5)
                      END
                    ELSE 1
                  END
                ),
                1
              )
            ELSE COALESCE(NEW.total_price, 0) / GREATEST(COALESCE(NEW.piece_count, 1), 1)
          END,
          
          COALESCE(NEW.total_price, 0),
          NEW.min_stock_alert,
          NEW.id,
          NEW.supplier_id,
          NEW.photos,
          DATE(NEW.purchase_date),
          NEW.notes,
          NEW.user_id,
          NEW.created_at,
          NEW.updated_at
        );
      END IF;
    END`;
    
    await connection.query(insertTrigger);
    
    // ÂàõÂª∫UPDATEËß¶ÂèëÂô®
    console.log('üîÑ ÂàõÂª∫UPDATEËß¶ÂèëÂô®...');
    const updateTrigger = `
    CREATE TRIGGER tr_purchase_update_material
    AFTER UPDATE ON purchases
    FOR EACH ROW
    BEGIN
      IF NEW.status = 'ACTIVE' AND OLD.status = 'ACTIVE' THEN
        UPDATE materials SET
          -- Âü∫Á°Ä‰ø°ÊÅØÂêåÊ≠•
          material_code = NEW.purchase_code,
          material_name = NEW.purchase_name,
          material_type = NEW.purchase_type,
          quality = COALESCE(NEW.quality, 'UNKNOWN'),
          
          -- ËßÑÊ†º‰ø°ÊÅØÂêåÊ≠•
          bead_diameter = NEW.bead_diameter,
          bracelet_inner_diameter = CASE 
            WHEN NEW.purchase_type = 'BRACELET' THEN NEW.specification
            ELSE bracelet_inner_diameter
          END,
          bracelet_bead_count = NEW.beads_per_string,
          accessory_specification = CASE 
            WHEN NEW.purchase_type = 'ACCESSORIES' THEN CAST(NEW.specification AS CHAR)
            ELSE accessory_specification
          END,
          finished_material_specification = CASE 
            WHEN NEW.purchase_type = 'FINISHED_MATERIAL' THEN CAST(NEW.specification AS CHAR)
            ELSE finished_material_specification
          END,
          
          -- Êï∞ÈáèÂíåÊàêÊú¨‰ø°ÊÅØÂêåÊ≠•
          original_quantity = CASE 
            WHEN NEW.purchase_type = 'LOOSE_BEADS' THEN 
              COALESCE(NEW.piece_count, 
                CASE 
                  WHEN COALESCE(NEW.weight, 0) > 0 THEN
                    CASE 
                      WHEN NEW.bead_diameter = 4.0 THEN FLOOR(NEW.weight * 25)
                      WHEN NEW.bead_diameter = 6.0 THEN FLOOR(NEW.weight * 11)
                      WHEN NEW.bead_diameter = 8.0 THEN FLOOR(NEW.weight * 6)
                      WHEN NEW.bead_diameter = 10.0 THEN FLOOR(NEW.weight * 4)
                      WHEN NEW.bead_diameter = 12.0 THEN FLOOR(NEW.weight * 3)
                      ELSE FLOOR(NEW.weight * 5)
                    END
                  ELSE 0
                END
              )
            WHEN NEW.purchase_type = 'BRACELET' THEN 
              COALESCE(NEW.total_beads, NEW.piece_count,
                CASE 
                  WHEN COALESCE(NEW.weight, 0) > 0 THEN
                    CASE 
                      WHEN NEW.bead_diameter = 4.0 THEN FLOOR(NEW.weight * 25)
                      WHEN NEW.bead_diameter = 6.0 THEN FLOOR(NEW.weight * 11)
                      WHEN NEW.bead_diameter = 8.0 THEN FLOOR(NEW.weight * 6)
                      WHEN NEW.bead_diameter = 10.0 THEN FLOOR(NEW.weight * 4)
                      WHEN NEW.bead_diameter = 12.0 THEN FLOOR(NEW.weight * 3)
                      ELSE FLOOR(NEW.weight * 5)
                    END
                  ELSE 1
                END
              )
            WHEN NEW.purchase_type = 'ACCESSORIES' THEN COALESCE(NEW.piece_count, 1)
            WHEN NEW.purchase_type = 'FINISHED_MATERIAL' THEN COALESCE(NEW.piece_count, 1)
            ELSE COALESCE(NEW.piece_count, NEW.quantity, 1)
          END,
          
          unit_cost = CASE 
            WHEN NEW.purchase_type = 'LOOSE_BEADS' THEN 
              COALESCE(NEW.total_price, 0) / GREATEST(
                COALESCE(NEW.piece_count, 
                  CASE 
                    WHEN COALESCE(NEW.weight, 0) > 0 THEN
                      CASE 
                        WHEN NEW.bead_diameter = 4.0 THEN FLOOR(NEW.weight * 25)
                        WHEN NEW.bead_diameter = 6.0 THEN FLOOR(NEW.weight * 11)
                        WHEN NEW.bead_diameter = 8.0 THEN FLOOR(NEW.weight * 6)
                        WHEN NEW.bead_diameter = 10.0 THEN FLOOR(NEW.weight * 4)
                        WHEN NEW.bead_diameter = 12.0 THEN FLOOR(NEW.weight * 3)
                        ELSE FLOOR(NEW.weight * 5)
                      END
                    ELSE 1
                  END
                ),
                1
              )
            WHEN NEW.purchase_type = 'BRACELET' THEN 
              COALESCE(NEW.total_price, 0) / GREATEST(
                COALESCE(NEW.total_beads, NEW.piece_count,
                  CASE 
                    WHEN COALESCE(NEW.weight, 0) > 0 THEN
                      CASE 
                        WHEN NEW.bead_diameter = 4.0 THEN FLOOR(NEW.weight * 25)
                        WHEN NEW.bead_diameter = 6.0 THEN FLOOR(NEW.weight * 11)
                        WHEN NEW.bead_diameter = 8.0 THEN FLOOR(NEW.weight * 6)
                        WHEN NEW.bead_diameter = 10.0 THEN FLOOR(NEW.weight * 4)
                        WHEN NEW.bead_diameter = 12.0 THEN FLOOR(NEW.weight * 3)
                        ELSE FLOOR(NEW.weight * 5)
                      END
                    ELSE 1
                  END
                ),
                1
              )
            ELSE COALESCE(NEW.total_price, 0) / GREATEST(COALESCE(NEW.piece_count, 1), 1)
          END,
          
          total_cost = COALESCE(NEW.total_price, 0),
          
          -- ÈáçÊñ∞ËÆ°ÁÆóremaining_quantity
          remaining_quantity = (
            CASE 
              WHEN NEW.purchase_type = 'LOOSE_BEADS' THEN 
                COALESCE(NEW.piece_count, 
                  CASE 
                    WHEN COALESCE(NEW.weight, 0) > 0 THEN
                      CASE 
                        WHEN NEW.bead_diameter = 4.0 THEN FLOOR(NEW.weight * 25)
                        WHEN NEW.bead_diameter = 6.0 THEN FLOOR(NEW.weight * 11)
                        WHEN NEW.bead_diameter = 8.0 THEN FLOOR(NEW.weight * 6)
                        WHEN NEW.bead_diameter = 10.0 THEN FLOOR(NEW.weight * 4)
                        WHEN NEW.bead_diameter = 12.0 THEN FLOOR(NEW.weight * 3)
                        ELSE FLOOR(NEW.weight * 5)
                      END
                    ELSE 0
                  END
                )
              WHEN NEW.purchase_type = 'BRACELET' THEN 
                COALESCE(NEW.total_beads, NEW.piece_count,
                  CASE 
                    WHEN COALESCE(NEW.weight, 0) > 0 THEN
                      CASE 
                        WHEN NEW.bead_diameter = 4.0 THEN FLOOR(NEW.weight * 25)
                        WHEN NEW.bead_diameter = 6.0 THEN FLOOR(NEW.weight * 11)
                        WHEN NEW.bead_diameter = 8.0 THEN FLOOR(NEW.weight * 6)
                        WHEN NEW.bead_diameter = 10.0 THEN FLOOR(NEW.weight * 4)
                        WHEN NEW.bead_diameter = 12.0 THEN FLOOR(NEW.weight * 3)
                        ELSE FLOOR(NEW.weight * 5)
                      END
                    ELSE 1
                  END
                )
              WHEN NEW.purchase_type = 'ACCESSORIES' THEN COALESCE(NEW.piece_count, 1)
              WHEN NEW.purchase_type = 'FINISHED_MATERIAL' THEN COALESCE(NEW.piece_count, 1)
              ELSE COALESCE(NEW.piece_count, NEW.quantity, 1)
            END
          ) - used_quantity,
          
          -- Â∫ìÂ≠òÁÆ°ÁêÜÂ≠óÊÆµÂêåÊ≠•
          min_stock_alert = NEW.min_stock_alert,
          
          -- ÂÖ≥ËÅî‰ø°ÊÅØÂêåÊ≠•
          supplier_id = NEW.supplier_id,
          
          -- ÈôÑÂä†‰ø°ÊÅØÂêåÊ≠•
          photos = NEW.photos,
          material_date = DATE(NEW.purchase_date),
          notes = NEW.notes,
          
          -- Êõ¥Êñ∞Êó∂Èó¥Êà≥
          updated_at = NEW.updated_at
          
        WHERE purchase_id = NEW.id;
        
      ELSEIF NEW.status = 'USED' AND OLD.status = 'ACTIVE' THEN
        -- purchaseÁä∂ÊÄÅÂèò‰∏∫USEDÊó∂Ôºå‰∏çÂà†Èô§materialËÆ∞ÂΩïÔºå‰øùÊåÅÂ∫ìÂ≠òÊï∞ÊçÆÂÆåÊï¥ÊÄß
        UPDATE materials SET
          notes = CONCAT(COALESCE(notes, ''), '\n[ÈááË¥≠ËÆ∞ÂΩïÂ∑≤Ê†áËÆ∞‰∏∫USED]'),
          updated_at = NEW.updated_at
        WHERE purchase_id = NEW.id;
      END IF;
    END`;
    
    await connection.query(updateTrigger);
    
    // ÂàõÂª∫material_usageÁõ∏ÂÖ≥Ëß¶ÂèëÂô®
    console.log('üìä ÂàõÂª∫material_usageËß¶ÂèëÂô®...');
    
    const usageInsertTrigger = `
    CREATE TRIGGER tr_material_usage_update_stock
    AFTER INSERT ON material_usage
    FOR EACH ROW
    BEGIN
      UPDATE materials SET
        used_quantity = (
          SELECT COALESCE(SUM(quantity_used), 0)
          FROM material_usage
          WHERE material_id = NEW.material_id
        ),
        remaining_quantity = original_quantity - (
          SELECT COALESCE(SUM(quantity_used), 0)
          FROM material_usage
          WHERE material_id = NEW.material_id
        ),
        updated_at = CURRENT_TIMESTAMP
      WHERE id = NEW.material_id;
    END`;
    
    await connection.query(usageInsertTrigger);
    
    const usageUpdateTrigger = `
    CREATE TRIGGER tr_material_usage_update_stock_after_update
    AFTER UPDATE ON material_usage
    FOR EACH ROW
    BEGIN
      UPDATE materials SET
        used_quantity = (
          SELECT COALESCE(SUM(quantity_used), 0)
          FROM material_usage
          WHERE material_id = NEW.material_id
        ),
        remaining_quantity = original_quantity - (
          SELECT COALESCE(SUM(quantity_used), 0)
          FROM material_usage
          WHERE material_id = NEW.material_id
        ),
        updated_at = CURRENT_TIMESTAMP
      WHERE id = NEW.material_id;
    END`;
    
    await connection.query(usageUpdateTrigger);
    
    const usageDeleteTrigger = `
    CREATE TRIGGER tr_material_usage_update_stock_after_delete
    AFTER DELETE ON material_usage
    FOR EACH ROW
    BEGIN
      UPDATE materials SET
        used_quantity = (
          SELECT COALESCE(SUM(quantity_used), 0)
          FROM material_usage
          WHERE material_id = OLD.material_id
        ),
        remaining_quantity = original_quantity - (
          SELECT COALESCE(SUM(quantity_used), 0)
          FROM material_usage
          WHERE material_id = OLD.material_id
        ),
        updated_at = CURRENT_TIMESTAMP
      WHERE id = OLD.material_id;
    END`;
    
    await connection.query(usageDeleteTrigger);
    
    // ÂàõÂª∫Á¥¢ÂºïÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®Ôºâ
    console.log('üîç ÂàõÂª∫‰ºòÂåñÁ¥¢Âºï...');
    try {
      await connection.query('CREATE INDEX idx_materials_purchase_id ON materials(purchase_id)');
    } catch (error) {
      if (error.code !== 'ER_DUP_KEYNAME') {
        console.log('Á¥¢Âºïidx_materials_purchase_idÂ∑≤Â≠òÂú®ÔºåË∑≥ËøáÂàõÂª∫');
      }
    }
    
    try {
      await connection.query('CREATE INDEX idx_material_usage_material_id ON material_usage(material_id)');
    } catch (error) {
      if (error.code !== 'ER_DUP_KEYNAME') {
        console.log('Á¥¢Âºïidx_material_usage_material_idÂ∑≤Â≠òÂú®ÔºåË∑≥ËøáÂàõÂª∫');
      }
    }
    
    console.log('‚úÖ ÂÖ®Èù¢Ëß¶ÂèëÂô®Â∫îÁî®ÊàêÂäüÔºÅ');
    console.log('üìã Ëß¶ÂèëÂô®ÂäüËÉΩËØ¥ÊòéÔºö');
    console.log('- INSERTËß¶ÂèëÂô®ÔºöÂàõÂª∫purchaseÊó∂Ëá™Âä®ÂàõÂª∫materialËÆ∞ÂΩïÔºåÂåÖÂê´remaining_quantityÂàùÂßãÂÄº');
    console.log('- UPDATEËß¶ÂèëÂô®ÔºöÂêåÊ≠•ÊâÄÊúâÂèØ‰øÆÊîπÂ≠óÊÆµÂà∞materialË°®');
    console.log('- ÊîØÊåÅÂ≠óÊÆµÔºöpurchase_name, quality, bead_diameter, weight, piece_count, total_price, specification, photos, notes, supplier_id, min_stock_alertÁ≠â');
    console.log('- ÊîØÊåÅÊâÄÊúâ‰∫ßÂìÅÁ±ªÂûãÔºöLOOSE_BEADS, BRACELET, ACCESSORIES, FINISHED_MATERIAL');
    console.log('- material_usageËß¶ÂèëÂô®ÔºöËá™Âä®Êõ¥Êñ∞Â∫ìÂ≠òÊï∞Èáè');
    
  } catch (error) {
    console.error('‚ùå Ëß¶ÂèëÂô®Â∫îÁî®Â§±Ë¥•:', error.message);
    throw error;
  } finally {
    await connection.end();
  }
}

applyComprehensiveTriggers().catch(console.error);