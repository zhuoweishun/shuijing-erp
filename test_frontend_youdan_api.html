<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•æ²¹èƒ†ä»·æ ¼API</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            border-left: 4px solid #28a745;
        }
        .error {
            border-left: 4px solid #dc3545;
            background: #f8d7da;
        }
        .price-highlight {
            background: yellow;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª æ²¹èƒ†ä»·æ ¼æ˜¾ç¤ºAPIæµ‹è¯•</h1>
        
        <div class="test-section">
            <h3>1. æµ‹è¯•å±‚çº§å¼åº“å­˜API</h3>
            <p>æµ‹è¯• <code>/api/inventory/hierarchical</code> æ¥å£è¿”å›çš„æ²¹èƒ†ä»·æ ¼æ•°æ®</p>
            <button onclick="testHierarchicalAPI()">æµ‹è¯•å±‚çº§å¼åº“å­˜API</button>
            <div id="hierarchical-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>2. æµ‹è¯•æ²¹èƒ†æ•°æ®è°ƒè¯•API</h3>
            <p>æµ‹è¯• <code>/api/inventory/debug/youdan</code> æ¥å£çš„æ²¹èƒ†ä¸“ç”¨è°ƒè¯•æ•°æ®</p>
            <button onclick="testYoudanDebugAPI()">æµ‹è¯•æ²¹èƒ†è°ƒè¯•API</button>
            <div id="youdan-debug-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>3. åˆ†æä»·æ ¼å­—æ®µæ˜ å°„</h3>
            <p>åˆ†æå‰ç«¯æ¥æ”¶åˆ°çš„ä»·æ ¼å­—æ®µåç§°å’Œæ•°å€¼</p>
            <button onclick="analyzePriceFields()">åˆ†æä»·æ ¼å­—æ®µ</button>
            <div id="price-analysis-result" class="result"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3001/api';
        const AUTH_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoidXNlcl8xNzM3MzU5NzE5NzI5IiwidXNlcm5hbWUiOiJhZG1pbiIsInJvbGUiOiJCT1NTIiwiaWF0IjoxNzM3MzU5NzIwLCJleHAiOjE3Mzc0NDYxMjB9.Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8';
        
        let hierarchicalData = null;
        
        async function makeRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${AUTH_TOKEN}`,
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('è¯·æ±‚å¤±è´¥:', error);
                throw error;
            }
        }
        
        async function testHierarchicalAPI() {
            const resultDiv = document.getElementById('hierarchical-result');
            resultDiv.textContent = 'æ­£åœ¨æµ‹è¯•å±‚çº§å¼åº“å­˜API...';
            resultDiv.className = 'result';
            
            try {
                const response = await makeRequest(`${API_BASE_URL}/inventory/hierarchical?material_types=LOOSE_BEADS&search=æ²¹èƒ†`);
                hierarchicalData = response;
                
                let output = 'âœ… å±‚çº§å¼åº“å­˜APIè°ƒç”¨æˆåŠŸ\n\n';
                output += `å“åº”çŠ¶æ€: ${response.success}\n`;
                output += `æ•°æ®ç»“æ„: ${JSON.stringify(response.data, null, 2)}\n\n`;
                
                // æŸ¥æ‰¾æ²¹èƒ†æ•°æ®
                const hierarchy = response.data?.hierarchy || [];
                const youdanData = hierarchy.filter(item => 
                    item.material_type === 'LOOSE_BEADS' && 
                    item.specifications?.some(spec => 
                        spec.qualities?.some(quality => 
                            quality.batches?.some(batch => 
                                batch.material_name?.includes('æ²¹èƒ†')
                            )
                        )
                    )
                );
                
                if (youdanData.length > 0) {
                    output += 'ğŸ” æ‰¾åˆ°æ²¹èƒ†æ•°æ®:\n';
                    youdanData.forEach((typeGroup, index) => {
                        output += `\nç±»å‹ç»„ ${index + 1}: ${typeGroup.material_type}\n`;
                        typeGroup.specifications?.forEach((spec, specIndex) => {
                            output += `  è§„æ ¼ ${specIndex + 1}: ${spec.specification_value}${spec.specification_unit}\n`;
                            spec.qualities?.forEach((quality, qualityIndex) => {
                                output += `    å“ç›¸ ${qualityIndex + 1}: ${quality.quality}çº§\n`;
                                output += `    å‰©ä½™æ•°é‡: ${quality.remaining_quantity}\n`;
                                output += `    price_per_unit: ${quality.price_per_unit}\n`;
                                output += `    price_per_gram: ${quality.price_per_gram}\n`;
                                
                                quality.batches?.forEach((batch, batchIndex) => {
                                    if (batch.material_name?.includes('æ²¹èƒ†')) {
                                        output += `      æ‰¹æ¬¡ ${batchIndex + 1}:\n`;
                                        output += `        - material_name: ${batch.material_name}\n`;
                                        output += `        - remaining_quantity: ${batch.remaining_quantity}\n`;
                                        output += `        - price_per_unit: ${batch.price_per_unit} (ç±»å‹: ${typeof batch.price_per_unit})\n`;
                                        output += `        - unit_cost: ${batch.unit_cost} (ç±»å‹: ${typeof batch.unit_cost})\n`;
                                        output += `        - price_per_gram: ${batch.price_per_gram}\n`;
                                        output += `        - supplier_name: ${batch.supplier_name}\n`;
                                    }
                                });
                            });
                        });
                    });
                } else {
                    output += 'âš ï¸ æœªæ‰¾åˆ°æ²¹èƒ†æ•°æ®\n';
                }
                
                resultDiv.textContent = output;
                resultDiv.className = 'result success';
                
            } catch (error) {
                resultDiv.textContent = `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }
        
        async function testYoudanDebugAPI() {
            const resultDiv = document.getElementById('youdan-debug-result');
            resultDiv.textContent = 'æ­£åœ¨æµ‹è¯•æ²¹èƒ†è°ƒè¯•API...';
            resultDiv.className = 'result';
            
            try {
                const response = await makeRequest(`${API_BASE_URL}/inventory/debug/youdan`);
                
                let output = 'âœ… æ²¹èƒ†è°ƒè¯•APIè°ƒç”¨æˆåŠŸ\n\n';
                output += `å“åº”çŠ¶æ€: ${response.success}\n`;
                output += `æ¶ˆæ¯: ${response.data?.message}\n\n`;
                
                // åˆ†æmaterialsæ•°æ®
                const materialsData = response.data?.materials_data || [];
                if (materialsData.length > 0) {
                    output += `ğŸ“Š Materialsè¡¨æ•°æ® (${materialsData.length} æ¡è®°å½•):\n`;
                    materialsData.forEach((record, index) => {
                        output += `\nè®°å½• ${index + 1}:\n`;
                        output += `  - material_name: ${record.material_name}\n`;
                        output += `  - quality: ${record.quality}\n`;
                        output += `  - bead_diameter: ${record.bead_diameter}\n`;
                        output += `  - remaining_quantity: ${record.remaining_quantity}\n`;
                        output += `  - unit_cost: ${record.unit_cost} (ç±»å‹: ${typeof record.unit_cost})\n`;
                    });
                }
                
                // åˆ†æåŸå§‹åº“å­˜è®¡ç®—æ•°æ®
                const rawInventory = response.data?.raw_inventory_calculation || [];
                if (rawInventory.length > 0) {
                    output += `\n\nğŸ“Š åŸå§‹åº“å­˜è®¡ç®—æ•°æ® (${rawInventory.length} æ¡è®°å½•):\n`;
                    rawInventory.forEach((record, index) => {
                        output += `\nè®°å½• ${index + 1}:\n`;
                        output += `  - material_name: ${record.material_name}\n`;
                        output += `  - material_type: ${record.material_type}\n`;
                        output += `  - quality: ${record.quality}\n`;
                        output += `  - remaining_quantity: ${record.remaining_quantity}\n`;
                        output += `  - price_per_unit: ${record.price_per_unit} (ç±»å‹: ${typeof record.price_per_unit})\n`;
                    });
                }
                
                resultDiv.textContent = output;
                resultDiv.className = 'result success';
                
            } catch (error) {
                resultDiv.textContent = `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }
        
        async function analyzePriceFields() {
            const resultDiv = document.getElementById('price-analysis-result');
            
            if (!hierarchicalData) {
                resultDiv.textContent = 'è¯·å…ˆè¿è¡Œ"æµ‹è¯•å±‚çº§å¼åº“å­˜API"è·å–æ•°æ®';
                resultDiv.className = 'result error';
                return;
            }
            
            let output = 'ğŸ” ä»·æ ¼å­—æ®µåˆ†æ\n\n';
            
            const hierarchy = hierarchicalData.data?.hierarchy || [];
            let foundYoudan = false;
            
            hierarchy.forEach((typeGroup, typeIndex) => {
                if (typeGroup.material_type === 'LOOSE_BEADS') {
                    typeGroup.specifications?.forEach((spec, specIndex) => {
                        spec.qualities?.forEach((quality, qualityIndex) => {
                            quality.batches?.forEach((batch, batchIndex) => {
                                if (batch.material_name?.includes('æ²¹èƒ†')) {
                                    foundYoudan = true;
                                    output += `æ²¹èƒ†æ‰¹æ¬¡ ${batchIndex + 1} (${batch.material_name} - ${quality.quality}çº§):\n`;
                                    
                                    // æ£€æŸ¥æ‰€æœ‰å¯èƒ½çš„ä»·æ ¼å­—æ®µ
                                    const priceFields = [
                                        'price_per_unit',
                                        'unit_cost', 
                                        'price_per_bead',
                                        'price_per_gram'
                                    ];
                                    
                                    priceFields.forEach(field => {
                                        const value = batch[field];
                                        const type = typeof value;
                                        const isValid = value !== null && value !== undefined && value !== 0;
                                        
                                        output += `  - ${field}: ${value} (ç±»å‹: ${type}, æœ‰æ•ˆ: ${isValid})\n`;
                                    });
                                    
                                    // æ£€æŸ¥å‰ç«¯åº”è¯¥ä½¿ç”¨å“ªä¸ªå­—æ®µ
                                    const frontendPrice = batch.price_per_unit || batch.unit_cost;
                                    output += `  - å‰ç«¯åº”ä½¿ç”¨ä»·æ ¼: ${frontendPrice}\n`;
                                    output += `  - æ•°å€¼è½¬æ¢ç»“æœ: ${Number(frontendPrice)}\n\n`;
                                }
                            });
                        });
                    });
                }
            });
            
            if (!foundYoudan) {
                output += 'âš ï¸ åœ¨å±‚çº§æ•°æ®ä¸­æœªæ‰¾åˆ°æ²¹èƒ†è®°å½•\n';
            }
            
            // æ¨¡æ‹Ÿå‰ç«¯ä»·æ ¼è®¡ç®—é€»è¾‘
            output += '\nğŸ“Š æ¨¡æ‹Ÿå‰ç«¯ä»·æ ¼è®¡ç®—é€»è¾‘:\n';
            output += 'å‰ç«¯ä»£ç : const price = Number(batch.price_per_unit) || 0\n';
            output += 'å¦‚æœprice_per_unitä¸ºnullï¼Œåˆ™ä½¿ç”¨0\n';
            output += 'å¦‚æœprice_per_unitæœ‰å€¼ï¼Œåˆ™è½¬æ¢ä¸ºæ•°å­—\n\n';
            
            output += 'ğŸ”§ ä¿®å¤å»ºè®®:\n';
            output += '1. ç¡®ä¿åç«¯è¿”å›price_per_unitå­—æ®µ\n';
            output += '2. å‰ç«¯ä½¿ç”¨price_per_unitè€Œä¸æ˜¯unit_cost\n';
            output += '3. æ·»åŠ å‘åå…¼å®¹ï¼šprice_per_unit || unit_cost\n';
            
            resultDiv.textContent = output;
            resultDiv.className = 'result success';
        }
    </script>
</body>
</html>